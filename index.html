<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SurveyOS ‚Äî Motor Insurance Survey Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Barlow+Condensed:wght@400;500;600;700&family=Barlow+Semi+Condensed:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{--ink:#0D1521;--ink2:#1C2B3A;--surface:#F5F7FA;--panel:#FFFFFF;--border:#E2E8F0;--border2:#CBD5E1;--teal:#0E9F8A;--teal-dark:#0B7D6E;--teal-light:#E6F7F5;--amber:#F59E0B;--amber-bg:#FFFBEB;--red:#EF4444;--red-bg:#FEF2F2;--green:#10B981;--green-bg:#ECFDF5;--blue:#3B82F6;--blue-bg:#EFF6FF;--gold:#B45309;--muted:#64748B;--muted2:#94A3B8;--cream:#F8F5F0;--sidebar-w:220px;--header-h:54px}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'Barlow',sans-serif;font-size:14px;color:var(--ink);background:var(--surface)}
.app{display:grid;grid-template-columns:var(--sidebar-w) 1fr;height:100vh}
.sidebar{background:var(--ink);color:#fff;display:flex;flex-direction:column;overflow:hidden;z-index:10}
.sidebar-logo{padding:18px 16px 14px;border-bottom:1px solid rgba(255,255,255,0.08)}
.logo-mark{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:0.04em;color:#fff}
.logo-mark span{color:var(--teal)}
.logo-sub{font-size:10px;color:rgba(255,255,255,0.35);letter-spacing:0.08em;text-transform:uppercase;margin-top:2px}
.sidebar-nav{flex:1;overflow-y:auto;padding:10px 0}
.nav-section{font-size:9px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.3);padding:14px 16px 5px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;transition:all 0.12s;font-size:13px;color:rgba(255,255,255,0.65);border-left:3px solid transparent;font-weight:500}
.nav-item:hover{background:rgba(255,255,255,0.06);color:#fff}
.nav-item.active{background:rgba(14,159,138,0.15);color:#fff;border-left-color:var(--teal)}
.nav-icon{width:18px;text-align:center;font-size:14px}
.nav-badge{margin-left:auto;background:var(--teal);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px}
.sidebar-profile{padding:12px 14px;border-top:1px solid rgba(255,255,255,0.08);cursor:pointer}
.profile-avatar{width:32px;height:32px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;color:#fff;flex-shrink:0}
.main{display:flex;flex-direction:column;overflow:hidden;background:var(--surface)}
.topbar{height:var(--header-h);background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px;flex-shrink:0}
.topbar-title{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--ink);letter-spacing:0.02em}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.page{display:none;flex:1;overflow:hidden;flex-direction:column}
.page.active{display:flex}
.dashboard-body{flex:1;overflow-y:auto;padding:24px}
.section-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:16px}
.section-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;letter-spacing:0.02em;color:var(--ink)}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:18px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--teal)}
.stat-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-bottom:8px}
.stat-value{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:700;color:var(--ink);line-height:1}
.stat-sub{font-size:11px;color:var(--muted2);margin-top:5px}
.claims-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
.claim-card{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:all 0.15s}
.claim-card:hover{border-color:var(--teal);box-shadow:0 4px 16px rgba(14,159,138,0.1);transform:translateY(-1px)}
.claim-card-strip{height:4px}
.claim-card-body{padding:14px 16px}
.claim-veh{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;letter-spacing:0.04em;color:var(--ink)}
.claim-insured{font-size:13px;color:var(--muted);margin-top:2px}
.claim-meta{display:flex;align-items:center;gap:8px;margin-top:10px;flex-wrap:wrap}
.claim-tag{font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;letter-spacing:0.04em;text-transform:uppercase;font-family:'Barlow Condensed',sans-serif}
.claim-card-footer{padding:10px 16px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.progress-dot{width:8px;height:8px;border-radius:50%;background:var(--border2);display:inline-block;margin-right:4px}
.progress-dot.done{background:var(--teal)}
.progress-dot.active{background:var(--amber)}
.claim-date{font-size:11px;color:var(--muted2)}
.wizard-body{flex:1;overflow-y:auto;padding:32px;max-width:760px;margin:0 auto;width:100%}
.wizard-step{display:none}
.wizard-step.active{display:block}
.wizard-heading{font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:700;margin-bottom:6px;color:var(--ink)}
.wizard-sub{font-size:14px;color:var(--muted);margin-bottom:28px;line-height:1.6}
.vtype-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:28px}
.vtype-card{border:2px solid var(--border);border-radius:12px;padding:20px 16px;cursor:pointer;transition:all 0.15s;text-align:center;background:var(--panel)}
.vtype-card:hover{border-color:var(--teal);background:var(--teal-light)}
.vtype-card.selected{border-color:var(--teal);background:var(--teal-light);box-shadow:0 0 0 3px rgba(14,159,138,0.15)}
.vtype-icon{font-size:32px;margin-bottom:10px}
.vtype-name{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:var(--ink);margin-bottom:4px}
.vtype-desc{font-size:11px;color:var(--muted);line-height:1.5}
.workspace{flex:1;display:flex;flex-direction:column;overflow:hidden}
.ws-header{background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;flex-shrink:0}
.ws-vehicle{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:700;letter-spacing:0.04em}
.ws-insured{font-size:12px;color:var(--muted);margin-top:2px}
.ws-tabs{background:var(--panel);border-bottom:1px solid var(--border);display:flex;gap:0;flex-shrink:0;overflow-x:auto}
.ws-tab{padding:11px 18px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.12s;font-family:'Barlow Semi Condensed',sans-serif;letter-spacing:0.02em}
.ws-tab:hover{color:var(--ink)}
.ws-tab.active{color:var(--teal);border-bottom-color:var(--teal)}
.ws-content{flex:1;overflow-y:auto}
.ws-panel{display:none;padding:24px}
.ws-panel.active{display:block}
.doc-slots-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px;margin-bottom:20px}
.doc-slot{border:2px dashed var(--border2);border-radius:10px;padding:16px;text-align:center;cursor:pointer;transition:all 0.15s;background:var(--panel);position:relative;min-height:96px}
.doc-slot:hover{border-color:var(--teal);background:var(--teal-light)}
.doc-slot.has-file{border-style:solid;border-color:var(--green);background:var(--green-bg)}
.doc-slot.processing{border-color:var(--amber);background:var(--amber-bg);animation:pulse 1.5s infinite}
.doc-slot.done{border-style:solid;border-color:var(--teal);background:var(--teal-light)}
.doc-slot.error{border-style:solid;border-color:var(--red);background:var(--red-bg)}
.doc-slot-icon{font-size:22px;margin-bottom:6px}
.doc-slot-name{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--ink);font-family:'Barlow Condensed',sans-serif}
.doc-slot-hint{font-size:10px;color:var(--muted2);margin-top:3px}
.doc-slot-status{font-size:10px;font-weight:600;margin-top:5px}
.doc-slot.processing .doc-slot-status{color:var(--amber)}
.doc-slot.done .doc-slot-status,.doc-slot.has-file .doc-slot-status{color:var(--green)}
.doc-slot.error .doc-slot-status{color:var(--red)}
.doc-tick{position:absolute;top:8px;right:8px;width:16px;height:16px;border-radius:50%;background:var(--green);display:none;align-items:center;justify-content:center;color:#fff;font-size:9px}
.doc-slot.done .doc-tick,.doc-slot.has-file .doc-tick{display:flex}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.form-grid.three{grid-template-columns:repeat(3,1fr)}
.form-grid.four{grid-template-columns:repeat(4,1fr)}
.form-grid.one{grid-template-columns:1fr}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group.span2{grid-column:span 2}
.form-group.span3{grid-column:span 3}
.form-group.span4{grid-column:span 4}
.form-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);font-family:'Barlow Condensed',sans-serif}
.form-input,.form-select,.form-textarea{border:1px solid var(--border2);border-radius:6px;padding:7px 10px;font-size:13px;font-family:'Barlow',sans-serif;color:var(--ink);background:var(--panel);transition:border-color 0.12s;width:100%}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 2px rgba(14,159,138,0.1)}
.form-input.ai-filled,.form-select.ai-filled,.form-textarea.ai-filled{background:var(--amber-bg);border-color:var(--amber)}
.form-textarea{resize:vertical;min-height:70px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:18px;overflow:hidden}
.card-header{padding:11px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--ink)}
.card-header h3{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:0.06em;color:#fff;text-transform:uppercase}
.card-body{padding:16px}
.assess-table-wrap{overflow-x:auto;margin-bottom:16px}
table.at{width:100%;border-collapse:collapse;font-size:12px}
table.at th{background:var(--ink);color:#fff;padding:7px 8px;font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:0.05em;text-transform:uppercase;white-space:nowrap}
table.at td{padding:5px 7px;border-bottom:1px solid var(--border)}
table.at tr.sr td{background:var(--ink2);color:rgba(255,255,255,0.8);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;padding:4px 8px}
table.at tr.subt td{background:var(--teal-light);font-weight:700;color:var(--teal-dark);border-top:2px solid var(--teal)}
table.at tr:hover td{background:#f8fbfa}
.num-input{width:80px;border:1px solid var(--border2);border-radius:4px;padding:3px 5px;font-size:12px;font-family:'Barlow Condensed',sans-serif;text-align:right}
.text-input-cell{border:1px solid transparent;padding:3px 5px;font-size:12px;font-family:'Barlow',sans-serif;border-radius:4px;background:transparent;width:100%;min-width:100px}
.text-input-cell:focus{outline:none;border-color:var(--teal);background:var(--teal-light)}
.summary-card{background:var(--ink);color:#fff;border-radius:10px;padding:16px}
.sum-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.07)}
.sum-label{color:rgba(255,255,255,0.6)}
.sum-value{font-family:'Barlow Condensed',sans-serif;font-weight:600}
.sum-row.total{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--teal);padding-top:10px;margin-top:5px;border-bottom:none}
.inwords{font-size:11px;color:rgba(255,255,255,0.35);font-style:italic;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)}
.reports-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;margin-bottom:24px}
.report-card{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:all 0.15s}
.report-card:hover{border-color:var(--teal);box-shadow:0 3px 12px rgba(14,159,138,0.1)}
.report-card-header{padding:16px;border-bottom:1px solid var(--border)}
.report-card-icon{font-size:24px;margin-bottom:8px}
.report-card-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;color:var(--ink)}
.report-card-desc{font-size:11px;color:var(--muted);margin-top:3px;line-height:1.5}
.report-card-footer{padding:10px 16px;display:flex;gap:8px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:13px;font-weight:600;border:1px solid transparent;cursor:pointer;transition:all 0.14s;font-family:'Barlow Semi Condensed',sans-serif;letter-spacing:0.02em;white-space:nowrap}
.btn-primary{background:var(--teal);color:#fff;border-color:var(--teal)}
.btn-primary:hover{background:var(--teal-dark)}
.btn-secondary{background:var(--panel);color:var(--ink);border-color:var(--border2)}
.btn-secondary:hover{border-color:var(--teal);color:var(--teal)}
.btn-danger{background:var(--red-bg);color:var(--red);border-color:transparent}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-ghost{background:transparent;color:var(--muted);border-color:transparent;padding:6px 10px}
.btn-ghost:hover{color:var(--teal);background:var(--teal-light)}
.btn-sm{padding:4px 10px;font-size:11px}
.btn-lg{padding:10px 22px;font-size:15px}
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:700;letter-spacing:0.05em;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase}
.badge-green{background:var(--green-bg);color:var(--green)}
.badge-amber{background:var(--amber-bg);color:var(--gold)}
.badge-red{background:var(--red-bg);color:var(--red)}
.badge-blue{background:var(--blue-bg);color:var(--blue)}
.badge-grey{background:var(--surface);color:var(--muted)}
.badge-teal{background:var(--teal-light);color:var(--teal-dark)}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--ink);color:#fff;padding:10px 16px;border-radius:8px;font-size:13px;box-shadow:0 4px 20px rgba(0,0,0,0.25);animation:slideIn 0.25s ease;max-width:320px;border-left:3px solid var(--teal)}
.toast.error{border-left-color:var(--red)}
.toast.success{border-left-color:var(--green)}
@keyframes slideIn{from{transform:translateX(30px);opacity:0}to{transform:translateX(0);opacity:1}}
.alert{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;border-radius:8px;font-size:13px;line-height:1.5;margin-bottom:16px}
.alert-ai{background:var(--amber-bg);border:1px solid var(--amber);color:var(--gold)}
.alert-success{background:var(--green-bg);border:1px solid var(--green);color:#065f46}
.alert-info{background:var(--blue-bg);border:1px solid var(--blue);color:#1e40af}
.alert-warn{background:var(--red-bg);border:1px solid var(--red);color:var(--red)}
.mono{font-family:'Barlow Condensed',monospace;letter-spacing:0.04em}
.text-right{text-align:right}.text-center{text-align:center}
.dep-toggle{display:flex;gap:8px;flex-wrap:wrap}
.dep-btn{padding:5px 13px;border-radius:6px;border:1px solid var(--border2);cursor:pointer;font-size:12px;font-weight:600;font-family:'Barlow Condensed',sans-serif;background:var(--panel);color:var(--muted);transition:all 0.12s}
.dep-btn.active{background:var(--teal);color:#fff;border-color:var(--teal)}
.spot-dmg-row{display:grid;grid-template-columns:200px 1fr 34px;gap:8px;align-items:start;padding:7px 10px;border-bottom:1px solid var(--border)}
.spot-dmg-row:last-child{border-bottom:none}
.dep-table td,.dep-table th{padding:7px 12px;border:1px solid var(--border);font-size:12px}
.dep-table th{background:var(--ink);color:#fff;font-family:'Barlow Condensed',sans-serif}
.empty-state{text-align:center;padding:60px 24px;color:var(--muted)}
.empty-icon{font-size:48px;margin-bottom:14px;opacity:0.4}
.empty-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;color:var(--ink);margin-bottom:8px}
.empty-desc{font-size:13px;line-height:1.6;max-width:340px;margin:0 auto 20px}
.sig-area{border:2px dashed var(--border2);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:border-color 0.15s;min-height:90px}
.sig-area:hover{border-color:var(--teal)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
.profile-body{flex:1;overflow-y:auto;padding:24px;max-width:800px}
.ai-review-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.review-section{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:0}
.review-sec-header{background:var(--ink);color:#fff;padding:9px 14px;display:flex;align-items:center;gap:8px}
.review-sec-title{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:0.05em}
.review-sec-badge{margin-left:auto;font-size:10px;background:rgba(255,255,255,0.2);padding:2px 7px;border-radius:10px}
.review-field{display:grid;grid-template-columns:90px 1fr;border-bottom:1px solid var(--border)}
.review-field:last-child{border-bottom:none}
.review-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);padding:7px 10px;background:var(--surface);border-right:1px solid var(--border);display:flex;align-items:center}
.review-val-input{border:none;padding:6px 9px;font-size:12px;font-family:'Barlow',sans-serif;width:100%;background:transparent;color:var(--ink)}
.review-val-input:focus{outline:none;background:var(--teal-light)}
.review-val-input.ai-filled{background:var(--amber-bg)}
</style>
</head>
<body>
<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">Survey<span>OS</span></div>
    <div class="logo-sub">Motor Insurance Platform</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">Workspace</div>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">‚äû</span> Dashboard <span class="nav-badge" id="badge-active">0</span></div>
    <div class="nav-item" onclick="startNewClaim()"><span class="nav-icon">Ôºã</span> New Claim</div>
    <div id="sidebar-claim-section" style="display:none">
      <div class="nav-section" style="margin-top:4px">Open Claim</div>
      <div style="padding:6px 14px"><div id="sb-veh" style="font-size:12px;font-weight:700;color:#fff;font-family:'Barlow Condensed',sans-serif;letter-spacing:0.04em">‚Äî</div><div id="sb-insured" style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:1px">‚Äî</div></div>
      <div class="nav-item" id="nav-docs" onclick="openWorkspace('docs')"><span class="nav-icon">üìÑ</span> Documents</div>
      <div class="nav-item" id="nav-review" onclick="openWorkspace('review')"><span class="nav-icon">ü§ñ</span> AI Review</div>
      <div class="nav-item" id="nav-details" onclick="openWorkspace('details')"><span class="nav-icon">üìã</span> Claim Details</div>
      <div class="nav-item" id="nav-assess" onclick="openWorkspace('assess')"><span class="nav-icon">‚öñ</span> Assessment</div>
      <div class="nav-item" id="nav-spot" onclick="openWorkspace('spot')"><span class="nav-icon">üìç</span> Spot Survey</div>
      <div class="nav-item" id="nav-reports" onclick="openWorkspace('reports')"><span class="nav-icon">üìä</span> Reports</div>
    </div>
    <div class="nav-section" style="margin-top:8px">Settings</div>
    <div class="nav-item" onclick="showPage('profile')"><span class="nav-icon">üë§</span> Surveyor Profile</div>
    <div style="padding:10px 12px 6px"><div id="drive-nav-badge" class="drive-badge disconnected" onclick="connectDrive()">‚òÅ Drive: Not connected</div></div>
    <div class="nav-item" onclick="showPage('dep')"><span class="nav-icon">üìâ</span> Dep. Schedule</div>
  </nav>
  <div class="sidebar-profile" onclick="showPage('profile')">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="profile-avatar" id="sb-avatar">SP</div>
      <div><div style="font-size:12px;font-weight:600;color:#fff" id="sb-name">Surveyor</div><div style="font-size:10px;color:rgba(255,255,255,0.4)" id="sb-lic">License #</div></div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div><div class="topbar-title" id="page-title">Dashboard</div></div>
    <div class="topbar-right">
      <div id="ai-status-bar" style="display:none;align-items:center;gap:8px;font-size:12px;color:var(--amber)"><span style="animation:pulse 1s infinite">‚ö°</span><span id="ai-status-text">Processing‚Ä¶</span></div>
      <button class="btn btn-primary btn-sm" onclick="startNewClaim()">Ôºã New Claim</button>
    </div>
  </div>

<!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
<div class="page active" id="page-dashboard">
  <div class="dashboard-body">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Active Claims</div><div class="stat-value" id="st-active">0</div><div class="stat-sub">In progress</div></div>
      <div class="stat-card" style="--teal:#F59E0B"><div class="stat-label">This Month</div><div class="stat-value" id="st-month">0</div><div class="stat-sub">Reports generated</div></div>
      <div class="stat-card"><div class="stat-label">Total Assessed</div><div class="stat-value" id="st-assessed" style="font-size:18px">‚Çπ0</div><div class="stat-sub">Across all claims</div></div>
      <div class="stat-card"><div class="stat-label">All Claims</div><div class="stat-value" id="st-total">0</div><div class="stat-sub">Total in system</div></div>
    </div>
    <div class="section-header">
      <div class="section-title">Claims</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="exportClaims()">‚Üì Export CSV</button>
        <button class="btn btn-primary btn-sm" onclick="startNewClaim()">Ôºã New Claim</button>
      </div>
    </div>
    <div id="claims-container"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê NEW CLAIM WIZARD ‚ïê‚ïê‚ïê -->
<div class="page" id="page-new-claim">
  <div class="wizard-body">
    <div class="wizard-step active" id="wizard-step-1">
      <div class="wizard-heading">Select Survey Type</div>
      <div class="wizard-sub">Choose the type of survey. Spot Survey is done at the accident scene; Final Survey is the full workshop assessment.</div>
      <div class="vtype-grid" style="grid-template-columns:1fr 1fr">
        <div class="vtype-card" id="wz-st-spot" onclick="selectSurveyType('spot')" style="border:2px solid transparent">
          <div class="vtype-icon">üìç</div>
          <div class="vtype-name">Spot Survey</div>
          <div class="vtype-desc">Accident scene inspection.<br/>3‚Äì4 documents ¬∑ Spot Report + Fee Bill.</div>
        </div>
        <div class="vtype-card" id="wz-st-final" onclick="selectSurveyType('final')" style="border:2px solid transparent">
          <div class="vtype-icon">üîß</div>
          <div class="vtype-name">Final Survey</div>
          <div class="vtype-desc">Full workshop assessment.<br/>5‚Äì10 documents ¬∑ All 5 reports.</div>
        </div>
      </div>
      <div id="stype-msg" style="display:none" class="alert alert-success"><span>‚úÖ</span><span id="stype-msg-text">Selected</span></div>
      <div style="display:flex;justify-content:flex-end;margin-top:16px">
        <button class="btn btn-primary btn-lg" id="wz-next0" onclick="wizardStep1b()" disabled>Next: Vehicle Type ‚Üí</button>
      </div>
    </div>
    <div class="wizard-step" id="wizard-step-1b">
      <div class="wizard-heading">Select Vehicle Type</div>
      <div class="wizard-sub">Vehicle type determines which documents are required and which commercial compliance checks are performed.</div>
      <div class="vtype-grid">
        <div class="vtype-card" id="vt-private" onclick="selectVehicleType('private')"><div class="vtype-icon">üöó</div><div class="vtype-name">Private Vehicle</div><div class="vtype-desc">Cars, SUVs, motorcycles for personal use.</div></div>
        <div class="vtype-card" id="vt-comm-pass" onclick="selectVehicleType('comm-pass')"><div class="vtype-icon">üöå</div><div class="vtype-name">Commercial Passenger</div><div class="vtype-desc">Buses, taxis, auto-rickshaws, cabs.<br/>Permit + Fitness + Auth required.</div></div>
        <div class="vtype-card" id="vt-comm-goods" onclick="selectVehicleType('comm-goods')"><div class="vtype-icon">üöõ</div><div class="vtype-name">Commercial Goods</div><div class="vtype-desc">Trucks, lorries, pickups.<br/>Permit + Fitness + Lok Challan.</div></div>
      </div>
      <div id="vtype-msg" style="display:none" class="alert alert-success"><span>‚úÖ</span><span id="vtype-msg-text">Selected</span></div>
      <div style="display:flex;justify-content:space-between;margin-top:16px">
        <button class="btn btn-secondary" onclick="wizardBackTo(1)">‚Üê Back</button>
        <button class="btn btn-primary btn-lg" id="wz-next1" onclick="wizardStep2()" disabled>Next: Claim Info ‚Üí</button>
      </div>
    </div>
    <div class="wizard-step" id="wizard-step-2">
      <div class="wizard-heading">Basic Claim Information</div>
      <div class="wizard-sub">Key identifiers only ‚Äî all document fields will be filled by AI after uploading.</div>
      <div class="card">
        <div class="card-header"><h3>Claim &amp; Policy</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Claim Number <span id="wz-claim-optional" style="color:var(--muted);font-weight:400">(optional for Spot)</span></label><input class="form-input" id="wz-claim-no" placeholder="CL/HDF/2025/12345"/></div>
            <div class="form-group"><label class="form-label">Policy Number</label><input class="form-input" id="wz-policy-no" placeholder="2311002813P117584390"/></div>
            <div class="form-group"><label class="form-label">Vehicle Reg. Number</label><input class="form-input" id="wz-reg-no" placeholder="MH-15-AV-1234" style="text-transform:uppercase"/></div>
            <div class="form-group"><label class="form-label">Insurer</label><input class="form-input" id="wz-insurer" placeholder="HDFC ERGO General Insurance Co. Ltd."/></div>
            <div class="form-group"><label class="form-label">Report Number</label><input class="form-input" id="wz-report-no"/></div>
            <div class="form-group"><label class="form-label">Date of Accident</label><input class="form-input" type="datetime-local" id="wz-doa"/></div>
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <button class="btn btn-secondary" onclick="wizardBackTo('1b')">‚Üê Back</button>
        <button class="btn btn-primary btn-lg" onclick="createClaim()">Create Claim &amp; Open Workspace ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê WORKSPACE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-workspace">
  <div class="workspace">
    <div class="ws-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div><div class="ws-vehicle" id="ws-veh-title">‚Äî</div><div class="ws-insured" id="ws-insured-title">‚Äî</div></div>
        <div id="ws-status-bar" style="margin-left:4px"></div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" onclick="saveClaim()">üíæ Save</button>
          <button class="btn btn-ghost btn-sm" onclick="deleteClaim()">üóë</button>
          <button class="btn btn-secondary btn-sm" id="ws-drive-folder-btn" onclick="openDriveFolder()" title="Open Drive folder" style="display:none">‚òÅ Folder</button>
          <span id="ws-survey-type-badge" class="badge" style="font-size:11px"></span>
        </div>
      </div>
    </div>
    <div id="chunk-bar">‚ö° <span id="chunk-bar-text">Processing‚Ä¶</span></div>
    <div class="ws-tabs">
      <div class="ws-tab active" onclick="switchTab('docs')" data-tab="docs">üìÑ Documents</div>
      <div class="ws-tab" onclick="switchTab('review')" data-tab="review">ü§ñ AI Review</div>
      <div class="ws-tab" onclick="switchTab('details')" data-tab="details">üìã Claim Details</div>
      <div class="ws-tab" onclick="switchTab('assess')" data-tab="assess">‚öñ Assessment</div>
      <div class="ws-tab" onclick="switchTab('spot')" data-tab="spot">üìç Spot Survey</div>
      <div class="ws-tab" onclick="switchTab('reports')" data-tab="reports">üìä Reports</div>
    </div>
    <div class="ws-content">

<!-- TAB: DOCUMENTS -->
<div class="ws-panel active" id="tab-docs">
  <div class="alert alert-ai">ü§ñ Upload all documents at once ‚Äî AI processes them in parallel and fills the entire form automatically. Review extracted data in the <b>AI Review</b> tab before proceeding.</div>
  <div id="doc-slots-container" class="doc-slots-grid"></div>
  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <button class="btn btn-primary" id="process-all-btn" onclick="processAllDocs()" style="font-size:14px;padding:10px 20px">‚ö° Process All with AI</button>
    <button class="btn btn-secondary" onclick="switchTab('review')">View AI Results ‚Üí</button>
    <div id="process-status" style="font-size:12px;color:var(--muted)"></div>
  </div>
</div>

<!-- TAB: AI REVIEW -->
<div class="ws-panel" id="tab-review">
  <div id="review-empty-msg" class="alert alert-info">‚Ñπ Upload documents and click <b>Process All with AI</b> to extract data. Results appear here for review.</div>
  <div id="ai-review-content" style="display:none">
    <div class="alert alert-ai" style="margin-bottom:20px">ü§ñ <span id="review-summary-msg">AI extracted data ‚Äî review amber fields.</span></div>
    <div class="ai-review-grid" id="review-grid"></div>
    <div style="margin-top:20px;display:flex;gap:10px">
      <button class="btn btn-primary" onclick="applyAndProceed()">‚úì Confirm & Go to Claim Details</button>
      <button class="btn btn-secondary" onclick="switchTab('details')">Skip Review ‚Üí</button>
    </div>
  </div>
</div>

<!-- TAB: CLAIM DETAILS -->
<div class="ws-panel" id="tab-details">

<div class="card"><div class="card-header"><h3>Policy & Insurer</h3></div><div class="card-body">
  <div class="form-grid four">
    <div class="form-group"><label class="form-label">Report No.</label><input class="form-input" id="f-report-no"/></div>
    <div class="form-group"><label class="form-label">Report Date</label><input class="form-input" type="date" id="f-report-date"/></div>
    <div class="form-group span2"><label class="form-label">Insurer Name & Address</label><input class="form-input" id="f-insurer" placeholder="HDFC ERGO General Insurance Co. Ltd., Mumbai"/></div>
    <div class="form-group"><label class="form-label">Policy No.</label><input class="form-input mono" id="f-policy-no"/></div>
    <div class="form-group"><label class="form-label">Claim No.</label><input class="form-input mono" id="f-claim-no"/></div>
    <div class="form-group"><label class="form-label">Policy From</label><input class="form-input" type="date" id="f-policy-from"/></div>
    <div class="form-group"><label class="form-label">Policy To</label><input class="form-input" type="date" id="f-policy-to"/></div>
    <div class="form-group"><label class="form-label">IDV (‚Çπ)</label><input class="form-input" id="f-idv"/></div>
    <div class="form-group"><label class="form-label">Policy Type</label><select class="form-select" id="f-policy-type"><option>Comprehensive (OD + TP)</option><option>OD Only</option><option>Third Party Only</option><option>Zero Depreciation</option><option>Bundled</option></select></div>
    <div class="form-group"><label class="form-label">Policy Issuing Office</label><input class="form-input" id="f-policy-office"/></div>
    <div class="form-group"><label class="form-label">Appointing Office</label><input class="form-input" id="f-appt-office"/></div>
  </div>
</div></div>

<div class="card"><div class="card-header"><h3>Insured Details</h3></div><div class="card-body">
  <div class="form-grid four">
    <div class="form-group span2"><label class="form-label">Insured Name</label><input class="form-input" id="f-insured-name"/></div>
    <div class="form-group"><label class="form-label">Mobile</label><input class="form-input" id="f-insured-mobile"/></div>
    <div class="form-group"><label class="form-label">HPA / Finance With</label><input class="form-input" id="f-hpa" placeholder="NIL"/></div>
    <div class="form-group span4"><label class="form-label">Address</label><input class="form-input" id="f-insured-addr"/></div>
  </div>
</div></div>

<div class="card"><div class="card-header"><h3>Vehicle Particulars</h3></div><div class="card-body">
  <div class="form-grid four">
    <div class="form-group"><label class="form-label">Reg. No.</label><input class="form-input mono" id="f-reg-no" style="text-transform:uppercase"/></div>
    <div class="form-group"><label class="form-label">Date of Reg.</label><input class="form-input" type="date" id="f-reg-date"/></div>
    <div class="form-group"><label class="form-label">Class of Vehicle</label><input class="form-input" id="f-veh-class" placeholder="LMV / HMV / MCWG"/></div>
    <div class="form-group"><label class="form-label">Year of Mfg.</label><input class="form-input" id="f-year"/></div>
    <div class="form-group"><label class="form-label">Make</label><input class="form-input" id="f-make"/></div>
    <div class="form-group"><label class="form-label">Model / Variant</label><input class="form-input" id="f-model"/></div>
    <div class="form-group"><label class="form-label">Chassis No.</label><input class="form-input mono" id="f-chassis"/></div>
    <div class="form-group"><label class="form-label">Engine No.</label><input class="form-input mono" id="f-engine"/></div>
    <div class="form-group"><label class="form-label">Body Type</label><input class="form-input" id="f-body-type"/></div>
    <div class="form-group"><label class="form-label">Colour</label><input class="form-input" id="f-colour"/></div>
    <div class="form-group"><label class="form-label">Fuel Type</label><select class="form-select" id="f-fuel"><option>Petrol</option><option>Diesel</option><option>CNG</option><option>Electric</option><option>Hybrid</option><option>LPG</option></select></div>
    <div class="form-group"><label class="form-label">CC</label><input class="form-input" id="f-cc"/></div>
    <div class="form-group"><label class="form-label">RLW / GVW / Seating</label><input class="form-input" id="f-rlw"/></div>
    <div class="form-group"><label class="form-label">Odometer (KM)</label><input class="form-input" id="f-odo"/></div>
    <div class="form-group"><label class="form-label">Pre-Accident Condition</label><input class="form-input" id="f-condition" placeholder="Good / Average / Poor"/></div>
    <div class="form-group" id="grp-fitness" style="display:none"><label class="form-label">Fitness Cert. No.</label><input class="form-input" id="f-fitness"/></div>
    <div class="form-group" id="grp-route" style="display:none"><label class="form-label">Route / Area</label><input class="form-input" id="f-route"/></div>
  </div>
</div></div>

<div class="card"><div class="card-header"><h3>Driver's Particulars</h3></div><div class="card-body">
  <div class="form-grid four">
    <div class="form-group span2"><label class="form-label">Driver Name</label><input class="form-input" id="f-driver-name"/></div>
    <div class="form-group"><label class="form-label"><select style="border:none;background:transparent;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);cursor:pointer;font-family:'Barlow Condensed',sans-serif" id="f-dl-relation"><option value="S/o">S/o</option><option value="D/o">D/o</option><option value="W/o">W/o</option></select></label><input class="form-input" id="f-dl-parent" placeholder="Father / Husband name"/></div>
    <div class="form-group"><label class="form-label">Date of Birth</label><input class="form-input" type="date" id="f-dob"/></div>
    <div class="form-group"><label class="form-label">MDL No.</label><input class="form-input mono" id="f-mdl"/></div>
    <div class="form-group"><label class="form-label">DL Issue Date</label><input class="form-input" type="date" id="f-dl-issue"/></div>
    <div class="form-group"><label class="form-label">Non-Transport Valid Upto</label><input class="form-input" type="date" id="f-dl-valid"/></div>
    <div class="form-group"><label class="form-label">Transport Valid Upto</label><input class="form-input" type="date" id="f-dl-valid-transport"/></div>
    <div class="form-group"><label class="form-label">Issuing Authority</label><input class="form-input" id="f-dl-auth"/></div>
    <div class="form-group span4"><label class="form-label">Licence Classes</label><input class="form-input" id="f-dl-type" placeholder="LMV, MCWG, TRANS, HMV"/></div>
    <div class="form-group"><label class="form-label">MDL Verification</label><select class="form-select" id="f-dl-mdl-verified"><option value="verified">Original MDL Verified</option><option value="photocopy">Photocopy Verified</option><option value="not-available">Not Available</option></select></div>
  </div>
</div></div>

<div class="card"><div class="card-header"><h3>Accident & Survey Details</h3></div><div class="card-body">
  <div class="form-grid four">
    <div class="form-group span2"><label class="form-label">Date & Time of Accident</label><input class="form-input" type="datetime-local" id="f-doa"/></div>
    <div class="form-group span2"><label class="form-label">Place of Accident</label><input class="form-input" id="f-poa"/></div>
    <div class="form-group span2"><label class="form-label">Date of Survey</label><input class="form-input" type="date" id="f-survey-date"/></div>
    <div class="form-group span2"><label class="form-label">Place of Survey / Workshop</label><input class="form-input" id="f-survey-place"/></div>
    <div class="form-group span4"><label class="form-label">Third Party Details</label><input class="form-input" id="f-tp" placeholder="NIL or describe third party involvement"/></div>
    <div class="form-group span4"><label class="form-label">Cause & Nature of Accident</label><textarea class="form-textarea" id="f-cause"></textarea></div>
  </div>
</div></div>

</div><!-- tab-details -->

<!-- TAB: ASSESSMENT -->
<div class="ws-panel" id="tab-assess">
  <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px;flex-wrap:wrap">
    <div>
      <div class="form-label" style="margin-bottom:8px">Depreciation Method</div>
      <div class="dep-toggle">
        <button class="dep-btn active" id="dep-nil" onclick="setDep('nil')">Nil Depreciation</button>
        <button class="dep-btn" id="dep-standard" onclick="setDep('standard')">Standard IRDAI</button>
        <button class="dep-btn" id="dep-zero" onclick="setDep('zero')">Zero Dep Policy</button>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-secondary btn-sm" onclick="addAssessRow('parts')">+ Parts</button>
      <button class="btn btn-secondary btn-sm" onclick="addAssessRow('labour')">+ Labour</button>
      <button class="btn btn-secondary btn-sm" onclick="addAssessRow('paint')">+ Paint</button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 320px;gap:18px">
    <div>
      <div class="assess-table-wrap">
        <table class="at">
          <thead><tr>
            <th style="width:26px">#</th><th style="text-align:left">Particulars</th><th>Type</th><th>GST%</th>
            <th>Est. ‚Çπ</th><th>Assessed ‚Çπ</th><th>Dep%</th><th>After Dep ‚Çπ</th><th>Allow</th><th style="width:24px"></th>
          </tr></thead>
          <tbody id="assess-tbody"><tr><td colspan="10" style="text-align:center;padding:30px;color:var(--muted2);font-size:13px">Upload estimate to auto-populate, or add rows manually</td></tr></tbody>
        </table>
      </div>
    </div>
    <div>
      <div class="summary-card">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:12px">Assessment Summary</div>
        <div class="sum-row"><span class="sum-label">Parts Base (after dep)</span><span class="sum-value" id="sum-parts-base">‚Çπ 0.00</span></div>
        <div class="sum-row"><span class="sum-label">CGST @ 9%</span><span class="sum-value" id="sum-parts-cgst">‚Çπ 0.00</span></div>
        <div class="sum-row"><span class="sum-label">SGST @ 9%</span><span class="sum-value" id="sum-parts-sgst">‚Çπ 0.00</span></div>
        <div class="sum-row"><span class="sum-label">Parts Total (incl. GST)</span><span class="sum-value" id="sum-parts-total">‚Çπ 0.00</span></div>
        <div style="height:1px;background:rgba(255,255,255,0.07);margin:6px 0"></div>
        <div class="sum-row"><span class="sum-label">Labour Base</span><span class="sum-value" id="sum-labour-base">‚Çπ 0.00</span></div>
        <div class="sum-row"><span class="sum-label">GST @ 18%</span><span class="sum-value" id="sum-labour-gst">‚Çπ 0.00</span></div>
        <div class="sum-row"><span class="sum-label">Labour Total (incl. GST)</span><span class="sum-value" id="sum-labour-total">‚Çπ 0.00</span></div>
        <div style="height:1px;background:rgba(255,255,255,0.07);margin:6px 0"></div>
        <div class="sum-row"><span class="sum-label">Grand Total</span><span class="sum-value" id="sum-grand">‚Çπ 0.00</span></div>
        <div class="sum-row"><span class="sum-label">Less: Policy Excess</span><input id="sum-excess" value="500" onchange="recalcSummary()" style="width:70px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#fff;font-size:12px;padding:2px 5px;text-align:right;font-family:'Barlow Condensed',sans-serif"/></div>
        <div class="sum-row"><span class="sum-label">Less: Salvage</span><input id="sum-salvage" value="0" onchange="recalcSummary()" style="width:70px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#fff;font-size:12px;padding:2px 5px;text-align:right;font-family:'Barlow Condensed',sans-serif"/></div>
        <div class="sum-row total"><span>Net Assessed Loss</span><span id="sum-net">‚Çπ 0.00</span></div>
        <div class="inwords" id="sum-inwords">RUPEES ZERO ONLY</div>
      </div>
      <div style="margin-top:14px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px">
        <div class="form-label" style="margin-bottom:10px">Breakdown by Part Type</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <div style="text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:3px">Metal</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700" id="bd-metal">‚Çπ0.00</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:3px">Plastic</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700" id="bd-plastic">‚Çπ0.00</div></div>
          <div style="text-align:center"><div style="font-size:10px;color:var(--muted);margin-bottom:3px">Glass</div><div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700" id="bd-glass">‚Çπ0.00</div></div>
        </div>
        <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font-size:11px;display:flex;justify-content:space-between;color:var(--muted)">
          <span>Estimate: <b id="cmp-est">‚Çπ0</b></span><span>Assessed: <b id="cmp-ass">‚Çπ0</b></span><span>Œî <b id="cmp-diff" style="color:var(--amber)">‚Çπ0</b></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TAB: SPOT SURVEY -->
<div class="ws-panel" id="tab-spot">
  <div class="card"><div class="card-header"><h3>Spot Report Info</h3></div><div class="card-body">
    <div class="form-grid four">
      <div class="form-group"><label class="form-label">Spot Report No.</label><input class="form-input" id="spot-report-no" placeholder="SPO/463/2025"/></div>
      <div class="form-group"><label class="form-label">Report Date</label><input class="form-input" type="date" id="spot-report-date"/></div>
      <div class="form-group"><label class="form-label">Date of Allotment</label><input class="form-input" type="date" id="spot-allot-date"/></div>
      <div class="form-group"><label class="form-label">Date & Time of Survey</label><input class="form-input" type="datetime-local" id="spot-survey-datetime"/></div>
    </div>
  </div></div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div class="card"><div class="card-header"><h3>Driver's Particulars</h3></div><div class="card-body">
      <div class="form-grid one">
        <div class="form-group"><label class="form-label">Driver Name</label><input class="form-input" id="spot-driver-name"/></div>
        <div class="form-group"><label class="form-label"><select style="border:none;background:transparent;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);cursor:pointer;font-family:'Barlow Condensed',sans-serif" id="spot-dl-relation"><option>S/o</option><option>D/o</option><option>W/o</option></select></label><input class="form-input" id="spot-dl-parent" placeholder="Father / Husband name"/></div>
        <div class="form-group"><label class="form-label">MDL No.</label><input class="form-input mono" id="spot-mdl-no"/></div>
        <div class="form-group"><label class="form-label">DL Issue Date</label><input class="form-input" type="date" id="spot-dl-issue"/></div>
        <div class="form-group"><label class="form-label">Non-Transport Valid Upto</label><input class="form-input" type="date" id="spot-dl-valid" onchange="checkSpotDL()"/></div>
        <div class="form-group"><label class="form-label">Transport Valid Upto</label><input class="form-input" type="date" id="spot-dl-valid-transport" onchange="checkSpotDL()"/></div>
        <div class="form-group"><label class="form-label">Licence Classes</label><input class="form-input" id="spot-dl-type"/></div>
        <div class="form-group"><label class="form-label">Issuing Authority</label><input class="form-input" id="spot-dl-authority"/></div>
        <div class="form-group"><label class="form-label">MDL Verification</label><select class="form-select" id="spot-mdl-verified" onchange="checkSpotDL()"><option value="verified">Original Verified</option><option value="photocopy">Photocopy Verified</option><option value="not-available">Not Available</option></select></div>
        <div id="spot-dl-badge" style="display:none"></div>
        <div id="spot-dl-remark-grp" style="display:none" class="form-group"><label class="form-label">DL Invalidity Remarks (Mandatory)</label><textarea class="form-textarea" id="spot-dl-invalid-remarks"></textarea></div>
      </div>
    </div></div>

    <div class="card"><div class="card-header"><h3>Accident Details</h3></div><div class="card-body">
      <div class="form-grid one">
        <div class="form-group"><label class="form-label">Date & Time of Accident</label><input class="form-input" type="datetime-local" id="spot-accident-datetime"/></div>
        <div class="form-group"><label class="form-label">Place of Accident</label><input class="form-input" id="spot-accident-place"/></div>
        <div class="form-group"><label class="form-label">Place of Survey / Workshop</label><input class="form-input" id="spot-survey-place"/></div>
        <div class="form-group"><label class="form-label">Third Party Involvement</label><select class="form-select" id="spot-tp-involved"><option value="no">NIL ‚Äî No Third Party</option><option value="tppd">TPPD ‚Äî Property Damage Only</option><option value="tppi">TPPI ‚Äî Personal Injury / Death</option><option value="both">Both ‚Äî Property Damage & Injury</option></select></div>
        <div class="form-group"><label class="form-label">Third Party Details</label><input class="form-input" id="spot-tp-details" placeholder="NIL"/></div>
        <div class="form-group"><label class="form-label">Reported to Police?</label><select class="form-select" id="spot-police-reported"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div class="form-group"><label class="form-label">Police Station</label><input class="form-input" id="spot-police-station"/></div>
        <div class="form-group"><label class="form-label">Diary / FIR No.</label><input class="form-input" id="spot-diary-no"/></div>
        <div class="form-group"><label class="form-label">Panchanama Drawn?</label><select class="form-select" id="spot-panchanama"><option value="no">No</option><option value="yes">Yes</option></select></div>
      </div>
    </div></div>
  </div>

  <div id="spot-comm-section" style="display:none">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card"><div class="card-header"><h3>Commercial Documents</h3></div><div class="card-body">
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Permit No.</label><input class="form-input mono" id="spot-permit-no"/></div>
          <div class="form-group"><label class="form-label">Permit Type</label><input class="form-input" id="spot-permit-type" placeholder="National / State / Contract Carriage"/></div>
          <div class="form-group"><label class="form-label">Permit Valid From</label><input class="form-input" type="date" id="spot-permit-from"/></div>
          <div class="form-group"><label class="form-label">Permit Valid Upto</label><input class="form-input" type="date" id="spot-permit-to"/></div>
          <div class="form-group"><label class="form-label">Auth. Cert. No.</label><input class="form-input mono" id="spot-auth-no"/></div>
          <div class="form-group"><label class="form-label">Auth Valid Upto</label><input class="form-input" type="date" id="spot-auth-valid"/></div>
          <div class="form-group"><label class="form-label">Fitness Cert. No.</label><input class="form-input mono" id="spot-fitness-no"/></div>
          <div class="form-group"><label class="form-label">Fitness Valid Upto</label><input class="form-input" type="date" id="spot-fitness-valid"/></div>
        </div>
      </div></div>
      <div id="spot-goods-card" style="display:none">
        <div class="card"><div class="card-header"><h3>Load / Lok Challan</h3></div><div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">GVW (kg)</label><input class="form-input" id="spot-gvw" onchange="autoCalcLoad()"/></div>
            <div class="form-group"><label class="form-label">ULW / Tare (kg)</label><input class="form-input" id="spot-ulw" onchange="autoCalcLoad()"/></div>
            <div class="form-group"><label class="form-label">Legal Load Capacity (kg)</label><input class="form-input" id="spot-load-capacity" placeholder="Auto = GVW ‚àí ULW" readonly style="background:var(--surface)"/></div>
            <div class="form-group"><label class="form-label">Actual Load (kg)</label><input class="form-input" id="spot-actual-load" onchange="autoCalcLoad()"/></div>
            <div class="form-group"><label class="form-label">Challan / CN No.</label><input class="form-input mono" id="spot-cn-no"/></div>
            <div class="form-group"><label class="form-label">Challan Date</label><input class="form-input" type="date" id="spot-cn-date"/></div>
            <div class="form-group"><label class="form-label">Origin</label><input class="form-input" id="spot-load-origin"/></div>
            <div class="form-group"><label class="form-label">Destination</label><input class="form-input" id="spot-load-dest"/></div>
            <div class="form-group span2"><label class="form-label">Goods Description</label><input class="form-input" id="spot-load-desc"/></div>
          </div>
          <div id="load-overage-alert" style="display:none" class="alert alert-warn" style="margin-top:10px">‚ö† <span id="load-overage-text"></span></div>
        </div></div>
      </div>
    </div>
  </div>

  <div class="card"><div class="card-header"><h3>Cause & Nature of Accident</h3></div><div class="card-body">
    <textarea class="form-textarea" id="spot-accident-cause" style="min-height:80px"></textarea>
  </div></div>

  <div class="card"><div class="card-header"><h3>Damage Assessment at Spot</h3><button class="btn btn-secondary btn-sm" onclick="addSpotDamageRow('','')">+ Add Component</button></div><div class="card-body">
    <div class="form-grid four" style="margin-bottom:14px">
      <div class="form-group"><label class="form-label">Overall Severity</label><select class="form-select" id="spot-damage-severity"><option value="minor">Minor</option><option value="moderate">Moderate</option><option value="major">Major</option><option value="total-loss">Total Loss</option></select></div>
      <div class="form-group"><label class="form-label">Airbags Deployed?</label><select class="form-select" id="spot-airbags"><option value="no">No</option><option value="yes">Yes</option></select></div>
      <div class="form-group span2"><label class="form-label">Vehicle Drivable?</label><select class="form-select" id="spot-drivable"><option>Yes ‚Äî Vehicle was drivable</option><option>No ‚Äî Vehicle was not drivable</option><option>Partially ‚Äî With difficulty</option></select></div>
    </div>
    <div id="spot-damage-rows" style="border:1px solid var(--border);border-radius:8px;overflow:hidden"><div style="padding:20px;text-align:center;color:var(--muted2);font-size:13px">No components added yet.</div></div>
  </div></div>

  <div class="card"><div class="card-header"><h3>Observations & Comments</h3></div><div class="card-body">
    <textarea class="form-textarea" id="spot-comments" placeholder="Observations, towing instructions, workshop details‚Ä¶" style="min-height:80px"></textarea>
  </div></div>
</div>

<!-- TAB: REPORTS -->
<div class="ws-panel" id="tab-reports">
  <div class="reports-grid">
    <div class="report-card"><div class="report-card-header"><div class="report-card-icon">üìç</div><div class="report-card-name">Spot Survey Report</div><div class="report-card-desc">On-site accident inspection. Filed separately, first report.</div></div><div class="report-card-footer"><button class="btn btn-primary btn-sm" onclick="genReport('spot')">üìÑ Generate PDF</button></div></div>
    <div class="report-card"><div class="report-card-header"><div class="report-card-icon">üìã</div><div class="report-card-name">Final Survey Report</div><div class="report-card-desc">Complete loss assessment with depreciation and net liability.</div></div><div class="report-card-footer"><button class="btn btn-primary btn-sm" onclick="genReport('final')">üìÑ Generate PDF</button></div></div>
    <div class="report-card"><div class="report-card-header"><div class="report-card-icon">‚úÖ</div><div class="report-card-name">Bill Check Report</div><div class="report-card-desc">Estimate vs. assessed comparison with GST breakdown.</div></div><div class="report-card-footer"><button class="btn btn-primary btn-sm" onclick="genReport('bill')">üìÑ Generate PDF</button></div></div>
    <div class="report-card"><div class="report-card-header"><div class="report-card-icon">üîÑ</div><div class="report-card-name">Reinspection Report</div><div class="report-card-desc">Verify repairs completed. Track replaced vs repaired parts.</div></div><div class="report-card-footer"><button class="btn btn-primary btn-sm" onclick="genReport('ri')">üìÑ Generate PDF</button></div></div>
    <div class="report-card"><div class="report-card-header"><div class="report-card-icon">üí∞</div><div class="report-card-name">Surveyor Fee Bill</div><div class="report-card-desc">Professional fee invoice for insurer payment.</div></div><div class="report-card-footer"><button class="btn btn-primary btn-sm" onclick="genReport('fee')">üìÑ Generate PDF</button></div></div>
  </div>

  <div class="card"><div class="card-header"><h3>Surveyor Fee Inputs</h3></div><div class="card-body">
    <div class="form-grid four">
      <div class="form-group"><label class="form-label">Professional Fees (‚Çπ)</label><input class="form-input" id="fee-prof" value="3500" onchange="calcFeeTotal()"/></div>
      <div class="form-group"><label class="form-label">RI Fees (‚Çπ)</label><input class="form-input" id="fee-ri" value="0" onchange="calcFeeTotal()"/></div>
      <div class="form-group"><label class="form-label">Travel (‚Çπ)</label><input class="form-input" id="fee-travel" value="500" onchange="calcFeeTotal()"/></div>
      <div class="form-group"><label class="form-label">Travel Notes</label><input class="form-input" id="fee-travel-note" placeholder="40 KM @ ‚Çπ12.50/km"/></div>
      <div class="form-group"><label class="form-label">Photos Count</label><input class="form-input" id="fee-photos-count" value="20" onchange="calcFeeTotal()"/></div>
      <div class="form-group"><label class="form-label">Photo Rate (‚Çπ)</label><input class="form-input" id="fee-photo-rate" value="10" onchange="calcFeeTotal()"/></div>
      <div class="form-group"><label class="form-label">Postal / Courier (‚Çπ)</label><input class="form-input" id="fee-postal" value="50" onchange="calcFeeTotal()"/></div>
      <div class="form-group"><label class="form-label">Haltage (‚Çπ)</label><input class="form-input" id="fee-haltage" value="0" onchange="calcFeeTotal()"/></div>
    </div>
    <div style="margin-top:10px;padding:10px 14px;background:var(--ink);border-radius:8px;display:flex;gap:20px;align-items:center;flex-wrap:wrap">
      <span style="color:rgba(255,255,255,0.5);font-size:12px">Prof: <b id="fs-prof" style="color:#fff">‚Çπ0</b></span>
      <span style="color:rgba(255,255,255,0.5);font-size:12px">RI: <b id="fs-ri" style="color:#fff">‚Çπ0</b></span>
      <span style="color:rgba(255,255,255,0.5);font-size:12px">Travel: <b id="fs-travel" style="color:#fff">‚Çπ0</b></span>
      <span style="color:rgba(255,255,255,0.5);font-size:12px">Photos: <b id="fs-photos" style="color:#fff">‚Çπ0</b></span>
      <div style="margin-left:auto;font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--teal)">TOTAL: <span id="fs-total">‚Çπ0</span></div>
    </div>
  </div></div>

  <div class="card"><div class="card-header"><h3>Reinspection Details</h3><button class="btn btn-secondary btn-sm" onclick="loadPartsForRI()">Load Parts from Assessment</button></div><div class="card-body">
    <div class="form-grid">
      <div class="form-group"><label class="form-label">RI Ref No.</label><input class="form-input" id="ri-ref"/></div>
      <div class="form-group"><label class="form-label">RI Date</label><input class="form-input" type="date" id="ri-date"/></div>
      <div class="form-group"><label class="form-label">Original Survey Report Ref</label><input class="form-input" id="ri-survey-ref"/></div>
      <div class="form-group"><label class="form-label">Original Survey Date</label><input class="form-input" type="date" id="ri-survey-date"/></div>
      <div class="form-group"><label class="form-label">Repair Quality</label><select class="form-select" id="ri-repair-quality"><option value="satisfactory">Satisfactory ‚Äî As per report</option><option value="good">Good ‚Äî Better than expected</option><option value="partial">Partial ‚Äî Some items pending</option><option value="unsatisfactory">Unsatisfactory</option></select></div>
      <div class="form-group"><label class="form-label">Vehicle Condition</label><select class="form-select" id="ri-vehicle-condition"><option value="roadworthy">Road Worthy ‚Äî Fit for operation</option><option value="needs-attention">Needs Minor Attention</option><option value="not-roadworthy">Not Road Worthy</option></select></div>
      <div class="form-group"><label class="form-label">Salvage Status</label><select class="form-select" id="ri-salvage-status"><option value="collected">Collected & Verified</option><option value="not-collected">Not Collected</option><option value="partial">Partial</option><option value="na">N/A</option></select></div>
      <div class="form-group span2"><label class="form-label">Additional Observations</label><textarea class="form-textarea" id="ri-observations"></textarea></div>
    </div>
    <div id="ri-parts-container" style="margin-top:14px"></div>
  </div></div>
</div>

    </div><!-- ws-content -->
  </div><!-- workspace -->
</div><!-- page-workspace -->

<!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-profile">
  <div class="profile-body">
    <div class="section-header" style="margin-bottom:20px"><div class="section-title">Surveyor Profile</div><button class="btn btn-primary" onclick="saveProfile()">Save Profile</button></div>
    <div class="card"><div class="card-header"><h3>Personal & Licence Details</h3></div><div class="card-body">
      <div class="form-grid">
        <div class="form-group span2"><label class="form-label">Full Name</label><input class="form-input" id="sp-name"/></div>
        <div class="form-group span2"><label class="form-label">Qualification</label><input class="form-input" id="sp-qual" placeholder="B.Sc., Dip. in Auto Engg."/></div>
        <div class="form-group"><label class="form-label">Surveyor Licence No.</label><input class="form-input mono" id="sp-lic"/></div>
        <div class="form-group"><label class="form-label">Licence Expiry</label><input class="form-input" id="sp-lic-exp" placeholder="DD-MM-YYYY"/></div>
        <div class="form-group"><label class="form-label">IIISLA Membership No.</label><input class="form-input mono" id="sp-iiisla"/></div>
        <div class="form-group"><label class="form-label">IRDAI Surveyor Code</label><input class="form-input mono" id="sp-code"/></div>
        <div class="form-group span2"><label class="form-label">Survey Categories</label><input class="form-input" id="sp-categories" placeholder="MOTOR, MARINE, ENGG"/></div>
        <div class="form-group"><label class="form-label">Mobile</label><input class="form-input" id="sp-mobile"/></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="sp-email"/></div>
        <div class="form-group span2"><label class="form-label">Office Address</label><textarea class="form-textarea" id="sp-addr" style="min-height:56px"></textarea></div>
        <div class="form-group"><label class="form-label">GST Number</label><input class="form-input mono" id="sp-gst"/></div>
      </div>
    </div></div>
    <div class="card"><div class="card-header"><h3>Bank Details (for Fee Bill)</h3></div><div class="card-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Bank Name</label><input class="form-input" id="bank-name"/></div>
        <div class="form-group"><label class="form-label">Account Number</label><input class="form-input mono" id="bank-ac"/></div>
        <div class="form-group"><label class="form-label">IFSC Code</label><input class="form-input mono" id="bank-ifsc"/></div>
        <div class="form-group"><label class="form-label">PAN Number</label><input class="form-input mono" id="bank-pan"/></div>
      </div>
    </div></div>
    <div class="card"><div class="card-header"><h3>Signature & Stamp</h3></div><div class="card-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div>
          <div class="form-label" style="margin-bottom:8px">Signature (transparent PNG)</div>
          <div class="sig-area" style="height:90px"><input type="file" accept="image/*" onchange="loadSig(this,'sig')" style="position:absolute;inset:0;opacity:0;cursor:pointer"/><img id="sig-preview" style="max-height:80px;max-width:100%;display:none"/><span id="sig-ph" style="font-size:12px;color:var(--muted2)">Click to upload signature</span></div>
          <button class="btn btn-ghost btn-sm" style="margin-top:6px" onclick="clearSig('sig')">Clear</button>
        </div>
        <div>
          <div class="form-label" style="margin-bottom:8px">Stamp / Seal</div>
          <div class="sig-area" style="height:90px"><input type="file" accept="image/*" onchange="loadSig(this,'stamp')" style="position:absolute;inset:0;opacity:0;cursor:pointer"/><img id="stamp-preview" style="max-height:80px;max-width:100%;display:none"/><span id="stamp-ph" style="font-size:12px;color:var(--muted2)">Click to upload stamp</span></div>
          <button class="btn btn-ghost btn-sm" style="margin-top:6px" onclick="clearSig('stamp')">Clear</button>
        </div>
      </div>
    </div></div>
    <div class="card"><div class="card-header"><h3>AI Configuration</h3></div><div class="card-body">
      <div class="form-grid">
        <div class="form-group span2"><label class="form-label">Groq API Key</label><input class="form-input mono" id="sp-groq-key" type="password" placeholder="gsk_‚Ä¶"/></div>
        <div class="form-group span2"><label class="form-label">AI Model</label><select class="form-select" id="sp-groq-model"><option value="meta-llama/llama-4-scout-17b-16e-instruct">Llama 4 Scout 17B (Recommended)</option><option value="meta-llama/llama-4-maverick-17b-128e-instruct">Llama 4 Maverick 17B (Higher accuracy)</option><option value="llama-3.2-11b-vision-preview">Llama 3.2 11B Vision (Faster)</option></select></div>
      </div>
      <div class="alert alert-warn" style="margin-top:12px">‚ö† Your API key is stored locally in your browser and never sent to any server other than Groq's API.</div>
    </div></div>

    <div class="card"><div class="card-header"><h3>Google Drive Integration</h3></div><div class="card-body">
      <div class="form-grid">
        <div class="form-group span2">
          <label class="form-label">Google OAuth Client ID</label>
          <input class="form-input mono" id="sp-google-client-id" placeholder="xxxxxxxxxxxxxxxx.apps.googleusercontent.com"/>
          <div style="font-size:11px;color:var(--muted);margin-top:5px">Get this from Google Cloud Console ‚Üí APIs &amp; Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID. Set Authorised JavaScript origin to <b>http://localhost</b> (or your domain). Drive will not work on <b>file://</b> protocol.</div>
        </div>
      </div>
      <div style="margin-top:14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="saveProfileAndConnectDrive()">üíæ Save &amp; Connect Drive</button>
        <div id="drive-status-detail" style="font-size:12px;color:var(--muted)">Not connected</div>
      </div>
      <div class="alert" style="margin-top:12px;background:var(--teal-light);color:#065f46;border-color:#a7f3d0">
        ‚òÅ <b>What Drive sync does:</b> Creates a <code>/SurveyOS/</code> folder on your Drive. Each claim gets its own subfolder. Documents are uploaded automatically when you drop them. Every save backs up <code>claim_data.json</code>. Opening the app on any device and reconnecting Drive will restore all folder links automatically via the index file.
      </div>
    </div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DEP SCHEDULE ‚ïê‚ïê‚ïê -->
<div class="page" id="page-dep">
  <div style="padding:24px;flex:1;overflow-y:auto">
    <div class="section-title" style="margin-bottom:20px">IRDAI Depreciation Schedule</div>
    <div class="card"><div class="card-header"><h3>Standard Depreciation Rates</h3></div><div class="card-body">
      <table class="dep-table" style="width:100%;border-collapse:collapse">
        <thead><tr><th>Vehicle Age</th><th>Metal Parts</th><th>Plastic / Rubber / Nylon</th><th>Glass Parts</th><th>Tyres & Tubes</th></tr></thead>
        <tbody>
          <tr><td>Up to 6 months</td><td>0%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>6 months to 1 year</td><td>5%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>1 year to 2 years</td><td>10%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>2 years to 3 years</td><td>15%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>3 years to 4 years</td><td>25%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>4 years to 5 years</td><td>35%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>5 years to 10 years</td><td>40%</td><td>50%</td><td>0%</td><td>50%</td></tr>
          <tr><td>Exceeding 10 years</td><td>50%</td><td>50%</td><td>0%</td><td>50%</td></tr>
        </tbody>
      </table>
      <p style="font-size:12px;color:var(--muted);margin-top:12px;line-height:1.6">Labour charges attract GST at 18% with no depreciation. Under Zero Depreciation / Nil Dep policies, no depreciation is applied. These rates are per IRDAI Motor Claims Guidelines.</p>
    </div></div>
  </div>
</div>

</main>
</div><!-- .app -->

<div class="toast-container" id="toast-container"></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentClaimId = null;
let surveyType     = 'final'; // 'spot' or 'final'
let newSType       = null;
let vehicleType    = 'private';
let newVType       = null;
let gDriveToken    = null;
let gDriveFolderId = null;
let gDriveClient   = null;
let idb            = null;
let depType        = 'nil';
let assessRows     = [];
let spotDamageRows = [];
let riParts        = [];
let sigDataUrl     = null;
let stampDataUrl   = null;
let uploadedDocs   = {};
let extractedData  = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PROMPTS (verbatim from original, all 10 document types)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DOC_PROMPTS = {
  rc:`You are an expert at reading Indian vehicle RC (Registration Certificate) documents. Extract ALL visible fields from this RC book image. Return ONLY a JSON object with these keys (use empty string if not found):\n{\n  "registration_number": "",\n  "date_of_registration": "",\n  "owner_name": "",\n  "address": "",\n  "make": "",\n  "model": "",\n  "body_type": "",\n  "chassis_number": "",\n  "engine_number": "",\n  "cubic_capacity": "",\n  "colour": "",\n  "fuel": "",\n  "seating_capacity": "",\n  "unladen_weight": "",\n  "gross_weight": "",\n  "class_of_vehicle": "",\n  "fitness_cert_no": "",\n  "fitness_valid_upto": "",\n  "permit_no": "",\n  "route": "",\n  "road_tax": "",\n  "year_of_manufacture": "",\n  "hypothecation": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  dl:`You are an expert at reading Indian Driving Licence (DL/MDL) documents. Extract ALL visible fields including BOTH validity dates. Return ONLY a JSON object:\n{\n  "licence_number": "",\n  "holder_name": "",\n  "relation_type": "S/o or D/o or W/o",\n  "father_or_husband_name": "",\n  "date_of_birth": "",\n  "address": "",\n  "date_of_issue": "",\n  "validity_non_transport": "expiry date of LMV/Non-Transport licence",\n  "validity_transport": "expiry date of Transport/HMV/TRANS licence (if present)",\n  "issuing_authority": "",\n  "rto": "",\n  "vehicle_classes": "all classes listed e.g. LMV, MCWG, TRANS, HMV",\n  "badge_no": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  policy:`You are an expert at reading Indian motor insurance policy documents. Extract ALL visible fields. Return ONLY a JSON object:\n{\n  "policy_number": "",\n  "insurer_name": "",\n  "insurer_address": "",\n  "insured_name": "",\n  "insured_address": "",\n  "insured_mobile": "",\n  "registration_number": "",\n  "make_model": "",\n  "chassis_number": "",\n  "engine_number": "",\n  "policy_type": "",\n  "period_from": "",\n  "period_to": "",\n  "idv": "",\n  "policy_issuing_office": "",\n  "appointing_office": "",\n  "hpa_with": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  claim:`You are an expert at reading Indian motor insurance claim forms and intimation letters. Extract ALL visible fields. Return ONLY a JSON object:\n{\n  "claim_number": "",\n  "policy_number": "",\n  "insured_name": "",\n  "vehicle_number": "",\n  "date_of_accident": "",\n  "time_of_accident": "",\n  "place_of_accident": "",\n  "cause_of_accident": "",\n  "driver_name": "",\n  "driver_licence_no": "",\n  "workshop_name": "",\n  "place_of_repair": "",\n  "third_party_details": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  estimate:`You are an expert at reading Indian vehicle repair estimates and workshop bills. Extract ALL line items and totals. Return ONLY a JSON object:\n{\n  "workshop_name": "",\n  "workshop_address": "",\n  "vehicle_number": "",\n  "chassis_number": "",\n  "engine_number": "",\n  "estimate_date": "",\n  "bill_number": "",\n  "spare_parts": [\n    { "description": "", "part_number": "", "quantity": 1, "unit_price": 0, "amount": 0, "gst_percent": 18, "category": "metal or plastic or glass" }\n  ],\n  "labour_items": [\n    { "description": "", "amount": 0, "gst_percent": 18 }\n  ],\n  "painting_items": [\n    { "description": "", "amount": 0, "gst_percent": 18 }\n  ],\n  "subtotal_parts": 0,\n  "subtotal_labour": 0,\n  "subtotal_painting": 0,\n  "gst_amount": 0,\n  "total_amount": 0\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  photos:`You are a senior motor vehicle damage assessor with 20 years experience. Analyze ALL damage photos comprehensively and identify every damaged component. Return ONLY a JSON object:\n{\n  "damaged_parts": [\n    { "part": "component name", "damage_type": "dented/scratched/cracked/broken/deformed/shattered", "severity": "Minor/Moderate/Major", "side": "Front/Rear/Left/Right/Multiple", "recommendation": "REPAIR or REPLACE", "reason": "brief technical reason", "estimated_cost": 0 }\n  ],\n  "overall_damage_summary": "one paragraph description",\n  "overall_assessment": { "severity": "Minor/Moderate/Major/Total Loss", "total_parts": 0, "total_cost": 0, "repair_days": 0 }\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  permit:`You are an expert at reading Indian commercial vehicle permit documents. Extract ALL visible fields. Return ONLY a JSON object:\n{\n  "permit_no": "",\n  "permit_type": "",\n  "vehicle_number": "",\n  "validity_from": "",\n  "validity_to": "",\n  "route": "",\n  "issuing_authority": "",\n  "goods_category": "",\n  "gross_vehicle_weight_kg": "",\n  "unladen_weight_kg": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  auth:`You are an expert at reading Indian commercial vehicle authorisation certificates. Return ONLY a JSON object:\n{\n  "auth_no": "",\n  "auth_type": "",\n  "vehicle_number": "",\n  "validity_from": "",\n  "validity_to": "",\n  "issuing_authority": "",\n  "remarks": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  fitness:`You are an expert at reading Indian vehicle fitness certificates. Return ONLY a JSON object:\n{\n  "fitness_cert_no": "",\n  "vehicle_number": "",\n  "chassis_number": "",\n  "engine_number": "",\n  "validity_from": "",\n  "validity_to": "",\n  "issuing_authority": "",\n  "gross_vehicle_weight_kg": "",\n  "unladen_weight_kg": "",\n  "seating_capacity": "",\n  "fuel_type": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`,
  'lok-challan':`You are an expert at reading Indian goods transport Lok Challan / Consignment Note documents. Return ONLY a JSON object:\n{\n  "challan_no": "",\n  "challan_date": "",\n  "vehicle_number": "",\n  "origin": "",\n  "destination": "",\n  "consignor": "",\n  "consignee": "",\n  "goods_description": "",\n  "weight_kg": "",\n  "freight_amount": "",\n  "remarks": ""\n}\nReturn ONLY the JSON. No explanation, no markdown, no backticks.`
};

const DOC_SLOTS = {
  private:[
    {key:'rc',label:'RC Book',icon:'üöó',hint:'Registration Certificate'},
    {key:'dl',label:'Driving Licence',icon:'ü™™',hint:'MDL / Driving Licence'},
    {key:'policy',label:'Insurance Policy',icon:'üìú',hint:'Policy schedule'},
    {key:'claim',label:'Claim Form',icon:'üìÑ',hint:'Claim intimation / form'},
    {key:'estimate',label:'Repair Estimate',icon:'üîß',hint:'Workshop estimate / bill',multiple:true},
    {key:'photos',label:'Damage Photos',icon:'üì∑',hint:'Vehicle damage photographs',multiple:true}
  ],
  'comm-pass':[
    {key:'rc',label:'RC Book',icon:'üöó',hint:'Registration Certificate'},
    {key:'dl',label:'Driving Licence',icon:'ü™™',hint:'MDL with Transport endorsement'},
    {key:'policy',label:'Insurance Policy',icon:'üìú',hint:'Policy schedule'},
    {key:'claim',label:'Claim Form',icon:'üìÑ',hint:'Claim intimation / form'},
    {key:'permit',label:'Permit',icon:'üìã',hint:'Route permit / Contract carriage'},
    {key:'fitness',label:'Fitness Certificate',icon:'‚úÖ',hint:'RTO Fitness Certificate'},
    {key:'auth',label:'Authorisation / Badge',icon:'üèÖ',hint:'Auth cert / Badge (taxis)'},
    {key:'estimate',label:'Repair Estimate',icon:'üîß',hint:'Workshop estimate / bill',multiple:true},
    {key:'photos',label:'Damage Photos',icon:'üì∑',hint:'Vehicle damage photographs',multiple:true}
  ],
  'comm-goods':[
    {key:'rc',label:'RC Book',icon:'üöó',hint:'Registration Certificate'},
    {key:'dl',label:'Driving Licence',icon:'ü™™',hint:'MDL with HMV / Transport endorsement'},
    {key:'policy',label:'Insurance Policy',icon:'üìú',hint:'Policy schedule'},
    {key:'claim',label:'Claim Form',icon:'üìÑ',hint:'Claim intimation / form'},
    {key:'permit',label:'Permit',icon:'üìã',hint:'State / National / All-India Goods Permit'},
    {key:'fitness',label:'Fitness Certificate',icon:'‚úÖ',hint:'RTO Fitness Certificate'},
    {key:'auth',label:'Authorisation Cert.',icon:'üèÖ',hint:'For hazmat / special cargo'},
    {key:'lok-challan',label:'Lok Challan / CN',icon:'üì¶',hint:'Consignment note for the load'},
    {key:'estimate',label:'Repair Estimate',icon:'üîß',hint:'Workshop estimate / bill',multiple:true},
    {key:'photos',label:'Damage Photos',icon:'üì∑',hint:'Vehicle damage photographs',multiple:true}
  ]
};

const DOC_SLOTS_SPOT = {
  private:[
    {key:'rc',label:'RC Book',icon:'üöó',hint:'Registration Certificate'},
    {key:'dl',label:'Driving Licence',icon:'ü™™',hint:'MDL / Driving Licence'},
    {key:'policy',label:'Insurance Policy',icon:'üìú',hint:'Policy schedule',optional:true},
    {key:'photos',label:'Damage Photos',icon:'üì∑',hint:'Vehicle damage photographs',multiple:true}
  ],
  'comm-pass':[
    {key:'rc',label:'RC Book',icon:'üöó',hint:'Registration Certificate'},
    {key:'dl',label:'Driving Licence',icon:'ü™™',hint:'MDL with Transport endorsement'},
    {key:'policy',label:'Insurance Policy',icon:'üìú',hint:'Policy schedule',optional:true},
    {key:'permit',label:'Permit',icon:'üìã',hint:'Route permit'},
    {key:'fitness',label:'Fitness Certificate',icon:'‚úÖ',hint:'RTO Fitness Certificate'},
    {key:'auth',label:'Authorisation / Badge',icon:'üèÖ',hint:'Auth cert / Badge'},
    {key:'photos',label:'Damage Photos',icon:'üì∑',hint:'Vehicle damage photographs',multiple:true}
  ],
  'comm-goods':[
    {key:'rc',label:'RC Book',icon:'üöó',hint:'Registration Certificate'},
    {key:'dl',label:'Driving Licence',icon:'ü™™',hint:'MDL with HMV endorsement'},
    {key:'policy',label:'Insurance Policy',icon:'üìú',hint:'Policy schedule',optional:true},
    {key:'permit',label:'Permit',icon:'üìã',hint:'Goods Permit'},
    {key:'fitness',label:'Fitness Certificate',icon:'‚úÖ',hint:'RTO Fitness Certificate'},
    {key:'lok-challan',label:'Lok Challan / CN',icon:'üì¶',hint:'Consignment note for the load'},
    {key:'photos',label:'Damage Photos',icon:'üì∑',hint:'Vehicle damage photographs',multiple:true}
  ]
};

const SPOT_COMPONENTS = ['FRONT END STRUCTURE / DRIVERS CABIN','INSTRUMENTS','COOLING SYSTEM','ENGINE & TRANSMISSION','CHASSIS ASSY','LOAD BODY','STEERING SYSTEM','FRONT SUSPENSION','REAR SUSPENSION','WHEEL DISCS & TYRES','FRONT AXLE ASSY','REAR AXLE ASSY','BRAKING SYSTEM','ELECTRICAL SYSTEM','FUEL SYSTEM','EXHAUST SYSTEM','BODY PANELS','WINDSHIELD & GLASS','INTERIOR','OTHER'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  const T = {dashboard:'Dashboard',profile:'Surveyor Profile',dep:'Depreciation Schedule','new-claim':'New Claim',workspace:'Claim Workspace'};
  document.getElementById('page-title').textContent = T[id]||id;
  if (id==='dashboard') refreshDashboard();
}
function switchTab(tab) {
  document.querySelectorAll('.ws-tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
  document.querySelectorAll('.ws-panel').forEach(p => p.classList.toggle('active', p.id==='tab-'+tab));
  document.querySelectorAll('.nav-item[id^="nav-"]').forEach(n => n.classList.remove('active'));
  const ni = document.getElementById('nav-'+tab); if (ni) ni.classList.add('active');
}
function openWorkspace(tab) { showPage('workspace'); switchTab(tab||'docs'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadClaims() { return JSON.parse(localStorage.getItem('os_claims')||'[]'); }
function saveClaims(c) { localStorage.setItem('os_claims', JSON.stringify(c)); }
function gv(id) { return (document.getElementById(id)||{}).value||''; }
function fmt2(v) { return parseFloat(v||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,','); }
function setV(id,val) { const el=document.getElementById(id); if(el&&val!==undefined) el.value=val; }

const ALL_FIELD_IDS = [
  'f-report-no','f-report-date','f-insurer','f-policy-no','f-claim-no','f-policy-from','f-policy-to',
  'f-idv','f-policy-type','f-policy-office','f-appt-office',
  'f-insured-name','f-insured-mobile','f-hpa','f-insured-addr',
  'f-reg-no','f-reg-date','f-veh-class','f-year','f-make','f-model','f-chassis','f-engine',
  'f-body-type','f-colour','f-fuel','f-cc','f-rlw','f-odo','f-condition','f-fitness','f-route',
  'f-driver-name','f-dl-parent','f-dl-relation','f-mdl','f-dob','f-dl-issue','f-dl-valid',
  'f-dl-valid-transport','f-dl-auth','f-dl-type','f-dl-mdl-verified',
  'f-doa','f-poa','f-survey-date','f-survey-place','f-tp','f-cause',
  'sum-excess','sum-salvage',
  'fee-prof','fee-ri','fee-travel','fee-travel-note','fee-photos-count','fee-photo-rate','fee-postal','fee-haltage',
  'spot-report-no','spot-report-date','spot-allot-date','spot-survey-datetime',
  'spot-driver-name','spot-dl-parent','spot-dl-relation','spot-mdl-no','spot-dl-authority',
  'spot-dl-issue','spot-dl-valid','spot-dl-valid-transport','spot-dl-type','spot-mdl-verified','spot-dl-invalid-remarks',
  'spot-accident-datetime','spot-accident-place','spot-survey-place',
  'spot-tp-involved','spot-tp-details','spot-police-reported','spot-police-station','spot-diary-no','spot-panchanama',
  'spot-permit-no','spot-permit-type','spot-permit-from','spot-permit-to',
  'spot-auth-no','spot-auth-valid','spot-fitness-no','spot-fitness-valid',
  'spot-gvw','spot-ulw','spot-load-capacity','spot-actual-load','spot-cn-no','spot-cn-date',
  'spot-load-origin','spot-load-dest','spot-load-desc',
  'spot-accident-cause','spot-damage-severity','spot-airbags','spot-drivable','spot-comments',
  'ri-ref','ri-date','ri-survey-ref','ri-survey-date','ri-repair-quality','ri-vehicle-condition','ri-salvage-status','ri-observations',
  'sp-name','sp-qual','sp-lic','sp-lic-exp','sp-iiisla','sp-code','sp-categories','sp-mobile','sp-email','sp-addr','sp-gst',
  'bank-name','bank-ac','bank-ifsc','bank-pan','sp-groq-key','sp-groq-model'
];

function captureFields() { const f={}; ALL_FIELD_IDS.forEach(id=>{const el=document.getElementById(id);if(el)f[id]=el.value;}); return f; }
function restoreFields(f) { if(!f)return; ALL_FIELD_IDS.forEach(id=>{const el=document.getElementById(id);if(el&&f[id]!==undefined)el.value=f[id];}); }

function computeStatus() {
  const hasDocs = Object.keys(uploadedDocs).length>0;
  const hasAssess = assessRows.length>0;
  if (!gv('f-claim-no')) return 'new';
  if (!hasDocs) return 'docs-pending';
  if (!hasAssess) return 'in-progress';
  if (!gv('f-report-no')) return 'assessment-done';
  return 'submitted';
}

function getCurrentClaimData() {
  return {
    id:currentClaimId, surveyType, vehicleType, depType,
    status:computeStatus(),
    updatedAt:new Date().toISOString(),
    regNo:gv('f-reg-no')||gv('spot-report-no'),
    insuredName:gv('f-insured-name'),
    claimNo:gv('f-claim-no'),
    insurer:gv('f-insurer'),make:gv('f-make'),model:gv('f-model'),
    fields:captureFields(),
    assessRows:JSON.parse(JSON.stringify(assessRows)),
    spotDamageRows:JSON.parse(JSON.stringify(spotDamageRows)),
    riParts:JSON.parse(JSON.stringify(riParts))
  };
}

async function saveClaim() {
  if (!currentClaimId) return;
  const claims = loadClaims();
  const idx = claims.findIndex(c=>c.id===currentClaimId);
  const data = getCurrentClaimData();
  // Preserve gDriveFolderId in the data object
  if (gDriveFolderId) data.gDriveFolderId = gDriveFolderId;
  if (idx>=0) claims[idx]=data; else claims.push(data);
  saveClaims(claims);
  showToast('Claim saved','success');
  refreshDashboard();
  // Backup to Drive (non-blocking)
  if (gDriveToken && gDriveFolderId) {
    driveBackupClaim(data, gDriveFolderId).catch(e=>console.warn('Drive backup:', e));
  }
}

function deleteClaim() {
  if (!currentClaimId||!confirm('Delete this claim permanently?')) return;
  saveClaims(loadClaims().filter(c=>c.id!==currentClaimId));
  currentClaimId=null;
  hideSidebarClaim();
  showPage('dashboard');
  showToast('Claim deleted');
}

function loadClaim(id) {
  const c = loadClaims().find(c=>c.id===id);
  if (!c) return;
  currentClaimId=c.id;
  surveyType=c.surveyType||'final';
  vehicleType=c.vehicleType||'private';
  depType=c.depType||'nil';
  gDriveFolderId=c.gDriveFolderId||null;
  assessRows=c.assessRows||[]; spotDamageRows=c.spotDamageRows||[]; riParts=c.riParts||[];
  uploadedDocs={}; extractedData={};
  restoreFields(c.fields||{});
  applyVehicleTypeUI(); buildDocSlots(); renderAssessTable(); renderSpotDamageRows();
  updateWorkspaceHeader(); showSidebarClaim(); openWorkspace('docs');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshDashboard() {
  const claims = loadClaims();
  const badge = document.getElementById('badge-active');
  if (badge) badge.textContent = claims.length;
  document.getElementById('st-total').textContent = claims.length;
  document.getElementById('st-active').textContent = claims.filter(c=>c.status!=='submitted').length;
  const mo=new Date().getMonth(),yr=new Date().getFullYear();
  document.getElementById('st-month').textContent = claims.filter(c=>{const d=new Date(c.updatedAt||0);return d.getMonth()===mo&&d.getFullYear()===yr;}).length;
  const container = document.getElementById('claims-container');
  if (!claims.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No claims yet</div><div class="empty-desc">Create your first claim to get started.</div><button class="btn btn-primary" onclick="startNewClaim()">Ôºã Create First Claim</button></div>`;
    return;
  }
  const SC = {new:'#94A3B8','docs-pending':'#F59E0B','in-progress':'#3B82F6','assessment-done':'#0E9F8A',submitted:'#10B981'};
  const SL = {new:'New','docs-pending':'Docs Pending','in-progress':'In Progress','assessment-done':'Ready',submitted:'Submitted'};
  const VL = {private:'üöó Private','comm-pass':'üöå Passenger','comm-goods':'üöõ Goods'};
  const prog = ['docs-pending','in-progress','assessment-done','submitted'];
  container.innerHTML = '<div class="claims-grid">' + claims.slice().reverse().map(c => {
    const col = SC[c.status]||'#94A3B8';
    const pi = prog.indexOf(c.status);
    const dots = prog.map((_,i)=>`<span class="progress-dot ${i<pi?'done':i===pi?'active':''}"></span>`).join('');
    return `<div class="claim-card" onclick="loadClaim('${c.id}')">
      <div class="claim-card-strip" style="background:${col}"></div>
      <div class="claim-card-body">
        <div class="claim-veh">${c.regNo||'‚Äî'}</div>
        <div class="claim-insured">${c.insuredName||c.claimNo||'New Claim'}</div>
        <div class="claim-meta">
          <span class="claim-tag" style="background:${col}22;color:${col}">${SL[c.status]||'New'}</span>
          <span class="claim-tag badge-grey">${VL[c.vehicleType]||'Unknown'}</span>
          <span class="claim-tag ${c.surveyType==='spot'?'badge-spot':'badge-final'}">${c.surveyType==='spot'?'üìç Spot':'üîß Final'}</span>
          ${c.claimNo?`<span class="claim-tag badge-grey">${c.claimNo}</span>`:''}
        </div>
      </div>
      <div class="claim-card-footer"><div>${dots}</div><div class="claim-date">${c.updatedAt?new Date(c.updatedAt).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):'‚Äî'}</div></div>
    </div>`;
  }).join('') + '</div>';
}

function exportClaims() {
  const claims = loadClaims();
  if (!claims.length) { showToast('No claims to export','error'); return; }
  const headers = ['Claim No','Policy No','Reg No','Insured Name','Insurer','Status','Vehicle Type','Updated At'];
  const rows = claims.map(c=>[c.claimNo,c.fields?.['f-policy-no']||'',c.regNo,c.insuredName,c.insurer,c.status,c.vehicleType,c.updatedAt].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
  const csv = [headers.join(','),...rows].join('\n');
  const a = document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='claims_export.csv'; a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIZARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startNewClaim() {
  newSType=null; newVType=null;
  document.querySelectorAll('.vtype-card,.wizard-step').forEach(c=>c.classList.remove('selected','active'));
  document.getElementById('wizard-step-1').classList.add('active');
  document.getElementById('stype-msg').style.display='none';
  document.getElementById('vtype-msg').style.display='none';
  document.getElementById('wz-next0').disabled=true;
  document.getElementById('wz-next1').disabled=true;
  ['wz-claim-no','wz-policy-no','wz-reg-no','wz-insurer','wz-report-no','wz-doa'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  showPage('new-claim');
}

function selectSurveyType(type) {
  newSType=type;
  document.querySelectorAll('#wz-st-spot,#wz-st-final').forEach(c=>c.style.borderColor='transparent');
  document.getElementById('wz-st-'+type).style.borderColor='var(--teal)';
  document.getElementById('stype-msg').style.display='flex';
  document.getElementById('stype-msg-text').textContent = type==='spot' ? 'Spot Survey ‚Äî accident scene inspection. Spot Report + Fee Bill.' : 'Final Survey ‚Äî full workshop assessment. All 5 reports available.';
  document.getElementById('wz-next0').disabled=false;
}

function wizardStep1b() {
  document.getElementById('wizard-step-1').classList.remove('active');
  document.getElementById('wizard-step-1b').classList.add('active');
}

function wizardBackTo(step) {
  document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('active'));
  document.getElementById('wizard-step-'+step).classList.add('active');
}
function selectVehicleType(type) {
  newVType=type;
  document.querySelectorAll('.vtype-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('vt-'+type).classList.add('selected');
  const N={private:'Private Vehicle','comm-pass':'Commercial Passenger Vehicle','comm-goods':'Commercial Goods Vehicle'};
  const D={private:'5','comm-pass':'9','comm-goods':'10'};
  document.getElementById('vtype-msg').style.display='flex';
  document.getElementById('vtype-msg-text').textContent=`${N[type]} selected ‚Äî ${D[type]} document slots prepared.`;
  document.getElementById('wz-next1').disabled=false;
}
function wizardStep2() {
  document.getElementById('wizard-step-1b').classList.remove('active');
  document.getElementById('wizard-step-2').classList.add('active');
  const yr=new Date().getFullYear();
  const prefix = newSType==='spot' ? 'SPO' : 'SUR';
  document.getElementById('wz-report-no').value=`${prefix}/${Math.floor(Math.random()*900+100)}/${yr}-${String(yr+1).slice(-2)}`;
}
// wizardBack replaced by wizardBackTo
async function createClaim() {
  surveyType = newSType||'final';
  vehicleType = newVType||'private';
  depType='nil';
  uploadedDocs={}; extractedData={}; assessRows=[]; spotDamageRows=[]; riParts=[];
  const PROFILE_KEYS=['sp-name','sp-qual','sp-lic','sp-lic-exp','sp-iiisla','sp-code','sp-categories','sp-mobile','sp-email','sp-addr','sp-gst','bank-name','bank-ac','bank-ifsc','bank-pan','sp-groq-key','sp-groq-model'];
  ALL_FIELD_IDS.forEach(id=>{const el=document.getElementById(id);if(el&&!PROFILE_KEYS.includes(id))el.value='';});
  document.querySelectorAll('.form-input,.form-select,.form-textarea').forEach(e=>e.classList.remove('ai-filled'));
  setV('f-claim-no',gv('wz-claim-no')); setV('f-policy-no',gv('wz-policy-no'));
  setV('f-reg-no',gv('wz-reg-no').toUpperCase()); setV('f-insurer',gv('wz-insurer'));
  setV('f-report-no',gv('wz-report-no')); setV('spot-report-no',gv('wz-report-no'));
  if(gv('wz-doa')) setV('f-doa',gv('wz-doa'));
  const today=new Date().toISOString().split('T')[0];
  setV('f-report-date',today); setV('f-survey-date',today);
  setV('spot-report-date',today); setV('spot-allot-date',today);
  setV('sum-excess','500'); setV('sum-salvage','0');
  const isFinal = surveyType==='final';
  setV('fee-prof', isFinal?'3500':'1500');
  setV('fee-ri','0'); setV('fee-travel', isFinal?'500':'250');
  setV('fee-photos-count', isFinal?'20':'10'); setV('fee-photo-rate','10');
  setV('fee-postal','50'); setV('fee-haltage','0');
  currentClaimId='claim_'+Date.now();
  applyVehicleTypeUI(); buildDocSlots(); updateWorkspaceHeader(); showSidebarClaim();
  const claimData = getCurrentClaimData();
  const claims=loadClaims();
  claims.push(claimData);
  saveClaims(claims);
  openWorkspace('docs');
  showToast('Claim created ('+(surveyType==='spot'?'Spot Survey':'Final Survey')+') ‚Äî upload documents','success');
  // Wire up Google Drive folder for this claim (non-blocking)
  if (gDriveToken) {
    try {
      const folder = await createClaimFolder(currentClaimId, surveyType, gv('wz-reg-no'));
      if (folder) {
        gDriveFolderId = folder.id;
        // Save folderId into the claim
        const claims2 = loadClaims();
        const idx2 = claims2.findIndex(c => c.id === currentClaimId);
        if (idx2 >= 0) { claims2[idx2].gDriveFolderId = folder.id; saveClaims(claims2); }
        // Update index file
        const index = await loadDriveIndex();
        index[currentClaimId] = { folderId: folder.id, folderName: folder.name };
        await saveDriveIndex(index);
        showToast('Drive folder created: ' + folder.name, 'success');
        updateWorkspaceHeader();
      }
    } catch(e) { console.warn('Drive setup for new claim:', e); }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VEHICLE TYPE UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyVehicleTypeUI() {
  const isComm = vehicleType!=='private', isGoods = vehicleType==='comm-goods';
  document.getElementById('spot-comm-section').style.display = isComm?'block':'none';
  const gcs = document.getElementById('spot-goods-card'); if(gcs) gcs.style.display = isGoods?'block':'none';
  ['grp-fitness','grp-route'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display=isComm?'flex':'none';});
  ['nil','standard','zero'].forEach(d=>document.getElementById('dep-'+d).classList.toggle('active',d===depType));
}

function updateWorkspaceHeader() {
  const veh=gv('f-reg-no')||'New Claim', ins=gv('f-insured-name')||gv('f-claim-no')||'‚Äî';
  document.getElementById('ws-veh-title').textContent=veh;
  document.getElementById('ws-insured-title').textContent=ins+(gv('f-make')?` ‚Äî ${gv('f-make')} ${gv('f-model')}`:'');
  document.getElementById('sb-veh').textContent=veh;
  document.getElementById('sb-insured').textContent=ins;
  const SM={new:'badge-grey','docs-pending':'badge-amber','in-progress':'badge-blue','assessment-done':'badge-teal',submitted:'badge-green'};
  const SL={new:'New','docs-pending':'Docs Pending','in-progress':'In Progress','assessment-done':'Ready',submitted:'Submitted'};
  const VL={private:'üöó Private','comm-pass':'üöå Passenger','comm-goods':'üöõ Goods'};
  const s=computeStatus();
  document.getElementById('ws-status-bar').innerHTML=`<span class="badge ${SM[s]||'badge-grey'}">${SL[s]||'New'}</span><span class="badge badge-grey" style="margin-left:6px">${VL[vehicleType]||''}</span>`;
  const stbadge=document.getElementById('ws-survey-type-badge');
  if(stbadge) stbadge.innerHTML=`<span class="badge ${surveyType==='spot'?'badge-spot':'badge-final'}" style="margin-left:6px">${surveyType==='spot'?'üìç Spot':'üîß Final'}</span>`;
  const drivebtn=document.getElementById('ws-drive-folder-btn');
  if(drivebtn) drivebtn.style.display=gDriveFolderId?'inline-flex':'none';
}

function showSidebarClaim() {
  const sec=document.getElementById('sidebar-claim-section'); if(sec)sec.style.display='block';
}
function hideSidebarClaim() {
  const sec=document.getElementById('sidebar-claim-section'); if(sec)sec.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCUMENT SLOTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDocSlots() {
  const slotDefs = surveyType==='spot' ? (DOC_SLOTS_SPOT[vehicleType]||DOC_SLOTS_SPOT.private) : (DOC_SLOTS[vehicleType]||DOC_SLOTS.private);
  document.getElementById('doc-slots-container').innerHTML = slotDefs.map(s=>`
    <div class="doc-slot${s.optional?' optional':''}" id="slot-${s.key}" style="${s.optional?'opacity:0.75;':''}">
      <input type="file" id="file-${s.key}" accept=".jpg,.jpeg,.png,.webp,.pdf" ${s.multiple?'multiple':''} onchange="handleFile(this,'${s.key}')" style="position:absolute;inset:0;opacity:0;cursor:pointer"/>
      <div class="doc-tick">‚úì</div>
      ${s.optional?'<div style="position:absolute;top:6px;left:8px;font-size:9px;color:var(--muted2);font-weight:600">OPTIONAL</div>':''}
      <div class="doc-slot-icon">${s.icon}</div>
      <div class="doc-slot-name">${s.label}</div>
      <div class="doc-slot-hint">${s.hint}</div>
      <div class="doc-slot-status" id="slot-status-${s.key}">Click to upload</div>
    </div>`).join('');
}

function handleFile(input, key) {
  const files=Array.from(input.files); if(!files.length) return;
  uploadedDocs[key] = (key==='photos'||key==='estimate') ? files : files[0];
  const slot=document.getElementById('slot-'+key), st=document.getElementById('slot-status-'+key);
  slot.classList.add('has-file');
  st.textContent = key==='photos' ? `${files.length} photo${files.length>1?'s':''} ready` : files[0].name.substring(0,22)+'‚Ä¶';
  showToast(`${key.toUpperCase()} uploaded`,'success');
  // Upload file to Drive in background
  if (gDriveToken && gDriveFolderId) {
    const filesToUpload = Array.isArray(uploadedDocs[key]) ? uploadedDocs[key] : [uploadedDocs[key]];
    for (const f of filesToUpload) {
      f.arrayBuffer().then(buf => {
        driveUploadFile(key+'_'+f.name, new Blob([buf], {type:f.type}), gDriveFolderId)
          .then(()=>{ const slot=document.getElementById('slot-'+key); if(slot) slot.classList.add('drive-synced'); })
          .catch(e=>console.warn('Drive doc upload:', e));
      });
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ PDF.js setup ‚îÄ‚îÄ‚îÄ
function setupPDFjs() {
  if(typeof pdfjsLib!=='undefined') pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

async function fileToB64(file) {
  return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file);});
}

// Convert file to array of base64 images (handles PDF multi-page)
async function fileToImages(file, onProgress) {
  if(file.type==='application/pdf' && typeof pdfjsLib!=='undefined') {
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    const imgs=[];
    for(let i=1;i<=pdf.numPages;i++){
      if(onProgress) onProgress(i,pdf.numPages);
      const page=await pdf.getPage(i);
      const vp=page.getViewport({scale:2.0});
      const canvas=document.createElement('canvas');
      canvas.width=vp.width; canvas.height=vp.height;
      await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;
      imgs.push(canvas.toDataURL('image/png').split(',')[1]);
    }
    return imgs;
  }
  return [await fileToB64(file)];
}

async function callGroq(parts, maxTokens=4000) {
  const key=localStorage.getItem('groq_api_key')||(document.getElementById('sp-groq-key')||{}).value||'';
  if(!key) throw new Error('No Groq API key configured ‚Äî go to Surveyor Profile');
  const model=localStorage.getItem('groq_model')||'meta-llama/llama-4-scout-17b-16e-instruct';
  const content=[];
  for(const p of parts) {
    if(p.inlineData) content.push({type:'image_url',image_url:{url:`data:${p.inlineData.mimeType};base64,${p.inlineData.data}`}});
    else if(p.text) content.push({type:'text',text:p.text});
  }
  const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model,max_tokens:maxTokens,temperature:0.1,messages:[{role:'user',content}]})});
  if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(`Groq ${r.status}: ${e.error?.message||r.statusText}`);}
  const d=await r.json(); return d.choices?.[0]?.message?.content||'';
}

// Process images in chunks of 5 (API limit) and merge results
async function processInChunks(images, prompt, maxTokens, key) {
  const CHUNK=5;
  const chunks=[];
  for(let i=0;i<images.length;i+=CHUNK) chunks.push(images.slice(i,i+CHUNK));
  const results=[];
  const bar=document.getElementById('chunk-bar'), barText=document.getElementById('chunk-bar-text');
  if(bar) bar.style.display='block';
  for(let ci=0;ci<chunks.length;ci++) {
    const from=ci*CHUNK+1, to=Math.min((ci+1)*CHUNK,images.length);
    if(barText) barText.textContent=`${key.toUpperCase()} ‚Äî pages ${from}‚Äì${to} of ${images.length} (chunk ${ci+1}/${chunks.length})`;
    const st=document.getElementById('slot-status-'+key);
    if(st) st.textContent=`Pages ${from}‚Äì${to}/${images.length}‚Ä¶`;
    const parts=chunks[ci].map(b64=>({inlineData:{mimeType:'image/png',data:b64}}));
    parts.push({text:prompt});
    try {
      const raw=await callGroq(parts,maxTokens);
      const parsed=JSON.parse(raw.replace(/```json|```/g,'').trim());
      results.push(parsed);
    } catch(e) { console.warn('Chunk',ci,'failed:',e.message); }
  }
  if(bar) bar.style.display='none';
  return mergeChunkResults(results);
}

function mergeChunkResults(results) {
  const merged={};
  for(const result of results) {
    if(!result||typeof result!=='object') continue;
    for(const [k,v] of Object.entries(result)) {
      if(Array.isArray(v)) {
        if(!merged[k]) merged[k]=[];
        for(const item of v) {
          const key=(item.description||item.part||item.particulars||JSON.stringify(item)).toLowerCase();
          if(!merged[k].some(e=>(e.description||e.part||e.particulars||JSON.stringify(e)).toLowerCase()===key)) merged[k].push(item);
        }
      } else if(v!==null&&v!==undefined&&v!==''&&!merged[k]) {
        merged[k]=v;
      }
    }
  }
  return merged;
}

async function extractDoc(key, file) {
  const slot=document.getElementById('slot-'+key), st=document.getElementById('slot-status-'+key);
  if(slot) slot.className='doc-slot processing';
  if(st) st.textContent='Converting‚Ä¶';
  try {
    const images=await fileToImages(file,(pg,total)=>{if(st)st.textContent=`Page ${pg}/${total}‚Ä¶`;});
    if(st) st.textContent=`Extracting (${images.length} page${images.length>1?'s':''})‚Ä¶`;
    const prompt=DOC_PROMPTS[key]||'Extract all text fields as JSON.';
    let data;
    if(images.length<=5) {
      const parts=images.map(b64=>({inlineData:{mimeType:'image/png',data:b64}}));
      parts.push({text:prompt});
      const raw=await callGroq(parts,4000);
      data=JSON.parse(raw.replace(/```json|```/g,'').trim());
    } else {
      data=await processInChunks(images,prompt,4000,key);
    }
    extractedData[key]=data;
    if(slot) slot.className='doc-slot done';
    if(st) st.textContent='‚úì Extracted';
    return {key,data,ok:true};
  } catch(err) {
    if(slot) slot.className='doc-slot error';
    if(st) st.textContent='‚úó '+err.message.substring(0,30);
    return {key,err:err.message,ok:false};
  }
}

async function extractPhotos(photos) {
  const slot=document.getElementById('slot-photos'), st=document.getElementById('slot-status-photos');
  if(slot)slot.className='doc-slot processing'; if(st)st.textContent=`Analyzing ${photos.length} photos‚Ä¶`;
  try {
    const parts=[];
    for(const ph of photos.slice(0,8)){if(!ph.type.startsWith('image/'))continue;const b64=await fileToB64(ph);parts.push({inlineData:{mimeType:'image/jpeg',data:b64}});}
    parts.push({text:DOC_PROMPTS.photos});
    const raw=await callGroq(parts,3000);
    const data=JSON.parse(raw.replace(/```json|```/g,'').trim());
    extractedData.photos=data;
    if(slot)slot.className='doc-slot done'; if(st)st.textContent=`‚úì ${data.damaged_parts?.length||0} parts`;
    return {key:'photos',data,ok:true};
  } catch(err) {
    if(slot)slot.className='doc-slot error'; if(st)st.textContent='‚úó '+err.message;
    return {key:'photos',err:err.message,ok:false};
  }
}

async function processAllDocs() {
  const keys=Object.keys(uploadedDocs);
  if(!keys.length){showToast('Upload at least one document first','error');return;}
  const apiKey=localStorage.getItem('groq_api_key')||(document.getElementById('sp-groq-key')||{}).value||'';
  if(!apiKey){showToast('No API key ‚Äî add your Groq API key in Surveyor Profile','error');return;}
  const btn=document.getElementById('process-all-btn'), st=document.getElementById('process-status');
  btn.disabled=true; btn.textContent='‚ö° Processing‚Ä¶';
  document.getElementById('ai-status-bar').style.display='flex';
  document.getElementById('ai-status-text').textContent=`Processing ${keys.length} document${keys.length>1?'s':''}‚Ä¶`;
  const tasks=[];
  for(const k of keys){
    if(k==='photos')continue;
    const f=uploadedDocs[k]; const file=Array.isArray(f)?f[0]:f;
    if(file)tasks.push(extractDoc(k,file));
  }
  if(uploadedDocs.photos?.length) tasks.push(extractPhotos(uploadedDocs.photos));
  st.textContent=`Running ${tasks.length} AI extractions in parallel‚Ä¶`;
  const results=await Promise.allSettled(tasks);
  const ok=results.filter(r=>r.status==='fulfilled'&&r.value?.ok).length;
  for(const k of Object.keys(extractedData)) applyExtractedData(k,extractedData[k]);
  buildAIReview(); updateWorkspaceHeader();
  btn.disabled=false; btn.innerHTML='‚ö° Process All with AI';
  document.getElementById('ai-status-bar').style.display='none';
  const msg=`Extracted from ${ok} document${ok!==1?'s':''}${tasks.length-ok?' ('+( tasks.length-ok)+' failed)':''}`;
  st.textContent=msg; showToast(msg,ok>0?'success':'error');
  if(ok>0)switchTab('review');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPLY EXTRACTED DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyExtractedData(type, data) {
  function sf(id,val) {
    if(!val) return; const el=document.getElementById(id); if(!el) return;
    const s=String(val).trim(); if(!s||s==='null'||s==='undefined') return;
    el.value=s; el.classList.add('ai-filled');
  }
  function td(v) {
    if(!v) return '';
    const m=String(v).match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})/);
    if(m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; return v;
  }
  if(type==='rc'){
    sf('f-reg-no',data.registration_number); sf('f-make',data.make); sf('f-model',data.model);
    sf('f-chassis',data.chassis_number); sf('f-engine',data.engine_number); sf('f-cc',data.cubic_capacity);
    sf('f-colour',data.colour); sf('f-body-type',data.body_type); sf('f-veh-class',data.class_of_vehicle);
    sf('f-hpa',data.hypothecation); sf('f-insured-name',data.owner_name); sf('f-insured-addr',data.address);
    sf('f-fitness',data.fitness_cert_no); sf('f-route',data.route);
    if(data.year_of_manufacture) sf('f-year',data.year_of_manufacture);
    if(data.fuel){const fe=document.getElementById('f-fuel');if(fe){const o=[...fe.options].find(o=>o.text.toLowerCase().includes((data.fuel||'').toLowerCase()));if(o){fe.value=o.value;}}}
    if(data.date_of_registration) sf('f-reg-date',td(data.date_of_registration));
    if(data.gross_weight){sf('spot-gvw',String(Math.round(parseFloat(data.gross_weight)||0)));sf('f-rlw',String(Math.round(parseFloat(data.gross_weight)||0)));}
    if(data.unladen_weight) sf('spot-ulw',String(Math.round(parseFloat(data.unladen_weight)||0)));
    if(data.gross_weight&&data.unladen_weight){const cap=Math.round((parseFloat(data.gross_weight)||0)-(parseFloat(data.unladen_weight)||0));if(cap>0)sf('spot-load-capacity',String(cap));}
  }
  if(type==='dl'){
    sf('f-driver-name',data.holder_name); sf('f-dl-parent',data.father_or_husband_name);
    if(data.relation_type){const e=document.getElementById('f-dl-relation');if(e)e.value=data.relation_type;}
    sf('f-mdl',data.licence_number); sf('f-dl-auth',data.issuing_authority||data.rto); sf('f-dl-type',data.vehicle_classes);
    if(data.validity_non_transport) sf('f-dl-valid',td(data.validity_non_transport));
    if(data.validity_transport) sf('f-dl-valid-transport',td(data.validity_transport));
    if(data.date_of_birth) sf('f-dob',td(data.date_of_birth));
    if(data.date_of_issue) sf('f-dl-issue',td(data.date_of_issue));
    sf('spot-driver-name',data.holder_name); sf('spot-dl-parent',data.father_or_husband_name);
    sf('spot-mdl-no',data.licence_number); sf('spot-dl-authority',data.issuing_authority||data.rto);
    sf('spot-dl-type',data.vehicle_classes);
    if(data.validity_non_transport) sf('spot-dl-valid',td(data.validity_non_transport));
    if(data.validity_transport) sf('spot-dl-valid-transport',td(data.validity_transport));
    if(data.date_of_issue) sf('spot-dl-issue',td(data.date_of_issue));
    if(data.relation_type){const e=document.getElementById('spot-dl-relation');if(e)e.value=data.relation_type;}
  }
  if(type==='policy'){
    sf('f-policy-no',data.policy_number);
    sf('f-insurer',data.insurer_name&&data.insurer_address?data.insurer_name+' '+data.insurer_address:data.insurer_name);
    sf('f-insured-name',data.insured_name); sf('f-insured-addr',data.insured_address);
    sf('f-insured-mobile',data.insured_mobile); sf('f-idv',data.idv);
    sf('f-policy-office',data.policy_issuing_office); sf('f-appt-office',data.appointing_office);
    sf('f-hpa',data.hpa_with); sf('f-reg-no',data.registration_number);
    sf('f-chassis',data.chassis_number); sf('f-engine',data.engine_number);
    if(data.period_from) sf('f-policy-from',td(data.period_from));
    if(data.period_to) sf('f-policy-to',td(data.period_to));
    if(data.policy_type){const s=document.getElementById('f-policy-type');if(s){const o=[...s.options].find(o=>o.text.toLowerCase().includes((data.policy_type||'').toLowerCase().substring(0,6)));if(o)s.value=o.value;}}
  }
  if(type==='claim'){
    sf('f-claim-no',data.claim_number); sf('f-policy-no',data.policy_number);
    sf('f-insured-name',data.insured_name); sf('f-poa',data.place_of_accident);
    sf('f-cause',data.cause_of_accident); sf('f-driver-name',data.driver_name);
    sf('f-mdl',data.driver_licence_no); sf('f-tp',data.third_party_details);
    sf('f-survey-place',data.workshop_name||data.place_of_repair);
    if(data.vehicle_number) sf('f-reg-no',data.vehicle_number);
    if(data.date_of_accident){const dt=td(data.date_of_accident),ti=(data.time_of_accident||'00:00').substring(0,5);sf('f-doa',dt+'T'+ti);}
    sf('spot-accident-place',data.place_of_accident); sf('spot-accident-cause',data.cause_of_accident);
    sf('spot-driver-name',data.driver_name); sf('spot-mdl-no',data.driver_licence_no);
    sf('spot-survey-place',data.workshop_name||data.place_of_repair); sf('spot-tp-details',data.third_party_details);
    if(data.date_of_accident){const dt=td(data.date_of_accident),ti=(data.time_of_accident||'00:00').substring(0,5);sf('spot-accident-datetime',dt+'T'+ti);}
    if(data.third_party_details&&data.third_party_details.toLowerCase()!=='nil'&&data.third_party_details.trim()){
      const ts=document.getElementById('spot-tp-involved');
      if(ts){const s=(data.third_party_details||'').toLowerCase();ts.value=(s.includes('injur')||s.includes('death'))&&(s.includes('damage')||s.includes('property'))?'both':s.includes('injur')||s.includes('death')?'tppi':'tppd';}
    }
    const today=new Date().toISOString().split('T')[0];
    ['spot-report-date','spot-allot-date'].forEach(id=>{const e=document.getElementById(id);if(e&&!e.value){e.value=today;e.classList.add('ai-filled');}});
  }
  if(type==='estimate'){
    sf('f-survey-place',data.workshop_name); sf('spot-survey-place',data.workshop_name);
    if(data.spare_parts?.length) data.spare_parts.forEach(p=>{
      if(!p.description)return;
      const cat=(p.category||'').toLowerCase();
      const pt=cat.includes('glass')?'glass':cat.includes('plastic')||cat.includes('rubber')?'plastic':'metal';
      assessRows.push({particulars:p.description,estimated:parseFloat(p.amount)||0,assessed:parseFloat(p.amount)||0,partType:pt,gst:parseInt(p.gst_percent)||18,section:'parts'});
    });
    if(data.labour_items?.length) data.labour_items.forEach(i=>{if(!i.description)return;assessRows.push({particulars:i.description,estimated:parseFloat(i.amount)||0,assessed:parseFloat(i.amount)||0,partType:'labour',gst:18,section:'labour'});});
    if(data.painting_items?.length) data.painting_items.forEach(i=>{if(!i.description)return;assessRows.push({particulars:i.description,estimated:parseFloat(i.amount)||0,assessed:parseFloat(i.amount)||0,partType:'paint',gst:18,section:'paint'});});
    renderAssessTable();
  }
  if(type==='photos'){
    if(data.overall_damage_summary){sf('spot-comments',data.overall_damage_summary);}
    if(data.damaged_parts?.length){
      const sevEl=document.getElementById('spot-damage-severity');
      if(sevEl){const sArr=data.damaged_parts.map(p=>(p.severity||'').toLowerCase());sevEl.value=sArr.some(s=>s.includes('major'))?'major':sArr.some(s=>s.includes('moderate'))?'moderate':'minor';}
      if(!spotDamageRows.length){
        const CM={'bumper':'BODY PANELS','bonnet':'BODY PANELS','hood':'BODY PANELS','fender':'BODY PANELS','door':'BODY PANELS','panel':'BODY PANELS','windshield':'WINDSHIELD & GLASS','windscreen':'WINDSHIELD & GLASS','glass':'WINDSHIELD & GLASS','window':'WINDSHIELD & GLASS','headlight':'ELECTRICAL SYSTEM','taillight':'ELECTRICAL SYSTEM','light':'ELECTRICAL SYSTEM','tyre':'WHEEL DISCS & TYRES','wheel':'WHEEL DISCS & TYRES','rim':'WHEEL DISCS & TYRES','engine':'ENGINE & TRANSMISSION','radiator':'COOLING SYSTEM','suspension':'FRONT SUSPENSION','chassis':'CHASSIS ASSY','axle':'FRONT AXLE ASSY','brake':'BRAKING SYSTEM','steering':'STEERING SYSTEM','airbag':'INTERIOR','dashboard':'INTERIOR','cabin':'FRONT END STRUCTURE / DRIVERS CABIN','roof':'BODY PANELS'};
        data.damaged_parts.forEach(p=>{const n=(p.part||'').toLowerCase();let c='BODY PANELS';for(const[k,v]of Object.entries(CM)){if(n.includes(k)){c=v;break;}}const side=p.side?`(${p.side}) `:'';addSpotDamageRow(c,`${side}${p.damage_type||'Damaged'}. Severity: ${p.severity||'Moderate'}.`);});
      }
    }
  }
  if(type==='permit'){sf('spot-permit-no',data.permit_no);sf('spot-permit-type',data.permit_type);sf('f-route',data.route||data.permit_type);if(data.validity_from)sf('spot-permit-from',td(data.validity_from));if(data.validity_to)sf('spot-permit-to',td(data.validity_to));if(data.gross_vehicle_weight_kg)sf('spot-gvw',String(Math.round(parseFloat(data.gross_vehicle_weight_kg)||0)));if(data.unladen_weight_kg)sf('spot-ulw',String(Math.round(parseFloat(data.unladen_weight_kg)||0)));}
  if(type==='auth'){sf('spot-auth-no',data.auth_no);if(data.validity_to)sf('spot-auth-valid',td(data.validity_to));}
  if(type==='fitness'){sf('spot-fitness-no',data.fitness_cert_no);sf('f-fitness',data.fitness_cert_no);if(data.validity_to)sf('spot-fitness-valid',td(data.validity_to));if(data.gross_vehicle_weight_kg)sf('spot-gvw',String(Math.round(parseFloat(data.gross_vehicle_weight_kg)||0)));if(data.unladen_weight_kg)sf('spot-ulw',String(Math.round(parseFloat(data.unladen_weight_kg)||0)));}
  if(type==='lok-challan'){sf('spot-cn-no',data.challan_no);if(data.challan_date)sf('spot-cn-date',td(data.challan_date));sf('spot-load-origin',data.origin);sf('spot-load-dest',data.destination);sf('spot-load-desc',data.goods_description);sf('spot-actual-load',data.weight_kg);autoCalcLoad();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI REVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildAIReview() {
  const keys=Object.keys(extractedData);
  if(!keys.length) return;
  document.getElementById('review-empty-msg').style.display='none';
  document.getElementById('ai-review-content').style.display='block';
  const defs = {
    rc:{title:'RC ‚Äî Vehicle',fields:[['Reg No','f-reg-no'],['Make','f-make'],['Model','f-model'],['Year','f-year'],['Chassis','f-chassis'],['Engine','f-engine'],['Colour','f-colour'],['Fuel','f-fuel'],['Class','f-veh-class'],['Reg Date','f-reg-date'],['GVW (kg)','spot-gvw'],['ULW (kg)','spot-ulw']]},
    dl:{title:'Driving Licence',fields:[['Name','f-driver-name'],['DL No','f-mdl'],['DOB','f-dob'],['Issue Date','f-dl-issue'],['NT Valid','f-dl-valid'],['T Valid','f-dl-valid-transport'],['Auth','f-dl-auth'],['Classes','f-dl-type']]},
    policy:{title:'Insurance Policy',fields:[['Policy No','f-policy-no'],['Insurer','f-insurer'],['IDV','f-idv'],['From','f-policy-from'],['To','f-policy-to'],['Type','f-policy-type']]},
    claim:{title:'Claim Form',fields:[['Claim No','f-claim-no'],['Insured','f-insured-name'],['Date/Time','f-doa'],['Place','f-poa'],['Driver','f-driver-name'],['Workshop','f-survey-place']]},
    permit:{title:'Permit',fields:[['Permit No','spot-permit-no'],['Type','spot-permit-type'],['From','spot-permit-from'],['To','spot-permit-to']]},
    fitness:{title:'Fitness Certificate',fields:[['Cert No','spot-fitness-no'],['Valid To','spot-fitness-valid']]},
    auth:{title:'Authorisation',fields:[['Auth No','spot-auth-no'],['Valid To','spot-auth-valid']]},
    'lok-challan':{title:'Lok Challan',fields:[['Challan No','spot-cn-no'],['Origin','spot-load-origin'],['Dest','spot-load-dest'],['Goods','spot-load-desc'],['Weight (kg)','spot-actual-load']]}
  };
  const grid=document.getElementById('review-grid'); grid.innerHTML='';
  let totalFilled=0;
  keys.filter(k=>k!=='photos').forEach(k=>{
    const def=defs[k]; if(!def) return;
    const filled=def.fields.filter(([,id])=>{const e=document.getElementById(id);return e&&e.value;}).length;
    totalFilled+=filled;
    const sec=document.createElement('div'); sec.className='review-section';
    sec.innerHTML=`<div class="review-sec-header"><span class="review-sec-title">${def.title}</span><span class="review-sec-badge">${filled} fields</span></div>`+
      def.fields.map(([label,id])=>{
        const el=document.getElementById(id); const val=el?el.value:''; const isAI=el&&el.classList.contains('ai-filled');
        return `<div class="review-field"><div class="review-label">${label}</div><div><input class="review-val-input ${isAI?'ai-filled':''}" value="${val.replace(/"/g,'&quot;')}" onchange="syncField('${id}',this.value);this.classList.remove('ai-filled')"/></div></div>`;
      }).join('');
    grid.appendChild(sec);
  });
  if(extractedData.photos){
    const d=extractedData.photos; const sec=document.createElement('div'); sec.className='review-section';
    sec.innerHTML=`<div class="review-sec-header"><span class="review-sec-title">üì∑ Photo Analysis</span><span class="review-sec-badge">${d.damaged_parts?.length||0} parts</span></div><div style="padding:12px;font-size:12px;line-height:1.7">`+
      (d.damaged_parts||[]).map(p=>`<div style="padding:4px 8px;border-radius:4px;margin-bottom:3px;background:var(--surface);display:flex;gap:8px;align-items:center"><span style="width:7px;height:7px;border-radius:50%;background:${p.severity==='Major'?'var(--red)':p.severity==='Moderate'?'var(--amber)':'var(--green)'};flex-shrink:0;display:inline-block"></span><b>${p.part}</b><span style="color:var(--muted)">${p.damage_type} ‚Äî ${p.severity}</span><span style="margin-left:auto;color:var(--teal);font-weight:600">‚Çπ${(p.estimated_cost||0).toLocaleString('en-IN')}</span></div>`).join('')+
      `<div style="margin-top:8px;font-size:11px;color:var(--muted)">${d.overall_damage_summary||''}</div></div>`;
    grid.appendChild(sec);
  }
  document.getElementById('review-summary-msg').textContent=`AI extracted ${totalFilled} fields from ${keys.length} document${keys.length!==1?'s':''}. Amber fields = AI filled ‚Äî click to edit.`;
}

function syncField(id, val) { const e=document.getElementById(id); if(e) e.value=val; }
function applyAndProceed() { updateWorkspaceHeader(); switchTab('details'); showToast('All fields applied ‚Äî complete Claim Details','success'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ASSESSMENT ENGINE (preserved verbatim logic)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setDep(type) {
  depType=type;
  ['nil','standard','zero'].forEach(d=>document.getElementById('dep-'+d).classList.toggle('active',d===type));
  renderAssessTable();
}
function getVehicleAgeMonths() {
  const rs=gv('f-reg-date'),my=parseInt(gv('f-year'));
  let start=rs?new Date(rs):(my?new Date(my,0,1):null);
  if(!start)return 0;
  const ref=gv('f-doa')?new Date(gv('f-doa')):new Date();
  if(isNaN(start.getTime())||isNaN(ref.getTime())||ref<start)return 0;
  return (ref.getFullYear()-start.getFullYear())*12+ref.getMonth()-start.getMonth();
}
function getDepRate(pt) {
  if(depType==='nil'||depType==='zero')return 0;
  if(pt==='glass')return 0; if(pt==='plastic')return 50; if(pt==='labour'||pt==='paint')return 0;
  const a=getVehicleAgeMonths();
  if(a<=6)return 0;if(a<=12)return 5;if(a<=24)return 10;if(a<=36)return 15;if(a<=48)return 25;if(a<=60)return 35;if(a<=120)return 40;return 50;
}
function addAssessRow(section) {
  assessRows.push({particulars:'',estimated:0,assessed:0,partType:section==='labour'?'labour':section==='paint'?'paint':'metal',gst:18,section});
  renderAssessTable();
}
function deleteRow(idx){assessRows.splice(idx,1);renderAssessTable();}
function toggleAllowed(idx){assessRows[idx].allowed=assessRows[idx].allowed===false?true:false;renderAssessTable();}
function renderAssessTable() {
  const tb=document.getElementById('assess-tbody'); tb.innerHTML='';
  const secs=[{key:'parts',label:'SPARE PARTS'},{key:'labour',label:'LABOUR CHARGES'},{key:'paint',label:'PAINTING CHARGES'}];
  const pto=`<option value="metal">Metal</option><option value="plastic">Plastic/Rubber</option><option value="glass">Glass</option><option value="labour">Labour</option><option value="paint">Paint</option>`;
  secs.forEach(sec=>{
    const rows=assessRows.map((r,i)=>({...r,oi:i})).filter(r=>r.section===sec.key);
    if(!rows.length)return;
    const hr=tb.insertRow(); hr.className='sr'; hr.innerHTML=`<td colspan="10">${sec.label}</td>`;
    let sn=1;
    rows.forEach(row=>{
      const i=row.oi; if(assessRows[i].allowed===undefined)assessRows[i].allowed=true;
      const al=assessRows[i].allowed, dep=getDepRate(row.partType), ad=al?row.assessed*(1-dep/100):0;
      const tr=tb.insertRow(); tr.style.opacity=al?'1':'0.45';
      tr.innerHTML=`<td class="mono" style="color:var(--muted2);font-size:11px">${sn++}</td>
        <td><input class="text-input-cell" value="${row.particulars.replace(/"/g,'&quot;')}" onchange="assessRows[${i}].particulars=this.value"/></td>
        <td><select class="text-input-cell" style="font-size:11px" onchange="assessRows[${i}].partType=this.value;renderAssessTable()">${pto.replace(`value="${row.partType}"`,`value="${row.partType}" selected`)}</select></td>
        <td class="text-center"><input class="num-input" style="width:38px;text-align:center" value="${row.gst}" onchange="assessRows[${i}].gst=parseInt(this.value)||18;recalcSummary()"/>%</td>
        <td class="text-right"><input class="num-input" value="${row.estimated.toFixed(2)}" onchange="assessRows[${i}].estimated=parseFloat(this.value)||0;recalcSummary()"/></td>
        <td class="text-right"><input class="num-input" style="background:${al?'#f0fdf8':'#fef2f2'}" value="${row.assessed.toFixed(2)}" onchange="assessRows[${i}].assessed=parseFloat(this.value)||0;renderAssessTable()"/></td>
        <td class="text-center mono" style="font-size:11px;color:${dep>0?'var(--amber)':'var(--muted2)'}">${dep}%</td>
        <td class="text-right mono" style="font-weight:700;color:${al?'var(--teal)':'var(--red)'};font-size:12px">${al?'‚Çπ'+ad.toFixed(2):'DISALLOWED'}</td>
        <td class="text-center"><button onclick="toggleAllowed(${i})" style="font-size:10px;padding:2px 7px;border-radius:4px;border:none;cursor:pointer;font-weight:700;background:${al?'var(--green-bg)':'var(--red-bg)'};color:${al?'var(--green)':'var(--red)'}">${al?'‚úì':'‚úó'}</button></td>
        <td class="text-center"><button class="btn btn-danger btn-sm" style="padding:2px 6px;font-size:10px" onclick="deleteRow(${i})">‚úï</button></td>`;
    });
    const sub=rows.map(r=>assessRows[r.oi]).reduce((s,r)=>s+(r.allowed!==false?r.assessed*(1-getDepRate(r.partType)/100):0),0);
    const str=tb.insertRow(); str.className='subt';
    str.innerHTML=`<td colspan="7" style="text-align:right;font-size:11px">Sub-Total ${sec.label}</td><td colspan="2" class="text-right mono">‚Çπ${sub.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',')}</td><td></td>`;
  });
  recalcSummary();
}
function recalcSummary() {
  let metal=0,plastic=0,glass=0,labBase=0;
  assessRows.filter(r=>r.section==='parts').forEach(r=>{if(r.allowed===false)return;const dep=getDepRate(r.partType),ad=r.assessed*(1-dep/100);if(r.partType==='metal')metal+=ad;else if(r.partType==='glass')glass+=ad;else plastic+=ad;});
  assessRows.filter(r=>r.section==='labour'||r.section==='paint').forEach(r=>{if(r.allowed!==false)labBase+=r.assessed;});
  const pb=metal+plastic+glass,pGST=pb*0.09,pT=pb+pGST*2,lGST=labBase*0.18,lT=labBase+lGST,grand=pT+lT;
  const salvage=parseFloat(gv('sum-salvage'))||0,excess=parseFloat(gv('sum-excess'))||500,net=Math.max(0,grand-salvage-excess);
  const f=v=>'‚Çπ '+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  const st=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  st('sum-parts-base',f(pb));st('sum-parts-cgst',f(pGST));st('sum-parts-sgst',f(pGST));st('sum-parts-total',f(pT));
  st('sum-labour-base',f(labBase));st('sum-labour-gst',f(lGST));st('sum-labour-total',f(lT));
  st('sum-grand',f(grand));st('sum-net',f(net));st('sum-inwords','RUPEES '+numberToWords(net)+' ONLY');
  st('bd-metal',f(metal));st('bd-plastic',f(plastic));st('bd-glass',f(glass));
  let est=0;assessRows.forEach(r=>{est+=r.estimated*(1+r.gst/100);});
  st('cmp-est',f(est));st('cmp-ass',f(grand));st('cmp-diff',f(Math.abs(est-grand)));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPOT DAMAGE ROWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addSpotDamageRow(comp,dmg) {
  spotDamageRows.push({id:Date.now()+Math.random(),component:comp,damage:dmg});
  renderSpotDamageRows();
}
function deleteSpotRow(id){spotDamageRows=spotDamageRows.filter(r=>String(r.id)!==String(id));renderSpotDamageRows();}
function renderSpotDamageRows() {
  const container=document.getElementById('spot-damage-rows');
  if(!spotDamageRows.length){container.innerHTML='<div style="padding:20px;text-align:center;color:var(--muted2);font-size:13px">No components added yet.</div>';return;}
  const opts=SPOT_COMPONENTS.map(c=>`<option value="${c}">${c}</option>`).join('');
  container.innerHTML=spotDamageRows.map((row,idx)=>{
    const isCustom=row.component&&!SPOT_COMPONENTS.includes(row.component);
    const selOpts=opts.replace(`value="${row.component}"`,`value="${row.component}" selected`);
    const finalOpts=isCustom?selOpts+`<option value="${row.component}" selected>${row.component}</option>`:selOpts;
    return `<div class="spot-dmg-row" style="background:${idx%2===0?'#fff':'var(--surface)'}">
      <div>
        <select class="form-select" style="font-size:11px;padding:4px 7px" onchange="spotDamageRows[${idx}].component=this.value;renderSpotDamageRows()"><option value="">Select Component</option>${finalOpts}</select>
        ${isCustom?`<input class="form-input" style="margin-top:5px;font-size:11px;padding:3px 7px" value="${row.component}" onchange="spotDamageRows[${idx}].component=this.value"/>`:row.component==='OTHER'?`<input class="form-input" style="margin-top:5px;font-size:11px;padding:3px 7px" value="${row.damage||''}" onchange="spotDamageRows[${idx}].component=this.value" placeholder="Specify component‚Ä¶"/>`:''}
      </div>
      <textarea class="form-textarea" style="min-height:50px;font-size:12px" onchange="spotDamageRows[${idx}].damage=this.value" placeholder="Describe damage‚Ä¶">${row.damage||''}</textarea>
      <button class="btn btn-danger btn-sm" style="padding:3px 7px;margin-top:2px" onclick="deleteSpotRow('${row.id}')">‚úï</button>
    </div>`;
  }).join('');
}

function autoCalcLoad() {
  const gvw=parseFloat(gv('spot-gvw'))||0,ulw=parseFloat(gv('spot-ulw'))||0;
  if(gvw>0&&ulw>0&&gvw>ulw){
    const cap=Math.round(gvw-ulw); const e=document.getElementById('spot-load-capacity'); if(e){e.value=cap;e.classList.add('ai-filled');}
    const actual=parseFloat(gv('spot-actual-load'))||0;
    const al=document.getElementById('load-overage-alert'),tl=document.getElementById('load-overage-text');
    if(al&&actual>0&&actual>cap){al.style.display='flex';tl.textContent=`OVERLOADED: Actual ${actual.toLocaleString()} kg exceeds capacity ${cap.toLocaleString()} kg by ${Math.round(actual-cap).toLocaleString()} kg (${Math.round((actual-cap)/cap*100)}%). Policy condition breach.`;}
    else if(al)al.style.display='none';
  }
}

function checkSpotDL() {
  const nt=gv('spot-dl-valid'),t=gv('spot-dl-valid-transport'),mv=gv('spot-mdl-verified');
  const today=new Date();today.setHours(0,0,0,0);
  const ntExp=nt&&new Date(nt)<today,tExp=t&&new Date(t)<today;
  const badge=document.getElementById('spot-dl-badge'),rg=document.getElementById('spot-dl-remark-grp');
  if(!badge)return;
  if(mv==='not-available'){badge.style.display='block';badge.innerHTML='<span class="badge badge-amber" style="font-size:12px;padding:4px 10px">‚ö† DL Not Available ‚Äî Add remarks</span>';rg.style.display='block';}
  else if(ntExp||tExp){const lbl=[ntExp?'Non-Transport':'',tExp?'Transport':''].filter(Boolean).join(' & ');badge.style.display='block';badge.innerHTML=`<span class="badge badge-red" style="font-size:12px;padding:4px 10px">‚ùå ${lbl} DL EXPIRED ‚Äî Mandatory remarks required</span>`;rg.style.display='block';}
  else{badge.style.display='none';rg.style.display='none';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RI PARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadPartsForRI() {
  if(!assessRows.length){showToast('No parts in assessment','error');return;}
  riParts=assessRows.filter(r=>r.section==='parts'&&r.assessed>0).map((r,i)=>({id:'ri-'+i,particulars:r.particulars,assessed:r.assessed,status:'replaced',remarks:''}));
  setV('ri-survey-ref',gv('f-report-no')); setV('ri-survey-date',gv('f-report-date'));
  renderRIParts(); showToast(`Loaded ${riParts.length} parts`,'success');
}
function renderRIParts() {
  const c=document.getElementById('ri-parts-container'); if(!riParts.length){c.innerHTML='';return;}
  c.innerHTML=`<div class="form-label" style="margin-bottom:8px">Parts Replacement Verification</div>`+
    riParts.map((p,i)=>`<div style="display:grid;grid-template-columns:1fr 150px 1fr;gap:10px;align-items:start;padding:7px 0;border-bottom:1px solid var(--border)">
      <div style="padding-top:8px;font-size:13px;font-weight:500">${p.particulars}</div>
      <select class="form-select" style="font-size:12px" onchange="riParts[${i}].status=this.value;renderRIParts()">
        <option value="replaced" ${p.status==='replaced'?'selected':''}>‚úì Replaced</option>
        <option value="repaired" ${p.status==='repaired'?'selected':''}>‚ö° Repaired</option>
        <option value="not-replaced" ${p.status==='not-replaced'?'selected':''}>‚úó Not Replaced</option>
      </select>
      <input class="form-input" style="font-size:12px" value="${p.remarks}" onchange="riParts[${i}].remarks=this.value" placeholder="Remarks‚Ä¶"/>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveProfile() {
  const save=['sp-name','sp-qual','sp-lic','sp-lic-exp','sp-iiisla','sp-code','sp-categories','sp-mobile','sp-email','sp-addr','sp-gst','bank-name','bank-ac','bank-ifsc','bank-pan','sp-groq-model','sp-google-client-id'];
  save.forEach(id=>{const e=document.getElementById(id);if(e)localStorage.setItem('profile_'+id,e.value);});
  const keyEl=document.getElementById('sp-groq-key'); if(keyEl&&keyEl.value) localStorage.setItem('groq_api_key',keyEl.value);
  const modEl=document.getElementById('sp-groq-model'); if(modEl) localStorage.setItem('groq_model',modEl.value);
  if(sigDataUrl) localStorage.setItem('sig_data_url',sigDataUrl);
  if(stampDataUrl) localStorage.setItem('stamp_data_url',stampDataUrl);
  const name=gv('sp-name'); const initials=name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase()||'SP';
  document.getElementById('sb-avatar').textContent=initials; document.getElementById('sb-name').textContent=name||'Surveyor';
  document.getElementById('sb-lic').textContent=gv('sp-lic')||'License #';
  showToast('Profile saved','success');
  // Re-init Drive client in case Client ID changed
  initDriveClient();
}
function saveProfileAndConnectDrive() {
  const clientId = gv('sp-google-client-id').trim();
  if (!clientId) { showToast('Enter your Google OAuth Client ID first', 'error'); return; }
  saveProfile();
  setTimeout(() => connectDrive(), 300);
}
function loadProfile() {
  ['sp-name','sp-qual','sp-lic','sp-lic-exp','sp-iiisla','sp-code','sp-categories','sp-mobile','sp-email','sp-addr','sp-gst','bank-name','bank-ac','bank-ifsc','bank-pan','sp-groq-model','sp-google-client-id'].forEach(id=>{const v=localStorage.getItem('profile_'+id);const e=document.getElementById(id);if(v&&e)e.value=v;});
  const keyEl=document.getElementById('sp-groq-key'); if(keyEl){const k=localStorage.getItem('groq_api_key');if(k)keyEl.value=k;}
  // Restore Drive status in profile card
  const savedEmail=localStorage.getItem('g_drive_email')||'';
  const driveDetail=document.getElementById('drive-status-detail');
  if(driveDetail) driveDetail.textContent=gDriveToken ? ('Connected: '+savedEmail) : 'Not connected';
  const name=gv('sp-name'); const initials=name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase()||'SP';
  document.getElementById('sb-avatar').textContent=initials; document.getElementById('sb-name').textContent=name||'Surveyor';
  document.getElementById('sb-lic').textContent=gv('sp-lic')||'License #';
  sigDataUrl=localStorage.getItem('sig_data_url')||null; stampDataUrl=localStorage.getItem('stamp_data_url')||null;
  if(sigDataUrl){const p=document.getElementById('sig-preview'),ph=document.getElementById('sig-ph');if(p){p.src=sigDataUrl;p.style.display='block';}if(ph)ph.style.display='none';}
  if(stampDataUrl){const p=document.getElementById('stamp-preview'),ph=document.getElementById('stamp-ph');if(p){p.src=stampDataUrl;p.style.display='block';}if(ph)ph.style.display='none';}
}
function loadSig(input,type) {
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader(); reader.onload=e=>{
    if(type==='sig'){sigDataUrl=e.target.result;const p=document.getElementById('sig-preview'),ph=document.getElementById('sig-ph');if(p){p.src=sigDataUrl;p.style.display='block';}if(ph)ph.style.display='none';}
    else{stampDataUrl=e.target.result;const p=document.getElementById('stamp-preview'),ph=document.getElementById('stamp-ph');if(p){p.src=stampDataUrl;p.style.display='block';}if(ph)ph.style.display='none';}
  }; reader.readAsDataURL(file);
}
function clearSig(type) {
  if(type==='sig'){sigDataUrl=null;const p=document.getElementById('sig-preview'),ph=document.getElementById('sig-ph');if(p){p.src='';p.style.display='none';}if(ph)ph.style.display='block';}
  else{stampDataUrl=null;const p=document.getElementById('stamp-preview'),ph=document.getElementById('stamp-ph');if(p){p.src='';p.style.display='none';}if(ph)ph.style.display='block';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEE BILL CALC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcFeeTotal() {
  const prof=parseFloat(gv('fee-prof'))||0,ri=parseFloat(gv('fee-ri'))||0,travel=parseFloat(gv('fee-travel'))||0,
    photos=(parseFloat(gv('fee-photos-count'))||0)*(parseFloat(gv('fee-photo-rate'))||0),
    postal=parseFloat(gv('fee-postal'))||0,halt=parseFloat(gv('fee-haltage'))||0;
  const total=prof+ri+travel+photos+postal+halt;
  const fmt=v=>'‚Çπ'+v.toLocaleString('en-IN');
  const st=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  st('fs-prof',fmt(prof));st('fs-ri',fmt(ri));st('fs-travel',fmt(travel));st('fs-photos',fmt(photos));st('fs-total',fmt(total));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg,type='') {
  const c=document.getElementById('toast-container');
  const t=document.createElement('div'); t.className='toast'+(type?' '+type:'');
  const icons={success:'‚úì ',error:'‚úó ','':''}; t.textContent=(icons[type]||'')+msg;
  c.appendChild(t); setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(20px)';t.style.transition='all 0.3s';setTimeout(()=>t.remove(),300);},3000);
}

function numberToWords(num) {
  if(!num||isNaN(num))return'ZERO';
  const ones=['','ONE','TWO','THREE','FOUR','FIVE','SIX','SEVEN','EIGHT','NINE','TEN','ELEVEN','TWELVE','THIRTEEN','FOURTEEN','FIFTEEN','SIXTEEN','SEVENTEEN','EIGHTEEN','NINETEEN'];
  const tens=['','','TWENTY','THIRTY','FORTY','FIFTY','SIXTY','SEVENTY','EIGHTY','NINETY'];
  function c(n){if(n<20)return ones[n];if(n<100)return tens[Math.floor(n/10)]+(n%10?' '+ones[n%10]:'');if(n<1000)return ones[Math.floor(n/100)]+' HUNDRED'+(n%100?' '+c(n%100):'');if(n<100000)return c(Math.floor(n/1000))+' THOUSAND'+(n%1000?' '+c(n%1000):'');if(n<10000000)return c(Math.floor(n/100000))+' LAKH'+(n%100000?' '+c(n%100000):'');return c(Math.floor(n/10000000))+' CRORE'+(n%10000000?' '+c(n%10000000):'');}
  return c(Math.floor(num));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT BUILDERS (preserved from original)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSurveyorHeader() {
  const name=gv('sp-name')||'SURVEYOR NAME',qual=gv('sp-qual')||'B.Sc., Dip. in Auto Engg.',addr=gv('sp-addr')||'Address',lic=gv('sp-lic')||'‚Äî',exp=gv('sp-lic-exp')||'‚Äî',iiisla=gv('sp-iiisla')||'‚Äî',email=gv('sp-email')||'‚Äî',mob=gv('sp-mobile')||'‚Äî',cats=gv('sp-categories')||'MOTOR';
  return`<div style="border-bottom:1.2pt solid #000;padding-bottom:5px;margin-bottom:6px;"><div style="text-align:center;"><div style="font-size:13pt;font-weight:700;">${name}</div><div style="font-size:7pt;">${qual}</div><div style="font-size:7.5pt;font-weight:700;">INSURANCE SURVEYOR, LOSS ASSESSOR &amp; VALUER</div></div><div style="display:flex;justify-content:space-between;margin-top:4px;font-size:6.8pt;"><div>Lic. No.: <b>${lic}</b> &nbsp;|&nbsp; Expiry: <b>${exp}</b> &nbsp;|&nbsp; IIISLA: <b>${iiisla}</b> &nbsp;|&nbsp; E-mail: ${email} &nbsp;|&nbsp; Cell: ${mob}</div><div style="text-align:right;font-weight:700;">${cats}<br/><span style="font-weight:400;">${addr}</span></div></div></div>`;
}
function getSigBlock() {
  const sig=sigDataUrl?`<img src="${sigDataUrl}" style="max-height:48px;max-width:90px;object-fit:contain;"/>`:''
  const stamp=stampDataUrl?`<img src="${stampDataUrl}" style="max-height:55px;max-width:70px;object-fit:contain;"/>`:''
  const name=gv('sp-name')||'SURVEYOR NAME';
  return`<div style="display:flex;justify-content:flex-end;align-items:flex-end;margin-top:14px;gap:8px;">${stamp}<div style="text-align:center;">${sig}<div style="font-weight:700;font-size:7.5pt;margin-top:2px;">${name}</div><div style="font-size:6.5pt;color:#555;">Licenced Surveyor &amp; Loss Assessor</div></div></div>`;
}

function buildFinalSurveyHTML() {
  let metal=0,plastic=0,glass=0,labBase=0;
  assessRows.filter(r=>r.section==='parts').forEach(r=>{if(r.allowed===false)return;const dep=getDepRate(r.partType),ad=r.assessed*(1-dep/100);if(r.partType==='metal')metal+=ad;else if(r.partType==='glass')glass+=ad;else plastic+=ad;});
  assessRows.filter(r=>r.section==='labour'||r.section==='paint').forEach(r=>{if(r.allowed!==false)labBase+=r.assessed;});
  const pb=metal+plastic+glass,pCGST=pb*0.09,pT=pb+pCGST*2,lGST=labBase*0.18,lT=labBase+lGST,grand=pT+lT;
  const salvage=parseFloat(document.getElementById('sum-salvage').value)||0,excess=parseFloat(document.getElementById('sum-excess').value)||500,net=Math.max(0,grand-salvage-excess);
  const fa=v=>'‚Çπ '+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  const ts='width:100%;border-collapse:collapse;font-size:7.8pt;margin-bottom:4px;',th='background:#0d1b2a;color:#fff;padding:2px 4px;font-size:6.8pt;',td='padding:2px 4px;border:0.4pt solid #bbb;vertical-align:top;',tdr='padding:2px 4px;border:0.4pt solid #bbb;text-align:right;white-space:nowrap;',sec='padding:2px 4px;font-weight:700;background:#e8e3da;font-size:6.8pt;text-transform:uppercase;border:0.4pt solid #bbb;',sub='padding:2px 4px;font-weight:700;background:#dff0ec;color:#1a5a50;border:0.4pt solid #bbb;';
  const age=getVehicleAgeMonths(),metalDep=depType==='nil'?0:getDepRate('metal'),ageLabel=age>0?`${Math.floor(age/12)}yr ${age%12}mo`:'';
  let psn=1;
  const partsHtml=assessRows.filter(r=>r.section==='parts').map(r=>{const dep=getDepRate(r.partType),ad=r.allowed===false?0:r.assessed*(1-dep/100);return`<tr${r.allowed===false?' style="opacity:0.55;"':''}><td style="${td}text-align:center;">${psn++}</td><td style="${td}${r.allowed===false?'text-decoration:line-through;color:#a00;':''}">${r.particulars}${r.allowed===false?' <i style="font-size:6pt;">(Disallowed)</i>':''}</td><td style="${td}text-align:center;">${r.partType.charAt(0).toUpperCase()+r.partType.slice(1)}</td><td style="${tdr}">${r.allowed!==false?fa(r.assessed):'‚Äî'}</td><td style="${tdr}">${dep}%</td><td style="${tdr}">${r.partType==='metal'&&r.allowed!==false?fa(ad):'‚Äî'}</td><td style="${tdr}">${r.partType==='plastic'&&r.allowed!==false?fa(ad):'‚Äî'}</td><td style="${tdr}">${r.partType==='glass'&&r.allowed!==false?fa(ad):'‚Äî'}</td></tr>`;}).join('');
  let lsn=1;
  const labHtml=assessRows.filter(r=>r.section==='labour'||r.section==='paint').map(r=>`<tr${r.allowed===false?' style="opacity:0.55;"':''}><td style="${td}text-align:center;">${lsn++}</td><td style="${td}${r.allowed===false?'text-decoration:line-through;color:#a00;':''}">${r.particulars}</td><td style="${td}text-align:center;">${r.section==='paint'?'Paint':'Labour'}</td><td style="${tdr}">${r.gst}%</td><td colspan="4" style="${tdr}">${r.allowed!==false?fa(r.assessed):'‚Äî'}</td></tr>`).join('');
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:8.5pt;margin-bottom:3px;text-decoration:underline;letter-spacing:0.05em;">PRIVATE AND CONFIDENTIAL ‚Äî MOTOR (FINAL) SURVEY REPORT</div>
<p style="font-size:6.5pt;font-style:italic;margin-bottom:4px;text-align:justify;color:#444;">This report is issued by us as Licenced Surveyors without prejudice, in respect of cause, nature &amp; extent of loss/damage, subject to the terms &amp; conditions of the Insurance policy.</p>
<table style="${ts}"><tr><td style="${td}color:#444;width:18%;font-size:6.8pt;">Report No.</td><td style="${td}font-weight:700;width:32%;">${gv('f-report-no')}</td><td style="${td}color:#444;width:18%;font-size:6.8pt;">Date</td><td style="${td}font-weight:700;">${gv('f-report-date')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Policy No.</td><td style="${td}font-family:monospace;">${gv('f-policy-no')}</td><td style="${td}color:#444;font-size:6.8pt;">Claim No.</td><td style="${td}font-family:monospace;">${gv('f-claim-no')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Policy Period</td><td style="${td}">${gv('f-policy-from')} to ${gv('f-policy-to')}</td><td style="${td}color:#444;font-size:6.8pt;">I.D.V.</td><td style="${td}font-weight:600;">‚Çπ ${fmt2(gv('f-idv'))}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Policy Type</td><td style="${td}" colspan="3">${gv('f-policy-type')} ‚Äî <b>${depType==='nil'?'Nil Depreciation':depType==='zero'?'Zero Dep Policy':'Standard IRDAI '+ageLabel}</b></td></tr></table>
<table style="${ts}"><tr><td style="${td}font-weight:700;width:18%;background:#f5f2ee;font-size:6.8pt;">1. INSURER</td><td style="${td}" colspan="3">${gv('f-insurer')} | Appointing: ${gv('f-appt-office')}</td></tr><tr><td style="${td}font-weight:700;background:#f5f2ee;font-size:6.8pt;">2. INSURED</td><td style="${td}font-weight:600;width:32%;">${gv('f-insured-name')}</td><td style="${td}color:#444;font-size:6.8pt;">Mobile</td><td style="${td}">${gv('f-insured-mobile')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Address</td><td style="${td}" colspan="3">${gv('f-insured-addr')}</td></tr><tr><td style="${td}font-weight:700;background:#f5f2ee;font-size:6.8pt;">3. H.P.A.</td><td style="${td}" colspan="3">${gv('f-hpa')||'NIL'}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">4. VEHICLE PARTICULARS</div>
<table style="${ts}"><tr><td style="${td}color:#444;font-size:6.8pt;width:18%;">Reg. No.</td><td style="${td}font-weight:700;width:32%;">${gv('f-reg-no')}</td><td style="${td}color:#444;font-size:6.8pt;">Date of Reg.</td><td style="${td}">${gv('f-reg-date')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Make / Model / Year</td><td style="${td}" colspan="3"><b>${gv('f-make')}</b> / ${gv('f-model')} / ${gv('f-year')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Chassis No.</td><td style="${td}font-family:monospace;">${gv('f-chassis')}</td><td style="${td}color:#444;font-size:6.8pt;">Engine No.</td><td style="${td}font-family:monospace;">${gv('f-engine')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Body / Colour / Fuel</td><td style="${td}" colspan="3">${gv('f-body-type')} / ${gv('f-colour')} / ${gv('f-fuel')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">CC / Odometer</td><td style="${td}">${gv('f-cc')} / ${gv('f-odo')} KM</td><td style="${td}color:#444;font-size:6.8pt;">Pre-Accident Cond.</td><td style="${td}">${gv('f-condition')}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">5. DRIVER'S PARTICULARS</div>
<table style="${ts}"><tr><td style="${td}color:#444;font-size:6.8pt;width:18%;">Driver Name</td><td style="${td}font-weight:600;" colspan="3">${gv('f-driver-name')||'‚Äî'}${gv('f-dl-parent')?' '+(gv('f-dl-relation')||'S/o')+' '+gv('f-dl-parent'):''}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">M.D.L. No.</td><td style="${td}font-family:monospace;width:32%;">${gv('f-mdl')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Date of Birth</td><td style="${td}">${gv('f-dob')||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Licence Classes</td><td style="${td}" colspan="3">${gv('f-dl-type')||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Non-Transport Valid</td><td style="${td}${gv('f-dl-valid')&&new Date(gv('f-dl-valid'))<new Date()?'color:#c00;font-weight:700;':''}">${gv('f-dl-valid')||'‚Äî'}${gv('f-dl-valid')&&new Date(gv('f-dl-valid'))<new Date()?' ‚ö† EXPIRED':''}</td><td style="${td}color:#444;font-size:6.8pt;">Transport Valid</td><td style="${td}${gv('f-dl-valid-transport')&&new Date(gv('f-dl-valid-transport'))<new Date()?'color:#c00;font-weight:700;':''}">${gv('f-dl-valid-transport')||'‚Äî'}${gv('f-dl-valid-transport')&&new Date(gv('f-dl-valid-transport'))<new Date()?' ‚ö† EXPIRED':''}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">6. ACCIDENT &amp; SURVEY DETAILS</div>
<table style="${ts}"><tr><td style="${td}color:#444;font-size:6.8pt;width:18%;">Date &amp; Time</td><td style="${td}width:32%;">${gv('f-doa')}</td><td style="${td}color:#444;font-size:6.8pt;">Place</td><td style="${td}">${gv('f-poa')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Date of Survey</td><td style="${td}">${gv('f-survey-date')}</td><td style="${td}color:#444;font-size:6.8pt;">Place of Survey</td><td style="${td}">${gv('f-survey-place')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Third Party</td><td style="${td}" colspan="3">${gv('f-tp')||'NIL'}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">7. CAUSE &amp; NATURE OF ACCIDENT</div>
<div style="font-size:7.2pt;margin-bottom:4px;padding:2px 4px;border:0.4pt solid #bbb;background:#fafaf7;line-height:1.5;">${gv('f-cause')||'‚Äî'}</div>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">8. ASSESSMENT SUMMARY</div>
<table style="${ts}"><thead><tr><th style="${th};width:40%;text-align:left;">Head</th><th style="${th};text-align:right;">Estimated</th><th style="${th};text-align:right;">Assessed (after Dep.)</th><th style="${th};text-align:right;">Incl. GST</th></tr></thead><tbody>
<tr><td style="${td}">Spare Parts</td><td style="${tdr}">${fa(assessRows.filter(r=>r.section==='parts'&&r.allowed!==false).reduce((s,r)=>s+r.estimated,0))}</td><td style="${tdr}">${fa(pb)}</td><td style="${tdr}">${fa(pT)}</td></tr>
<tr><td style="${td}">Labour &amp; Painting</td><td style="${tdr}">${fa(assessRows.filter(r=>(r.section==='labour'||r.section==='paint')&&r.allowed!==false).reduce((s,r)=>s+r.estimated,0))}</td><td style="${tdr}">${fa(labBase)}</td><td style="${tdr}">${fa(lT)}</td></tr>
<tr style="background:#e8f5f3;"><td style="${td}font-weight:700;">GRAND TOTAL</td><td style="${tdr}font-weight:700;background:#e8f5f3;"></td><td style="${tdr}font-weight:700;background:#e8f5f3;"></td><td style="${tdr}font-weight:700;background:#e8f5f3;">${fa(grand)}</td></tr>
<tr><td style="${td}">Less: Policy Excess</td><td colspan="2" style="border:0.4pt solid #bbb;"></td><td style="${tdr}">( ${fa(excess)} )</td></tr>
<tr><td style="${td}">Less: Salvage Value</td><td colspan="2" style="border:0.4pt solid #bbb;"></td><td style="${tdr}">( ${fa(salvage)} )</td></tr>
<tr style="background:#0d1b2a;color:#fff;"><td style="padding:3px 4px;font-weight:700;font-size:8pt;">NET ASSESSED LOSS</td><td colspan="2" style="border:none;"></td><td style="padding:3px 4px;text-align:right;font-weight:700;font-size:8pt;">${fa(net)}</td></tr>
<tr><td colspan="4" style="${td}font-style:italic;font-size:6.5pt;color:#444;">RUPEES ${numberToWords(net)} ONLY</td></tr></tbody></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">9. DETAILS OF ASSESSMENT</div>
<table style="${ts}"><thead><tr><th style="${th};width:18pt;text-align:center;">Sr.</th><th style="${th}">Particulars</th><th style="${th};width:38pt;text-align:center;">Type</th><th style="${th};text-align:right;width:46pt;">Assessed ‚Çπ</th><th style="${th};text-align:center;width:28pt;">Dep%</th><th style="${th};text-align:right;width:48pt;">Metal ‚Çπ</th><th style="${th};text-align:right;width:48pt;">Plastic ‚Çπ</th><th style="${th};text-align:right;width:44pt;">Glass ‚Çπ</th></tr></thead><tbody>
<tr><td colspan="8" style="${sec}">SPARE PARTS</td></tr>${partsHtml}
<tr><td colspan="5" style="${sub}text-align:right;font-size:6.8pt;">Sub-Total Parts</td><td style="${sub}text-align:right;">${fa(metal)}</td><td style="${sub}text-align:right;">${fa(plastic)}</td><td style="${sub}text-align:right;">${fa(glass)}</td></tr>
<tr><td colspan="8" style="${sec}">LABOUR &amp; PAINTING</td></tr>
<tr><th style="${th};width:18pt;text-align:center;">Sr.</th><th style="${th}">Particulars</th><th style="${th};width:38pt;text-align:center;">Type</th><th style="${th};text-align:center;width:28pt;">GST%</th><th colspan="4" style="${th};text-align:right;">Amount ‚Çπ</th></tr>
${labHtml}
<tr><td colspan="4" style="${sub}text-align:right;font-size:6.8pt;">Sub-Total Labour &amp; Paint</td><td colspan="4" style="${sub}text-align:right;">${fa(labBase)}</td></tr>
</tbody></table>
<p style="font-size:6.5pt;line-height:1.5;margin-bottom:5px;text-align:justify;color:#333;">We have carried out survey of the above motor vehicle in connection with the captioned claim and assessed the loss as per Surveyors and Loss Assessors Regulations 2015 under the Insurance Act 1938. This is a final report without prejudice, subject to terms and conditions of the policy including any applicable policy excess and depreciation as per IRDAI guidelines.</p>
${getSigBlock()}
<div style="font-size:6pt;color:#666;margin-top:4px;border-top:0.4pt solid #ccc;padding-top:2px;">Encl: Repair Estimate / Tax Invoice &amp; Digital Photographs</div>`;
}

function buildBillCheckHTML() {
  let metal=0,plastic=0,labBase=0;
  assessRows.filter(r=>r.section==='parts').forEach(r=>{if(r.partType==='metal')metal+=r.assessed;else plastic+=r.assessed;});
  assessRows.filter(r=>r.section==='labour'||r.section==='paint').forEach(r=>labBase+=r.assessed);
  const mGST=metal*1.18,pGST=plastic*1.18,lGST=labBase*1.18,total=mGST+pGST+lGST,excess=parseFloat(document.getElementById('sum-excess').value)||500,net=Math.max(0,total-excess);
  const fa=v=>v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  const ts='width:100%;border-collapse:collapse;font-size:0.79rem;',th='background:#0d1b2a;color:#fff;padding:6px 9px;font-size:0.7rem;text-align:left;';
  const partsHtml=assessRows.filter(r=>r.section==='parts').map((r,i)=>`<tr><td style="padding:5px 8px;">${i+1}</td><td style="padding:5px 8px;">${r.particulars}</td><td style="padding:5px 8px;text-align:center;">${r.gst}%</td><td style="padding:5px 8px;text-align:right;">${r.partType==='metal'?fa(r.assessed):''}</td><td style="padding:5px 8px;text-align:right;">${r.partType!=='metal'?fa(r.assessed):''}</td></tr>`).join('');
  const labHtml=assessRows.filter(r=>r.section==='labour'||r.section==='paint').map((r,i)=>`<tr><td style="padding:5px 8px;">${i+1}</td><td style="padding:5px 8px;">${r.particulars}</td><td style="padding:5px 8px;text-align:center;">${r.gst}%</td><td colspan="2" style="padding:5px 8px;text-align:right;">${fa(r.assessed)}</td></tr>`).join('');
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:1.05rem;margin-bottom:12px;">BILL CHECK REPORT</div>
<table style="${ts}margin-bottom:12px;"><tr><td style="padding:4px 0;color:#666;width:33%;">Report No.</td><td style="font-weight:600;">${gv('f-report-no')}</td><td style="color:#666;">Date</td><td>${gv('f-report-date')}</td></tr><tr><td style="padding:4px 0;color:#666;">Insurer</td><td colspan="3">${gv('f-insurer')}</td></tr><tr><td style="padding:4px 0;color:#666;">Insured</td><td colspan="3">${gv('f-insured-name')}</td></tr><tr><td style="padding:4px 0;color:#666;">Policy No.</td><td>${gv('f-policy-no')}</td><td style="color:#666;">Vehicle No.</td><td style="font-weight:600;">${gv('f-reg-no')}</td></tr><tr><td style="padding:4px 0;color:#666;">Chassis</td><td>${gv('f-chassis')}</td><td style="color:#666;">Engine</td><td>${gv('f-engine')}</td></tr></table>
<table style="${ts}margin-bottom:12px;"><thead><tr><th style="${th}">Sr.</th><th style="${th}">Particulars</th><th style="${th}text-align:center;">GST%</th><th style="${th}text-align:right;">Metal ‚Çπ</th><th style="${th}text-align:right;">Plastic/Rubber ‚Çπ</th></tr></thead><tbody><tr><td colspan="5" style="padding:5px 8px;font-weight:600;background:#ede8df;font-size:0.7rem;">SPARE PARTS</td></tr>${partsHtml}<tr style="background:#e8f5f3;"><td colspan="3" style="padding:5px 8px;font-weight:600;">TOTAL</td><td style="padding:5px 8px;text-align:right;font-weight:600;">${fa(metal)}</td><td style="padding:5px 8px;text-align:right;font-weight:600;">${fa(plastic)}</td></tr><tr><td colspan="5" style="padding:5px 8px;font-weight:600;background:#ede8df;font-size:0.7rem;">LABOUR</td></tr>${labHtml}<tr style="background:#e8f5f3;"><td colspan="3" style="padding:5px 8px;font-weight:600;">TOTAL LABOUR</td><td colspan="2" style="padding:5px 8px;text-align:right;font-weight:600;">${fa(labBase)}</td></tr></tbody></table>
<table style="${ts}margin-bottom:14px;"><tr><td style="padding:7px;border-bottom:1px solid #ddd;">I) Total Spare Parts (incl. GST)</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;font-weight:600;">‚Çπ ${fa(mGST+pGST)}</td></tr><tr><td style="padding:7px;border-bottom:1px solid #ddd;">II) Total Labour (incl. GST)</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;font-weight:600;">‚Çπ ${fa(lGST)}</td></tr><tr><td style="padding:7px;border-bottom:1px solid #ddd;">Total (I+II)</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;">‚Çπ ${fa(total)}</td></tr><tr><td style="padding:7px;border-bottom:1px solid #ddd;">Less Excess</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;">‚Çπ ${fa(excess)}</td></tr><tr style="background:#0d1b2a;color:#fff;"><td style="padding:9px;font-weight:700;">NET LIABILITY</td><td style="padding:9px;text-align:right;font-weight:700;">‚Çπ ${fa(net)}</td></tr></table>
<div style="font-style:italic;font-size:0.78rem;margin-bottom:14px;">INWORDS : RUPEES ${numberToWords(net)} ONLY</div>
<div style="font-size:0.76rem;"><strong>ENCL:-</strong> REPAIR BILLS / TAX INVOICE</div>
${getSigBlock()}`;
}

function buildSpotSurveyHTML() {
  const ts='width:100%;border-collapse:collapse;font-size:7.8pt;margin-bottom:4px;',td='padding:2px 4px;border:0.4pt solid #bbb;vertical-align:top;',th='background:#0d1b2a;color:#fff;padding:2px 4px;font-size:6.8pt;';
  const isComm=vehicleType!=='private',isGoods=vehicleType==='comm-goods';
  const dlValid=gv('spot-dl-valid'),dlTValid=gv('spot-dl-valid-transport');
  const today=new Date();today.setHours(0,0,0,0);
  const ntExpired=dlValid&&new Date(dlValid)<today,tExpired=dlTValid&&new Date(dlTValid)<today;
  const gvwVal=parseFloat(gv('spot-gvw'))||0,ulwVal=parseFloat(gv('spot-ulw'))||0,capVal=parseFloat(gv('spot-load-capacity'))||0,actualLoad=parseFloat(gv('spot-actual-load'))||0;
  const overload=isGoods&&actualLoad>0&&capVal>0&&actualLoad>capVal;
  const dmgRows=spotDamageRows.filter(r=>r.component||r.damage).map((r,i)=>`<tr><td style="${td}text-align:center;">${i+1}</td><td style="${td}font-weight:600;">${r.component||'‚Äî'}</td><td style="${td}">${r.damage||'‚Äî'}</td></tr>`).join('');
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:8.5pt;margin-bottom:3px;text-decoration:underline;">SPOT SURVEY REPORT</div>
<table style="${ts}"><tr><td style="${td}color:#444;font-size:6.8pt;width:18%;">Spot Report No.</td><td style="${td}font-weight:700;width:32%;">${gv('spot-report-no')}</td><td style="${td}color:#444;font-size:6.8pt;">Date of Report</td><td style="${td}font-weight:700;">${gv('spot-report-date')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Date of Allotment</td><td style="${td}">${gv('spot-allot-date')}</td><td style="${td}color:#444;font-size:6.8pt;">Date & Time of Survey</td><td style="${td}">${gv('spot-survey-datetime')}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">A. VEHICLE PARTICULARS</div>
<table style="${ts}"><tr><td style="${td}color:#444;width:18%;font-size:6.8pt;">Policy No.</td><td style="${td}font-family:monospace;width:32%;">${gv('f-policy-no')}</td><td style="${td}color:#444;font-size:6.8pt;">Claim No.</td><td style="${td}font-family:monospace;">${gv('f-claim-no')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Reg. No.</td><td style="${td}font-weight:700;">${gv('f-reg-no')}</td><td style="${td}color:#444;font-size:6.8pt;">Make / Model / Year</td><td style="${td}"><b>${gv('f-make')}</b> / ${gv('f-model')} / ${gv('f-year')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Chassis No.</td><td style="${td}font-family:monospace;">${gv('f-chassis')}</td><td style="${td}color:#444;font-size:6.8pt;">Engine No.</td><td style="${td}font-family:monospace;">${gv('f-engine')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Insured</td><td style="${td}font-weight:600;">${gv('f-insured-name')}</td><td style="${td}color:#444;font-size:6.8pt;">Insurer</td><td style="${td}">${gv('f-insurer')}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">B. DRIVER'S PARTICULARS &amp; DL VERIFICATION</div>
<table style="${ts}"><tr><td style="${td}color:#444;width:18%;font-size:6.8pt;">Driver Name</td><td style="${td}font-weight:600;width:32%;">${gv('spot-driver-name')||'‚Äî'}${gv('spot-dl-parent')?' '+(gv('spot-dl-relation')||'S/o')+' '+gv('spot-dl-parent'):''}</td><td style="${td}color:#444;font-size:6.8pt;">MDL No.</td><td style="${td}font-family:monospace;">${gv('spot-mdl-no')||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Licence Classes</td><td style="${td}">${gv('spot-dl-type')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Issue Date</td><td style="${td}">${gv('spot-dl-issue')||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Non-Transport Valid</td><td style="${td}${ntExpired?'color:#c00;font-weight:700;':''}">${dlValid||'‚Äî'}${ntExpired?' ‚ö† EXPIRED':''}</td><td style="${td}color:#444;font-size:6.8pt;">Transport Valid</td><td style="${td}${tExpired?'color:#c00;font-weight:700;':''}">${dlTValid||'‚Äî'}${tExpired?' ‚ö† EXPIRED':''}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">MDL Status</td><td style="${td}" colspan="3"><b>${gv('spot-mdl-verified')==='verified'?'ORIGINAL MDL VERIFIED':gv('spot-mdl-verified')==='photocopy'?'PHOTOCOPY VERIFIED':'NOT AVAILABLE'}</b>${gv('spot-dl-invalid-remarks')?' ‚Äî '+gv('spot-dl-invalid-remarks'):''}</td></tr></table>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">C. ACCIDENT DETAILS</div>
<table style="${ts}"><tr><td style="${td}color:#444;width:18%;font-size:6.8pt;">Date &amp; Time</td><td style="${td}width:32%;">${gv('spot-accident-datetime')}</td><td style="${td}color:#444;font-size:6.8pt;">Place of Accident</td><td style="${td}">${gv('spot-accident-place')}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Place of Survey</td><td style="${td}">${gv('spot-survey-place')}</td><td style="${td}color:#444;font-size:6.8pt;">Third Party</td><td style="${td}">${gv('spot-tp-involved')==='no'?'NIL':gv('spot-tp-involved').toUpperCase()}</td></tr>${gv('spot-tp-details')&&gv('spot-tp-details')!=='NIL'?`<tr><td style="${td}color:#444;font-size:6.8pt;">TP Details</td><td style="${td}" colspan="3">${gv('spot-tp-details')}</td></tr>`:''}<tr><td style="${td}color:#444;font-size:6.8pt;">Police Reported</td><td style="${td}">${gv('spot-police-reported')==='yes'?'Yes ‚Äî '+gv('spot-police-station')+' | Diary: '+gv('spot-diary-no'):'No'}</td><td style="${td}color:#444;font-size:6.8pt;">Panchanama</td><td style="${td}">${gv('spot-panchanama')==='yes'?'Yes':'No'}</td></tr></table>
${isComm?`<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">D. COMMERCIAL VEHICLE DOCUMENTS</div><table style="${ts}"><tr><td style="${td}color:#444;width:18%;font-size:6.8pt;">Permit No.</td><td style="${td}font-family:monospace;width:32%;">${gv('spot-permit-no')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Permit Type / Valid To</td><td style="${td}">${gv('spot-permit-type')||'‚Äî'} / ${gv('spot-permit-to')||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Fitness No.</td><td style="${td}font-family:monospace;">${gv('spot-fitness-no')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Fitness Valid To</td><td style="${td}${gv('spot-fitness-valid')&&new Date(gv('spot-fitness-valid'))<today?'color:#c00;font-weight:700;':''}">${gv('spot-fitness-valid')||'‚Äî'}${gv('spot-fitness-valid')&&new Date(gv('spot-fitness-valid'))<today?' ‚ö† EXPIRED':''}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Auth. No.</td><td style="${td}font-family:monospace;">${gv('spot-auth-no')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Auth Valid To</td><td style="${td}">${gv('spot-auth-valid')||'‚Äî'}</td></tr></table>`:''}
${isGoods?`<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">E. LOAD DETAILS</div><table style="${ts}"><tr><td style="${td}color:#444;width:25%;font-size:6.8pt;">GVW (kg)</td><td style="${td}width:25%;">${gvwVal||'‚Äî'}</td><td style="${td}color:#444;width:25%;font-size:6.8pt;">ULW / Tare (kg)</td><td style="${td}">${ulwVal||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Legal Load Capacity</td><td style="${td}font-weight:600;">${capVal?capVal+' kg':'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Actual Load Carried</td><td style="${td}${overload?'color:#c00;font-weight:700;':''}">${actualLoad?actualLoad+' kg':'‚Äî'}${overload?` ‚ö† OVERLOADED by ${Math.round(actualLoad-capVal)} kg`:''}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">CN / Challan No.</td><td style="${td}font-family:monospace;">${gv('spot-cn-no')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Goods</td><td style="${td}">${gv('spot-load-desc')||'‚Äî'}</td></tr><tr><td style="${td}color:#444;font-size:6.8pt;">Origin</td><td style="${td}">${gv('spot-load-origin')||'‚Äî'}</td><td style="${td}color:#444;font-size:6.8pt;">Destination</td><td style="${td}">${gv('spot-load-dest')||'‚Äî'}</td></tr></table>`:''}
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">F. CAUSE OF ACCIDENT</div>
<div style="font-size:7.2pt;margin-bottom:4px;padding:2px 4px;border:0.4pt solid #bbb;line-height:1.5;">${gv('spot-accident-cause')||'‚Äî'}</div>
<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;">G. DAMAGE PARTICULARS AT SPOT</div>
<div style="font-size:6.8pt;margin-bottom:3px;padding:2px 4px;">Severity: <b>${gv('spot-damage-severity').toUpperCase()}</b> &nbsp;|&nbsp; Airbags Deployed: <b>${gv('spot-airbags').toUpperCase()}</b> &nbsp;|&nbsp; Drivable: <b>${gv('spot-drivable')}</b></div>
${dmgRows.length?`<table style="${ts}"><thead><tr><th style="${th};width:20pt;text-align:center;">Sr.</th><th style="${th}">Component</th><th style="${th}">Damage Description</th></tr></thead><tbody>${dmgRows}</tbody></table>`:'<p style="font-size:7pt;padding:2px 4px;border:0.4pt solid #bbb;">Damage observations: '+gv('spot-comments')+'</p>'}
${gv('spot-comments')?`<div style="font-size:7pt;margin-top:4px;padding:2px 4px;border:0.4pt solid #bbb;">Comments: ${gv('spot-comments')}</div>`:''}
<p style="font-size:6.5pt;line-height:1.5;margin:8px 0;text-align:justify;color:#333;">We hereby certify that we have carried out spot survey of the above vehicle and report as above without prejudice and subject to terms and conditions of the policy.</p>
${getSigBlock()}`;
}

function buildRIHTML() {
  const ts='width:100%;border-collapse:collapse;font-size:0.79rem;',td='padding:5px 0;',th='background:#0d1b2a;color:#fff;padding:6px 9px;font-size:0.7rem;text-align:left;';
  const repQ=gv('ri-repair-quality'),vC=gv('ri-vehicle-condition'),salv=gv('ri-salvage-status');
  const qT={satisfactory:'Satisfactory ‚Äî As per survey report',good:'Good ‚Äî Better than expected',partial:'Partial ‚Äî Some items pending',unsatisfactory:'Unsatisfactory'}[repQ];
  const vT={roadworthy:'Road Worthy ‚Äî Fit for operation','needs-attention':'Needs Minor Attention','not-roadworthy':'Not Road Worthy'}[vC];
  const sT={collected:'Salvage collected & verified','not-collected':'Not collected',partial:'Partial collection',na:'Not Applicable'}[salv];
  const partsTable=riParts.length?`<div style="font-weight:700;margin:14px 0 7px;">PARTS REPLACEMENT VERIFICATION</div>
<table style="${ts}margin-bottom:12px;border:1px solid #ddd;"><thead><tr style="background:#0d1b2a;color:#fff;"><th style="${th}width:30px;">Sr.</th><th style="${th}">Particulars</th><th style="${th}text-align:center;width:100px;">Status</th><th style="${th}width:160px;">Remarks</th></tr></thead><tbody>${riParts.map((p,i)=>{const st=p.status==='replaced'?'‚úì Replaced':p.status==='repaired'?'‚ö° Repaired':'‚úó Not Replaced';const col=p.status==='replaced'?'#1e7e52':p.status==='repaired'?'#b45309':'#c0392b';return`<tr style="border-bottom:1px solid #e5e0d8;"><td style="padding:5px 9px;color:#666;">${i+1}</td><td style="padding:5px 9px;">${p.particulars}</td><td style="padding:5px 9px;text-align:center;color:${col};font-weight:600;font-size:0.75rem;">${st}</td><td style="padding:5px 9px;font-size:0.75rem;font-style:italic;">${p.remarks||'‚Äî'}</td></tr>`;}).join('')}</tbody></table>`:''
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:1.15rem;margin-bottom:12px;">REINSPECTION REPORT</div>
<div style="display:flex;justify-content:space-between;margin-bottom:12px;"><div><strong>Ref No.: ${gv('ri-ref')||'RIN/‚Äî/'+new Date().getFullYear()}</strong></div><div><strong>Date: ${gv('ri-date')}</strong></div></div>
<table style="${ts}margin-bottom:12px;"><tr><td style="${td}color:#666;width:35%;">Insurer</td><td>${gv('f-insurer')}</td></tr><tr><td style="${td}color:#666;">Insured</td><td style="font-weight:600;">${gv('f-insured-name')}</td></tr><tr><td style="${td}color:#666;">Policy No.</td><td style="font-family:monospace;">${gv('f-policy-no')}</td></tr><tr><td style="${td}color:#666;">Claim No.</td><td style="font-family:monospace;">${gv('f-claim-no')}</td></tr></table>
<table style="${ts}margin-bottom:12px;"><tr><td style="${td}color:#666;width:35%;">Registration No.</td><td style="font-weight:600;">${gv('f-reg-no')}</td></tr><tr><td style="${td}color:#666;">Make &amp; Model</td><td>${gv('f-make')} ${gv('f-model')}</td></tr><tr><td style="${td}color:#666;">Chassis No.</td><td style="font-family:monospace;">${gv('f-chassis')}</td></tr><tr><td style="${td}color:#666;">Engine No.</td><td style="font-family:monospace;">${gv('f-engine')}</td></tr><tr><td style="${td}color:#666;">Original Survey Ref</td><td><strong>${gv('ri-survey-ref')||gv('f-report-no')}</strong> dated ${gv('ri-survey-date')||gv('f-report-date')}</td></tr></table>
${partsTable}
<table style="${ts}margin-bottom:12px;"><tr><td style="${td}color:#666;width:35%;">Repair Quality</td><td style="font-weight:600;">${qT}</td></tr><tr><td style="${td}color:#666;">Vehicle Condition</td><td style="font-weight:600;">${vT}</td></tr><tr><td style="${td}color:#666;">Salvage Status</td><td>${sT}</td></tr></table>
${gv('ri-observations')?`<div style="font-weight:700;margin-bottom:7px;">ADDITIONAL OBSERVATIONS</div><p style="font-size:0.8rem;line-height:1.6;margin-bottom:14px;background:#f7f3ed;padding:12px;border-radius:6px;">${gv('ri-observations')}</p>`:''}
<p style="font-size:0.8rem;line-height:1.75;margin-bottom:18px;text-transform:uppercase;font-weight:500;">WE HAVE RE-INSPECTED THE CAPTIONED VEHICLE &amp; VERIFIED REPAIRS / REPLACEMENTS AS DETAILED ABOVE. THE VEHICLE WAS FOUND TO BE ${vC==='roadworthy'?'IN ROAD WORTHY CONDITION':'REQUIRING ATTENTION'} AT TIME OF INSPECTION.</p>
${getSigBlock()}
<div style="font-size:0.72rem;color:#666;margin-top:14px;">ENCL: R.I PHOTOS, SALVAGE PARTS PHOTOS &amp; MY BILL FOR SURVEY.</div>`;
}

function buildFeeBillHTML() {
  const prof=parseFloat(gv('fee-prof'))||0,ri=parseFloat(gv('fee-ri'))||0,travel=parseFloat(gv('fee-travel'))||0,
    photos=(parseFloat(gv('fee-photos-count'))||0)*(parseFloat(gv('fee-photo-rate'))||0),
    postal=parseFloat(gv('fee-postal'))||0,halt=parseFloat(gv('fee-haltage'))||0,total=prof+ri+travel+photos+postal+halt;
  const gstAmt=total*0.18,grand=total+gstAmt;
  const fa=v=>'‚Çπ '+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  const rows=[[`Professional Survey Fee ‚Äî ${gv('f-reg-no')||'Vehicle'}`,fa(prof)],[`RI Inspection Fee`,fa(ri)],[`Travel Expenses ‚Äî ${gv('fee-travel-note')||''}`,fa(travel)],[`Photography Charges (${gv('fee-photos-count')} photos √ó ‚Çπ${gv('fee-photo-rate')})`,fa(photos)],[`Postal / Courier Charges`,fa(postal)],[`Haltage Charges`,fa(halt)]].filter(r=>parseFloat(r[1].replace(/[‚Çπ,\s]/g,''))||false);
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:1.1rem;margin-bottom:12px;">SURVEYOR FEE BILL / INVOICE</div>
<table style="width:100%;border-collapse:collapse;font-size:0.79rem;margin-bottom:12px;"><tr><td style="padding:4px 0;color:#666;width:35%;">To</td><td style="font-weight:600;">${gv('f-insurer')}</td></tr><tr><td style="padding:4px 0;color:#666;">Report No.</td><td>${gv('f-report-no')}</td></tr><tr><td style="padding:4px 0;color:#666;">Claim No.</td><td style="font-family:monospace;">${gv('f-claim-no')}</td></tr><tr><td style="padding:4px 0;color:#666;">Insured</td><td>${gv('f-insured-name')}</td></tr><tr><td style="padding:4px 0;color:#666;">Vehicle</td><td><b>${gv('f-reg-no')}</b> ‚Äî ${gv('f-make')} ${gv('f-model')}</td></tr></table>
<table style="width:100%;border-collapse:collapse;font-size:0.79rem;margin-bottom:14px;"><thead><tr style="background:#0d1b2a;color:#fff;"><th style="padding:7px 9px;text-align:left;">Particulars</th><th style="padding:7px 9px;text-align:right;">Amount</th></tr></thead><tbody>${rows.map((r,i)=>`<tr style="background:${i%2===0?'#fff':'#f8f5f0'}"><td style="padding:6px 9px;">${r[0]}</td><td style="padding:6px 9px;text-align:right;">${r[1]}</td></tr>`).join('')}<tr style="background:#f0fdf8;"><td style="padding:6px 9px;font-weight:600;">Sub-Total</td><td style="padding:6px 9px;text-align:right;font-weight:600;">${fa(total)}</td></tr><tr><td style="padding:6px 9px;">GST @ 18% (SAC 998549)</td><td style="padding:6px 9px;text-align:right;">${fa(gstAmt)}</td></tr><tr style="background:#0d1b2a;color:#fff;"><td style="padding:9px;font-weight:700;">TOTAL PAYABLE</td><td style="padding:9px;text-align:right;font-weight:700;">${fa(grand)}</td></tr></tbody></table>
<div style="font-style:italic;font-size:0.78rem;margin-bottom:14px;">RUPEES ${numberToWords(grand)} ONLY</div>
<div style="font-size:0.78rem;margin-top:14px;padding:10px 12px;background:#f5f7fa;border-radius:6px;line-height:1.8;"><strong>Payment Details:</strong><br/>Bank: ${gv('bank-name')} &nbsp;|&nbsp; A/c: ${gv('bank-ac')} &nbsp;|&nbsp; IFSC: ${gv('bank-ifsc')}<br/>GST No.: ${gv('sp-gst')||'N/A'} &nbsp;|&nbsp; PAN: ${gv('bank-pan')}</div>
${getSigBlock()}`;
}

function printHTML(html, title) {
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>${title}</title><link href='https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700&display=swap' rel='stylesheet'/><style>@page{margin:8mm 10mm;size:A4 portrait;}*{box-sizing:border-box;}body{font-family:'Barlow',Arial,sans-serif;font-size:7.8pt;line-height:1.3;color:#000;margin:0;padding:0;}table{border-collapse:collapse;width:100%;font-size:7.8pt;}td,th{padding:2px 4px;}p{margin:0 0 4px;}@media print{@page{margin:8mm 10mm;}body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}tr{page-break-inside:avoid;}}</style></head><body>${html}</body></html>`);
  w.document.close();
  setTimeout(()=>{w.focus();w.print();},600);
  showToast('Report opened ‚Äî use Print ‚Üí Save as PDF');
}

function genReport(type) {
  if(type==='final') printHTML(buildFinalSurveyHTML(),'Final Survey Report ‚Äî '+gv('f-reg-no'));
  else if(type==='bill') printHTML(buildBillCheckHTML(),'Bill Check ‚Äî '+gv('f-reg-no'));
  else if(type==='spot') printHTML(buildSpotSurveyHTML(),'Spot Survey Report ‚Äî '+gv('f-reg-no'));
  else if(type==='ri') printHTML(buildRIHTML(),'Reinspection Report ‚Äî '+gv('f-reg-no'));
  else if(type==='fee') printHTML(buildFeeBillHTML(),'Fee Bill ‚Äî '+gv('f-claim-no'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ Google Drive ‚Äî Full Two-Way Sync (Index File approach) ‚îÄ‚îÄ‚îÄ

let driveRootId = null;       // cached SurveyOS root folder ID
let driveIndexFileId = null;  // cached ID of surveyos_index.json

// ‚îÄ‚îÄ Auth & Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDriveClient() {
  const clientId = localStorage.getItem('profile_sp-google-client-id') || gv('sp-google-client-id');
  if (!clientId || typeof google === 'undefined' || !google.accounts) return;
  try {
    gDriveClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file',
      callback: async (resp) => {
        if (resp.error) { showToast('Drive auth failed: ' + resp.error, 'error'); return; }
        gDriveToken = resp.access_token;
        localStorage.setItem('g_drive_token', gDriveToken);
        try {
          const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: 'Bearer ' + gDriveToken } });
          const u = await r.json();
          localStorage.setItem('g_drive_email', u.email || '');
          updateDriveUI(true, u.email || '');
          showToast('Drive connected: ' + (u.email || ''), 'success');
          const dd=document.getElementById('drive-status-detail'); if(dd) dd.textContent='Connected: '+(u.email||'');
        } catch(e) { updateDriveUI(true, ''); }
        // After connecting: load index, reconcile folder links to local claims
        await reconcileDriveClaims();
      }
    });
  } catch(e) { console.warn('Drive init:', e); }
}

function connectDrive() {
  if (!gDriveClient) {
    initDriveClient();
    if (!gDriveClient) { showToast('Add Google Client ID in Surveyor Profile first', 'error'); return; }
  }
  gDriveClient.requestAccessToken();
}

function updateDriveUI(connected, email) {
  const b = document.getElementById('drive-nav-badge');
  if (!b) return;
  b.className = 'drive-badge ' + (connected ? 'connected' : 'disconnected');
  b.textContent = connected ? '‚òÅ ' + (email || 'Drive Connected') : '‚òÅ Drive: Not connected';
  b.title = connected ? 'Click to sync Drive index' : 'Click to connect Google Drive';
  b.onclick = connected ? reconcileDriveClaims : connectDrive;
}

// ‚îÄ‚îÄ Root Folder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getDriveRootId() {
  if (driveRootId) return driveRootId;
  if (!gDriveToken) return null;
  try {
    // Search for existing SurveyOS root folder
    const q = encodeURIComponent("name='SurveyOS' and mimeType='application/vnd.google-apps.folder' and trashed=false");
    const r = await driveGet(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
    if (r.files && r.files.length > 0) {
      driveRootId = r.files[0].id;
    } else {
      // Create it
      const created = await drivePost('https://www.googleapis.com/drive/v3/files', {
        name: 'SurveyOS', mimeType: 'application/vnd.google-apps.folder'
      });
      driveRootId = created.id;
    }
    return driveRootId;
  } catch(e) { console.warn('Drive root:', e); return null; }
}

// ‚îÄ‚îÄ Claim Folder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function createClaimFolder(claimId, survType, regNo) {
  if (!gDriveToken) return null;
  try {
    const rootId = await getDriveRootId();
    if (!rootId) return null;
    const today = new Date().toISOString().split('T')[0];
    const folderName = `${survType.toUpperCase()}-${(regNo||claimId).replace(/[^A-Z0-9]/gi,'-')}-${today}`;
    const created = await drivePost('https://www.googleapis.com/drive/v3/files', {
      name: folderName, mimeType: 'application/vnd.google-apps.folder', parents: [rootId]
    });
    return { id: created.id, name: folderName };
  } catch(e) { console.warn('Drive claim folder:', e); return null; }
}

// ‚îÄ‚îÄ Index File ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// surveyos_index.json in root folder: { "claim_id": { "folderId": "xxx", "folderName": "SPOT-MH15-..." } }

async function loadDriveIndex() {
  if (!gDriveToken) return {};
  try {
    const rootId = await getDriveRootId();
    if (!rootId) return {};
    const q = encodeURIComponent(`name='surveyos_index.json' and '${rootId}' in parents and trashed=false`);
    const r = await driveGet(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
    if (!r.files || r.files.length === 0) return {};
    driveIndexFileId = r.files[0].id;
    // Download file content
    const content = await driveGetRaw(`https://www.googleapis.com/drive/v3/files/${driveIndexFileId}?alt=media`);
    return JSON.parse(content);
  } catch(e) { console.warn('Drive index load:', e); return {}; }
}

async function saveDriveIndex(index) {
  if (!gDriveToken) return;
  try {
    const rootId = await getDriveRootId();
    if (!rootId) return;
    const blob = new Blob([JSON.stringify(index, null, 2)], { type: 'application/json' });
    if (driveIndexFileId) {
      // Update existing file (PATCH ‚Äî no parents needed)
      const form = new FormData();
      form.append('file', blob);
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveIndexFileId}?uploadType=media`, {
        method: 'PATCH', headers: { Authorization: 'Bearer ' + gDriveToken }, body: blob
      });
    } else {
      // Create new index file
      const meta = JSON.stringify({ name: 'surveyos_index.json', parents: [rootId] });
      const form = new FormData();
      form.append('metadata', new Blob([meta], { type: 'application/json' }));
      form.append('file', blob);
      const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
        method: 'POST', headers: { Authorization: 'Bearer ' + gDriveToken }, body: form
      });
      const d = await r.json();
      driveIndexFileId = d.id;
    }
  } catch(e) { console.warn('Drive index save:', e); }
}

// ‚îÄ‚îÄ Reconcile: restore gDriveFolderId for all local claims ‚îÄ‚îÄ
async function reconcileDriveClaims() {
  if (!gDriveToken) return;
  showToast('Syncing Drive folders‚Ä¶', '');
  try {
    const index = await loadDriveIndex();
    const keys = Object.keys(index);
    if (keys.length === 0) { showToast('Drive index empty ‚Äî new claims will be linked automatically', ''); return; }
    const claims = loadClaims();
    let restored = 0;
    for (const claim of claims) {
      if (index[claim.id]) {
        claim.gDriveFolderId = index[claim.id].folderId;
        // If this is the currently open claim, restore gDriveFolderId in memory
        if (claim.id === currentClaimId) gDriveFolderId = claim.gDriveFolderId;
        restored++;
      }
    }
    saveClaims(claims);
    showToast(`Drive sync: ${restored} claim folder${restored!==1?'s':''} linked`, 'success');
  } catch(e) { showToast('Drive sync failed: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ Upload file to a claim's Drive folder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function driveUploadFile(name, blob, folderId) {
  if (!gDriveToken || !folderId) return null;
  try {
    // Check if file already exists in folder ‚Äî update it if so
    const q = encodeURIComponent(`name='${name}' and '${folderId}' in parents and trashed=false`);
    const existing = await driveGet(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`);
    if (existing.files && existing.files.length > 0) {
      // Update existing file
      const fileId = existing.files[0].id;
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
        method: 'PATCH', headers: { Authorization: 'Bearer ' + gDriveToken, 'Content-Type': blob.type || 'application/octet-stream' }, body: blob
      });
      return fileId;
    }
    // Create new file
    const meta = JSON.stringify({ name, parents: [folderId] });
    const form = new FormData();
    form.append('metadata', new Blob([meta], { type: 'application/json' }));
    form.append('file', blob);
    const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
      method: 'POST', headers: { Authorization: 'Bearer ' + gDriveToken }, body: form
    });
    const d = await r.json();
    return d.id;
  } catch(e) { console.warn('Drive upload:', e); return null; }
}

// Upload claim_data.json snapshot to Drive
async function driveBackupClaim(claimData, folderId) {
  if (!gDriveToken || !folderId) return;
  const blob = new Blob([JSON.stringify(claimData, null, 2)], { type: 'application/json' });
  await driveUploadFile('claim_data.json', blob, folderId);
}

// ‚îÄ‚îÄ Drive HTTP helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function driveGet(url) {
  const r = await fetch(url, { headers: { Authorization: 'Bearer ' + gDriveToken } });
  if (!r.ok) throw new Error('Drive GET ' + r.status);
  return r.json();
}
async function driveGetRaw(url) {
  const r = await fetch(url, { headers: { Authorization: 'Bearer ' + gDriveToken } });
  if (!r.ok) throw new Error('Drive GET raw ' + r.status);
  return r.text();
}
async function drivePost(url, body) {
  const r = await fetch(url, {
    method: 'POST', headers: { Authorization: 'Bearer ' + gDriveToken, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error('Drive POST ' + r.status);
  return r.json();
}

// ‚îÄ‚îÄ Open claim folder in browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDriveFolder() {
  if (!gDriveFolderId) { showToast('No Drive folder linked to this claim', 'error'); return; }
  window.open('https://drive.google.com/drive/folders/' + gDriveFolderId, '_blank');
}

window.addEventListener('load', () => {
  setupPDFjs();
  const savedToken=localStorage.getItem('g_drive_token');
  const savedEmail=localStorage.getItem('g_drive_email')||'';
  if(savedToken){gDriveToken=savedToken;updateDriveUI(true,savedEmail);}
  setTimeout(async()=>{
    initDriveClient();
    // After init, if we already have a token, silently reconcile Drive index
    if(gDriveToken){ try{ await reconcileDriveClaims(); }catch(e){} }
  },1500);
  loadProfile();
  refreshDashboard();
  calcFeeTotal();
  // Auto-save on form changes
  let autoSaveTimer;
  document.addEventListener('change', ()=>{
    if(!currentClaimId) return;
    clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      const claims=loadClaims(); const idx=claims.findIndex(c=>c.id===currentClaimId);
      if(idx>=0){claims[idx]=getCurrentClaimData();saveClaims(claims);}
    },3000);
  });
});
</script>
</body>
</html>
