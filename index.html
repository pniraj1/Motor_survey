<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Motor Survey & Loss Assessment System v2</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<!-- PDF.js for converting PDF pages to images before sending to Groq -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Google Identity Services for Drive OAuth -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
  --navy: #0d1b2a; --navy2: #1b2d3e; --teal: #1a7a6e; --teal-light: #22a99a;
  --gold: #c9943a; --gold-light: #e8b95a; --cream: #f7f3ed; --cream2: #ede8df;
  --red: #c0392b; --green: #1e7e52; --text: #1a1a1a; --muted: #6b7280;
  --border: #d4cfc7; --shadow: 0 2px 12px rgba(13,27,42,0.10);
  --shadow-lg: 0 8px 32px rgba(13,27,42,0.16);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

.app-shell { display: flex; min-height: 100vh; }
.sidebar {
  width: 260px; min-width: 260px; background: var(--navy);
  display: flex; flex-direction: column; position: fixed;
  top: 0; left: 0; height: 100vh; z-index: 100; box-shadow: var(--shadow-lg);
}
.sidebar-logo { padding: 22px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.sidebar-logo h1 { font-family: 'Crimson Pro', serif; font-size: 1.2rem; font-weight: 700; color: #fff; line-height: 1.3; }
.sidebar-logo span { font-size: 0.68rem; color: var(--teal-light); font-weight: 400; letter-spacing: 0.08em; text-transform: uppercase; display: block; margin-top: 3px; }
.sidebar-nav { flex: 1; padding: 10px 0; overflow-y: auto; }
.nav-section-label { font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.3); padding: 12px 20px 5px; font-weight: 500; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 20px; cursor: pointer; color: rgba(255,255,255,0.62); font-size: 0.85rem; transition: all 0.15s; border-left: 3px solid transparent; }
.nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; }
.nav-item.active { background: rgba(26,122,110,0.18); color: var(--teal-light); border-left-color: var(--teal-light); font-weight: 500; }
.nav-item .icon { font-size: 0.95rem; width: 18px; text-align: center; }
.sidebar-footer { padding: 14px 20px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 0.68rem; color: rgba(255,255,255,0.28); }

.main-content { margin-left: 260px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
.topbar { background: #fff; border-bottom: 1px solid var(--border); padding: 12px 28px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
.topbar-title { font-family: 'Crimson Pro', serif; font-size: 1.3rem; font-weight: 600; color: var(--navy); }
.topbar-meta { font-size: 0.75rem; color: var(--muted); margin-top: 1px; }
.topbar-actions { display: flex; gap: 8px; align-items: center; }
.autosave-dot { width:8px;height:8px;border-radius:50%;background:var(--muted);display:inline-block;transition:background 0.4s,transform 0.2s; }
.autosave-dot.saving { background:#fbbf24;transform:scale(1.3); }
.autosave-dot.saved  { background:var(--green); }
.autosave-label { font-size:0.68rem;color:var(--muted);letter-spacing:0.03em;transition:color 0.3s; }
.autosave-label.saved { color:var(--green); }
.model-badge { font-size:0.65rem;padding:2px 7px;border-radius:20px;border:1px solid var(--border);color:var(--muted);cursor:pointer;user-select:none;white-space:nowrap;transition:all 0.2s; }
.model-badge:hover { border-color:var(--teal);color:var(--teal); }
.share-fab { position:fixed;bottom:24px;right:24px;z-index:200;background:var(--teal);color:#fff;border:none;border-radius:50px;padding:10px 18px;font-size:0.8rem;font-weight:600;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.18);display:flex;align-items:center;gap:7px;transition:opacity 0.3s,transform 0.2s; }
.share-fab:hover { transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.22); }
.share-fab.hidden { opacity:0;pointer-events:none;transform:translateY(12px); }
.preflight-modal { position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s; }
.preflight-modal.open { opacity:1;pointer-events:all; }
.preflight-box { background:#fff;border-radius:12px;padding:24px;width:440px;max-width:94vw;box-shadow:0 12px 48px rgba(0,0,0,0.22); }
.preflight-row { display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--cream2);font-size:0.83rem; }
.preflight-row:last-child { border:none; }
.preflight-icon { font-size:1rem;width:22px;text-align:center; }
.pwa-banner { position:fixed;bottom:0;left:0;right:0;background:var(--navy);color:#fff;padding:11px 20px;display:flex;align-items:center;justify-content:space-between;z-index:300;font-size:0.82rem;transform:translateY(100%);transition:transform 0.3s; }
.pwa-banner.show { transform:translateY(0); }
.fee-auto-row { background:#f0fdf8;border-radius:8px;padding:10px 14px;font-size:0.8rem;border:1px dashed var(--teal);display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px; }
.page-body { padding: 24px 28px; flex: 1; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* FORMS */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 13px; }
.span-2 { grid-column: 1 / -1; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; color: var(--navy2); }
.form-input, .form-select, .form-textarea { padding: 8px 11px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; color: var(--text); background: #fff; transition: border-color 0.15s; outline: none; }
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(26,122,110,0.09); }
.form-input.ai-filled { border-color: var(--teal); background: #f0fdf8; }
.form-textarea { resize: vertical; min-height: 68px; }

/* CARDS */
.card { background: #fff; border-radius: 10px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; }
.card-header { padding: 13px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%); }
.card-header h3 { font-family: 'Crimson Pro', serif; font-size: 1rem; font-weight: 600; color: #fff; }
.card-header .badge { font-size: 0.67rem; padding: 2px 8px; border-radius: 20px; background: rgba(201,148,58,0.2); color: var(--gold-light); font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase; }
.card-body { padding: 18px; }

/* BUTTONS */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 7px; font-size: 0.83rem; font-weight: 500; cursor: pointer; border: none; font-family: 'DM Sans', sans-serif; transition: all 0.15s; white-space: nowrap; }
.btn-primary { background: var(--teal); color: #fff; }
.btn-primary:hover { background: #155f55; transform: translateY(-1px); }
.btn-secondary { background: #fff; color: var(--navy); border: 1.5px solid var(--border); }
.btn-secondary:hover { border-color: var(--teal); color: var(--teal); }
.btn-gold { background: var(--gold); color: #fff; }
.btn-gold:hover { background: #a87830; }
.btn-danger { background: var(--red); color: #fff; }
.btn-ai { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; }
.btn-ai:hover { background: linear-gradient(135deg, #4f46e5, #7c3aed); transform: translateY(-1px); }
.btn-sm { padding: 5px 11px; font-size: 0.76rem; }
.btn-lg { padding: 11px 26px; font-size: 0.93rem; }

/* VOICE INPUT */
.voice-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.2s; box-shadow: 0 2px 8px rgba(99,102,241,0.3); }
.voice-btn:hover { transform: translateY(-50%) scale(1.05); box-shadow: 0 4px 12px rgba(99,102,241,0.4); }
.voice-btn.recording { background: var(--red); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); } }
.voice-btn.processing { background: #fbbf24; }
.form-group { position: relative; }
.voice-modal-content { max-height: 400px; overflow-y: auto; }

/* ==============================
   DOCUMENT UPLOAD & AI EXTRACTION
   ============================== */
.doc-upload-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;
}
.doc-card {
  border: 2px dashed var(--border); border-radius: 12px;
  background: #fafaf8; transition: all 0.2s; overflow: hidden;
  position: relative;
}
.doc-card:hover { border-color: var(--teal); box-shadow: 0 4px 16px rgba(26,122,110,0.1); }
.doc-card.has-file { border-style: solid; border-color: var(--teal); background: #f0fdf8; }
.doc-card.processing { border-color: #6366f1; background: #f5f3ff; }
.doc-card.done { border-color: var(--green); background: #f0fdf4; }
.doc-card.error { border-color: var(--red); background: #fef2f2; }

.doc-card-header {
  padding: 12px 14px 8px; display: flex; align-items: center; gap: 8px;
}
.doc-type-icon { font-size: 1.4rem; }
.doc-type-label { font-size: 0.78rem; font-weight: 600; color: var(--navy); line-height: 1.2; }
.doc-type-sub { font-size: 0.68rem; color: var(--muted); }

.doc-drop-zone {
  margin: 0 14px 14px; border: 1.5px dashed var(--border);
  border-radius: 8px; padding: 16px 10px; text-align: center;
  cursor: pointer; transition: all 0.18s; background: rgba(255,255,255,0.6);
}
.doc-drop-zone:hover { border-color: var(--teal); background: rgba(26,122,110,0.04); }
.doc-drop-zone .dz-icon { font-size: 1.5rem; margin-bottom: 4px; }
.doc-drop-zone .dz-text { font-size: 0.75rem; color: var(--muted); }
.doc-drop-zone .dz-text strong { color: var(--teal); }

.doc-file-preview {
  margin: 0 14px 10px; display: none;
  border-radius: 6px; overflow: hidden; border: 1px solid var(--border);
}
.doc-file-preview img { width: 100%; max-height: 110px; object-fit: cover; }
.doc-file-preview .pdf-preview {
  background: #fff5f5; padding: 12px; text-align: center;
  font-size: 0.75rem; color: var(--red);
}

.doc-status {
  margin: 0 14px 14px; padding: 8px 10px;
  border-radius: 6px; font-size: 0.75rem; display: none;
}
.doc-status.processing { display: flex; align-items: center; gap: 8px; background: #f5f3ff; color: #6d28d9; }
.doc-status.done { display: flex; align-items: center; gap: 8px; background: #f0fdf4; color: var(--green); }
.doc-status.error { display: flex; align-items: center; gap: 8px; background: #fef2f2; color: var(--red); }

.doc-extracted-fields {
  margin: 0 14px 14px; display: none;
  background: #fff; border: 1px solid #d1fae5; border-radius: 6px;
  padding: 8px 10px;
}
.doc-extracted-fields.show { display: block; }
.extracted-field { font-size: 0.7rem; padding: 2px 0; display: flex; gap: 6px; }
.extracted-field .ef-key { color: var(--muted); flex-shrink: 0; min-width: 80px; }
.extracted-field .ef-val { color: var(--navy); font-weight: 500; word-break: break-word; }

/* spinner */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { width: 14px; height: 14px; border: 2px solid rgba(109,40,217,0.2); border-top-color: #6d28d9; border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
.spinner-green { border-color: rgba(30,126,82,0.2); border-top-color: var(--green); }

/* ASSESSMENT TABLE */
.assess-table-wrap { overflow-x: auto; }
.assess-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 860px; }
.assess-table th { background: var(--navy); color: #fff; padding: 9px 9px; text-align: left; font-size: 0.68rem; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; }
.assess-table td { padding: 7px 9px; border-bottom: 1px solid var(--cream2); vertical-align: middle; }
.assess-table tr:hover td { background: rgba(26,122,110,0.025); }
.assess-table tr.section-row td { background: var(--cream2); font-weight: 600; font-size: 0.72rem; color: var(--navy); text-transform: uppercase; letter-spacing: 0.05em; }
.assess-table tr.total-row td { background: var(--navy); color: #fff; font-weight: 600; }
.assess-table tr.subtotal-row td { background: #e8f5f3; font-weight: 600; color: var(--teal); border-top: 2px solid var(--teal); }
.num-input { width: 85px; padding: 4px 7px; border: 1px solid var(--border); border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 0.78rem; text-align: right; background: #fafaf8; }
.num-input:focus { outline: none; border-color: var(--teal); background: #fff; }
.text-input-cell { width: 100%; min-width: 130px; padding: 4px 7px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.78rem; background: #fafaf8; font-family: 'DM Sans', sans-serif; }
.text-input-cell:focus { outline: none; border-color: var(--teal); background: #fff; }
.mono { font-family: 'DM Mono', monospace; font-size: 0.78rem; }
.allowed-tag { display: inline-block; padding: 2px 7px; border-radius: 3px; font-size: 0.67rem; font-weight: 600; }
.tag-allowed { background: #d1fae5; color: var(--green); }
.tag-partial { background: #fef3c7; color: #92400e; }

/* SUMMARY */
.summary-panel { background: linear-gradient(135deg, var(--navy) 0%, #0a3d62 100%); border-radius: 10px; padding: 20px 22px; color: #fff; }
.summary-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.09); }
.summary-row:last-child { border-bottom: none; }
.summary-label { font-size: 0.82rem; color: rgba(255,255,255,0.68); }
.summary-val { font-family: 'DM Mono', monospace; font-size: 0.87rem; }
.summary-total-row { background: rgba(201,148,58,0.15); border-radius: 6px; padding: 10px 12px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(201,148,58,0.3); }
.summary-total-label { font-family: 'Crimson Pro', serif; font-size: 1.02rem; font-weight: 600; color: var(--gold-light); }
.summary-total-val { font-family: 'DM Mono', monospace; font-size: 1.1rem; font-weight: 600; color: var(--gold-light); }

/* stats */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
.stat-card { background: #fff; border-radius: 10px; padding: 16px 18px; border: 1px solid var(--border); box-shadow: var(--shadow); }
.stat-label { font-size: 0.7rem; color: var(--muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
.stat-value { font-family: 'Crimson Pro', serif; font-size: 1.7rem; font-weight: 700; color: var(--navy); margin: 3px 0 0; }
.stat-sub { font-size: 0.72rem; color: var(--muted); margin-top: 1px; }
.stat-card.accent { background: var(--teal); border-color: var(--teal); }
.stat-card.accent .stat-label { color: rgba(255,255,255,0.72); }
.stat-card.accent .stat-value { color: #fff; }
.stat-card.accent .stat-sub { color: rgba(255,255,255,0.55); }

/* modal */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(13,27,42,0.6); backdrop-filter: blur(3px); z-index: 500; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: #fff; border-radius: 14px; width: 90%; max-width: 520px; box-shadow: var(--shadow-lg); overflow: hidden; animation: modalIn 0.2s ease; }
@keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-head { background: var(--navy); padding: 16px 22px; display: flex; align-items: center; justify-content: space-between; }
.modal-head h2 { font-family: 'Crimson Pro', serif; font-size: 1.05rem; font-weight: 600; color: #fff; }
.modal-close { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; }
.modal-body { padding: 22px; }
.modal-foot { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }

/* sig */
.sig-area { border: 2px dashed var(--border); border-radius: 8px; padding: 16px; text-align: center; background: #fafaf8; cursor: pointer; transition: all 0.2s; }
.sig-area:hover { border-color: var(--teal); }
.sig-preview { max-height: 70px; max-width: 180px; object-fit: contain; }

/* alerts */
.alert { padding: 10px 14px; border-radius: 7px; font-size: 0.82rem; margin-bottom: 14px; display: flex; align-items: flex-start; gap: 9px; }
.alert-info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
.alert-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d; }
.alert-ai { background: #f5f3ff; border: 1px solid #c4b5fd; color: #5b21b6; }

/* toast */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--navy); color: #fff; padding: 11px 18px; border-radius: 8px; font-size: 0.83rem; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 9px; z-index: 9999; transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(.17,.67,.41,1.3); max-width: 340px; }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-left: 4px solid var(--teal-light); }
.toast.error { border-left: 4px solid var(--red); }
.toast.ai { border-left: 4px solid #8b5cf6; }

/* policy toggle */
.policy-toggle { display: inline-flex; border-radius: 7px; overflow: hidden; border: 1.5px solid var(--border); background: var(--cream2); }
.policy-toggle button { padding: 6px 16px; border: none; background: none; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; color: var(--muted); transition: all 0.15s; }
.policy-toggle button.active { background: var(--teal); color: #fff; }

/* dep table */
.dep-table { width: 100%; border-collapse: collapse; font-size: 0.79rem; }
.dep-table th, .dep-table td { padding: 7px 11px; border: 1px solid var(--border); text-align: center; }
.dep-table th { background: var(--cream2); font-weight: 600; color: var(--navy2); font-size: 0.7rem; }

/* report preview */
.report-preview { background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); }
.report-header-bar { background: var(--navy); padding: 9px 18px; display: flex; align-items: center; justify-content: space-between; }
.report-header-bar span { color: rgba(255,255,255,0.68); font-size: 0.78rem; }
.report-doc { padding: 28px; font-family: 'Crimson Pro', serif; font-size: 0.88rem; line-height: 1.6; }

/* progress bar */
.progress-bar-wrap { background: rgba(255,255,255,0.15); border-radius: 4px; height: 4px; margin-top: 6px; overflow: hidden; }
.progress-bar { height: 100%; background: var(--teal-light); border-radius: 4px; transition: width 0.3s; }

/* checklist */
.status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

/* misc */
.text-right { text-align: right; }
.text-center { text-align: center; }
.font-mono { font-family: 'DM Mono', monospace; }
.text-muted { color: var(--muted); }
.mb-4 { margin-bottom: 14px; }
.mb-6 { margin-bottom: 22px; }
.mt-4 { margin-top: 14px; }
.flex { display: flex; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.hidden { display: none !important; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.13); border-radius: 3px; }

/* AI badge on filled fields */
.ai-badge {
  display: inline-flex; align-items: center; gap: 3px;
  font-size: 0.6rem; background: #f5f3ff; color: #6d28d9;
  border: 1px solid #c4b5fd; border-radius: 3px; padding: 1px 5px;
  margin-left: 6px; vertical-align: middle;
}

/* upload area drag states */
.doc-card.dragover { border-color: var(--teal) !important; background: rgba(26,122,110,0.07) !important; transform: scale(1.01); }

/* ‚îÄ‚îÄ GOOGLE DRIVE INTEGRATION ‚îÄ‚îÄ */
.drive-badge {
  display:inline-flex;align-items:center;gap:6px;padding:5px 12px;
  border-radius:20px;font-size:0.72rem;font-weight:600;cursor:pointer;
  border:1.5px solid var(--border);background:#fff;color:var(--muted);
  transition:all 0.2s;white-space:nowrap;
}
.drive-badge:hover { border-color:#4285f4;color:#4285f4; }
.drive-badge.connected { border-color:#34a853;color:#1e7e34;background:#f0fdf4; }
.drive-badge.connected:hover { background:#dcfce7; }
.drive-badge.syncing { border-color:#fbbc04;color:#92400e;background:#fffbeb;animation:drivePulse 1.2s infinite; }
@keyframes drivePulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
.drive-badge .drive-dot { width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0; }

.drive-folder-card {
  background:#fff;border:1px solid var(--border);border-radius:10px;
  overflow:hidden;box-shadow:var(--shadow);margin-bottom:16px;
}
.drive-folder-header {
  padding:14px 18px;background:linear-gradient(135deg,#1a73e8 0%,#0d47a1 100%);
  display:flex;align-items:center;justify-content:space-between;
}
.drive-folder-header h3 { color:#fff;font-family:'Crimson Pro',serif;font-size:1rem;font-weight:600; }
.drive-file-row {
  display:flex;align-items:center;gap:12px;padding:11px 18px;
  border-bottom:1px solid var(--cream2);transition:background 0.12s;
  font-size:0.82rem;
}
.drive-file-row:last-child { border-bottom:none; }
.drive-file-row:hover { background:var(--cream); }
.drive-file-icon { font-size:1.1rem;width:22px;text-align:center;flex-shrink:0; }
.drive-file-name { flex:1;color:var(--navy);font-weight:500; }
.drive-file-size { font-size:0.72rem;color:var(--muted);white-space:nowrap; }
.drive-file-status { font-size:0.72rem;padding:2px 8px;border-radius:12px;white-space:nowrap; }
.drive-file-status.uploaded { background:#dcfce7;color:#15803d; }
.drive-file-status.pending { background:#fef3c7;color:#92400e; }
.drive-file-status.error { background:#fee2e2;color:#dc2626; }
.drive-file-status.uploading { background:#eff6ff;color:#1d4ed8; }

.drive-upload-progress {
  background:var(--cream);border-radius:8px;padding:14px 18px;
  margin-bottom:16px;border:1px solid var(--border);
}
.drive-progress-item { display:flex;align-items:center;gap:10px;padding:5px 0;font-size:0.8rem; }
.drive-progress-item .name { flex:1;color:var(--navy2); }
.drive-progress-item .status { font-size:0.72rem;padding:2px 8px;border-radius:12px; }

.drive-config-overlay { 
  display:none;position:fixed;inset:0;background:rgba(13,27,42,0.65);
  backdrop-filter:blur(4px);z-index:600;align-items:center;justify-content:center;
}
.drive-config-overlay.open { display:flex; }
.drive-config-box {
  background:#fff;border-radius:16px;width:96%;max-width:500px;
  box-shadow:0 20px 60px rgba(0,0,0,0.28);overflow:hidden;
  animation:modalIn 0.22s ease;
}
.drive-config-head {
  background:linear-gradient(135deg,#1a73e8 0%,#0d47a1 100%);
  padding:20px 24px;display:flex;align-items:center;gap:14px;
}
.drive-config-head .gdrive-logo { font-size:1.8rem; }
.drive-config-head h2 { font-family:'Crimson Pro',serif;color:#fff;font-size:1.2rem;font-weight:600; }
.drive-config-head p { color:rgba(255,255,255,0.72);font-size:0.76rem;margin-top:2px; }
.drive-config-body { padding:24px; }
.drive-step { display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--cream2); }
.drive-step:last-child { border-bottom:none; }
.drive-step-num { width:24px;height:24px;border-radius:50%;background:var(--teal);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;flex-shrink:0;margin-top:1px; }
.drive-step-content { flex:1; }
.drive-step-title { font-size:0.82rem;font-weight:600;color:var(--navy);margin-bottom:2px; }
.drive-step-desc { font-size:0.75rem;color:var(--muted);line-height:1.5; }
.drive-step-desc a { color:var(--teal);text-decoration:underline;cursor:pointer; }
.drive-step-desc code { background:var(--cream2);padding:1px 5px;border-radius:3px;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--navy); }

.drive-connect-btn {
  width:100%;padding:11px;background:linear-gradient(135deg,#1a73e8,#0d47a1);
  color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;
  font-size:0.88rem;font-weight:600;cursor:pointer;display:flex;align-items:center;
  justify-content:center;gap:8px;transition:opacity 0.2s;
}
.drive-connect-btn:hover { opacity:0.9; }

.folder-link-badge {
  display:inline-flex;align-items:center;gap:6px;padding:5px 12px;
  background:#eff6ff;border:1px solid #bfdbfe;border-radius:20px;
  font-size:0.75rem;color:#1d4ed8;cursor:pointer;text-decoration:none;
  transition:all 0.2s;
}
.folder-link-badge:hover { background:#dbeafe; }
</style>
</head>
<body>

<div class="toast" id="toast">
  <span id="toast-icon">‚úì</span>
  <span id="toast-msg">Saved</span>
</div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <h1>Motor Survey System</h1>
    <span>AI-Powered Loss Assessment</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Main</div>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="icon">üìä</span> Dashboard</div>
    <div class="nav-item" onclick="showPage('upload')"><span class="icon">ü§ñ</span> AI Document Scan</div>
    <div class="nav-item" onclick="showPage('claim-details')"><span class="icon">üìã</span> Claim Details</div>
    <div class="nav-item" onclick="showPage('assessment')"><span class="icon">üîç</span> Loss Assessment</div>
    <div class="nav-section-label">Reports</div>
    <div class="nav-item" onclick="showPage('spot-survey')"><span class="icon">üìç</span> Spot Survey</div>
    <div class="nav-item" onclick="showPage('survey-report')"><span class="icon">üìÑ</span> Survey Report</div>
    <div class="nav-item" onclick="showPage('bill-check')"><span class="icon">üßæ</span> Bill Check Report</div>
    <div class="nav-item" onclick="showPage('ri-report')"><span class="icon">üîÑ</span> RI Report</div>
    <div class="nav-item" onclick="showPage('fee-bill')"><span class="icon">üí∞</span> Surveyor Fee Bill</div>
    <div class="nav-section-label">Config</div>
    <div class="nav-item" onclick="showPage('surveyor-profile')"><span class="icon">üë§</span> Surveyor Profile</div>
    <div class="nav-item" onclick="showPage('dep-schedule')"><span class="icon">üìâ</span> Depreciation Schedule</div>
    <div class="nav-item" onclick="showPage('drive')"><span class="icon">‚òÅÔ∏è</span> Google Drive</div>
  </nav>
  <div class="sidebar-footer">
    <div>IRDAI Compliant ¬∑ India ¬∑ v2.0</div>
    <div style="margin-top:3px; color:rgba(255,255,255,0.45);">Claude AI ¬∑ Motor/Marine/Engg</div>
  </div>
</aside>

<!-- MAIN -->
<main class="main-content">
  <header class="topbar">
    <div>
      <div class="topbar-title" id="page-title">Dashboard</div>
      <div class="topbar-meta" id="page-meta">Motor Insurance Survey & Loss Assessment</div>
    </div>
    <div class="topbar-actions">
      <div style="display:flex;align-items:center;gap:5px;" title="Auto-saves every 30 seconds">
        <span class="autosave-dot" id="autosave-dot"></span>
        <span class="autosave-label" id="autosave-label">Auto-save on</span>
      </div>
      <div class="drive-badge" id="drive-topbar-badge" onclick="handleDriveBadgeClick()" title="Google Drive Cloud Backup">
        <span class="drive-dot"></span>
        <span id="drive-topbar-label">Connect Drive</span>
      </div>
      <span class="model-badge" id="model-badge" onclick="cycleModel()" title="Click to switch AI model">‚ö° Scout</span>
      <button class="btn btn-ai btn-sm" onclick="showPage('upload')">ü§ñ AI Scan</button>
      <button class="btn btn-secondary btn-sm" onclick="saveAll()">üíæ Save</button>
      <button class="btn btn-gold btn-sm" onclick="preflightThenGenerate()">üìÑ Generate Reports</button>
    </div>
  </header>

  <div class="page-body">

    <!-- ====== DASHBOARD ====== -->
    <div id="page-dashboard" class="tab-panel active">
      <div class="stats-grid">
        <div class="stat-card accent">
          <div class="stat-label">Claim Reference</div>
          <div class="stat-value" id="dash-ref" style="font-size:1.1rem; margin-top:6px;">‚Äî</div>
          <div class="stat-sub">Report No.</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Estimate Amount</div>
          <div class="stat-value" id="dash-est">‚Çπ ‚Äî</div>
          <div class="stat-sub">Garage Estimate</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Assessed Amount</div>
          <div class="stat-value" id="dash-assessed">‚Çπ ‚Äî</div>
          <div class="stat-sub">Surveyor Assessed</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Net Liability</div>
          <div class="stat-value" id="dash-net">‚Çπ ‚Äî</div>
          <div class="stat-sub">After deductions</div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:18px;" id="stats-section">
        <div class="stat-card">
          <div class="stat-label">This Month</div>
          <div class="stat-value" id="stat-month-count">0</div>
          <div class="stat-sub">Surveys Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Assessed</div>
          <div class="stat-value" id="stat-total-assessed">‚Çπ 0</div>
          <div class="stat-sub">This Month</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Assessment</div>
          <div class="stat-value" id="stat-avg-assessed">‚Çπ 0</div>
          <div class="stat-sub">Per Vehicle</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Saved</div>
          <div class="stat-value" id="stat-total-reports">0</div>
          <div class="stat-sub">All Reports</div>
        </div>
      </div>

      <!-- Recent Reports Section -->
      <div class="card" style="margin-top:18px;">
        <div class="card-header">
          <h3>üìã Recent Reports</h3>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-secondary btn-sm" onclick="exportToExcel()" title="Export all reports to Excel">üì§ Export</button>
            <button class="btn btn-secondary btn-sm" onclick="backupToGoogleSheets()" title="Backup to Google Sheets">‚òÅÔ∏è Backup</button>
            <button class="btn btn-secondary btn-sm" onclick="clearCurrentReport()">üÜï New</button>
            <button class="btn btn-secondary btn-sm" onclick="refreshReportsList()">üîÑ</button>
          </div>
        </div>
        <div class="card-body" style="padding:0;">
          <!-- Search Bar -->
          <div style="padding:14px;border-bottom:1px solid var(--border);">
            <div style="position:relative;">
              <input 
                type="text" 
                id="reports-search" 
                class="form-input" 
                placeholder="üîç Search by vehicle, claim no., insured name, or report no..."
                style="width:100%;padding-left:16px;"
                onkeyup="filterReports()"
              />
              <button 
                class="btn btn-secondary btn-sm" 
                onclick="document.getElementById('reports-search').value='';filterReports();" 
                style="position:absolute;right:8px;top:4px;padding:4px 10px;"
                title="Clear search"
              >‚úï</button>
            </div>
          </div>
          
          <div id="reports-list-container">
            <div style="padding:24px;text-align:center;color:var(--muted);">
              <div style="font-size:2.5rem;margin-bottom:10px;">üìÑ</div>
              <div style="font-size:0.88rem;font-weight:500;">No saved reports yet</div>
              <div style="font-size:0.76rem;margin-top:6px;">Complete and save a survey to see it here</div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1.4fr 1fr; gap: 18px; margin-top:18px;">
        <div class="card">
          <div class="card-header"><h3>Claim Summary</h3><span class="badge" id="dash-badge">Draft</span></div>
          <div class="card-body">
            <table style="width:100%; font-size:0.83rem; border-collapse:collapse;">
              <tr><td style="padding:6px 0; color:var(--muted); width:42%;">Insured Name</td><td id="ds-insured" style="font-weight:500;">‚Äî</td></tr>
              <tr><td style="padding:6px 0; color:var(--muted);">Vehicle No.</td><td id="ds-vehicle" style="font-weight:500; font-family:'DM Mono',monospace;">‚Äî</td></tr>
              <tr><td style="padding:6px 0; color:var(--muted);">Make / Model</td><td id="ds-model">‚Äî</td></tr>
              <tr><td style="padding:6px 0; color:var(--muted);">Policy No.</td><td id="ds-policy" style="font-family:'DM Mono',monospace; font-size:0.76rem;">‚Äî</td></tr>
              <tr><td style="padding:6px 0; color:var(--muted);">Claim No.</td><td id="ds-claim" style="font-family:'DM Mono',monospace; font-size:0.76rem;">‚Äî</td></tr>
              <tr><td style="padding:6px 0; color:var(--muted);">Date of Accident</td><td id="ds-doa">‚Äî</td></tr>
              <tr><td style="padding:6px 0; color:var(--muted);">Place of Survey</td><td id="ds-pos">‚Äî</td></tr>
            </table>
          </div>
        </div>
        <div>
          <div class="card mb-4">
            <div class="card-header"><h3>AI Extraction Status</h3></div>
            <div class="card-body" style="padding:14px;">
              <div style="display:flex; flex-direction:column; gap:8px;" id="ai-status-list">
                <div class="flex gap-2" style="align-items:center;"><span class="status-dot" id="ai-rc" style="background:#e5e7eb;"></span><span style="font-size:0.8rem;">RC Book</span></div>
                <div class="flex gap-2" style="align-items:center;"><span class="status-dot" id="ai-dl" style="background:#e5e7eb;"></span><span style="font-size:0.8rem;">Driving Licence</span></div>
                <div class="flex gap-2" style="align-items:center;"><span class="status-dot" id="ai-pol" style="background:#e5e7eb;"></span><span style="font-size:0.8rem;">Policy Document</span></div>
                <div class="flex gap-2" style="align-items:center;"><span class="status-dot" id="ai-claim" style="background:#e5e7eb;"></span><span style="font-size:0.8rem;">Claim Form</span></div>
                <div class="flex gap-2" style="align-items:center;"><span class="status-dot" id="ai-est" style="background:#e5e7eb;"></span><span style="font-size:0.8rem;">Repair Estimate</span></div>
                <div class="flex gap-2" style="align-items:center;"><span class="status-dot" id="ai-photos" style="background:#e5e7eb;"></span><span style="font-size:0.8rem;">Damage Photos</span></div>
              </div>
              <button class="btn btn-ai" style="width:100%;margin-top:14px;justify-content:center;" onclick="showPage('upload')">ü§ñ Go to AI Document Scan</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Quick Actions</h3></div>
            <div class="card-body" style="display:flex; flex-direction:column; gap:7px; padding:14px;">
              <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;" onclick="showPage('upload')">ü§ñ Upload & Auto-Extract Docs</button>
              <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;" onclick="showPage('assessment')">üîç Open Assessment Sheet</button>
              <button class="btn btn-gold" style="width:100%;justify-content:flex-start;" onclick="generateAllReports()">üìÑ Generate All Reports</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== AI DOCUMENT SCAN ====== -->
    <div id="page-upload" class="tab-panel">
      <div class="alert alert-ai" style="margin-bottom:14px;">
        <span>ü§ñ</span>
        <div>
          <strong>AI-Powered Document Extraction</strong> ‚Äî Upload photos or scanned PDFs below.
          Claude AI will instantly read and auto-fill all form fields. Review and edit extracted values before generating reports.
        </div>
      </div>

      <!-- Vehicle Type Toggle -->
      <div class="card mb-6" style="margin-bottom:16px;">
        <div class="card-body" style="padding:14px 18px;">
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
            <span style="font-weight:600;font-size:0.9rem;">Vehicle Type:</span>
            <div class="policy-toggle" id="veh-type-toggle">
              <button class="active" onclick="setVehicleType('commercial')">üöõ Commercial Vehicle</button>
              <button onclick="setVehicleType('private')">üöó Private Vehicle</button>
            </div>
            <span id="veh-type-hint" style="font-size:0.78rem;color:var(--muted);font-style:italic;">Permit, Fitness, Authorisation &amp; Lok Challan upload enabled</span>
          </div>
        </div>
      </div>

      <div class="doc-upload-grid">

        <!-- RC BOOK -->
        <div class="doc-card" id="card-rc"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'rc')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üöó</span>
            <div><div class="doc-type-label">RC Book</div><div class="doc-type-sub">Vehicle Registration Certificate</div></div>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('rc')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> RC Book ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-rc" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'rc')"/>
          <div class="doc-file-preview" id="preview-rc"></div>
          <div class="doc-status" id="status-rc"></div>
          <div class="doc-extracted-fields" id="fields-rc"></div>
        </div>

        <!-- DRIVING LICENCE -->
        <div class="doc-card" id="card-dl"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'dl')">
          <div class="doc-card-header">
            <span class="doc-type-icon">ü™™</span>
            <div><div class="doc-type-label">Driving Licence</div><div class="doc-type-sub">Driver's MDL Details</div></div>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('dl')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> DL ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-dl" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'dl')"/>
          <div class="doc-file-preview" id="preview-dl"></div>
          <div class="doc-status" id="status-dl"></div>
          <div class="doc-extracted-fields" id="fields-dl"></div>
        </div>

        <!-- INSURANCE POLICY -->
        <div class="doc-card" id="card-policy"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'policy')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üìú</span>
            <div><div class="doc-type-label">Insurance Policy</div><div class="doc-type-sub">Policy schedule & terms</div></div>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('policy')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Policy ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-policy" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'policy')"/>
          <div class="doc-file-preview" id="preview-policy"></div>
          <div class="doc-status" id="status-policy"></div>
          <div class="doc-extracted-fields" id="fields-policy"></div>
        </div>

        <!-- CLAIM FORM -->
        <div class="doc-card" id="card-claim"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'claim')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üìù</span>
            <div><div class="doc-type-label">Claim Form</div><div class="doc-type-sub">Motor claim intimation form</div></div>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('claim')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Claim form ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-claim" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'claim')"/>
          <div class="doc-file-preview" id="preview-claim"></div>
          <div class="doc-status" id="status-claim"></div>
          <div class="doc-extracted-fields" id="fields-claim"></div>
        </div>

        <!-- REPAIR ESTIMATE -->
        <div class="doc-card" id="card-estimate"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'estimate')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üîß</span>
            <div><div class="doc-type-label">Repair Estimate / Bill</div><div class="doc-type-sub">Workshop repair estimate</div></div>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('estimate')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Estimate ‚Äî multiple images or PDF (all pages read)</div>
          </div>
          <input type="file" id="upload-estimate" accept=".jpg,.jpeg,.png,.webp,.pdf" multiple style="display:none" onchange="handleDocFile(this,'estimate')"/>
          <div class="doc-file-preview" id="preview-estimate"></div>
          <div class="doc-status" id="status-estimate"></div>
          <div class="doc-extracted-fields" id="fields-estimate"></div>
        </div>

        <!-- DAMAGE PHOTOS -->
        <div class="doc-card" id="card-photos"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'photos')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üì∏</span>
            <div><div class="doc-type-label">Vehicle Damage Photos</div><div class="doc-type-sub">Pre/post repair survey + AI Analysis</div></div>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('photos')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Photos ‚Äî JPG/PNG/PDF</div>
          </div>
          <input type="file" id="upload-photos" accept=".jpg,.jpeg,.png,.webp,.pdf" multiple style="display:none" onchange="handleDocFile(this,'photos')"/>
          <div class="doc-file-preview" id="preview-photos"></div>
          <div class="doc-status" id="status-photos"></div>
          <div class="doc-extracted-fields" id="fields-photos"></div>
          <div style="margin:0 12px 12px;" id="damage-analysis-btn" class="hidden">
            <button class="btn btn-ai btn-sm" style="width:100%;justify-content:center;" onclick="analyzeSavedPhotos()">üîç AI Damage Analysis</button>
          </div>
        </div>

        <!-- PERMIT (Commercial only) -->
        <div class="doc-card commercial-doc" id="card-permit"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'permit')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üìã</span>
            <div><div class="doc-type-label">Permit</div><div class="doc-type-sub">Route/National/State Permit</div></div>
            <span class="badge" style="background:#d97706;color:#fff;font-size:0.6rem;padding:2px 6px;">Commercial</span>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('permit')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Permit ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-permit" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'permit')"/>
          <div class="doc-file-preview" id="preview-permit"></div>
          <div class="doc-status" id="status-permit"></div>
          <div class="doc-extracted-fields" id="fields-permit"></div>
        </div>

        <!-- AUTHORISATION (Commercial only) -->
        <div class="doc-card commercial-doc" id="card-auth"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'auth')">
          <div class="doc-card-header">
            <span class="doc-type-icon">ü™ô</span>
            <div><div class="doc-type-label">Authorisation</div><div class="doc-type-sub">Badge / Authorisation Certificate</div></div>
            <span class="badge" style="background:#d97706;color:#fff;font-size:0.6rem;padding:2px 6px;">Commercial</span>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('auth')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Authorisation ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-auth" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'auth')"/>
          <div class="doc-file-preview" id="preview-auth"></div>
          <div class="doc-status" id="status-auth"></div>
          <div class="doc-extracted-fields" id="fields-auth"></div>
        </div>

        <!-- FITNESS (Commercial only) -->
        <div class="doc-card commercial-doc" id="card-fitness-doc"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'fitness')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üî©</span>
            <div><div class="doc-type-label">Fitness Certificate</div><div class="doc-type-sub">Vehicle Roadworthiness Certificate</div></div>
            <span class="badge" style="background:#d97706;color:#fff;font-size:0.6rem;padding:2px 6px;">Commercial</span>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('fitness')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Fitness Cert ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-fitness" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'fitness')"/>
          <div class="doc-file-preview" id="preview-fitness"></div>
          <div class="doc-status" id="status-fitness"></div>
          <div class="doc-extracted-fields" id="fields-fitness"></div>
        </div>

        <!-- LOK CHALLAN (Commercial only) -->
        <div class="doc-card commercial-doc" id="card-lok-challan"
          ondragover="event.preventDefault();this.classList.add('dragover')"
          ondragleave="this.classList.remove('dragover')"
          ondrop="handleDocDrop(event,'lok-challan')">
          <div class="doc-card-header">
            <span class="doc-type-icon">üì¶</span>
            <div><div class="doc-type-label">Lok Challan</div><div class="doc-type-sub">Goods/Load Challan Document</div></div>
            <span class="badge" style="background:#d97706;color:#fff;font-size:0.6rem;padding:2px 6px;">Commercial</span>
          </div>
          <div class="doc-drop-zone" onclick="triggerDocUpload('lok-challan')">
            <div class="dz-icon">üì§</div>
            <div class="dz-text"><strong>Click or drag</strong> Lok Challan ‚Äî photo or PDF</div>
          </div>
          <input type="file" id="upload-lok-challan" accept=".jpg,.jpeg,.png,.webp,.pdf" style="display:none" onchange="handleDocFile(this,'lok-challan')"/>
          <div class="doc-file-preview" id="preview-lok-challan"></div>
          <div class="doc-status" id="status-lok-challan"></div>
          <div class="doc-extracted-fields" id="fields-lok-challan"></div>
        </div>

      </div><!-- end doc-upload-grid -->

      <!-- OVERALL PROGRESS -->
      <div class="card mt-4" style="margin-top:18px;" id="extraction-progress-card" style="display:none;">
        <div class="card-header"><h3>Extraction Progress</h3></div>
        <div class="card-body">
          <div id="extraction-log" style="font-size:0.8rem; max-height:180px; overflow-y:auto; font-family:'DM Mono',monospace; color:var(--navy2); line-height:1.8;"></div>
          <div id="go-to-form-btn" class="hidden" style="margin-top:14px;">
            <button class="btn btn-primary" onclick="showPage('claim-details')">‚úÖ Review Extracted Data ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== CLAIM DETAILS ====== -->
    <div id="page-claim-details" class="tab-panel">
      <div class="alert alert-ai">
        <span>ü§ñ</span>
        <span>Fields marked with <span class="ai-badge">‚ú® AI</span> were auto-filled from uploaded documents. Review and correct as needed before generating reports.</span>
      </div>
      <div class="alert alert-info" style="margin-bottom:14px;">
        <span>üé§</span>
        <span><strong>Voice Input with AI Verification</strong> ‚Äî Click the microphone button on any field to speak your input. Claude AI will verify, format, and clean up your speech before filling the field.</span>
      </div>

      <div class="card mb-6">
        <div class="card-header"><h3>Policy & Claim Information</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Report No.</label><input class="form-input" id="f-report-no" placeholder="e.g. MOTOR-785/2026"/></div>
            <div class="form-group"><label class="form-label">Report Date</label><input class="form-input" type="date" id="f-report-date"/></div>
            <div class="form-group"><label class="form-label">Policy No.</label><input class="form-input" id="f-policy-no" placeholder="Policy number"/></div>
            <div class="form-group"><label class="form-label">Claim No.</label><input class="form-input" id="f-claim-no" placeholder="Claim reference"/></div>
            <div class="form-group"><label class="form-label">Policy Period From</label><input class="form-input" type="date" id="f-policy-from"/></div>
            <div class="form-group"><label class="form-label">Policy Period To</label><input class="form-input" type="date" id="f-policy-to"/></div>
            <div class="form-group"><label class="form-label">IDV (‚Çπ)</label><input class="form-input" id="f-idv" type="number"/></div>
            <div class="form-group"><label class="form-label">Type of Policy</label><select class="form-select" id="f-policy-type"><option>Goods Carrying Vehicle Package Policy</option><option>Private Car Package Policy</option><option>Two Wheeler Package Policy</option><option>Commercial Vehicle Package Policy</option><option>Standalone OD Policy</option></select></div>
            <div class="form-group"><label class="form-label">Depreciation Type</label><div class="policy-toggle" id="dep-toggle"><button class="active" onclick="setDepType('nil')">Nil Dep (0%)</button><button onclick="setDepType('standard')">Standard Dep</button></div></div>
            <div class="form-group"><label class="form-label">Policy Issuing Office</label><input class="form-input" id="f-policy-office"/></div>
            <div class="form-group span-2"><label class="form-label">Insurer Name &amp; Address</label><input class="form-input" id="f-insurer" placeholder="Insurance company name and address"/></div>
            <div class="form-group"><label class="form-label">Appointing Office</label><input class="form-input" id="f-appt-office"/></div>
          </div>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header"><h3>Insured Details</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Insured Name</label><input class="form-input" id="f-insured-name"/></div>
            <div class="form-group"><label class="form-label">Mobile No.</label><input class="form-input" id="f-insured-mobile"/></div>
            <div class="form-group span-2"><label class="form-label">Address</label><input class="form-input" id="f-insured-addr"/></div>
            <div class="form-group"><label class="form-label">HPA / Finance With</label><input class="form-input" id="f-hpa"/></div>
          </div>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header"><h3>Vehicle Particulars</h3><span class="badge">RC Verified</span></div>
        <div class="card-body">
          <div class="form-grid-3">
            <div class="form-group"><label class="form-label">Registration No.</label><input class="form-input" id="f-reg-no" style="text-transform:uppercase;"/></div>
            <div class="form-group"><label class="form-label">Date of Registration</label><input class="form-input" type="date" id="f-reg-date" onchange="if(depType==='standard')setDepType('standard')"/></div>
            <div class="form-group"><label class="form-label">Class of Vehicle</label><select class="form-select" id="f-veh-class"><option>LGV</option><option>HGV</option><option>Car</option><option>Two Wheeler</option><option>Bus</option><option>Taxi</option></select></div>
            <div class="form-group"><label class="form-label">Make</label><input class="form-input" id="f-make"/></div>
            <div class="form-group"><label class="form-label">Model / Variant</label><input class="form-input" id="f-model"/></div>
            <div class="form-group"><label class="form-label">Year of Manufacture</label><input class="form-input" id="f-year" type="number"/></div>
            <div class="form-group"><label class="form-label">Chassis No.</label><input class="form-input" id="f-chassis" style="text-transform:uppercase;"/></div>
            <div class="form-group"><label class="form-label">Engine No.</label><input class="form-input" id="f-engine" style="text-transform:uppercase;"/></div>
            <div class="form-group"><label class="form-label">Cubic Capacity / HP</label><input class="form-input" id="f-cc"/></div>
            <div class="form-group"><label class="form-label">Type of Body</label><input class="form-input" id="f-body-type"/></div>
            <div class="form-group"><label class="form-label">Colour</label><input class="form-input" id="f-colour"/></div>
            <div class="form-group"><label class="form-label">Fuel Type</label><select class="form-select" id="f-fuel"><option>Diesel</option><option>Petrol</option><option>CNG</option><option>Electric</option><option>Hybrid</option></select></div>
            <div class="form-group"><label class="form-label">Odometer (KM)</label><input class="form-input" id="f-odo" type="number"/></div>
            <div class="form-group"><label class="form-label">RLW / Seating Capacity</label><input class="form-input" id="f-rlw"/></div>
            <div class="form-group"><label class="form-label">Pre-accident Condition</label><select class="form-select" id="f-condition"><option>New</option><option>Good</option><option>Fair</option><option>Poor</option></select></div>
            <div class="form-group"><label class="form-label">Fitness Cert No.</label><input class="form-input" id="f-fitness"/></div>
            <div class="form-group"><label class="form-label">Route / Area</label><input class="form-input" id="f-route"/></div>
            <div class="form-group"><label class="form-label">Road Tax</label><select class="form-select" id="f-roadtax"><option>LTT</option><option>Lifetime</option><option>Annual</option></select></div>
          </div>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header"><h3>Driver's Particulars</h3><span class="badge">MDL Verified</span></div>
        <div class="card-body">
          <div class="form-grid-3">
            <div class="form-group"><label class="form-label">Driver Name</label><input class="form-input" id="f-driver-name"/></div>
            <div class="form-group"><label class="form-label">Relation</label>
              <select class="form-select" id="f-dl-relation">
                <option value="S/o">S/o (Son of)</option>
                <option value="D/o">D/o (Daughter of)</option>
                <option value="W/o">W/o (Wife of)</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label">Father / Husband Name</label><input class="form-input" id="f-dl-parent" placeholder="Parent or spouse name"/></div>
            <div class="form-group"><label class="form-label">MDL No.</label><input class="form-input" id="f-mdl"/></div>
            <div class="form-group"><label class="form-label">Date of Birth</label><input class="form-input" type="date" id="f-dob"/></div>
            <div class="form-group"><label class="form-label">Date of Issue</label><input class="form-input" type="date" id="f-dl-issue"/></div>
            <div class="form-group"><label class="form-label">Non-Transport Validity (LMV)</label><input class="form-input" type="date" id="f-dl-valid" placeholder="Non-transport expiry"/></div>
            <div class="form-group"><label class="form-label">Transport Validity (HMV/TRANS)</label><input class="form-input" type="date" id="f-dl-valid-transport" placeholder="Transport expiry"/></div>
            <div class="form-group"><label class="form-label">Issuing Authority</label><input class="form-input" id="f-dl-auth"/></div>
            <div class="form-group"><label class="form-label">Type of License (Classes)</label><input class="form-input" id="f-dl-type"/></div>
          </div>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header"><h3>Accident &amp; Survey Details</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Date &amp; Time of Accident</label><input class="form-input" id="f-doa" type="datetime-local" onchange="if(depType==='standard')setDepType('standard')"/></div>
            <div class="form-group"><label class="form-label">Place of Accident</label><input class="form-input" id="f-poa"/></div>
            <div class="form-group"><label class="form-label">Date of Survey Allotment</label><input class="form-input" type="date" id="f-allot-date"/></div>
            <div class="form-group"><label class="form-label">Date of Survey</label><input class="form-input" id="f-survey-date"/></div>
            <div class="form-group span-2"><label class="form-label">Place of Survey (Workshop)</label><input class="form-input" id="f-survey-place"/></div>
            <div class="form-group span-2"><label class="form-label">Cause &amp; Nature of Accident</label><textarea class="form-textarea" id="f-cause"></textarea></div>
            <div class="form-group"><label class="form-label">Third Party Details</label><input class="form-input" id="f-tp" placeholder="Nil or details"/></div>
          </div>
        </div>
      </div>

      <!-- Signature & Stamp -->
      <div class="card mb-6">
        <div class="card-header"><h3>üîè Surveyor Signature &amp; Stamp</h3></div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
            <div>
              <div class="form-label mb-4" style="margin-bottom:8px;">Signature Image</div>
              <div class="sig-area" onclick="document.getElementById('sig-upload').click()">
                <div id="sig-placeholder"><div style="font-size:1.8rem;margin-bottom:5px;">‚úçÔ∏è</div><div style="font-size:0.78rem;color:var(--muted);">Click to upload signature</div></div>
                <img id="sig-preview-img" class="sig-preview hidden"/>
              </div>
              <input type="file" id="sig-upload" accept=".png,.jpg,.jpeg" style="display:none" onchange="handleSigUpload(this)"/>
            </div>
            <div>
              <div class="form-label mb-4" style="margin-bottom:8px;">Stamp Image</div>
              <div class="sig-area" onclick="document.getElementById('stamp-upload').click()">
                <div id="stamp-placeholder"><div style="font-size:1.8rem;margin-bottom:5px;">üîµ</div><div style="font-size:0.78rem;color:var(--muted);">Click to upload stamp</div></div>
                <img id="stamp-preview-img" class="sig-preview hidden"/>
              </div>
              <input type="file" id="stamp-upload" accept=".png,.jpg,.jpeg" style="display:none" onchange="handleStampUpload(this)"/>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button class="btn btn-secondary" onclick="showPage('upload')">‚Üê Back to Document Scan</button>
        <button class="btn btn-primary" onclick="showPage('assessment')">Save &amp; Continue to Assessment ‚Üí</button>
      </div>
    </div>

    <!-- ====== ASSESSMENT ====== -->
    <div id="page-assessment" class="tab-panel">
      <div class="flex-between mb-4">
        <div class="alert alert-ai" style="margin:0;flex:1;margin-right:14px;">
          <span>‚ö°</span>
          <span>If a Repair Estimate was uploaded, line items are <strong>auto-filled from AI extraction</strong>. Enter Assessed amounts to complete the assessment.</span>
        </div>
        <div style="display:flex;gap:7px;">
          <button class="btn btn-secondary btn-sm" onclick="addAssessRow('parts')">+ Part</button>
          <button class="btn btn-secondary btn-sm" onclick="addAssessRow('labour')">+ Labour</button>
          <button class="btn btn-secondary btn-sm" onclick="addAssessRow('paint')">+ Paint</button>
        </div>
      </div>

      <div class="card mb-6">
        <div class="card-header"><h3>Assessment Sheet</h3><span class="badge" id="assess-policy-badge">0% Dep. Policy</span></div>
        <div class="card-body" style="padding:0;">
          <div class="assess-table-wrap">
            <table class="assess-table" id="assess-table">
              <thead>
                <tr>
                  <th style="width:28px;">Sr.</th>
                  <th>Particulars</th>
                  <th style="width:80px;text-align:center;">Part Type</th>
                  <th style="width:62px;text-align:center;">GST%</th>
                  <th style="width:90px;text-align:right;">Estimated ‚Çπ</th>
                  <th style="width:90px;text-align:right;">Assessed ‚Çπ</th>
                  <th style="width:52px;text-align:center;">Dep%</th>
                  <th style="width:90px;text-align:right;">After Dep ‚Çπ</th>
                  <th style="width:70px;text-align:center;">Status</th>
                  <th style="width:36px;"></th>
                </tr>
              </thead>
              <tbody id="assess-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
        <div class="summary-panel">
          <div style="font-family:'Crimson Pro',serif;font-size:1.05rem;font-weight:600;margin-bottom:12px;color:var(--gold-light);">Assessment Summary</div>
          <div class="summary-row"><span class="summary-label">I) Total Parts (Base)</span><span class="summary-val" id="sum-parts-base">‚Çπ 0.00</span></div>
          <div class="summary-row"><span class="summary-label">+ CGST 9%</span><span class="summary-val" id="sum-parts-cgst">‚Çπ 0.00</span></div>
          <div class="summary-row"><span class="summary-label">+ SGST 9%</span><span class="summary-val" id="sum-parts-sgst">‚Çπ 0.00</span></div>
          <div class="summary-row" style="border-top:2px solid rgba(255,255,255,0.18);padding-top:8px;"><span class="summary-label" style="font-weight:600;">Total Parts (incl. GST)</span><span class="summary-val" id="sum-parts-total">‚Çπ 0.00</span></div>
          <div class="summary-row"><span class="summary-label">II) Total Labour (Base)</span><span class="summary-val" id="sum-labour-base">‚Çπ 0.00</span></div>
          <div class="summary-row"><span class="summary-label">+ GST 18%</span><span class="summary-val" id="sum-labour-gst">‚Çπ 0.00</span></div>
          <div class="summary-row" style="border-top:2px solid rgba(255,255,255,0.18);padding-top:8px;"><span class="summary-label" style="font-weight:600;">Total Labour (incl. GST)</span><span class="summary-val" id="sum-labour-total">‚Çπ 0.00</span></div>
          <div class="summary-row"><span class="summary-label">Grand Total (I+II)</span><span class="summary-val" id="sum-grand">‚Çπ 0.00</span></div>
          <div class="summary-row"><span class="summary-label">Less: Salvage ‚Çπ</span>
            <span><input id="sum-salvage" type="number" value="0" style="width:65px;background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,0.4);color:#fff;font-family:'DM Mono',monospace;font-size:0.85rem;text-align:right;" onchange="recalcSummary()"/></span></div>
          <div class="summary-row"><span class="summary-label">Less: Excess ‚Çπ</span>
            <span><input id="sum-excess" type="number" value="500" style="width:65px;background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,0.4);color:#fff;font-family:'DM Mono',monospace;font-size:0.85rem;text-align:right;" onchange="recalcSummary()"/></span></div>
          <div class="summary-total-row">
            <span class="summary-total-label">NET ASSESSED LOSS</span>
            <span class="summary-total-val" id="sum-net">‚Çπ 0.00</span>
          </div>
          <div style="margin-top:8px;font-size:0.72rem;color:rgba(255,255,255,0.45);font-style:italic;" id="sum-inwords">‚Äî</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div class="card">
            <div class="card-header"><h3>Estimate vs Assessed</h3></div>
            <div class="card-body">
              <table style="width:100%;font-size:0.82rem;border-collapse:collapse;">
                <tr><td style="padding:5px 0;color:var(--muted);">Original Estimate</td><td class="text-right mono" id="cmp-est">‚Çπ 0.00</td></tr>
                <tr><td style="padding:5px 0;color:var(--muted);">Assessed Amount</td><td class="text-right mono" style="color:var(--teal);" id="cmp-ass">‚Çπ 0.00</td></tr>
                <tr style="border-top:1px solid var(--border);"><td style="padding:7px 0;font-weight:600;">Difference</td><td class="text-right mono" style="color:var(--red);font-weight:600;" id="cmp-diff">‚Çπ 0.00</td></tr>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Parts Breakdown</h3></div>
            <div class="card-body">
              <table style="width:100%;font-size:0.82rem;border-collapse:collapse;">
                <tr><td style="padding:5px 0;color:var(--muted);">Nil Dep. Metal</td><td class="text-right mono" id="bd-metal">‚Çπ 0.00</td></tr>
                <tr><td style="padding:5px 0;color:var(--muted);">Nil Dep. Plastic/Rubber</td><td class="text-right mono" id="bd-plastic">‚Çπ 0.00</td></tr>
                <tr><td style="padding:5px 0;color:var(--muted);">Glass 0%</td><td class="text-right mono" id="bd-glass">‚Çπ 0.00</td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SPOT SURVEY ====== -->
    <div id="page-spot-survey" class="tab-panel">
      <div class="flex-between mb-4">
        <div class="alert alert-info" style="margin:0;flex:1;margin-right:14px;">
          <span>üìç</span>
          <span><strong>Spot Survey Report</strong> ‚Äî Independent on-the-spot accident inspection. This report is generated and filed separately from the Final Survey Report.</span>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:7px;">
          <button class="btn btn-gold" onclick="generateSpotSurveyPDF()">üìÑ Generate &amp; Print PDF</button>
          <label style="font-size:0.72rem;color:var(--muted);display:flex;align-items:center;gap:5px;cursor:pointer;">
            <input type="checkbox" id="attach-docs-spot" checked style="accent-color:var(--gold);"/>
            Include photos &amp; documents as enclosures
          </label>
        </div>
      </div>

      <!-- Report Header -->
      <div class="card mb-4">
        <div class="card-header"><h3>Report Details</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Spot Report No.</label><input class="form-input" id="spot-report-no" placeholder="e.g. SPO/463/2025"/></div>
            <div class="form-group"><label class="form-label">Date of Report</label><input class="form-input" type="date" id="spot-report-date"/></div>
            <div class="form-group"><label class="form-label">Date of Allotment</label><input class="form-input" type="date" id="spot-allot-date"/></div>
            <div class="form-group"><label class="form-label">Date &amp; Time of Survey</label><input class="form-input" type="datetime-local" id="spot-survey-datetime"/></div>
          </div>
        </div>
      </div>

      <!-- Accident Details -->
      <div class="card mb-4">
        <div class="card-header"><h3>Accident Details</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Date &amp; Time of Accident</label><input class="form-input" type="datetime-local" id="spot-accident-datetime"/></div>
            <div class="form-group"><label class="form-label">Place of Accident</label><input class="form-input" id="spot-accident-place" placeholder="Location details"/></div>
            <div class="form-group"><label class="form-label">Place of Survey (Workshop)</label><input class="form-input" id="spot-survey-place" placeholder="Survey location"/></div>
            <div class="form-group span-2"><label class="form-label">Cause &amp; Nature of Accident</label><textarea class="form-textarea" id="spot-accident-cause" rows="3" placeholder="Describe how the accident occurred..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Driver's Particulars -->
      <div class="card mb-4">
        <div class="card-header">
          <h3>Driver's Particulars &amp; DL Verification</h3>
          <span class="badge" id="dl-validity-badge" style="background:var(--muted);">Not Verified</span>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Driver Name</label><input class="form-input" id="spot-driver-name" placeholder="Full name" onchange="checkDLValidity()"/></div>
            <div class="form-group"><label class="form-label">Relation</label>
              <select class="form-select" id="spot-dl-relation">
                <option value="S/o">S/o (Son of)</option>
                <option value="D/o">D/o (Daughter of)</option>
                <option value="W/o">W/o (Wife of)</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label">Father / Husband Name</label><input class="form-input" id="spot-dl-parent" placeholder="Parent or spouse name"/></div>
            <div class="form-group"><label class="form-label">MDL Number</label><input class="form-input" id="spot-mdl-no" placeholder="e.g. RJ0520160011747" onchange="checkDLValidity()"/></div>
            <div class="form-group"><label class="form-label">Issuing Authority</label><input class="form-input" id="spot-dl-authority" placeholder="RTO/Sub Office"/></div>
            <div class="form-group"><label class="form-label">Date of Issue</label><input class="form-input" type="date" id="spot-dl-issue" onchange="checkDLValidity()"/></div>
            <div class="form-group"><label class="form-label">Non-Transport Valid Upto (LMV)</label><input class="form-input" type="date" id="spot-dl-valid" onchange="checkDLValidity()"/></div>
            <div class="form-group"><label class="form-label">Transport Valid Upto (HMV/TRANS)</label><input class="form-input" type="date" id="spot-dl-valid-transport" onchange="checkDLValidity()"/></div>
            <div class="form-group"><label class="form-label">Type of Licence (Classes)</label><input class="form-input" id="spot-dl-type" placeholder="LMV, MCWG, TRANS, HMV"/></div>
            <div class="form-group"><label class="form-label">MDL Verification Status</label>
              <select class="form-select" id="spot-mdl-verified" onchange="checkDLValidity()">
                <option value="verified">Original MDL Verified</option>
                <option value="photocopy">Photocopy Verified</option>
                <option value="not-available">Not Available</option>
              </select>
            </div>
            <div class="form-group span-2" id="dl-invalid-remarks-section" style="display:none;">
              <label class="form-label" style="color:var(--red);font-weight:600;">‚ö†Ô∏è DL Invalid ‚Äî Mandatory Remarks</label>
              <textarea class="form-textarea" id="spot-dl-invalid-remarks" rows="2" placeholder="Explain DL invalidity (expired, wrong class, not present, etc.)..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Commercial Vehicle Docs Section -->
      <div class="card mb-4" id="spot-commercial-section">
        <div class="card-header"><h3>üöõ Commercial Vehicle Documents</h3><span class="badge" style="background:#d97706;color:#fff;">Commercial Only</span></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Permit No.</label><input class="form-input" id="spot-permit-no" placeholder="e.g. RJ/14/GEN/2245"/></div>
            <div class="form-group"><label class="form-label">Permit Type</label><input class="form-input" id="spot-permit-type" placeholder="National/State/Route"/></div>
            <div class="form-group"><label class="form-label">Permit Valid From</label><input class="form-input" type="date" id="spot-permit-from"/></div>
            <div class="form-group"><label class="form-label">Permit Valid Upto</label><input class="form-input" type="date" id="spot-permit-to"/></div>
            <div class="form-group"><label class="form-label">Authorisation No.</label><input class="form-input" id="spot-auth-no" placeholder="Badge/Auth number"/></div>
            <div class="form-group"><label class="form-label">Auth Valid Upto</label><input class="form-input" type="date" id="spot-auth-valid"/></div>
            <div class="form-group"><label class="form-label">Fitness Cert. No.</label><input class="form-input" id="spot-fitness-no" placeholder="Fitness certificate number"/></div>
            <div class="form-group"><label class="form-label">Fitness Valid Upto</label><input class="form-input" type="date" id="spot-fitness-valid"/></div>
          </div>
        </div>
      </div>

      <!-- Load / Lok Challan -->
      <div class="card mb-4" id="spot-challan-section">
        <div class="card-header"><h3>Load / Lok Challan Details</h3><span class="badge" style="background:#d97706;color:#fff;">Commercial Only</span></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">CN/Challan Number</label><input class="form-input" id="spot-cn-no" placeholder="e.g. 340867"/></div>
            <div class="form-group"><label class="form-label">CN Date</label><input class="form-input" type="date" id="spot-cn-date"/></div>
            <div class="form-group"><label class="form-label">Gross Vehicle Weight ‚Äî GVW (KG)</label>
          <input class="form-input" type="number" id="spot-gvw" placeholder="From RC/Fitness e.g. 25000" oninput="calcLoadCapacity()"/>
        </div>
        <div class="form-group"><label class="form-label">Unladen Weight ‚Äî ULW (KG)</label>
          <input class="form-input" type="number" id="spot-ulw" placeholder="Tare weight e.g. 8500" oninput="calcLoadCapacity()"/>
        </div>
        <div class="form-group"><label class="form-label">Load Carrying Capacity (KG) <span style="font-size:0.7rem;color:var(--muted);">= GVW ‚àí ULW</span></label>
          <input class="form-input" type="number" id="spot-load-capacity" placeholder="Auto-calculated or enter manually" style="font-weight:600;"/>
        </div>
        <div class="form-group"><label class="form-label">Actual Load at Time of Accident (KG)</label>
          <input class="form-input" type="number" id="spot-actual-load" placeholder="e.g. 17500"/>
        </div>
            <div class="form-group"><label class="form-label">Origin</label><input class="form-input" id="spot-load-origin" placeholder="Loading point"/></div>
            <div class="form-group"><label class="form-label">Destination</label><input class="form-input" id="spot-load-dest" placeholder="Delivery point"/></div>
            <div class="form-group span-2"><label class="form-label">Load Description (Goods)</label><textarea class="form-textarea" id="spot-load-desc" rows="2" placeholder="Nature of goods, quantity, consignee..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Police Case -->
      <div class="card mb-4">
        <div class="card-header"><h3>Police Case Particulars</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Reported to Police?</label>
              <select class="form-select" id="spot-police-reported"><option value="no">No</option><option value="yes">Yes</option></select>
            </div>
            <div class="form-group"><label class="form-label">Police Station</label><input class="form-input" id="spot-police-station" placeholder="Station name"/></div>
            <div class="form-group"><label class="form-label">Station Diary / FIR No.</label><input class="form-input" id="spot-diary-no" placeholder="FIR/Diary number"/></div>
            <div class="form-group"><label class="form-label">Panchanama Done?</label>
              <select class="form-select" id="spot-panchanama"><option value="no">No</option><option value="yes">Yes</option></select>
            </div>
          </div>
        </div>
      </div>

      <!-- Third Party -->
      <div class="card mb-4">
        <div class="card-header"><h3>Third Party Details</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Third Party Involved?</label>
              <select class="form-select" id="spot-tp-involved">
                <option value="no">No</option>
                <option value="tppd">TPPD (Property Damage)</option>
                <option value="tppi">TPPI (Personal Injury)</option>
                <option value="both">Both TPPD &amp; TPPI</option>
              </select>
            </div>
            <div class="form-group span-2"><label class="form-label">Third Party Details</label><textarea class="form-textarea" id="spot-tp-details" rows="2" placeholder="Vehicle number, driver details, injury/damage details..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Damage at Spot -->
      <div class="card mb-4">
        <div class="card-header"><h3>Damage Assessment at Spot</h3></div>
        <div class="card-body">
          <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:18px;">
            <div class="form-group"><label class="form-label">Damage Severity</label>
              <select class="form-select" id="spot-damage-severity"><option value="minor">Minor</option><option value="moderate">Moderate</option><option value="major">Major</option></select>
            </div>
            <div class="form-group"><label class="form-label">Airbags Deployed</label>
              <select class="form-select" id="spot-airbags"><option value="no">No</option><option value="yes">Yes</option></select>
            </div>
            <div class="form-group"><label class="form-label">Vehicle Drivable</label>
              <select class="form-select" id="spot-drivable"><option value="yes">Yes</option><option value="no">No ‚Äî Towed</option><option value="limited">Limited ‚Äî Cautiously</option></select>
            </div>
          </div>
          <div style="background:var(--navy);color:white;padding:10px 14px;border-radius:6px 6px 0 0;display:grid;grid-template-columns:200px 1fr 50px;gap:12px;font-weight:600;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;">
            <div>System / Component</div><div>Damage Observed at Spot</div><div>Del</div>
          </div>
          <div id="spot-damage-rows" style="border:1px solid var(--border);border-top:none;border-radius:0 0 6px 6px;"></div>
          <button class="btn btn-secondary" style="margin-top:12px;" onclick="addSpotDamageRow()">+ Add Component</button>
          <div class="form-group" style="margin-top:18px;">
            <label class="form-label">Additional Comments / Vehicle will be shifted to</label>
            <textarea class="form-textarea" id="spot-comments" rows="3" placeholder="Vehicle will be shifted to... Garage inspection required for... Any hidden damages to be noted during dismantling..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SURVEY REPORT ====== -->
    <div id="page-survey-report" class="tab-panel">
      <div class="flex-between mb-4">
        <div class="alert alert-success" style="margin:0;flex:1;margin-right:14px;"><span>‚úÖ</span><span>Final Survey Report preview. Click <strong>Generate PDF</strong> to download.</span></div>
        <div style="display:flex;gap:7px;flex-direction:column;align-items:flex-end;">
          <div style="display:flex;gap:7px;">
            <button class="btn btn-secondary" onclick="refreshReportPreview()">üîÑ Refresh</button>
            <button class="btn btn-secondary" id="drive-survey-btn" onclick="quickSaveToDrive('survey')" style="border-color:#1a73e8;color:#1a73e8;" title="Save to Google Drive">‚òÅÔ∏è Drive</button>
            <button class="btn btn-gold btn-lg" onclick="generateSurveyReportPDF()">üìÑ Generate PDF</button>
          </div>
          <label style="font-size:0.72rem;color:var(--muted);display:flex;align-items:center;gap:5px;cursor:pointer;">
            <input type="checkbox" id="attach-docs-survey" checked style="accent-color:var(--gold);"/>
            Include photos &amp; documents as enclosures
          </label>
        </div>
      </div>
      <div class="report-preview">
        <div class="report-header-bar"><span>Final Survey Report ‚Äî Preview</span><span id="rp-report-no">‚Äî</span></div>
        <div class="report-doc" id="survey-report-html"><div style="text-align:center;padding:36px;color:var(--muted);"><div style="font-size:1.8rem;margin-bottom:10px;">üìã</div><div>Fill in claim details to preview</div><button class="btn btn-primary mt-4" style="margin-top:14px;" onclick="refreshReportPreview()">Generate Preview</button></div></div>
      </div>
    </div>

    <!-- ====== BILL CHECK ====== -->
    <div id="page-bill-check" class="tab-panel">
      <div class="flex-between mb-4">
        <div class="alert alert-info" style="margin:0;flex:1;margin-right:14px;"><span>‚ÑπÔ∏è</span><span>Bill Check Report ‚Äî Post-repair verification of actual workshop bill. Verifies parts replaced and repair costs against original survey assessment.</span></div>
        <div style="display:flex;gap:7px;">
          <button class="btn btn-secondary" id="drive-bill-btn" onclick="quickSaveToDrive('bill-check')" style="border-color:#1a73e8;color:#1a73e8;" title="Save to Google Drive">‚òÅÔ∏è Drive</button>
          <button class="btn btn-gold" onclick="generateBillCheckPDF()">üìÑ Generate PDF</button>
        </div>
      </div>
      <div class="report-preview">
        <div class="report-header-bar"><span>Bill Check Report ‚Äî Preview</span></div>
        <div class="report-doc" id="bill-check-html"><div style="text-align:center;padding:36px;color:var(--muted);"><button class="btn btn-primary" onclick="refreshBillCheck()">Generate Preview</button></div></div>
      </div>
    </div>

    <!-- ====== RI REPORT ====== -->
    <div id="page-ri-report" class="tab-panel">
      <div class="flex-between mb-4">
        <div class="alert alert-info" style="margin:0;flex:1;margin-right:14px;"><span>üîÑ</span><span>Reinspection Report ‚Äî Post-repair verification. Confirm which parts were actually replaced vs. allowed in survey report.</span></div>
        <button class="btn btn-gold" onclick="generateRIPDF()">üìÑ Generate PDF</button>
      </div>
      
      <div class="card mb-4">
        <div class="card-header"><h3>Reinspection Details</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">RI Ref No.</label><input class="form-input" id="ri-ref" placeholder="e.g. RIN/395/2026"/></div>
            <div class="form-group"><label class="form-label">Date of Reinspection</label><input class="form-input" type="date" id="ri-date"/></div>
            <div class="form-group"><label class="form-label">Survey Report Ref</label><input class="form-input" id="ri-survey-ref" placeholder="Original survey report no."/></div>
            <div class="form-group"><label class="form-label">Date of Survey</label><input class="form-input" type="date" id="ri-survey-date"/></div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h3>Parts Replacement Verification</h3>
          <span class="badge" style="background:rgba(34,169,154,0.2);color:var(--teal-light);">From Survey Report</span>
        </div>
        <div class="card-body">
          <div class="alert alert-ai" style="margin-bottom:14px;">
            <span>‚úì</span>
            <span>Check each part from the original survey report. Mark whether it was actually replaced during repair or not replaced.</span>
          </div>
          <div class="assess-table-wrap">
            <table class="assess-table" id="ri-parts-table">
              <thead>
                <tr>
                  <th style="width:35px;">Sr.</th>
                  <th>Particulars (From Survey Report)</th>
                  <th class="text-center" style="width:100px;">Allowed ‚Çπ</th>
                  <th class="text-center" style="width:140px;">Replacement Status</th>
                  <th style="width:200px;">Remarks</th>
                </tr>
              </thead>
              <tbody id="ri-parts-tbody"></tbody>
            </table>
          </div>
          <button class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="loadPartsForRI()">üîÑ Load Parts from Assessment</button>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header"><h3>Overall Condition After Repair</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Repair Quality</label>
              <select class="form-select" id="ri-repair-quality">
                <option value="satisfactory">Satisfactory - As per survey report</option>
                <option value="good">Good - Better than expected</option>
                <option value="partial">Partial - Some items pending</option>
                <option value="unsatisfactory">Unsatisfactory - Not as per survey</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Vehicle Condition</label>
              <select class="form-select" id="ri-vehicle-condition">
                <option value="roadworthy">Road Worthy - Fit for operation</option>
                <option value="needs-attention">Needs Minor Attention</option>
                <option value="not-roadworthy">Not Road Worthy</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Salvage Parts Status</label>
              <select class="form-select" id="ri-salvage-status">
                <option value="collected">Salvage parts collected and verified</option>
                <option value="not-collected">Salvage parts not collected</option>
                <option value="partial">Partial salvage collected</option>
                <option value="na">Not Applicable</option>
              </select>
            </div>
            <div class="form-group span-2">
              <label class="form-label">Additional Observations</label>
              <textarea class="form-textarea" id="ri-observations" placeholder="Any additional observations about the repair quality, parts replaced, or vehicle condition..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div class="card" style="margin:0;">
          <div class="card-header"><h3>Parts Summary</h3></div>
          <div class="card-body">
            <table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:6px 0;color:var(--muted);">Total Parts Allowed</td>
                <td class="text-right font-mono" id="ri-total-allowed">0</td>
              </tr>
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:6px 0;color:var(--muted);">Parts Replaced</td>
                <td class="text-right font-mono" style="color:var(--green);" id="ri-parts-replaced">0</td>
              </tr>
              <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:6px 0;color:var(--muted);">Parts Not Replaced</td>
                <td class="text-right font-mono" style="color:var(--red);" id="ri-parts-not-replaced">0</td>
              </tr>
              <tr>
                <td style="padding:8px 0;font-weight:600;">Replacement Rate</td>
                <td class="text-right font-mono" style="font-weight:600;color:var(--teal);" id="ri-replacement-rate">0%</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="card" style="margin:0;">
          <div class="card-header"><h3>Quick Actions</h3></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;" onclick="showPage('survey-report')">üìÑ View Original Survey Report</button>
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;" onclick="showPage('bill-check')">üßæ View Bill Check Report</button>
            <button class="btn btn-primary" style="width:100%;justify-content:flex-start;" onclick="refreshRIReport()">üîÑ Refresh Preview</button>
          </div>
        </div>
      </div>

      <div class="report-preview">
        <div class="report-header-bar"><span>Reinspection Report ‚Äî Preview</span></div>
        <div class="report-doc" id="ri-report-html"><div style="text-align:center;padding:36px;color:var(--muted);"><button class="btn btn-primary" onclick="refreshRIReport()">Generate Preview</button></div></div>
      </div>
    </div>

    <!-- ====== GOOGLE DRIVE ====== -->
    <div id="page-drive" class="tab-panel">

      <!-- Hero -->
      <div class="drive-hero">
        <div class="dh-icon">‚òÅÔ∏è</div>
        <div>
          <h2>Google Drive ‚Äî Claim Archive</h2>
          <p>All generated reports and source documents are automatically organised into per-claim folders in your Google Drive. Connect once, save forever.</p>
        </div>
        <div style="margin-left:auto;">
          <button id="drive-auth-btn" class="btn btn-secondary" onclick="handleDriveAuthBtn()" style="background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.4);color:#fff;padding:10px 20px;font-size:0.88rem;">
            üîó Connect Google Drive
          </button>
          <div id="drive-user-info" style="display:none;text-align:right;margin-top:6px;font-size:0.75rem;color:rgba(255,255,255,0.7);">
            <span id="drive-user-email"></span>
            <button onclick="disconnectDrive()" style="background:none;border:none;color:rgba(255,255,255,0.5);font-size:0.7rem;cursor:pointer;margin-left:8px;">Sign out</button>
          </div>
        </div>
      </div>

      <!-- Setup instructions (shown when not connected) -->
      <div id="drive-setup-panel">
        <div class="card" style="margin-bottom:18px;">
          <div class="card-header"><h3>‚öôÔ∏è One-Time Setup Required</h3></div>
          <div class="card-body">
            <p style="font-size:0.85rem;line-height:1.7;margin-bottom:14px;">To use Google Drive integration, you need a free Google Cloud API key. This takes about 5 minutes and is completely free.</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px;">
              <div style="background:var(--cream);padding:14px;border-radius:8px;border:1px solid var(--border);">
                <div style="font-weight:700;font-size:0.82rem;margin-bottom:8px;color:var(--navy);">Step 1 ‚Äî Create Google Cloud Project</div>
                <ol style="font-size:0.78rem;line-height:1.8;padding-left:16px;color:var(--muted);">
                  <li>Go to <a href="https://console.cloud.google.com" target="_blank" style="color:var(--teal);">console.cloud.google.com</a></li>
                  <li>Create a new project (e.g. "Motor Survey")</li>
                  <li>Enable <strong>Google Drive API</strong></li>
                  <li>Enable <strong>Google Picker API</strong></li>
                </ol>
              </div>
              <div style="background:var(--cream);padding:14px;border-radius:8px;border:1px solid var(--border);">
                <div style="font-weight:700;font-size:0.82rem;margin-bottom:8px;color:var(--navy);">Step 2 ‚Äî Create OAuth Credentials</div>
                <ol style="font-size:0.78rem;line-height:1.8;padding-left:16px;color:var(--muted);">
                  <li>Go to <strong>APIs &amp; Services ‚Üí Credentials</strong></li>
                  <li>Create <strong>OAuth 2.0 Client ID</strong></li>
                  <li>Type: <strong>Web application</strong></li>
                  <li>Add your app URL to Authorized Origins</li>
                </ol>
              </div>
            </div>
            <div style="background:#f0fdf8;border:1px solid var(--teal);border-radius:8px;padding:14px;margin-bottom:14px;">
              <div style="font-weight:700;font-size:0.82rem;margin-bottom:8px;color:var(--teal);">Step 3 ‚Äî Enter Your Credentials Below</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <div class="form-group">
                  <label class="form-label">OAuth Client ID</label>
                  <input class="form-input" id="drive-client-id" placeholder="xxxxxxx.apps.googleusercontent.com" oninput="saveDriveConfig()"/>
                </div>
                <div class="form-group">
                  <label class="form-label">API Key (for Drive listing)</label>
                  <input class="form-input" id="drive-api-key" placeholder="AIza..." oninput="saveDriveConfig()"/>
                </div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
                <button class="btn btn-primary" onclick="initDriveWithConfig()">‚úÖ Save &amp; Connect</button>
                <span id="drive-config-status" style="font-size:0.75rem;color:var(--muted);"></span>
              </div>
            </div>
            <p style="font-size:0.75rem;color:var(--muted);">Your credentials are stored only in your browser's localStorage and never sent anywhere except Google's servers directly.</p>
          </div>
        </div>
      </div>

      <!-- Current Claim Upload Panel (shown when connected) -->
      <div id="drive-connected-panel" style="display:none;">
        <div style="display:grid;grid-template-columns:1.4fr 1fr;gap:18px;margin-bottom:18px;">

          <!-- Upload current claim -->
          <div class="card">
            <div class="card-header">
              <h3>üìÅ Current Claim ‚Üí Drive</h3>
              <span class="badge" id="drive-folder-badge">No claim loaded</span>
            </div>
            <div class="card-body">
              <div id="drive-claim-folder-path" style="font-size:0.78rem;color:var(--muted);margin-bottom:12px;padding:8px;background:var(--cream);border-radius:6px;font-family:'DM Mono',monospace;">
                Motor Survey Reports / <span id="drive-folder-name">‚Äî</span>
              </div>

              <!-- File list -->
              <div id="drive-upload-file-list">
                <div style="font-size:0.8rem;color:var(--muted);padding:12px;text-align:center;">Load a claim first, then click Upload All</div>
              </div>

              <!-- Progress bar -->
              <div class="drive-progress-bar" id="drive-progress-bar" style="display:none;">
                <div class="drive-progress-fill" id="drive-progress-fill" style="width:0%"></div>
              </div>

              <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
                <button class="btn btn-drive btn-lg" onclick="uploadCurrentClaimToDrive()" id="drive-upload-btn">
                  ‚òÅÔ∏è Upload All to Drive
                </button>
                <button class="btn btn-secondary" onclick="refreshDriveFileList()">üîÑ Refresh</button>
                <button class="btn btn-secondary btn-sm" onclick="openDriveFolder()" id="drive-open-btn" style="display:none;">üìÇ Open in Drive</button>
              </div>

              <div id="drive-upload-log" style="font-size:0.75rem;margin-top:10px;max-height:100px;overflow-y:auto;font-family:'DM Mono',monospace;color:var(--navy2);line-height:1.8;"></div>
            </div>
          </div>

          <!-- Storage stats -->
          <div>
            <div class="card mb-4">
              <div class="card-header"><h3>üìä Drive Status</h3></div>
              <div class="card-body">
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                    <span style="color:var(--muted);">Connected Account</span>
                    <span style="font-weight:600;font-size:0.75rem;" id="ds-account">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                    <span style="color:var(--muted);">Root Folder</span>
                    <span style="color:var(--teal);font-size:0.75rem;">Motor Survey Reports</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                    <span style="color:var(--muted);">Claims Uploaded</span>
                    <span style="font-weight:600;" id="ds-claims-count">‚Äî</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;font-size:0.82rem;">
                    <span style="color:var(--muted);">Total Files</span>
                    <span style="font-weight:600;" id="ds-files-count">‚Äî</span>
                  </div>
                </div>
                <div style="margin-top:12px;">
                  <button class="btn btn-secondary btn-sm" style="width:100%;" onclick="loadDriveStats()">üîÑ Refresh Stats</button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><h3>üí° What Gets Saved</h3></div>
              <div class="card-body">
                <ul style="font-size:0.78rem;line-height:2;color:var(--muted);list-style:none;padding:0;">
                  <li>üìÑ Final Survey Report (.html)</li>
                  <li>üìÑ Spot Survey Report (.html)</li>
                  <li>üßæ Bill Check Report (.html)</li>
                  <li>üîÑ Reinspection Report (.html)</li>
                  <li>üí∞ Fee Bill (.html)</li>
                  <li>üìÅ Source Documents (original files)</li>
                  <li>üíæ Claim Data (.json backup)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- All claim folders list -->
        <div class="card">
          <div class="card-header">
            <h3>üìÇ All Claim Folders in Drive</h3>
            <button class="btn btn-secondary btn-sm" onclick="listAllClaimFolders()">üîÑ Refresh</button>
          </div>
          <div class="card-body" id="drive-folders-list">
            <div style="text-align:center;padding:24px;color:var(--muted);font-size:0.85rem;">Click Refresh to load your claim folders from Drive</div>
          </div>
        </div>
      </div>

    </div>
    <!-- ====== FEE BILL ====== -->
    <div id="page-fee-bill" class="tab-panel">
      <div class="flex-between mb-4"><div></div><button class="btn btn-gold" onclick="generateFeeBillPDF()">üìÑ Generate PDF</button></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
        <div class="card">
          <div class="card-header"><h3>Fee Details</h3></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:11px;">
            <div class="fee-auto-row">
              <div>
                <div style="font-weight:600;color:var(--teal);">‚ö° IRDAI Auto-Calculate</div>
                <div style="color:var(--muted);font-size:0.72rem;">Based on net assessed loss ‚Äî IRDAI scale</div>
              </div>
              <button class="btn btn-primary btn-sm" onclick="autoCalcIRDAIFee()" style="white-space:nowrap;">Calculate Fee</button>
            </div>
            <div class="form-group"><label class="form-label">Professional Fee (‚Çπ)</label><input class="form-input" id="fee-prof" type="number" value="1500" oninput="calcFeeTotal()"/></div>
            <div class="form-group"><label class="form-label">RI Fees (‚Çπ)</label><input class="form-input" id="fee-ri" type="number" value="1000"/></div>
            <div class="form-group"><label class="form-label">Travelling / Conveyance (‚Çπ)</label><input class="form-input" id="fee-travel" type="number" value="1000"/></div>
            <div class="form-group"><label class="form-label">Travel Notes</label><input class="form-input" id="fee-travel-note" value="Local 2 Visits Including R.I"/></div>
            <div class="form-group"><label class="form-label">Haltage (‚Çπ)</label><input class="form-input" id="fee-haltage" type="number" value="0"/></div>
            <div class="form-group"><label class="form-label">Digital Photos (No.)</label><input class="form-input" id="fee-photos-count" type="number" value="18" onchange="calcFeeTotal()"/></div>
            <div class="form-group"><label class="form-label">Rate per Photo (‚Çπ)</label><input class="form-input" id="fee-photo-rate" type="number" value="10" onchange="calcFeeTotal()"/></div>
            <div class="form-group"><label class="form-label">Postal / Courier (‚Çπ)</label><input class="form-input" id="fee-postal" type="number" value="100" onchange="calcFeeTotal()"/></div>
          </div>
        </div>
        <div>
          <div class="card mb-4">
            <div class="card-header"><h3>Summary</h3></div>
            <div class="card-body">
              <button class="btn btn-primary btn-sm" style="margin-bottom:12px;" onclick="calcFeeTotal()">üîÑ Calculate</button>
              <table style="width:100%;font-size:0.83rem;border-collapse:collapse;">
                <tr><td style="padding:6px 0;color:var(--muted);">Professional Fees</td><td class="text-right mono" id="fs-prof">‚Çπ 1,500.00</td></tr>
                <tr><td style="padding:6px 0;color:var(--muted);">RI Fees</td><td class="text-right mono" id="fs-ri">‚Çπ 1,000.00</td></tr>
                <tr><td style="padding:6px 0;color:var(--muted);">Travelling</td><td class="text-right mono" id="fs-travel">‚Çπ 1,000.00</td></tr>
                <tr><td style="padding:6px 0;color:var(--muted);">Photo Charges</td><td class="text-right mono" id="fs-photos">‚Çπ 180.00</td></tr>
                <tr><td style="padding:6px 0;color:var(--muted);">Postal</td><td class="text-right mono" id="fs-postal">‚Çπ 100.00</td></tr>
                <tr style="border-top:2px solid var(--border);"><td style="padding:9px 0;font-weight:700;">TOTAL</td><td class="text-right mono" style="font-weight:700;color:var(--teal);" id="fs-total">‚Çπ 3,780.00</td></tr>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Bank Details</h3></div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:9px;">
              <div class="form-group"><label class="form-label">Bank Name</label><input class="form-input" id="bank-name" value="State Bank Of India"/></div>
              <div class="form-group"><label class="form-label">A/C No.</label><input class="form-input" id="bank-ac"/></div>
              <div class="form-group"><label class="form-label">IFSC Code</label><input class="form-input" id="bank-ifsc"/></div>
              <div class="form-group"><label class="form-label">PAN No.</label><input class="form-input" id="bank-pan"/></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SURVEYOR PROFILE ====== -->
    <div id="page-surveyor-profile" class="tab-panel">
      <div class="card">
        <div class="card-header"><h3>Surveyor Profile</h3><span class="badge">Auto-fills all reports</span></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="sp-name"/></div>
            <div class="form-group"><label class="form-label">Qualifications</label><input class="form-input" id="sp-qual" placeholder="e.g. B.Sc., Dip. in Auto Engg."/></div>
            <div class="form-group"><label class="form-label">Licence No.</label><input class="form-input" id="sp-lic"/></div>
            <div class="form-group"><label class="form-label">Licence Expiry</label><input class="form-input" id="sp-lic-exp"/></div>
            <div class="form-group"><label class="form-label">IIISLA No.</label><input class="form-input" id="sp-iiisla"/></div>
            <div class="form-group"><label class="form-label">Surveyor Code</label><input class="form-input" id="sp-code"/></div>
            <div class="form-group"><label class="form-label">Categories</label><input class="form-input" id="sp-categories" placeholder="MOTOR, MARINE, ENGG"/></div>
            <div class="form-group"><label class="form-label">GST No.</label><input class="form-input" id="sp-gst"/></div>
            <div class="form-group"><label class="form-label">Mobile</label><input class="form-input" id="sp-mobile"/></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="sp-email" type="email"/></div>
            <div class="form-group span-2"><label class="form-label">Address</label><textarea class="form-textarea" id="sp-addr"></textarea></div>
          </div>
          <div style="margin-top:14px;display:flex;gap:9px;justify-content:flex-end;">
            <button class="btn btn-primary" onclick="showToast('Surveyor profile saved!')">üíæ Save Profile</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== DEP SCHEDULE ====== -->
    <div id="page-dep-schedule" class="tab-panel">
      <div class="alert alert-info mb-4"><span>‚ÑπÔ∏è</span><span>IRDAI standard depreciation schedule. Applied when Standard Dep policy is selected.</span></div>
      <div class="card">
        <div class="card-header"><h3>IRDAI Depreciation Schedule</h3></div>
        <div class="card-body">
          <table class="dep-table">
            <thead><tr><th>Vehicle Age</th><th>Metal (%)</th><th>Rubber/Plastic (%)</th><th>Fibre (%)</th><th>Glass (%)</th><th>Painting (%)</th></tr></thead>
            <tbody>
              <tr><td>‚â§ 6 months</td><td>Nil</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>6m ‚Äì 1 yr</td><td>5%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>1 ‚Äì 2 yrs</td><td>10%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>2 ‚Äì 3 yrs</td><td>15%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>3 ‚Äì 4 yrs</td><td>25%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>4 ‚Äì 5 yrs</td><td>35%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>5 ‚Äì 10 yrs</td><td>40%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
              <tr><td>> 10 yrs</td><td>50%</td><td>50%</td><td>30%</td><td>Nil</td><td>Nil</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

<!-- ‚îÄ‚îÄ Share Menu Modal ‚îÄ‚îÄ -->
<div class="preflight-modal" id="share-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="preflight-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="font-family:'Crimson Pro',serif;font-size:1.1rem;color:var(--navy);margin:0;">Share Report</h3>
      <button onclick="document.getElementById('share-modal').classList.remove('open')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted);">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <button class="btn btn-primary" onclick="shareViaWhatsApp()" style="justify-content:flex-start;gap:10px;">
        üí¨ Send via WhatsApp
      </button>
      <button class="btn btn-secondary" onclick="shareViaEmail()" style="justify-content:flex-start;gap:10px;">
        üìß Send via Email
      </button>
      <button class="btn btn-secondary" onclick="copyReportSummary()" style="justify-content:flex-start;gap:10px;">
        üìã Copy Summary to Clipboard
      </button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Pre-flight Validation Modal ‚îÄ‚îÄ -->
<div class="preflight-modal" id="preflight-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="preflight-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="font-family:'Crimson Pro',serif;font-size:1.1rem;color:var(--navy);margin:0;">üìã Report Checklist</h3>
      <button onclick="document.getElementById('preflight-modal').classList.remove('open')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted);">‚úï</button>
    </div>
    <p style="font-size:0.78rem;color:var(--muted);margin:0 0 14px;">Verify before generating. Missing fields may leave blanks in the report.</p>
    <div id="preflight-checks"></div>
    <div style="display:flex;gap:8px;margin-top:18px;">
      <button class="btn btn-primary" style="flex:1;" onclick="document.getElementById('preflight-modal').classList.remove('open');doGenerateAllReports()">Generate Anyway ‚Üí</button>
      <button class="btn btn-secondary" onclick="document.getElementById('preflight-modal').classList.remove('open')">Go Back & Fix</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ PWA Install Banner ‚îÄ‚îÄ -->
<div class="pwa-banner" id="pwa-banner">
  <span>üì± Install this app for offline use ‚Äî works without internet on the field!</span>
  <div style="display:flex;gap:8px;">
    <button class="btn btn-gold btn-sm" id="pwa-install-btn" onclick="installPWA()">Install</button>
    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('pwa-banner').classList.remove('show');localStorage.setItem('pwa-dismissed','1')">‚úï</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ Model Selector Modal ‚îÄ‚îÄ -->
<div class="preflight-modal" id="model-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="preflight-box" style="width:360px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="font-family:'Crimson Pro',serif;font-size:1.1rem;color:var(--navy);margin:0;">ü§ñ AI Model</h3>
      <button onclick="document.getElementById('model-modal').classList.remove('open')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted);">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;" id="model-options">
      <label class="preflight-row" style="cursor:pointer;border-radius:8px;padding:10px 12px;background:var(--cream);border:1px solid var(--border);">
        <input type="radio" name="groq-model" value="meta-llama/llama-4-scout-17b-16e-instruct" checked style="accent-color:var(--teal);"/>
        <div>
          <div style="font-weight:600;font-size:0.82rem;">‚ö° Llama 4 Scout <span style="color:var(--teal);font-size:0.7rem;">FAST</span></div>
          <div style="font-size:0.72rem;color:var(--muted);">Best for clear documents. Free tier friendly.</div>
        </div>
      </label>
      <label class="preflight-row" style="cursor:pointer;border-radius:8px;padding:10px 12px;background:var(--cream);border:1px solid var(--border);">
        <input type="radio" name="groq-model" value="meta-llama/llama-4-maverick-17b-128e-instruct" style="accent-color:var(--teal);"/>
        <div>
          <div style="font-weight:600;font-size:0.82rem;">ü¶Ö Llama 4 Maverick <span style="color:var(--gold);font-size:0.7rem;">ACCURATE</span></div>
          <div style="font-size:0.72rem;color:var(--muted);">Better for blurry or low-quality scans.</div>
        </div>
      </label>
      <label class="preflight-row" style="cursor:pointer;border-radius:8px;padding:10px 12px;background:var(--cream);border:1px solid var(--border);">
        <input type="radio" name="groq-model" value="llama-3.2-11b-vision-preview" style="accent-color:var(--teal);"/>
        <div>
          <div style="font-weight:600;font-size:0.82rem;">üîé Llama 3.2 Vision <span style="color:var(--muted);font-size:0.7rem;">LEGACY</span></div>
          <div style="font-size:0.72rem;color:var(--muted);">Fallback if newer models unavailable.</div>
        </div>
      </label>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:14px;" onclick="applyModelSelection()">Apply</button>
  </div>
</div>

<!-- ADD ROW MODAL -->
<div class="modal-overlay" id="add-row-modal">
  <div class="modal">
    <div class="modal-head"><h2 id="modal-title">Add Item</h2><button class="modal-close" onclick="closeModal()">‚úï</button></div>
    <div class="modal-body">
      <div class="form-group mb-4" style="margin-bottom:12px;"><label class="form-label">Description</label><input class="form-input" id="modal-particulars" placeholder="e.g. FRONT DOOR SHELL ASSY LH"/></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group"><label class="form-label">Estimated Amount (‚Çπ)</label><input class="form-input" id="modal-estimated" type="number" placeholder="0.00"/></div>
        <div class="form-group"><label class="form-label">Part Type</label><select class="form-select" id="modal-part-type"><option value="metal">Nil Dep. Metal</option><option value="plastic">Nil Dep. Plastic/Rubber</option><option value="glass">Glass 0%</option><option value="labour">Labour</option><option value="paint">Painting</option></select></div>
        <div class="form-group"><label class="form-label">Assessed Amount (‚Çπ)</label><input class="form-input" id="modal-assessed" type="number" placeholder="0.00"/></div>
        <div class="form-group"><label class="form-label">GST %</label><select class="form-select" id="modal-gst"><option value="18">18%</option><option value="12">12%</option><option value="28">28%</option><option value="5">5%</option><option value="0">0%</option></select></div>
      </div>
    </div>
    <div class="modal-foot"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="confirmAddRow()">Add Item</button></div>
  </div>
</div>

<!-- VOICE INPUT MODAL -->
<div class="modal-overlay" id="voice-modal">
  <div class="modal" style="max-width:560px;">
    <div class="modal-head">
      <h2>üé§ Voice Input</h2>
      <button class="modal-close" onclick="closeVoiceModal()">‚úï</button>
    </div>
    <div class="modal-body voice-modal-content">

      <!-- Field name -->
      <div style="text-align:center;margin-bottom:14px;font-size:0.78rem;color:var(--muted);">
        Filling: <strong id="voice-field-name" style="color:var(--navy);">‚Äî</strong>
      </div>

      <!-- Step 1: Record -->
      <div id="voice-step-record" style="text-align:center;margin-bottom:16px;">
        <button id="voice-record-btn" class="btn btn-ai btn-lg" onclick="toggleVoiceRecording()" style="width:auto;min-width:200px;">
          <span id="voice-record-icon">üé§</span>
          <span id="voice-record-text">Start Recording</span>
        </button>
        <div id="voice-status" style="font-size:0.78rem;color:var(--muted);margin-top:8px;">
          Press Start ‚Äî speak freely ‚Äî press Stop when done
        </div>
      </div>

      <!-- Live raw transcript (shown while recording) -->
      <div id="voice-raw-section" style="display:none;margin-bottom:12px;">
        <div style="font-size:0.7rem;font-weight:600;text-transform:uppercase;color:var(--navy2);margin-bottom:4px;">üìù What you said:</div>
        <div id="voice-raw-text" style="background:var(--cream);border-radius:6px;padding:10px;font-size:0.85rem;line-height:1.7;color:var(--text);font-style:italic;min-height:50px;"></div>
      </div>

      <!-- Step 2: AI formatted result ‚Äî editable -->
      <div id="voice-ai-section" style="display:none;margin-bottom:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
          <div style="font-size:0.7rem;font-weight:600;text-transform:uppercase;color:var(--green);">‚ú® AI Formatted ‚Äî edit if needed:</div>
          <div id="voice-ai-spinner" style="display:none;"><div class="spinner spinner-green"></div></div>
        </div>
        <textarea id="voice-ai-text"
          style="width:100%;min-height:90px;padding:10px;border:2px solid #bbf7d0;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.92rem;line-height:1.7;resize:vertical;outline:none;background:#f0fdf8;color:var(--text);"
          placeholder="AI formatted text will appear here..."></textarea>
        <div style="font-size:0.7rem;color:var(--muted);margin-top:3px;">‚úèÔ∏è You can correct spellings, names, or any text directly above ‚Äî corrections improve future suggestions</div>
      </div>

    </div>
    <div class="modal-foot" style="justify-content:space-between;align-items:center;">
      <div id="voice-correction-badge" style="display:none;font-size:0.7rem;color:var(--teal);"><span id="voice-correction-count">0</span> correction(s) learned this session</div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary" onclick="closeVoiceModal()">Cancel</button>
        <button class="btn btn-primary" id="voice-apply-btn" style="display:none;" onclick="applyVoiceInput()">‚úÖ Apply to Field</button>
      </div>
    </div>
  </div>
</div>


<script>
// ============================================================
// ‚öôÔ∏è CONFIGURATION - ADD YOUR GROQ API KEY HERE
// ============================================================
const GROQ_API_KEY = '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';
//
// üìù HOW TO GET YOUR FREE GROQ API KEY:
// 1. Go to: https://console.groq.com
// 2. Sign up free (no credit card needed)
// 3. Click "API Keys" ‚Üí "Create API Key"
// 4. Copy the key (starts with gsk_...)
// 5. Replace 'YOUR_GROQ_API_KEY_HERE' above with your actual key
//
// ‚úÖ FREE TIER LIMITS:
// - 14,400 requests per day
// - 30 requests per minute
// - 100% FREE forever
//
// ‚ö†Ô∏è SECURITY WARNING:
// - Never share this file with your API key in it
// - Don't commit API keys to public repositories
// ============================================================

// Helper: call Groq API (supports images via LLaMA 4 Scout vision model)
async function callGemini(parts, maxTokens = 3000) {
  // Build content array for Groq (OpenAI-compatible format)
  const userContent = [];
  for (const part of parts) {
    if (part.inlineData) {
      userContent.push({
        type: 'image_url',
        image_url: { url: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}` }
      });
    } else if (part.text) {
      userContent.push({ type: 'text', text: part.text });
    }
  }

  const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${GROQ_API_KEY}`
    },
    body: JSON.stringify({
      model: 'meta-llama/llama-4-scout-17b-16e-instruct',
      max_tokens: maxTokens,
      temperature: 0.1,
      messages: [{ role: 'user', content: userContent }]
    })
  });

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(`Groq API error ${response.status}: ${err.error?.message || response.statusText}`);
  }
  const data = await response.json();
  return data.choices?.[0]?.message?.content || '';
}

// ============================================================
// STATE
// ============================================================
let depType = 'nil';
let vehicleType = 'commercial'; // 'commercial' | 'private'
let currentModal = null;
let assessRows = [];
let sigDataUrl = null;
let stampDataUrl = null;
const aiStatusMap = { rc: false, dl: false, policy: false, claim: false, estimate: false, photos: false };

// ‚îÄ‚îÄ Uploaded file tracking for Google Drive ‚îÄ‚îÄ
const uploadedDocFiles = {}; // { rc: File, dl: File, policy: File, claim: File, estimate: [File,...], photos: [File,...], permit: File, auth: File, fitness: File, 'lok-challan': File }

// Track uploaded source files so they can be pushed to Drive
const uploadedDocs = {};  // { rc: File, dl: File, policy: File, claim: File, estimate: File|File[], photos: File[], permit: File, ... }

// Voice input state
let voiceRecognition = null;
let isRecording = false;
let currentVoiceFieldId = null;
let currentVoiceFieldLabel = null;
let voiceTranscript = '';
let voiceVerifiedData = '';

// RI parts tracking
let riParts = [];

// ============================================================
// NAVIGATION
// ============================================================
function showPage(id) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const panel = document.getElementById('page-' + id);
  if (panel) panel.classList.add('active');
  const meta = {
    dashboard: ['Dashboard', 'Claim overview'],
    upload: ['AI Document Scan', 'Upload docs for auto field extraction'],
    'claim-details': ['Claim Details', 'Review and edit extracted data'],
    assessment: ['Loss Assessment Sheet', 'Itemised assessment'],
    'survey-report': ['Final Survey Report', '4-page motor survey report'],
    'bill-check': ['Bill Check Report', 'Parts & labour breakdown'],
    'ri-report': ['Reinspection Report', 'Post-repair verification'],
    'fee-bill': ['Surveyor Fee Bill', 'Professional fee invoice'],
    'surveyor-profile': ['Surveyor Profile', 'Auto-fills all reports'],
    'dep-schedule': ['Depreciation Schedule', 'IRDAI rates reference'],
    drive: ['Google Drive', 'Cloud backup for all reports and documents']
  };
  if (meta[id]) { document.getElementById('page-title').textContent = meta[id][0]; document.getElementById('page-meta').textContent = meta[id][1]; }
  document.querySelectorAll('.nav-item').forEach(n => { if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + id + "'")) n.classList.add('active'); });
  updateDashboard();
  // Drive panel state
  if (id === 'drive') {
    if (typeof driveAccessToken !== 'undefined' && driveAccessToken && Date.now() < driveTokenExpiry) {
      if (typeof driveShowConnectedPanel === 'function') driveShowConnectedPanel();
    } else {
      if (typeof driveShowDisconnectedPanel === 'function') driveShowDisconnectedPanel();
    }
  }
}

// ============================================================
// AI DOCUMENT EXTRACTION VIA CLAUDE API
// ============================================================
// ============================================================
// CLAUDE AI DOCUMENT EXTRACTION PROMPTS
// ============================================================
const DOC_PROMPTS = {
  rc: `You are an expert at reading Indian vehicle RC (Registration Certificate) documents. Extract ALL visible fields from this RC book image. Return ONLY a JSON object with these keys (use empty string if not found):
{
  "registration_number": "",
  "date_of_registration": "",
  "owner_name": "",
  "address": "",
  "make": "",
  "model": "",
  "body_type": "",
  "chassis_number": "",
  "engine_number": "",
  "cubic_capacity": "",
  "colour": "",
  "fuel": "",
  "seating_capacity": "",
  "unladen_weight": "",
  "gross_weight": "",
  "class_of_vehicle": "",
  "fitness_cert_no": "",
  "fitness_valid_upto": "",
  "permit_no": "",
  "route": "",
  "road_tax": "",
  "year_of_manufacture": "",
  "hypothecation": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  dl: `You are an expert at reading Indian Driving Licence (DL/MDL) documents. Extract ALL visible fields including BOTH validity dates. Return ONLY a JSON object:
{
  "licence_number": "",
  "holder_name": "",
  "relation_type": "S/o or D/o or W/o",
  "father_or_husband_name": "",
  "date_of_birth": "",
  "address": "",
  "date_of_issue": "",
  "validity_non_transport": "expiry date of LMV/Non-Transport licence",
  "validity_transport": "expiry date of Transport/HMV/TRANS licence (if present)",
  "issuing_authority": "",
  "rto": "",
  "vehicle_classes": "all classes listed e.g. LMV, MCWG, TRANS, HMV",
  "badge_no": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  policy: `You are an expert at reading Indian motor insurance policy documents. Extract ALL visible fields. Return ONLY a JSON object:
{
  "policy_number": "",
  "insurer_name": "",
  "insurer_address": "",
  "insured_name": "",
  "insured_address": "",
  "insured_mobile": "",
  "registration_number": "",
  "make_model": "",
  "chassis_number": "",
  "engine_number": "",
  "policy_type": "",
  "period_from": "",
  "period_to": "",
  "idv": "",
  "premium": "",
  "hpa_with": "",
  "policy_issuing_office": "",
  "nomination": "",
  "endorsements": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  claim: `You are an expert at reading Indian motor insurance claim forms. Extract ALL visible fields. Return ONLY a JSON object:
{
  "claim_number": "",
  "policy_number": "",
  "insured_name": "",
  "vehicle_number": "",
  "date_of_accident": "",
  "time_of_accident": "",
  "place_of_accident": "",
  "cause_of_accident": "",
  "driver_name": "",
  "driver_licence_no": "",
  "place_of_repair": "",
  "workshop_name": "",
  "estimated_loss": "",
  "third_party_details": "",
  "surveyor_name": "",
  "date_of_intimation": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  estimate: `You are an expert at reading Indian vehicle repair estimates and workshop bills. Extract ALL line items and totals. Return ONLY a JSON object:
{
  "workshop_name": "",
  "workshop_address": "",
  "vehicle_number": "",
  "chassis_number": "",
  "engine_number": "",
  "estimate_date": "",
  "bill_number": "",
  "spare_parts": [
    { "description": "", "part_number": "", "quantity": 1, "unit_price": 0, "amount": 0, "gst_percent": 18, "category": "metal or plastic or glass" }
  ],
  "labour_items": [
    { "description": "", "amount": 0, "gst_percent": 18 }
  ],
  "painting_items": [
    { "description": "", "amount": 0, "gst_percent": 18 }
  ],
  "subtotal_parts": 0,
  "subtotal_labour": 0,
  "subtotal_painting": 0,
  "gst_amount": 0,
  "total_amount": 0
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  photos: `You are an expert vehicle damage assessor. Analyse this vehicle damage photo and describe:
1. Which parts of the vehicle are visibly damaged
2. Type of damage (dented, scratched, cracked, broken, deformed, etc.)
3. Severity (minor, moderate, major)
4. Affected side (front, rear, left, right)
Return ONLY a JSON object:
{
  "damaged_parts": [
    { "part": "", "damage_type": "", "severity": "", "side": "" }
  ],
  "overall_damage_summary": "",
  "recommended_repairs": []
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  permit: `You are an expert at reading Indian commercial vehicle permit documents (Route Permit, National Permit, State Permit, All India Tourist Permit). Extract ALL visible fields. Weights are in KG. Return ONLY a JSON object:
{
  "permit_no": "",
  "permit_type": "",
  "vehicle_number": "",
  "validity_from": "",
  "validity_to": "",
  "route": "",
  "issuing_authority": "",
  "goods_category": "",
  "gross_vehicle_weight_kg": "GVW or RLW in KG as a plain number if shown",
  "unladen_weight_kg": "unladen/tare weight in KG as a plain number if shown"
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  auth: `You are an expert at reading Indian commercial vehicle authorisation certificates (Badge, Authorisation). Extract ALL visible fields. Return ONLY a JSON object:
{
  "auth_no": "",
  "auth_type": "",
  "vehicle_number": "",
  "validity_from": "",
  "validity_to": "",
  "issuing_authority": "",
  "remarks": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  fitness: `You are an expert at reading Indian vehicle fitness certificates (roadworthiness certificate issued by RTO/VAHAN). Extract ALL visible fields. Weights are in KG. Return ONLY a JSON object:
{
  "fitness_cert_no": "",
  "vehicle_number": "",
  "chassis_number": "",
  "engine_number": "",
  "validity_from": "",
  "validity_to": "",
  "issuing_authority": "",
  "gross_vehicle_weight_kg": "GVW or GCW or RLW in KG as a plain number",
  "unladen_weight_kg": "Unladen/tare weight in KG as a plain number",
  "seating_capacity": "",
  "fuel_type": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`,

  'lok-challan': `You are an expert at reading Indian goods transport Lok Challan / Consignment Note documents. Extract ALL visible fields. Return ONLY a JSON object:
{
  "challan_no": "",
  "challan_date": "",
  "vehicle_number": "",
  "origin": "",
  "destination": "",
  "consignor": "",
  "consignee": "",
  "goods_description": "",
  "weight_kg": "",
  "freight_amount": "",
  "remarks": ""
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`
};

// ‚îÄ‚îÄ Vehicle Type Toggle ‚îÄ‚îÄ
function setVehicleType(type) {
  vehicleType = type;
  document.querySelectorAll('#veh-type-toggle button').forEach((b,i) => {
    b.classList.toggle('active', (type==='commercial'&&i===0)||(type==='private'&&i===1));
  });
  const hint = document.getElementById('veh-type-hint');
  const isComm = type === 'commercial';
  if (hint) hint.textContent = isComm
    ? 'Permit, Fitness, Authorisation & Lok Challan upload enabled'
    : 'Standard documents only';
  // Show/hide commercial doc cards on upload page
  document.querySelectorAll('.commercial-doc').forEach(el => {
    el.style.display = isComm ? '' : 'none';
  });
  // Show/hide commercial sections on spot survey page
  const commSec = document.getElementById('spot-commercial-section');
  const challSec = document.getElementById('spot-challan-section');
  if (commSec) commSec.style.display = isComm ? '' : 'none';
  if (challSec) challSec.style.display = isComm ? '' : 'none';
}

function triggerDocUpload(type) {
  const el = document.getElementById('upload-' + type);
  if (el) el.click();
}

function handleDocDrop(e, type) {
  e.preventDefault();
  const cardId = type === 'fitness' ? 'card-fitness-doc' : type === 'lok-challan' ? 'card-lok-challan' : 'card-' + type;
  const card = document.getElementById(cardId);
  if (card) card.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files);
  if (!files.length) return;
  // ‚îÄ‚îÄ Track for Google Drive ‚îÄ‚îÄ
  if (type === 'photos') {
    savedPhotoFiles = files;
    uploadedDocs['photos'] = files;
    document.getElementById('damage-analysis-btn').classList.remove('hidden');
  } else {
    uploadedDocs[type] = files.length === 1 ? files[0] : files;
  }
  if ((type === 'estimate' || type === 'photos') && files.length > 1) {
    processMultipleFiles(files, type);
  } else {
    processDocFile(files[0], type);
  }
}

function handleDocFile(input, type) {
  const files = Array.from(input.files);
  if (!files.length) return;
  // Store file references for Drive upload
  if (type === 'photos') {
    uploadedDocs['photos'] = files;
    savedPhotoFiles = files;
    document.getElementById('damage-analysis-btn').classList.remove('hidden');
  } else {
    uploadedDocs[type] = files.length === 1 ? files[0] : files;
  }
  if ((type === 'estimate' || type === 'photos') && files.length > 1) {
    processMultipleFiles(files, type);
  } else {
    processDocFile(files[0], type);
  }
}

// ‚îÄ‚îÄ Calc load capacity from GVW - ULW ‚îÄ‚îÄ
function calcLoadCapacity() {
  const gvw = parseFloat(document.getElementById('spot-gvw')?.value || 0);
  const ulw = parseFloat(document.getElementById('spot-ulw')?.value || 0);
  if (gvw > 0 && ulw > 0 && gvw > ulw) {
    const cap = Math.round(gvw - ulw);
    const el = document.getElementById('spot-load-capacity');
    if (el) { el.value = cap; el.classList.add('ai-filled'); }
    showToast(`Load capacity: ${gvw.toLocaleString()} ‚àí ${ulw.toLocaleString()} = ${cap.toLocaleString()} KG`, 'success');
  }
}

// ‚îÄ‚îÄ Convert ALL pages of a PDF to base64 image array ‚îÄ‚îÄ
async function callGeminiChunked(images, prompt, maxTokens = 4000) {
  const CHUNK_SIZE = 5;
  if (images.length <= CHUNK_SIZE) {
    const parts = [
      ...images.map(img => ({ inlineData: { mimeType: img.mimeType, data: img.base64 } })),
      { text: images.length > 1 ? `You are reading ${images.length} pages/images. Extract ALL data across ALL pages combined.\n\n${prompt}` : prompt }
    ];
    return callGemini(parts, maxTokens);
  }

  // Split into chunks ‚Äî collect partial JSON from each, merge
  const chunks = [];
  for (let i = 0; i < images.length; i += CHUNK_SIZE) chunks.push(images.slice(i, i + CHUNK_SIZE));

  let merged = {};
  for (let ci = 0; ci < chunks.length; ci++) {
    const chunk = chunks[ci];
    const chunkPrompt = `You are reading images ${ci*CHUNK_SIZE+1}‚Äì${ci*CHUNK_SIZE+chunk.length} of ${images.length} total. Extract whatever data is visible on THESE images only. Merge with any previously found data.\n\n${prompt}`;
    const parts = [
      ...chunk.map(img => ({ inlineData: { mimeType: img.mimeType, data: img.base64 } })),
      { text: chunkPrompt }
    ];
    const raw = await callGemini(parts, maxTokens);
    try {
      const parsed = JSON.parse(raw.replace(/```json|```/g, '').trim());
      // Merge: for arrays (spare_parts, damaged_parts etc.) append; for strings take non-empty
      for (const key of Object.keys(parsed)) {
        if (Array.isArray(parsed[key])) {
          merged[key] = [...(merged[key]||[]), ...parsed[key]];
        } else if (parsed[key] && !merged[key]) {
          merged[key] = parsed[key];
        }
      }
    } catch(e) { /* partial chunk failed ‚Äî continue */ }
  }
  return JSON.stringify(merged);
}
async function pdfToImages(file, statusEl) {
  const arrayBuffer = await file.arrayBuffer();
  const pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const totalPages = pdf.numPages;
  const images = []; // [{base64, dataUrl}]

  for (let p = 1; p <= totalPages; p++) {
    if (statusEl) statusEl.innerHTML = `<div class="spinner"></div> Converting PDF page ${p} of ${totalPages}...`;
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    images.push({ base64: dataUrl.split(',')[1], dataUrl, mimeType: 'image/jpeg' });
  }
  return images;
}

// ‚îÄ‚îÄ Process multiple image files together (estimate / photos) ‚îÄ‚îÄ
async function processMultipleFiles(files, type) {
  const card = document.getElementById('card-' + type);
  const previewEl = document.getElementById('preview-' + type);
  const statusEl = document.getElementById('status-' + type);
  const fieldsEl = document.getElementById('fields-' + type);
  const logEl = document.getElementById('extraction-log');
  const progressCard = document.getElementById('extraction-progress-card');
  const typeLabel = { estimate: 'Repair Estimate', photos: 'Damage Photos' };

  progressCard.style.display = 'block';
  card.className = 'doc-card processing';
  statusEl.className = 'doc-status processing';
  statusEl.innerHTML = `<div class="spinner"></div> Preparing ${files.length} files...`;
  fieldsEl.className = 'doc-extracted-fields';
  fieldsEl.style.display = 'none';

  appendLog(logEl, `üìÇ Processing ${files.length} files for ${typeLabel[type]}...`);

  try {
    // Collect all images from all files (images directly, PDFs converted)
    const allImages = [];
    for (let i = 0; i < files.length; i++) {
      const f = files[i];
      statusEl.innerHTML = `<div class="spinner"></div> Reading file ${i+1}/${files.length}: ${f.name}`;
      if (f.type === 'application/pdf') {
        const pages = await pdfToImages(f, statusEl);
        allImages.push(...pages);
        appendLog(logEl, `  üìÑ ${f.name} ‚Üí ${pages.length} page(s) converted`);
      } else {
        const base64 = await fileToBase64(f);
        let mt = f.type || 'image/jpeg';
        if (!['image/jpeg','image/png','image/webp','image/gif'].includes(mt)) mt = 'image/jpeg';
        allImages.push({ base64, dataUrl: `data:${mt};base64,${base64}`, mimeType: mt });
        appendLog(logEl, `  üñº ${f.name} added`);
      }
    }

    // Show preview grid of all images
    previewEl.style.display = 'block';
    previewEl.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:4px;padding:6px;">
      ${allImages.map((img,i) => `<img src="${img.dataUrl}" style="width:100%;height:60px;object-fit:cover;border-radius:4px;" title="Page/Image ${i+1}"/>`).join('')}
    </div><div style="padding:4px 8px;font-size:0.7rem;color:var(--muted);">${allImages.length} image(s) total</div>`;

    appendLog(logEl, `ü§ñ Sending ${allImages.length} images to AI${allImages.length > 5 ? ` (in ${Math.ceil(allImages.length/5)} chunks of 5)` : ''}...`);
    statusEl.innerHTML = `<div class="spinner"></div> AI reading ${allImages.length} images${allImages.length > 5 ? ' (chunked)' : ''}...`;

    const rawText = await callGeminiChunked(allImages, DOC_PROMPTS[type], 4000);
    let extracted;
    try {
      extracted = JSON.parse(rawText.replace(/```json|```/g, '').trim());
    } catch(e) {
      throw new Error('Could not parse AI response ‚Äî try fewer pages');
    }

    const fieldCount = applyExtractedData(type, extracted);
    card.className = 'doc-card done';
    statusEl.className = 'doc-status done';
    statusEl.innerHTML = `‚úÖ ${allImages.length} pages read ‚Äî ${fieldCount} items extracted`;
    showExtractedSummary(type, extracted, fieldsEl);
    aiStatusMap[type] = true;
    updateAIStatusDots();
    appendLog(logEl, `‚úÖ ${typeLabel[type]} ‚Äî ${fieldCount} items from ${allImages.length} pages`);
    showToast(`${typeLabel[type]}: ${fieldCount} items from ${allImages.length} pages!`, 'success');
    const doneCount = Object.values(aiStatusMap).filter(Boolean).length;
    if (doneCount >= 2) document.getElementById('go-to-form-btn').classList.remove('hidden');

  } catch(err) {
    card.className = 'doc-card error';
    statusEl.className = 'doc-status error';
    statusEl.innerHTML = `‚ö†Ô∏è ${err.message}`;
    appendLog(logEl, `‚ùå ${typeLabel[type]} ‚Äî ${err.message}`);
    showToast('Error: ' + err.message, 'error');
  }
}

async function processDocFile(file, type) {
  const cardId = type === 'fitness' ? 'card-fitness-doc' : type === 'lok-challan' ? 'card-lok-challan' : 'card-' + type;
  const card = document.getElementById(cardId);
  const previewEl = document.getElementById('preview-' + type);
  const statusEl = document.getElementById('status-' + type);
  const fieldsEl = document.getElementById('fields-' + type);
  const logEl = document.getElementById('extraction-log');
  const progressCard = document.getElementById('extraction-progress-card');

  progressCard.style.display = 'block';
  previewEl.style.display = 'block';
  if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = e => { previewEl.innerHTML = `<img src="${e.target.result}" style="width:100%;max-height:110px;object-fit:cover;"/>`; };
    reader.readAsDataURL(file);
  } else {
    previewEl.innerHTML = `<div class="pdf-prev">üìÑ ${file.name}<br/><span style="font-size:0.68rem;color:var(--muted);">${(file.size/1024).toFixed(0)} KB</span></div>`;
  }

  if (card) { card.className = 'doc-card processing commercial-doc'; }
  statusEl.className = 'doc-status processing';
  statusEl.innerHTML = `<div class="spinner"></div> AI is reading document...`;
  fieldsEl.className = 'doc-extracted-fields';
  fieldsEl.style.display = 'none';

  const typeLabel = { rc:'RC Book', dl:'Driving Licence', policy:'Insurance Policy', claim:'Claim Form', estimate:'Repair Estimate', photos:'Damage Photos', permit:'Permit', auth:'Authorisation', fitness:'Fitness Certificate', 'lok-challan':'Lok Challan' };
  appendLog(logEl, `üìÑ Processing ${typeLabel[type]||type}...`);

  try {
    let extracted;

    if (file.type === 'application/pdf') {
      // Convert ALL pages to images
      statusEl.innerHTML = `<div class="spinner"></div> Converting PDF pages...`;
      const images = await pdfToImages(file, statusEl);

      // Show preview strip
      previewEl.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:4px;padding:6px;">
        ${images.map((img,i) => `<img src="${img.dataUrl}" style="width:100%;height:60px;object-fit:cover;border-radius:4px;" title="Page ${i+1}"/>`).join('')}
      </div><div style="padding:4px 8px;font-size:0.7rem;color:var(--muted);">${images.length} page(s)</div>`;

      appendLog(logEl, `  üìÑ ${images.length} page(s) converted ‚Äî sending to AI${images.length > 5 ? ` (in ${Math.ceil(images.length/5)} chunks of 5)` : ''}...`);
      statusEl.innerHTML = `<div class="spinner"></div> AI reading ${images.length} page(s)${images.length > 5 ? ' (chunked)' : ''}...`;

      const rawText = await callGeminiChunked(images, DOC_PROMPTS[type], 4000);
      try {
        extracted = JSON.parse(rawText.replace(/```json|```/g, '').trim());
      } catch (e) {
        throw new Error('Could not parse AI response');
      }

    } else {
      // Single image file
      const base64 = await fileToBase64(file);
      let mediaType = file.type || 'image/jpeg';
      if (!['image/jpeg','image/png','image/webp','image/gif'].includes(mediaType)) mediaType = 'image/jpeg';
      const parts = [
        { inlineData: { mimeType: mediaType, data: base64 } },
        { text: DOC_PROMPTS[type] }
      ];
      const rawText = await callGemini(parts, 4000);
      try {
        extracted = JSON.parse(rawText.replace(/```json|```/g, '').trim());
      } catch (e) {
        throw new Error('Could not parse AI response');
      }
    }

    // Apply extracted data to form fields
    const fieldCount = applyExtractedData(type, extracted);

    // Show success state
    if (card) card.className = 'doc-card done' + (type==='fitness'||type==='permit'||type==='auth'||type==='lok-challan' ? ' commercial-doc' : '');
    statusEl.className = 'doc-status done';
    statusEl.innerHTML = `‚úÖ Extracted ${fieldCount} fields`;

    // Show extracted fields summary
    showExtractedSummary(type, extracted, fieldsEl);

    // Update status dots
    aiStatusMap[type] = true;
    updateAIStatusDots();

    appendLog(logEl, `‚úÖ ${typeLabel[type]||type} ‚Äî ${fieldCount} fields extracted`);
    showToast(`${typeLabel[type]||type}: ${fieldCount} fields filled!`, 'success');

    const doneCount = Object.values(aiStatusMap).filter(Boolean).length;
    if (doneCount >= 2) {
      document.getElementById('go-to-form-btn').classList.remove('hidden');
    }

  } catch (err) {
    if (card) card.className = 'doc-card error' + (type==='fitness'||type==='permit'||type==='auth'||type==='lok-challan' ? ' commercial-doc' : '');
    statusEl.className = 'doc-status error';
    statusEl.innerHTML = `‚ö†Ô∏è ${err.message}`;
    appendLog(logEl, `‚ùå ${typeLabel[type]||type} ‚Äî ${err.message}`);
    showToast(`Error: ${err.message}`, 'error');
    console.error('Extraction Error:', err);
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function appendLog(el, msg) {
  if (!el) return;
  el.innerHTML += `<div>${new Date().toLocaleTimeString('en-IN')} ‚Äî ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

// ============================================================
// APPLY EXTRACTED DATA TO FORM FIELDS
// ============================================================
function applyExtractedData(type, data) {
  let count = 0;
  function setField(id, val) {
    if (!val) return;
    const el = document.getElementById(id);
    if (!el) return;
    const str = String(val).trim();
    if (!str || str === 'null' || str === 'undefined') return;
    el.value = str;
    el.classList.add('ai-filled');
    count++;
  }
  function tryDate(v) {
    if (!v) return '';
    // Convert DD-MM-YYYY or DD/MM/YYYY to YYYY-MM-DD
    const m = String(v).match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})/);
    if (m) return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    // YYYY-MM-DD already
    if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
    return v;
  }

  if (type === 'rc') {
    setField('f-reg-no', data.registration_number);
    setField('f-make', data.make);
    setField('f-model', data.model);
    setField('f-chassis', data.chassis_number);
    setField('f-engine', data.engine_number);
    setField('f-cc', data.cubic_capacity);
    setField('f-colour', data.colour);
    setField('f-body-type', data.body_type);
    setField('f-rlw', data.gross_weight || data.seating_capacity);
    setField('f-route', data.route);
    setField('f-fitness', data.fitness_cert_no);
    setField('f-hpa', data.hypothecation);
    setField('f-insured-name', data.owner_name);
    setField('f-insured-addr', data.address);
    if (data.year_of_manufacture) setField('f-year', data.year_of_manufacture);
    if (data.fuel) {
      const fuelEl = document.getElementById('f-fuel');
      if (fuelEl) { const opt = [...fuelEl.options].find(o => o.text.toLowerCase().includes(data.fuel.toLowerCase())); if (opt) { fuelEl.value = opt.value; count++; } }
    }
    if (data.date_of_registration) setField('f-reg-date', tryDate(data.date_of_registration));
    // FIX: set vehicle class from RC
    if (data.class_of_vehicle) setField('f-veh-class', data.class_of_vehicle);
    // ‚îÄ‚îÄ Mirror to Spot Survey ‚îÄ‚îÄ
    // FIX Bug 2: gross_weight = GVW, not load capacity. Set spot-gvw and spot-ulw correctly.
    // spot-load-capacity (= GVW ‚àí ULW) will be auto-calculated by calcLoadCapacity() when both are set.
    if (data.gross_weight) {
      setField('spot-gvw', String(Math.round(parseFloat(data.gross_weight) || 0)));
      setField('f-rlw', String(Math.round(parseFloat(data.gross_weight) || 0)));  // keep RLW in sync
    }
    if (data.unladen_weight) {
      setField('spot-ulw', String(Math.round(parseFloat(data.unladen_weight) || 0)));
    }
    // Trigger auto-calculation of load capacity if both are now set
    if (data.gross_weight && data.unladen_weight) {
      const gvwVal = parseFloat(data.gross_weight) || 0;
      const ulwVal = parseFloat(data.unladen_weight) || 0;
      if (gvwVal > 0 && ulwVal > 0 && gvwVal > ulwVal) {
        const cap = Math.round(gvwVal - ulwVal);
        const capEl = document.getElementById('spot-load-capacity');
        if (capEl) { capEl.value = cap; capEl.classList.add('ai-filled'); count++; }
      }
    }
  }

  if (type === 'dl') {
    const fullName = data.holder_name || '';
    const relation = data.relation_type || 'S/o';
    const parent   = data.father_or_husband_name || '';
    // Build "Driver X S/o Y" display name for main form
    setField('f-driver-name', fullName);
    setField('f-dl-parent', parent);
    if (relation) {
      const relEl = document.getElementById('f-dl-relation');
      if (relEl) { relEl.value = relation; count++; }
    }
    setField('f-mdl', data.licence_number);
    if (data.validity_non_transport) setField('f-dl-valid', tryDate(data.validity_non_transport));
    if (data.validity_transport)     setField('f-dl-valid-transport', tryDate(data.validity_transport));
    setField('f-dl-auth', data.issuing_authority || data.rto);
    setField('f-dl-type', data.vehicle_classes);
    if (data.date_of_birth) setField('f-dob', tryDate(data.date_of_birth));
    if (data.date_of_issue) setField('f-dl-issue', tryDate(data.date_of_issue));
    // ‚îÄ‚îÄ Mirror to Spot Survey ‚îÄ‚îÄ
    setField('spot-driver-name', fullName);
    setField('spot-dl-parent', parent);
    if (relation) {
      const relEl2 = document.getElementById('spot-dl-relation');
      if (relEl2) { relEl2.value = relation; count++; }
    }
    setField('spot-mdl-no', data.licence_number);
    setField('spot-dl-authority', data.issuing_authority || data.rto);
    setField('spot-dl-type', data.vehicle_classes);
    if (data.validity_non_transport) setField('spot-dl-valid', tryDate(data.validity_non_transport));
    if (data.validity_transport)     setField('spot-dl-valid-transport', tryDate(data.validity_transport));
    if (data.date_of_issue) setField('spot-dl-issue', tryDate(data.date_of_issue));
  }

  if (type === 'policy') {
    setField('f-policy-no', data.policy_number);
    setField('f-insurer', data.insurer_name && data.insurer_address ? data.insurer_name + ' ' + data.insurer_address : data.insurer_name);
    setField('f-insured-name', data.insured_name);
    setField('f-insured-addr', data.insured_address);
    setField('f-insured-mobile', data.insured_mobile);
    setField('f-idv', data.idv);
    setField('f-policy-office', data.policy_issuing_office);
    setField('f-hpa', data.hpa_with);
    setField('f-reg-no', data.registration_number);
    setField('f-chassis', data.chassis_number);
    setField('f-engine', data.engine_number);
    if (data.period_from) setField('f-policy-from', tryDate(data.period_from));
    if (data.period_to) setField('f-policy-to', tryDate(data.period_to));
    if (data.policy_type) {
      const sel = document.getElementById('f-policy-type');
      if (sel) { const opt = [...sel.options].find(o => o.text.toLowerCase().includes((data.policy_type || '').toLowerCase().substring(0,6))); if (opt) { sel.value = opt.value; count++; } }
    }
    // ‚îÄ‚îÄ Mirror to Spot Survey ‚îÄ‚îÄ
    // Policy data doesn't directly feed spot survey fields ‚Äî no mirror needed
  }

  if (type === 'claim') {
    setField('f-claim-no', data.claim_number);
    setField('f-policy-no', data.policy_number);
    setField('f-insured-name', data.insured_name);
    setField('f-poa', data.place_of_accident);
    setField('f-cause', data.cause_of_accident);
    setField('f-driver-name', data.driver_name);
    setField('f-mdl', data.driver_licence_no);
    setField('f-survey-place', data.workshop_name || data.place_of_repair);
    setField('f-tp', data.third_party_details);
    if (data.date_of_accident) {
      const dt = tryDate(data.date_of_accident);
      const time = data.time_of_accident || '00:00';
      setField('f-doa', dt + 'T' + (time.includes(':') ? time.substring(0,5) : '00:00'));
    }
    if (data.vehicle_number) setField('f-reg-no', data.vehicle_number);
    // ‚îÄ‚îÄ Mirror to Spot Survey ‚îÄ‚îÄ
    setField('spot-accident-place', data.place_of_accident);
    setField('spot-accident-cause', data.cause_of_accident);
    setField('spot-driver-name', data.driver_name);
    setField('spot-mdl-no', data.driver_licence_no);
    setField('spot-survey-place', data.workshop_name || data.place_of_repair);
    setField('spot-tp-details', data.third_party_details);
    if (data.third_party_details && data.third_party_details.toLowerCase() !== 'nil' && data.third_party_details.trim() !== '') {
      // FIX Bug 3: 'yes' is not a valid option. Valid values: no, tppd, tppi, both.
      // Default to 'tppd' (property damage) as the most common case when TP is mentioned.
      const tpSel = document.getElementById('spot-tp-involved');
      if (tpSel) {
        const tpStr = (data.third_party_details || '').toLowerCase();
        if (tpStr.includes('injur') || tpStr.includes('death') || tpStr.includes('bodily')) {
          tpSel.value = tpStr.includes('damage') || tpStr.includes('property') ? 'both' : 'tppi';
        } else {
          tpSel.value = 'tppd';
        }
        count++;
      }
    }
    if (data.date_of_accident) {
      const dt = tryDate(data.date_of_accident);
      const time = data.time_of_accident || '00:00';
      const timeStr = time.includes(':') ? time.substring(0,5) : '00:00';
      setField('spot-accident-datetime', dt + 'T' + timeStr);
    }
    // FIX Bug 5: seed spot report date and allotment date (default to today if not already set)
    const today = new Date().toISOString().split('T')[0];
    const spotRptDate = document.getElementById('spot-report-date');
    if (spotRptDate && !spotRptDate.value) { spotRptDate.value = today; spotRptDate.classList.add('ai-filled'); count++; }
    const spotAllotDate = document.getElementById('spot-allot-date');
    if (spotAllotDate && !spotAllotDate.value) { spotAllotDate.value = today; spotAllotDate.classList.add('ai-filled'); count++; }
  }

  if (type === 'estimate') {
    setField('f-survey-place', data.workshop_name);
    // FIX Bug 4: also mirror workshop name to spot survey place
    setField('spot-survey-place', data.workshop_name);
    if (data.workshop_address) setField('f-insured-addr', data.workshop_address); // don't overwrite if already set
    // Build assessment rows from estimate
    if (data.spare_parts && Array.isArray(data.spare_parts) && data.spare_parts.length > 0) {
      data.spare_parts.forEach(part => {
        if (!part.description) return;
        const cat = (part.category || '').toLowerCase();
        const partType = cat.includes('glass') ? 'glass' : cat.includes('plastic') || cat.includes('rubber') ? 'plastic' : 'metal';
        assessRows.push({
          particulars: part.description,
          estimated: parseFloat(part.amount) || 0,
          assessed: parseFloat(part.amount) || 0,
          partType, gst: parseInt(part.gst_percent) || 18, section: 'parts'
        });
        count++;
      });
    }
    if (data.labour_items && Array.isArray(data.labour_items)) {
      data.labour_items.forEach(item => {
        if (!item.description) return;
        assessRows.push({ particulars: item.description, estimated: parseFloat(item.amount) || 0, assessed: parseFloat(item.amount) || 0, partType: 'labour', gst: 18, section: 'labour' });
        count++;
      });
    }
    if (data.painting_items && Array.isArray(data.painting_items)) {
      data.painting_items.forEach(item => {
        if (!item.description) return;
        assessRows.push({ particulars: item.description, estimated: parseFloat(item.amount) || 0, assessed: parseFloat(item.amount) || 0, partType: 'paint', gst: 18, section: 'paint' });
        count++;
      });
    }
    renderAssessTable();
  }

  if (type === 'photos') {
    if (data.overall_damage_summary) {
      const causeEl = document.getElementById('f-cause');
      if (causeEl && !causeEl.value) { causeEl.value = data.overall_damage_summary; count++; }
      // FIX Bug 1: spot-damage-details element does NOT exist. Route summary to spot-comments instead.
      const spotCommentsEl = document.getElementById('spot-comments');
      if (spotCommentsEl && !spotCommentsEl.value) {
        spotCommentsEl.value = data.overall_damage_summary;
        spotCommentsEl.classList.add('ai-filled');
        count++;
      }
    }
    if (data.damaged_parts && Array.isArray(data.damaged_parts) && data.damaged_parts.length > 0) {
      // Set overall severity from worst damage found
      const severities = data.damaged_parts.map(p => (p.severity||'').toLowerCase());
      const spotSev = document.getElementById('spot-damage-severity');
      if (spotSev) {
        if (severities.some(s => s.includes('major') || s.includes('severe'))) spotSev.value = 'major';
        else if (severities.some(s => s.includes('moderate') || s.includes('medium'))) spotSev.value = 'moderate';
        else spotSev.value = 'minor';
        spotSev.classList.add('ai-filled');
        count++;
      }
      // FIX Bug 1 (critical): Populate the spotDamageRows table with AI-detected components.
      // Map AI part names to the common component dropdown values where possible.
      const componentMap = {
        'bumper': 'BODY PANELS', 'bonnet': 'BODY PANELS', 'hood': 'BODY PANELS',
        'fender': 'BODY PANELS', 'door': 'BODY PANELS', 'panel': 'BODY PANELS',
        'windshield': 'WINDSHIELD & GLASS', 'windscreen': 'WINDSHIELD & GLASS',
        'glass': 'WINDSHIELD & GLASS', 'window': 'WINDSHIELD & GLASS',
        'headlight': 'ELECTRICAL SYSTEM', 'taillight': 'ELECTRICAL SYSTEM', 'light': 'ELECTRICAL SYSTEM',
        'headlamp': 'ELECTRICAL SYSTEM', 'foglamp': 'ELECTRICAL SYSTEM',
        'tyre': 'WHEEL DISCS & TYRES', 'wheel': 'WHEEL DISCS & TYRES', 'rim': 'WHEEL DISCS & TYRES',
        'engine': 'ENGINE & TRANSMISSION', 'transmission': 'ENGINE & TRANSMISSION', 'gearbox': 'ENGINE & TRANSMISSION',
        'radiator': 'COOLING SYSTEM', 'coolant': 'COOLING SYSTEM',
        'suspension': 'FRONT SUSPENSION', 'shock': 'FRONT SUSPENSION',
        'chassis': 'CHASSIS ASSY', 'frame': 'CHASSIS ASSY',
        'axle': 'FRONT AXLE ASSY', 'brake': 'BRAKING SYSTEM',
        'steering': 'STEERING SYSTEM', 'airbag': 'INTERIOR', 'dashboard': 'INTERIOR', 'interior': 'INTERIOR',
        'cabin': 'FRONT END STRUCTURE / DRIVERS CABIN', 'roof': 'BODY PANELS',
      };
      // Only add rows if spotDamageRows is currently empty (don't duplicate)
      if (spotDamageRows.length === 0) {
        data.damaged_parts.forEach(part => {
          const partName = (part.part || '').toLowerCase();
          let component = 'BODY PANELS'; // default
          for (const [key, val] of Object.entries(componentMap)) {
            if (partName.includes(key)) { component = val; break; }
          }
          const side = part.side ? `(${part.side}) ` : '';
          const damageDesc = `${side}${part.damage_type || 'Damaged'}. Severity: ${part.severity || 'Moderate'}.`;
          addSpotDamageRow(component, damageDesc);
          count++;
        });
      }
    }
  }

  if (type === 'permit') {
    setField('spot-permit-no', data.permit_no);
    setField('spot-permit-type', data.permit_type);
    setField('f-route', data.route || data.permit_type);
    if (data.validity_from) setField('spot-permit-from', tryDate(data.validity_from));
    if (data.validity_to)   setField('spot-permit-to',   tryDate(data.validity_to));
    // Compute load capacity if weights available
    const gvwP = parseFloat(data.gross_vehicle_weight_kg || 0);
    const ulwP = parseFloat(data.unladen_weight_kg || 0);
    if (gvwP > 0) setField('f-rlw', String(Math.round(gvwP)));
    if (gvwP > 0 && ulwP > 0) {
      const loadKg = Math.round(gvwP - ulwP);
      setField('spot-load-capacity', String(loadKg));
      showToast(`Load capacity from Permit: ${gvwP.toLocaleString()} - ${ulwP.toLocaleString()} = ${loadKg.toLocaleString()} KG`, 'success');
    }
  }

  if (type === 'auth') {
    setField('spot-auth-no', data.auth_no);
    if (data.validity_to) setField('spot-auth-valid', tryDate(data.validity_to));
  }

  if (type === 'fitness') {
    setField('spot-fitness-no', data.fitness_cert_no);
    setField('f-fitness', data.fitness_cert_no);
    if (data.validity_to) setField('spot-fitness-valid', tryDate(data.validity_to));
    const gvw = parseFloat(data.gross_vehicle_weight_kg || data.gross_weight || 0);
    const ulw = parseFloat(data.unladen_weight_kg || data.unladen_weight || 0);
    if (gvw > 0) {
      setField('f-rlw', String(Math.round(gvw)));
      setField('spot-gvw', String(Math.round(gvw)));
    }
    if (ulw > 0) setField('spot-ulw', String(Math.round(ulw)));
    // Load carrying capacity = GVW - Unladen weight
    if (gvw > 0 && ulw > 0) {
      const loadCapKg = Math.round(gvw - ulw);
      setField('spot-load-capacity', String(loadCapKg));
      showToast(`Load capacity (Fitness): ${gvw.toLocaleString()} ‚àí ${ulw.toLocaleString()} = ${loadCapKg.toLocaleString()} KG`, 'success');
    } else if (gvw > 0) {
      setField('spot-load-capacity', String(Math.round(gvw)));
    }
  }

  if (type === 'lok-challan') {
    setField('spot-cn-no', data.challan_no);
    setField('spot-load-desc', data.goods_description);
    setField('spot-load-origin', data.origin);
    setField('spot-load-dest', data.destination);
    if (data.weight_kg) setField('spot-actual-load', data.weight_kg);
    if (data.challan_date) setField('spot-cn-date', tryDate(data.challan_date));
  }
  return count;
}

function showExtractedSummary(type, data, el) {
  el.style.display = 'block';
  el.classList.add('show');
  let html = '';
  if (type === 'estimate') {
    const parts = (data.spare_parts || []).length;
    const labour = (data.labour_items || []).length;
    const paint = (data.painting_items || []).length;
    html = `<div class="extracted-field"><span class="ef-key">Parts:</span><span class="ef-val">${parts} items</span></div>
            <div class="extracted-field"><span class="ef-key">Labour:</span><span class="ef-val">${labour} items</span></div>
            <div class="extracted-field"><span class="ef-key">Painting:</span><span class="ef-val">${paint} items</span></div>
            <div class="extracted-field"><span class="ef-key">Total:</span><span class="ef-val">‚Çπ ${data.total_amount || '‚Äî'}</span></div>`;
  } else if (type === 'photos') {
    const parts = (data.damaged_parts || []);
    html = `<div class="extracted-field"><span class="ef-key">Damage:</span><span class="ef-val">${parts.length} areas found</span></div>`;
    parts.slice(0,3).forEach(p => { html += `<div class="extracted-field"><span class="ef-key">${p.side || ''}:</span><span class="ef-val">${p.part} ‚Äî ${p.damage_type}</span></div>`; });
  } else {
    const entries = Object.entries(data).filter(([k,v]) => v && v !== 'null' && String(v).trim() !== '').slice(0, 5);
    entries.forEach(([k, v]) => {
      html += `<div class="extracted-field"><span class="ef-key">${k.replace(/_/g,' ')}:</span><span class="ef-val">${String(v).substring(0,40)}${String(v).length>40?'‚Ä¶':''}</span></div>`;
    });
  }
  el.innerHTML = html;
}

function updateAIStatusDots() {
  const map = { rc: 'ai-rc', dl: 'ai-dl', policy: 'ai-pol', claim: 'ai-claim', estimate: 'ai-est', photos: 'ai-photos' };
  Object.entries(aiStatusMap).forEach(([k, v]) => {
    const el = document.getElementById(map[k]);
    if (el) el.style.background = v ? 'var(--green)' : '#e5e7eb';
  });
}

// ============================================================
// ASSESSMENT TABLE
// ============================================================
function addAssessRow(section) {
  currentModal = section;
  const titles = { parts: 'Add Spare Part', labour: 'Add Labour Item', paint: 'Add Painting Charge' };
  document.getElementById('modal-title').textContent = titles[section] || 'Add Item';
  const typeMap = { parts: 'metal', labour: 'labour', paint: 'paint' };
  document.getElementById('modal-part-type').value = typeMap[section] || 'metal';
  document.getElementById('modal-particulars').value = '';
  document.getElementById('modal-estimated').value = '';
  document.getElementById('modal-assessed').value = '';
  document.getElementById('add-row-modal').classList.add('open');
}
function closeModal() { document.getElementById('add-row-modal').classList.remove('open'); }
function confirmAddRow() {
  const particulars = document.getElementById('modal-particulars').value.trim();
  const estimated = parseFloat(document.getElementById('modal-estimated').value) || 0;
  const assessed = parseFloat(document.getElementById('modal-assessed').value) || estimated;
  const partType = document.getElementById('modal-part-type').value;
  const gst = parseInt(document.getElementById('modal-gst').value) || 18;
  if (!particulars) { showToast('Please enter a description', 'error'); return; }
  assessRows.push({ particulars, estimated, assessed, partType, gst, section: currentModal, allowed: true });
  renderAssessTable();
  closeModal();
  showToast('Item added');
}
function deleteRow(idx) { assessRows.splice(idx, 1); renderAssessTable(); }
function toggleAllowed(idx) {
  assessRows[idx].allowed = !assessRows[idx].allowed;
  renderAssessTable();
}

// IRDAI standard depreciation rates by vehicle age
// IRDAI depreciation ‚Äî calculated from Date of Registration to Date of Accident (exact months)
function getVehicleAgeMonths() {
  // Prefer exact registration date; fall back to Jan 1 of manufacture year
  const regDateStr = gv('f-reg-date');
  const mfgYear    = parseInt(gv('f-year'));
  let startDate;
  if (regDateStr) {
    startDate = new Date(regDateStr);
  } else if (mfgYear) {
    startDate = new Date(mfgYear, 0, 1); // Jan 1 of manufacture year
  } else {
    return 0; // no data ‚Äî assume new vehicle
  }

  // Reference: date of accident; fall back to today only if not filled
  const doaStr = gv('f-doa');
  const refDate = doaStr ? new Date(doaStr) : new Date();

  if (isNaN(startDate.getTime()) || isNaN(refDate.getTime())) return 0;
  if (refDate < startDate) return 0;

  const years  = refDate.getFullYear() - startDate.getFullYear();
  const months = refDate.getMonth()    - startDate.getMonth();
  return years * 12 + months;
}

function getDepRate(partType) {
  if (depType === 'nil') return 0;
  if (partType === 'glass')                      return 0;
  if (partType === 'plastic')                    return 50;
  if (partType === 'labour' || partType === 'paint') return 0;

  // Metal parts ‚Äî IRDAI slab by exact vehicle age at time of accident
  const age = getVehicleAgeMonths();
  if (age <= 6)   return 0;
  if (age <= 12)  return 5;
  if (age <= 24)  return 10;
  if (age <= 36)  return 15;
  if (age <= 48)  return 25;
  if (age <= 60)  return 35;
  if (age <= 120) return 40;
  return 50;
}

function renderAssessTable() {
  const tbody = document.getElementById('assess-tbody');
  tbody.innerHTML = '';
  const sections = [
    { key: 'parts',  label: 'SPARE PARTS' },
    { key: 'labour', label: 'LABOUR CHARGES' },
    { key: 'paint',  label: 'PAINTING CHARGES' }
  ];

  const ptOptions = `
    <option value="metal">Metal</option>
    <option value="plastic">Plastic/Rubber</option>
    <option value="glass">Glass</option>
    <option value="labour">Labour</option>
    <option value="paint">Paint</option>`;

  sections.forEach(sec => {
    const rows = assessRows.map((r,i) => ({...r, origIdx:i})).filter(r => r.section === sec.key);
    if (!rows.length) return;

    // Section header row
    const hr = tbody.insertRow();
    hr.className = 'section-row';
    hr.innerHTML = `<td colspan="10">${sec.label}</td>`;

    let secSrNo = 1;
    rows.forEach(row => {
      const idx = row.origIdx;
      if (row.allowed === undefined) assessRows[idx].allowed = true;
      const allowed = assessRows[idx].allowed;
      const depRate = getDepRate(row.partType);
      const afterDep = allowed ? row.assessed * (1 - depRate / 100) : 0;
      const tr = tbody.insertRow();
      tr.style.opacity = allowed ? '1' : '0.45';

      tr.innerHTML = `
        <td class="mono" style="color:var(--muted);font-size:0.75rem;">${secSrNo++}</td>
        <td><input class="text-input-cell" value="${row.particulars.replace(/"/g,'&quot;')}"
          onchange="assessRows[${idx}].particulars=this.value"/></td>
        <td>
          <select class="text-input-cell" style="font-size:0.73rem;padding:3px 4px;"
            onchange="assessRows[${idx}].partType=this.value;renderAssessTable()">
            ${ptOptions.replace(`value="${row.partType}"`,`value="${row.partType}" selected`)}
          </select>
        </td>
        <td class="text-center">
          <input class="num-input" style="width:46px;text-align:center;"
            value="${row.gst}"
            onchange="assessRows[${idx}].gst=parseInt(this.value)||18;recalcSummary()"/>%
        </td>
        <td class="text-right">
          <input class="num-input" value="${row.estimated.toFixed(2)}"
            onchange="assessRows[${idx}].estimated=parseFloat(this.value)||0;recalcSummary()"/>
        </td>
        <td class="text-right">
          <input class="num-input" style="background:${allowed?'#f0fdf8':'#fef2f2'};"
            value="${row.assessed.toFixed(2)}"
            onchange="assessRows[${idx}].assessed=parseFloat(this.value)||0;renderAssessTable()"/>
        </td>
        <td class="text-center mono" style="font-size:0.75rem;color:${depRate>0?'var(--gold)':'var(--muted)'};">
          ${depRate}%
        </td>
        <td class="text-right mono" style="font-weight:600;color:${allowed?'var(--teal)':'var(--red)'};">
          ${allowed ? '‚Çπ '+afterDep.toFixed(2) : 'DISALLOWED'}
        </td>
        <td class="text-center">
          <button onclick="toggleAllowed(${idx})"
            style="font-size:0.68rem;padding:3px 7px;border-radius:4px;border:none;cursor:pointer;font-weight:600;
              background:${allowed?'#d1fae5':'#fee2e2'};color:${allowed?'var(--green)':'var(--red)'};">
            ${allowed ? '‚úì Allow' : '‚úó Disallow'}
          </button>
        </td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" style="padding:3px 7px;" onclick="deleteRow(${idx})">üóë</button>
        </td>`;
    });

    // Section subtotal
    const subRows = rows.map(r => assessRows[r.origIdx]);
    const subAfterDep = subRows.reduce((s,r) => s + (r.allowed!==false ? r.assessed*(1-getDepRate(r.partType)/100) : 0), 0);
    const subtr = tbody.insertRow();
    subtr.className = 'subtotal-row';
    subtr.innerHTML = `<td colspan="7" style="text-align:right;font-size:0.75rem;">Sub-Total ${sec.label}</td>
      <td colspan="2" class="text-right mono">‚Çπ ${subAfterDep.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',')}</td>
      <td></td>`;
  });

  recalcSummary();
}

function recalcSummary() {
  let metal=0, plastic=0, glass=0, labBase=0;

  assessRows.filter(r => r.section==='parts').forEach(r => {
    if (r.allowed === false) return;
    const dep = getDepRate(r.partType);
    const afterDep = r.assessed * (1 - dep/100);
    if (r.partType==='metal')        metal   += afterDep;
    else if (r.partType==='glass')   glass   += afterDep;
    else                             plastic += afterDep;
  });

  assessRows.filter(r => r.section==='labour' || r.section==='paint').forEach(r => {
    if (r.allowed === false) return;
    labBase += r.assessed;
  });

  const partsBase = metal + plastic + glass;
  const pGST = partsBase * 0.09; // CGST+SGST each 9%
  const pTotal = partsBase + pGST * 2;
  const lGST = labBase * 0.18;
  const lTotal = labBase + lGST;
  const grand = pTotal + lTotal;
  const salvage = parseFloat(document.getElementById('sum-salvage').value) || 0;
  const excess  = parseFloat(document.getElementById('sum-excess').value)  || 500;
  const net = Math.max(0, grand - salvage - excess);

  const f = v => '‚Çπ ' + v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');

  document.getElementById('sum-parts-base').textContent  = f(partsBase);
  document.getElementById('sum-parts-cgst').textContent  = f(pGST);
  document.getElementById('sum-parts-sgst').textContent  = f(pGST);
  document.getElementById('sum-parts-total').textContent = f(pTotal);
  document.getElementById('sum-labour-base').textContent = f(labBase);
  document.getElementById('sum-labour-gst').textContent  = f(lGST);
  document.getElementById('sum-labour-total').textContent= f(lTotal);
  document.getElementById('sum-grand').textContent       = f(grand);
  document.getElementById('sum-net').textContent         = f(net);
  document.getElementById('sum-inwords').textContent     = 'RUPEES ' + numberToWords(net) + ' ONLY';
  document.getElementById('bd-metal').textContent        = f(metal);
  document.getElementById('bd-plastic').textContent      = f(plastic);
  document.getElementById('bd-glass').textContent        = f(glass);

  // estimate compare (include GST)
  let estTotal = 0;
  assessRows.forEach(r => { estTotal += r.estimated * (1 + r.gst/100); });
  document.getElementById('cmp-est').textContent  = f(estTotal);
  document.getElementById('cmp-ass').textContent  = f(grand);
  document.getElementById('cmp-diff').textContent = f(Math.abs(estTotal - grand));
  if (document.getElementById('dash-est'))      document.getElementById('dash-est').textContent      = f(estTotal);
  if (document.getElementById('dash-assessed')) document.getElementById('dash-assessed').textContent = f(grand);
  if (document.getElementById('dash-net'))      document.getElementById('dash-net').textContent      = f(net);
}

// ============================================================
// HELPERS
// ============================================================
function gv(id){return (document.getElementById(id)||{}).value||'';}
function fmt2(v){return parseFloat(v||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function setDepType(t){
  depType=t;
  document.querySelectorAll('#dep-toggle button').forEach((b,i)=>{
    b.classList.toggle('active',(t==='nil'&&i===0)||(t==='standard'&&i===1));
  });
  const age = getVehicleAgeMonths();
  const ageText = age > 0 ? ` ¬∑ ${Math.floor(age/12)}y ${age%12}m old` : '';
  const metalDep = t==='nil' ? 0 : getDepRate('metal');
  document.getElementById('assess-policy-badge').textContent =
    t==='nil' ? '0% Dep. Policy' : `Std. Dep. ‚Äî Metal ${metalDep}%${ageText}`;
  renderAssessTable();
}
function handleSigUpload(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{sigDataUrl=e.target.result;document.getElementById('sig-placeholder').classList.add('hidden');const img=document.getElementById('sig-preview-img');img.src=sigDataUrl;img.classList.remove('hidden');};r.readAsDataURL(f);}
function handleStampUpload(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{stampDataUrl=e.target.result;document.getElementById('stamp-placeholder').classList.add('hidden');const img=document.getElementById('stamp-preview-img');img.src=stampDataUrl;img.classList.remove('hidden');};r.readAsDataURL(f);}
function showToast(msg,type='success'){const t=document.getElementById('toast');document.getElementById('toast-msg').textContent=msg;document.getElementById('toast-icon').textContent=type==='error'?'‚úï':type==='ai'?'ü§ñ':'‚úì';t.className='toast show '+type;setTimeout(()=>t.classList.remove('show'),3200);}

// LocalStorage Save/Load System
function gatherCurrentReportData(){return{reportNo:gv('f-report-no'),reportDate:gv('f-report-date'),vehicle:gv('f-reg-no'),insured:gv('f-insured-name'),claimNo:gv('f-claim-no'),policyNo:gv('f-policy-no'),make:gv('f-make'),model:gv('f-model'),savedAt:new Date().toISOString(),formData:{policyFrom:gv('f-policy-from'),policyTo:gv('f-policy-to'),idv:gv('f-idv'),policyType:gv('f-policy-type'),policyOffice:gv('f-policy-office'),insurer:gv('f-insurer'),apptOffice:gv('f-appt-office'),insuredMobile:gv('f-insured-mobile'),insuredAddr:gv('f-insured-addr'),hpa:gv('f-hpa'),regDate:gv('f-reg-date'),vehClass:gv('f-veh-class'),year:gv('f-year'),chassis:gv('f-chassis'),engine:gv('f-engine'),cc:gv('f-cc'),bodyType:gv('f-body-type'),colour:gv('f-colour'),fuel:gv('f-fuel'),odo:gv('f-odo'),rlw:gv('f-rlw'),condition:gv('f-condition'),driverName:gv('f-driver-name'),mdl:gv('f-mdl'),dob:gv('f-dob'),dlIssue:gv('f-dl-issue'),dlValid:gv('f-dl-valid'),dlAuth:gv('f-dl-auth'),dlType:gv('f-dl-type'),doa:gv('f-doa'),poa:gv('f-poa'),surveyDate:gv('f-survey-date'),surveyPlace:gv('f-survey-place'),cause:gv('f-cause'),tp:gv('f-tp')},assessmentData:{rows:assessRows,depType:depType,salvage:parseFloat(gv('sum-salvage'))||0,excess:parseFloat(gv('sum-excess'))||0},riData:{riRef:gv('ri-ref'),riDate:gv('ri-date'),riParts:riParts},spotSurveyData:{reportNo:gv('spot-report-no'),reportDate:gv('spot-report-date'),allotDate:gv('spot-allot-date'),surveyDatetime:gv('spot-survey-datetime'),accidentDatetime:gv('spot-accident-datetime'),accidentPlace:gv('spot-accident-place'),surveyPlace:gv('spot-survey-place'),cause:gv('spot-accident-cause'),driverName:gv('spot-driver-name'),mdlNo:gv('spot-mdl-no'),dlAuthority:gv('spot-dl-authority'),dlIssue:gv('spot-dl-issue'),dlValid:gv('spot-dl-valid'),dlType:gv('spot-dl-type'),mdlVerified:gv('spot-mdl-verified'),dlInvalidRemarks:gv('spot-dl-invalid-remarks'),cnNo:gv('spot-cn-no'),cnDate:gv('spot-cn-date'),loadCapacity:gv('spot-load-capacity'),actualLoad:gv('spot-actual-load'),loadDesc:gv('spot-load-desc'),policeReported:gv('spot-police-reported'),policeStation:gv('spot-police-station'),diaryNo:gv('spot-diary-no'),panchanama:gv('spot-panchanama'),tpInvolved:gv('spot-tp-involved'),tpDetails:gv('spot-tp-details'),damageSeverity:gv('spot-damage-severity'),airbags:gv('spot-airbags'),drivable:gv('spot-drivable'),damageRows:spotDamageRows,comments:gv('spot-comments')},signatures:{signature:sigDataUrl,stamp:stampDataUrl}};}
function saveAll(){const data=gatherCurrentReportData();if(!data.vehicle){showToast('Enter vehicle registration number first','error');return;}const reportId='survey_'+data.vehicle.replace(/[^A-Z0-9]/gi,'')+'_'+Date.now();localStorage.setItem(reportId,JSON.stringify(data));let allReports=JSON.parse(localStorage.getItem('all_reports')||'[]');allReports=allReports.filter(r=>r.reportNo!==data.reportNo||!data.reportNo);allReports.unshift({id:reportId,reportNo:data.reportNo||'DRAFT-'+data.vehicle,vehicle:data.vehicle,insured:data.insured,claimNo:data.claimNo,savedAt:data.savedAt,make:data.make,model:data.model});if(allReports.length>50)allReports=allReports.slice(0,50);localStorage.setItem('all_reports',JSON.stringify(allReports));localStorage.setItem('current_report_id',reportId);showToast('Report saved successfully!','success');refreshReportsList();updateDashboard();}
function loadReport(reportId){const saved=localStorage.getItem(reportId);if(!saved){showToast('Report not found','error');return;}try{const data=JSON.parse(saved);document.getElementById('f-report-no').value=data.reportNo||'';document.getElementById('f-report-date').value=data.reportDate||'';document.getElementById('f-reg-no').value=data.vehicle||'';document.getElementById('f-insured-name').value=data.insured||'';document.getElementById('f-claim-no').value=data.claimNo||'';document.getElementById('f-policy-no').value=data.policyNo||'';document.getElementById('f-make').value=data.make||'';document.getElementById('f-model').value=data.model||'';if(data.formData){Object.keys(data.formData).forEach(key=>{const fieldId='f-'+key.replace(/([A-Z])/g,'-$1').toLowerCase();const el=document.getElementById(fieldId);if(el)el.value=data.formData[key]||'';});}if(data.assessmentData){assessRows=data.assessmentData.rows||[];depType=data.assessmentData.depType||'nil';renderAssessTable();if(data.assessmentData.salvage)document.getElementById('sum-salvage').value=data.assessmentData.salvage;if(data.assessmentData.excess)document.getElementById('sum-excess').value=data.assessmentData.excess;setDepType(depType);}if(data.riData){document.getElementById('ri-ref').value=data.riData.riRef||'';document.getElementById('ri-date').value=data.riData.riDate||'';if(data.riData.riParts){riParts=data.riData.riParts;renderRIParts();}}if(data.spotSurveyData){const ss=data.spotSurveyData;document.getElementById('spot-report-no').value=ss.reportNo||'';document.getElementById('spot-report-date').value=ss.reportDate||'';document.getElementById('spot-allot-date').value=ss.allotDate||'';document.getElementById('spot-survey-datetime').value=ss.surveyDatetime||'';document.getElementById('spot-accident-datetime').value=ss.accidentDatetime||'';document.getElementById('spot-accident-place').value=ss.accidentPlace||'';document.getElementById('spot-survey-place').value=ss.surveyPlace||'';document.getElementById('spot-accident-cause').value=ss.cause||'';document.getElementById('spot-driver-name').value=ss.driverName||'';document.getElementById('spot-mdl-no').value=ss.mdlNo||'';document.getElementById('spot-dl-authority').value=ss.dlAuthority||'';document.getElementById('spot-dl-issue').value=ss.dlIssue||'';document.getElementById('spot-dl-valid').value=ss.dlValid||'';document.getElementById('spot-dl-type').value=ss.dlType||'';document.getElementById('spot-mdl-verified').value=ss.mdlVerified||'verified';document.getElementById('spot-dl-invalid-remarks').value=ss.dlInvalidRemarks||'';document.getElementById('spot-cn-no').value=ss.cnNo||'';document.getElementById('spot-cn-date').value=ss.cnDate||'';document.getElementById('spot-load-capacity').value=ss.loadCapacity||'';document.getElementById('spot-actual-load').value=ss.actualLoad||'';document.getElementById('spot-load-desc').value=ss.loadDesc||'';document.getElementById('spot-police-reported').value=ss.policeReported||'no';document.getElementById('spot-police-station').value=ss.policeStation||'';document.getElementById('spot-diary-no').value=ss.diaryNo||'';document.getElementById('spot-panchanama').value=ss.panchanama||'no';document.getElementById('spot-tp-involved').value=ss.tpInvolved||'no';document.getElementById('spot-tp-details').value=ss.tpDetails||'';document.getElementById('spot-damage-severity').value=ss.damageSeverity||'moderate';document.getElementById('spot-airbags').value=ss.airbags||'no';document.getElementById('spot-drivable').value=ss.drivable||'yes';document.getElementById('spot-comments').value=ss.comments||'';if(ss.damageRows){spotDamageRows=ss.damageRows;renderSpotDamageRows();}checkDLValidity();}if(data.signatures){if(data.signatures.signature){sigDataUrl=data.signatures.signature;document.getElementById('sig-placeholder').classList.add('hidden');document.getElementById('sig-preview-img').src=sigDataUrl;document.getElementById('sig-preview-img').classList.remove('hidden');}if(data.signatures.stamp){stampDataUrl=data.signatures.stamp;document.getElementById('stamp-placeholder').classList.add('hidden');document.getElementById('stamp-preview-img').src=stampDataUrl;document.getElementById('stamp-preview-img').classList.remove('hidden');}}localStorage.setItem('current_report_id',reportId);showToast('Report loaded: '+(data.reportNo||data.vehicle),'success');updateDashboard();refreshReportsList();showPage('claim-details');}catch(e){showToast('Error loading report','error');console.error(e);}}
function deleteReport(reportId,event){event.stopPropagation();if(!confirm('Delete this report? This cannot be undone.'))return;localStorage.removeItem(reportId);let allReports=JSON.parse(localStorage.getItem('all_reports')||'[]');allReports=allReports.filter(r=>r.id!==reportId);localStorage.setItem('all_reports',JSON.stringify(allReports));showToast('Report deleted','success');refreshReportsList();}
function clearCurrentReport(){if(Object.values(aiStatusMap).some(v=>v)||assessRows.length>0){if(!confirm('Start a new report? Unsaved changes will be lost.'))return;}document.querySelectorAll('.form-input, .form-select, .form-textarea').forEach(el=>{el.value='';el.classList.remove('ai-filled');});assessRows=[];riParts=[];spotDamageRows=[];depType='nil';sigDataUrl=null;stampDataUrl=null;Object.keys(aiStatusMap).forEach(k=>aiStatusMap[k]=false);renderAssessTable();renderSpotDamageRows();updateAIStatusDots();updateDashboard();document.getElementById('sig-placeholder').classList.remove('hidden');document.getElementById('sig-preview-img').classList.add('hidden');document.getElementById('stamp-placeholder').classList.remove('hidden');document.getElementById('stamp-preview-img').classList.add('hidden');localStorage.removeItem('current_report_id');showToast('New report started','success');showPage('upload');}
function refreshReportsList(){const allReports=JSON.parse(localStorage.getItem('all_reports')||'[]');const container=document.getElementById('reports-list-container');const currentId=localStorage.getItem('current_report_id');if(allReports.length===0){container.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted);"><div style="font-size:2.5rem;margin-bottom:10px;">üìÑ</div><div style="font-size:0.88rem;font-weight:500;">No saved reports yet</div><div style="font-size:0.76rem;margin-top:6px;">Complete and save a survey to see it here</div></div>';updateStatistics(allReports);return;}let html='<table style="width:100%;border-collapse:collapse;font-size:0.8rem;" id="reports-table"><thead style="background:var(--cream2);"><tr><th style="padding:10px;text-align:left;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;">Report No.</th><th style="padding:10px;text-align:left;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;">Vehicle</th><th style="padding:10px;text-align:left;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;">Insured</th><th style="padding:10px;text-align:left;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;">Claim No.</th><th style="padding:10px;text-align:left;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;">Saved</th><th style="padding:10px;text-align:center;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;width:100px;">Actions</th></tr></thead><tbody>';allReports.forEach(report=>{const isCurrent=report.id===currentId;const savedDate=new Date(report.savedAt);const savedStr=savedDate.toLocaleDateString('en-IN',{day:'2-digit',month:'short'})+' '+savedDate.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});html+=`<tr onclick="loadReport('${report.id}')" data-vehicle="${report.vehicle||''}" data-insured="${report.insured||''}" data-claim="${report.claimNo||''}" data-report="${report.reportNo||''}" style="cursor:pointer;border-bottom:1px solid var(--cream2);${isCurrent?'background:#f0fdf8;':''}" onmouseover="this.style.background='var(--cream)'" onmouseout="this.style.background='${isCurrent?'#f0fdf8':''}'" >`;html+=`<td style="padding:10px;font-family:'DM Mono',monospace;font-size:0.75rem;color:${isCurrent?'var(--teal)':'var(--navy)'};font-weight:${isCurrent?'600':'400'};">${report.reportNo||'‚Äî'}${isCurrent?' <span style="font-size:0.65rem;color:var(--teal);">‚óè</span>':''}</td>`;html+=`<td style="padding:10px;font-weight:500;">${report.vehicle||'‚Äî'}</td>`;html+=`<td style="padding:10px;">${report.insured||'‚Äî'}</td>`;html+=`<td style="padding:10px;font-family:'DM Mono',monospace;font-size:0.75rem;">${report.claimNo||'‚Äî'}</td>`;html+=`<td style="padding:10px;color:var(--muted);font-size:0.75rem;">${savedStr}</td>`;html+=`<td style="padding:10px;text-align:center;"><button class="btn btn-danger btn-sm" style="padding:3px 8px;font-size:0.7rem;" onclick="deleteReport('${report.id}',event)" title="Delete">üóë</button></td>`;html+='</tr>';});html+='</tbody></table>';container.innerHTML=html;updateStatistics(allReports);}

// Search/Filter Reports
function filterReports(){const searchTerm=document.getElementById('reports-search').value.toLowerCase();const rows=document.querySelectorAll('#reports-table tbody tr');let visibleCount=0;rows.forEach(row=>{const vehicle=(row.getAttribute('data-vehicle')||'').toLowerCase();const insured=(row.getAttribute('data-insured')||'').toLowerCase();const claim=(row.getAttribute('data-claim')||'').toLowerCase();const reportNo=(row.getAttribute('data-report')||'').toLowerCase();const matches=vehicle.includes(searchTerm)||insured.includes(searchTerm)||claim.includes(searchTerm)||reportNo.includes(searchTerm);row.style.display=matches?'':'none';if(matches)visibleCount++;});if(visibleCount===0&&searchTerm){document.getElementById('reports-list-container').innerHTML='<div style="padding:24px;text-align:center;color:var(--muted);"><div style="font-size:2rem;margin-bottom:8px;">üîç</div><div style="font-size:0.85rem;">No reports found for "<strong>'+searchTerm+'</strong>"</div><div style="font-size:0.75rem;margin-top:6px;">Try a different search term</div></div>';}}

// Statistics
function updateStatistics(allReports){const now=new Date();const thisMonth=now.getMonth();const thisYear=now.getFullYear();let monthCount=0,totalAssessed=0;allReports.forEach(report=>{const savedDate=new Date(report.savedAt);if(savedDate.getMonth()===thisMonth&&savedDate.getFullYear()===thisYear){monthCount++;const reportData=JSON.parse(localStorage.getItem(report.id)||'{}');if(reportData.assessmentData&&reportData.assessmentData.rows){const assessed=reportData.assessmentData.rows.reduce((sum,row)=>sum+(row.assessed||0),0);totalAssessed+=assessed;}}});const avgAssessed=monthCount>0?totalAssessed/monthCount:0;document.getElementById('stat-month-count').textContent=monthCount;document.getElementById('stat-total-assessed').textContent='‚Çπ '+fmt2(totalAssessed);document.getElementById('stat-avg-assessed').textContent='‚Çπ '+fmt2(avgAssessed);document.getElementById('stat-total-reports').textContent=allReports.length;}

// Export to Excel
function exportToExcel(){const allReports=JSON.parse(localStorage.getItem('all_reports')||'[]');if(allReports.length===0){showToast('No reports to export','error');return;}let csv='Report No.,Date,Vehicle,Insured,Claim No.,Policy No.,Make/Model,Assessed Amount,Net Liability\n';allReports.forEach(report=>{const reportData=JSON.parse(localStorage.getItem(report.id)||'{}');let assessed=0,net=0;if(reportData.assessmentData&&reportData.assessmentData.rows){const rows=reportData.assessmentData.rows;assessed=rows.reduce((sum,r)=>sum+(r.assessed||0)*(1+r.gst/100),0);net=assessed-(reportData.assessmentData.salvage||0)-(reportData.assessmentData.excess||0);}const savedDate=new Date(report.savedAt).toLocaleString('en-IN');csv+=`"${report.reportNo||''}","${savedDate}","${report.vehicle||''}","${report.insured||''}","${report.claimNo||''}","${reportData.policyNo||''}","${report.make||''} ${report.model||''}",${assessed.toFixed(2)},${net.toFixed(2)}\n`;});const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='Motor_Survey_Reports_'+new Date().toISOString().split('T')[0]+'.csv';link.click();showToast('Excel file downloaded!','success');}

// Backup to Google Sheets
function backupToGoogleSheets(){const allReports=JSON.parse(localStorage.getItem('all_reports')||'[]');if(allReports.length===0){showToast('No reports to backup','error');return;}showToast('Google Sheets backup feature - Setup required','ai');setTimeout(()=>{const setup=`To enable Google Sheets backup:

1. Go to https://console.cloud.google.com
2. Create a new project
3. Enable Google Sheets API
4. Create credentials (API Key)
5. Create a Google Sheet and get its ID
6. Add your API key and Sheet ID to the code

Would you like detailed setup instructions?`;if(confirm(setup)){window.open('https://developers.google.com/sheets/api/quickstart/js','_blank');}},500);}

// Enhanced Damage Analysis with AI (Gemini)
async function analyzeMultipleDamagePhotos(photoFiles){showToast('Analyzing damage photos with AI...','ai');const photos=await Promise.all(Array.from(photoFiles).map(f=>fileToBase64(f)));const geminiParts=[...photos.map(base64=>({inlineData:{mimeType:'image/jpeg',data:base64}})),{text:`You are a senior motor vehicle damage assessor with 20 years of experience. Analyze ALL these damage photos comprehensively.

For EACH damaged part, provide:
1. Exact part name and location
2. Damage type and severity (Minor/Moderate/Major)
3. REPAIR vs REPLACE recommendation with reasoning
4. Estimated cost in INR

Also provide:
- Overall damage assessment
- Total estimated repair cost
- Safety concerns if any
- Recommended next steps

Return detailed JSON:
{
  "damaged_parts": [
    {
      "part": "Front Bumper",
      "location": "Center section",
      "damage_type": "Cracked and dented",
      "severity": "Major",
      "recommendation": "REPLACE",
      "reason": "Structural cracks present",
      "estimated_cost": 8500
    }
  ],
  "overall_assessment": {
    "total_parts": 5,
    "severity": "Moderate to Major",
    "total_cost": 45000,
    "repair_days": 3
  },
  "safety_concerns": ["Check frame damage"],
  "next_steps": ["Remove bumper for inspection"]
}
Return ONLY the JSON. No explanation, no markdown, no backticks.`}];try{const rawText=await callGemini(geminiParts,3000);const analysis=JSON.parse(rawText.replace(/```json|```/g,'').trim());showDamageAnalysisModal(analysis);return analysis;}catch(err){showToast('Damage analysis failed: '+err.message,'error');console.error(err);}}

// Show Damage Analysis Modal
function showDamageAnalysisModal(analysis){const modal=document.getElementById('add-row-modal');document.getElementById('modal-title').textContent='üîç AI Damage Analysis';let html='<div style="max-height:400px;overflow-y:auto;"><div class="alert alert-ai"><span>ü§ñ</span><span>Claude AI analyzed your damage photos</span></div>';if(analysis.damaged_parts&&analysis.damaged_parts.length>0){html+='<div style="margin-bottom:14px;"><strong>Damaged Parts Found:</strong></div>';analysis.damaged_parts.forEach((part,i)=>{const color=part.severity==='Major'?'var(--red)':part.severity==='Moderate'?'#fbbf24':'var(--green)';html+=`<div style="background:var(--cream);padding:10px;border-radius:6px;margin-bottom:8px;border-left:3px solid ${color};"><div style="font-weight:600;margin-bottom:4px;">${i+1}. ${part.part}</div><div style="font-size:0.8rem;line-height:1.6;"><strong>Damage:</strong> ${part.damage_type}<br/><strong>Severity:</strong> <span style="color:${color};">${part.severity}</span><br/><strong>Recommendation:</strong> ${part.recommendation}<br/><strong>Reason:</strong> ${part.reason}<br/><strong>Est. Cost:</strong> ‚Çπ${part.estimated_cost.toLocaleString('en-IN')}</div></div>`;});}if(analysis.overall_assessment){html+=`<div style="background:#f0fdf8;padding:12px;border-radius:6px;margin-top:14px;"><strong>Overall Assessment:</strong><div style="font-size:0.8rem;margin-top:6px;">Total Parts: ${analysis.overall_assessment.total_parts}<br/>Severity: ${analysis.overall_assessment.severity}<br/>Total Cost: ‚Çπ${analysis.overall_assessment.total_cost.toLocaleString('en-IN')}<br/>Repair Duration: ${analysis.overall_assessment.repair_days} days</div></div>`;}html+='<div style="margin-top:14px;"><button class="btn btn-primary" onclick="applyDamageAnalysisToAssessment();closeModal();">Apply to Assessment Sheet</button></div>';html+='</div>';document.querySelector('#add-row-modal .modal-body').innerHTML=html;modal.classList.add('open');window.currentDamageAnalysis=analysis;}

// Apply Damage Analysis to Assessment
function applyDamageAnalysisToAssessment(){if(!window.currentDamageAnalysis)return;const analysis=window.currentDamageAnalysis;if(analysis.damaged_parts){analysis.damaged_parts.forEach(part=>{assessRows.push({particulars:part.part+' - '+part.damage_type,estimated:part.estimated_cost,assessed:part.recommendation==='REPLACE'?part.estimated_cost:part.estimated_cost*0.6,partType:part.part.toLowerCase().includes('bumper')?'plastic':'metal',gst:18,section:'parts'});});}renderAssessTable();showToast('Added '+analysis.damaged_parts.length+' items from AI analysis','success');}

// Analyze Saved Photos
let savedPhotoFiles=[];
function analyzeSavedPhotos(){if(savedPhotoFiles.length===0){showToast('No photos available for analysis','error');return;}analyzeMultipleDamagePhotos(savedPhotoFiles);}

// ============================================================
// SPOT SURVEY & DL VALIDATION
// ============================================================
let spotDamageRows=[];

function addSpotDamageRow(component='',damage=''){const id=Date.now();spotDamageRows.push({id,component,damage});renderSpotDamageRows();}

function deleteSpotDamageRow(id){spotDamageRows=spotDamageRows.filter(r=>r.id!==id);renderSpotDamageRows();}

function renderSpotDamageRows() {
  const container = document.getElementById('spot-damage-rows');
  if (spotDamageRows.length === 0) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:0.85rem;">No components added yet. Click &quot;+ Add Component&quot; to start.</div>';
    return;
  }
  const commonComponents = [
    'FRONT END STRUCTURE / DRIVERS CABIN','INSTRUMENTS','COOLING SYSTEM',
    'ENGINE & TRANSMISSION','CHASSIS ASSY','LOAD BODY','STEERING SYSTEM',
    'FRONT SUSPENSION','REAR SUSPENSION','WHEEL DISCS & TYRES',
    'FRONT AXLE ASSY','REAR AXLE ASSY','BRAKING SYSTEM','ELECTRICAL SYSTEM',
    'FUEL SYSTEM','EXHAUST SYSTEM','BODY PANELS','WINDSHIELD & GLASS','INTERIOR','OTHER'
  ];
  let html = '';
  spotDamageRows.forEach((row, idx) => {
    const bgColor = idx % 2 === 0 ? '#ffffff' : 'var(--cream)';
    const rowId = 'sdr-' + row.id;
    const isCustom = row.component && !commonComponents.includes(row.component);
    let opts = '<option value="">Select Component</option>';
    commonComponents.forEach(c => { opts += `<option value="${c}" ${row.component===c?'selected':''}>${c}</option>`; });
    if (isCustom) opts += `<option value="${row.component}" selected>${row.component}</option>`;
    html += `
    <div style="display:grid;grid-template-columns:210px 1fr 44px;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);background:${bgColor};align-items:start;">
      <div>
        <select class="form-select" style="font-size:0.8rem;" onchange="spotDamageRows[${idx}].component=this.value;renderSpotDamageRows()">${opts}</select>
        ${(row.component==='OTHER'||isCustom)?`<input class="form-input" style="margin-top:5px;font-size:0.75rem;" value="${isCustom?row.component:''}" onchange="spotDamageRows[${idx}].component=this.value" placeholder="Specify component..."/>`:''}
      </div>
      <div style="position:relative;">
        <textarea
          id="${rowId}-dmg"
          class="form-textarea"
          rows="2"
          style="font-size:0.8rem;resize:vertical;padding-right:40px;min-height:56px;"
          placeholder="Describe damage ‚Äî e.g. Front bumper cracked, bonnet dented inward, headlamp glass shattered..."
          oninput="spotDamageRows[${idx}].damage=this.value"
        >${row.damage}</textarea>
        <button type="button" title="Voice input" style="position:absolute;top:5px;right:5px;background:var(--navy);color:#fff;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:0.8rem;display:flex;align-items:center;justify-content:center;z-index:3;"
          onclick="openVoiceInput('${rowId}-dmg','Damage on ${(row.component||'component').replace(/'/g,'')}')">üé§</button>
      </div>
      <div>
        <button class="btn btn-danger btn-sm" onclick="deleteSpotDamageRow(${row.id})" title="Delete" style="padding:6px 8px;font-size:0.75rem;">üóë</button>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

function checkDLValidity(){
  const validNT = document.getElementById('spot-dl-valid').value;
  const validT  = document.getElementById('spot-dl-valid-transport') ? document.getElementById('spot-dl-valid-transport').value : '';
  const badge   = document.getElementById('dl-validity-badge');
  const remarksSection = document.getElementById('dl-invalid-remarks-section');
  const mdlVerified = document.getElementById('spot-mdl-verified').value;
  const today = new Date(); today.setHours(0,0,0,0);

  if (!validNT && !validT) {
    badge.textContent = 'Not Verified'; badge.style.background = 'var(--muted)';
    remarksSection.style.display = 'none'; return;
  }

  const ntExpired = validNT && new Date(validNT) < today;
  const tExpired  = validT  && new Date(validT)  < today;
  const anyExpired = ntExpired || tExpired;

  if (mdlVerified === 'not-available') {
    badge.textContent = '‚ö†Ô∏è NOT AVAILABLE'; badge.style.background = '#fbbf24';
    remarksSection.style.display = 'block';
    showToast('DL not available ‚Äî Add remarks', 'error');
  } else if (anyExpired) {
    const expParts = [];
    if (ntExpired) expParts.push('Non-Transport');
    if (tExpired)  expParts.push('Transport');
    badge.textContent = `‚ùå ${expParts.join(' & ')} EXPIRED`;
    badge.style.background = 'var(--red)';
    remarksSection.style.display = 'block';
    showToast(`DL EXPIRED (${expParts.join(', ')}) ‚Äî Add mandatory remarks`, 'error');
  } else {
    const validParts = [];
    if (validNT) validParts.push('Non-Transport ‚úì');
    if (validT)  validParts.push('Transport ‚úì');
    badge.textContent = validParts.join(' | '); badge.style.background = 'var(--green)';
    remarksSection.style.display = 'none';
  }
}

function refreshSpotSurvey(){showToast('Spot survey PDF opening...','success');}
function generateSpotSurveyPDF(){ printReportWithAttachments(buildSpotSurveyHTML(), 'Spot Survey ‚Äî '+(gv('spot-report-no')||gv('f-reg-no')), REPORT_DOC_KEYS['spot-survey'], 'attach-docs-spot'); }

function buildSpotSurveyHTML() {
  const isComm = vehicleType === 'commercial';
  const ts  = 'width:100%;border-collapse:collapse;font-size:7.8pt;margin-bottom:4px;';
  const th  = 'background:#0d1b2a;color:#fff;padding:2px 4px;font-size:6.8pt;letter-spacing:0.02em;';
  const td  = 'padding:2px 4px;border:0.4pt solid #bbb;vertical-align:top;';
  const sec = 'font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin:4px 0 2px;letter-spacing:0.04em;display:block;';
  const lbl = 'color:#555;font-size:6.8pt;';

  const dlValidNT  = gv('spot-dl-valid');
  const dlValidT   = gv('spot-dl-valid-transport');
  const mdlVerified = gv('spot-mdl-verified');
  const today2 = new Date(); today2.setHours(0,0,0,0);
  const ntExpired = dlValidNT && new Date(dlValidNT) < today2;
  const tExpired  = dlValidT  && new Date(dlValidT)  < today2;
  const anyDLExpired = ntExpired || tExpired;
  const dlStatus = mdlVerified==='verified' ? 'ORIGINAL MDL VERIFIED'
    : mdlVerified==='photocopy' ? 'PHOTOCOPY VERIFIED' : 'NOT AVAILABLE';
  const ntLabel = dlValidNT ? (ntExpired ? `<b style="color:#c00;">${dlValidNT} ‚ö† EXPIRED</b>` : `${dlValidNT} ‚úì`) : '‚Äî';
  const tLabel  = dlValidT  ? (tExpired  ? `<b style="color:#c00;">${dlValidT} ‚ö† EXPIRED</b>`  : `${dlValidT} ‚úì`)  : '‚Äî';
  const dlRemarks = gv('spot-dl-invalid-remarks');
  const dlRemarksHTML = (anyDLExpired || mdlVerified==='not-available') && dlRemarks
    ? `<div style="border:1pt solid #ffc107;background:#fff8e1;padding:3px 5px;margin:3px 0;font-size:7pt;"><b>‚ö† DL INVALIDITY REMARKS:</b> ${dlRemarks}</div>` : '';
  // Driver name with relation
  const driverRelation = gv('spot-dl-relation') || 'S/o';
  const driverParent   = gv('spot-dl-parent');
  const driverNameFull = gv('spot-driver-name') + (driverParent ? ` ${driverRelation} ${driverParent}` : '');

  function expired(dateStr) {
    return dateStr && new Date(dateStr) < new Date();
  }
  function expLabel(dateStr) {
    if (!dateStr) return '‚Äî';
    return dateStr + (expired(dateStr) ? ' <b style="color:#c00;">‚ö† EXPIRED</b>' : '');
  }

  let damageHTML = '';
  if (spotDamageRows && spotDamageRows.length > 0) {
    damageHTML = '<table style="' + ts + '"><thead><tr><th style="' + th + ';width:36%;">Component</th><th style="' + th + '">Damage Observed at Spot</th></tr></thead><tbody>';
    spotDamageRows.forEach(r => { if (r.component && r.damage) damageHTML += '<tr><td style="' + td + 'font-weight:600;">' + r.component + '</td><td style="' + td + '">' + r.damage + '</td></tr>'; });
    damageHTML += '</tbody></table>';
  } else { damageHTML = '<p style="font-size:7pt;font-style:italic;color:#666;margin:0;">No component damages documented.</p>'; }

  const commDocsHTML = !isComm ? '' : `
<div style="${sec}">COMMERCIAL VEHICLE DOCUMENTS</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">Permit No.</td><td style="${td}font-family:monospace;">${gv('spot-permit-no')||'‚Äî'}</td>
    <td style="${td}${lbl}width:26%;">Permit Type</td><td style="${td}">${gv('spot-permit-type')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Permit Valid From</td><td style="${td}">${gv('spot-permit-from')||'‚Äî'}</td>
    <td style="${td}${lbl}">Permit Valid Upto</td><td style="${td}">${expLabel(gv('spot-permit-to'))}</td>
  </tr><tr>
    <td style="${td}${lbl}">Authorisation No.</td><td style="${td}font-family:monospace;">${gv('spot-auth-no')||'‚Äî'}</td>
    <td style="${td}${lbl}">Auth Valid Upto</td><td style="${td}">${expLabel(gv('spot-auth-valid'))}</td>
  </tr><tr>
    <td style="${td}${lbl}">Fitness Cert. No.</td><td style="${td}font-family:monospace;">${gv('spot-fitness-no')||gv('f-fitness')||'‚Äî'}</td>
    <td style="${td}${lbl}">Fitness Valid Upto</td><td style="${td}">${expLabel(gv('spot-fitness-valid'))}</td>
  </tr>
</table>`;

  const challanHTML = !isComm ? '' : `
<div style="${sec}">LOAD / LOK CHALLAN DETAILS</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">CN / Challan No.</td><td style="${td}font-family:monospace;">${gv('spot-cn-no')||'‚Äî'}</td>
    <td style="${td}${lbl}width:26%;">CN Date</td><td style="${td}">${gv('spot-cn-date')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Load Capacity (KG)</td><td style="${td}">${gv('spot-load-capacity')||'‚Äî'}</td>
    <td style="${td}${lbl}">Actual Load (KG)</td><td style="${td}">${gv('spot-actual-load')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Origin</td><td style="${td}">${gv('spot-load-origin')||'‚Äî'}</td>
    <td style="${td}${lbl}">Destination</td><td style="${td}">${gv('spot-load-dest')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Goods Description</td><td style="${td}" colspan="3">${gv('spot-load-desc')||'‚Äî'}</td>
  </tr>
</table>`;

  let sn = 1;
  return getSurveyorHeader() + `
<div style="text-align:center;font-weight:700;font-size:9pt;margin-bottom:2px;letter-spacing:0.05em;">MOTOR SPOT SURVEY REPORT</div>
<div style="text-align:center;font-size:6.8pt;font-style:italic;margin-bottom:4px;color:#444;">Private &amp; Confidential ‚Äî Without Prejudice ‚Äî Subject to Policy Terms &amp; Conditions</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:22%;">Report No.</td><td style="${td}font-weight:700;width:28%;">${gv('spot-report-no')||'‚Äî'}</td>
    <td style="${td}${lbl}width:22%;">Date of Report</td><td style="${td}font-weight:700;">${gv('spot-report-date')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Allotment Date</td><td style="${td}">${gv('spot-allot-date')||'‚Äî'}</td>
    <td style="${td}${lbl}">Date &amp; Time of Survey</td><td style="${td}">${gv('spot-survey-datetime')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Vehicle Type</td><td style="${td}font-weight:700;" colspan="3">${isComm ? 'COMMERCIAL VEHICLE' : 'PRIVATE VEHICLE'} &nbsp;|&nbsp; ${gv('f-veh-class')||''}</td>
  </tr>
</table>

<div style="${sec}">${sn++}. INSURER DETAILS</div>
<table style="${ts}">
  <tr><td style="${td}${lbl}width:26%;">Insurer</td><td style="${td}" colspan="3">${gv('f-insurer')||'‚Äî'} | Office: ${gv('f-policy-office')||'‚Äî'}</td></tr>
  <tr>
    <td style="${td}${lbl}">Policy No.</td><td style="${td}font-family:monospace;">${gv('f-policy-no')||'‚Äî'}</td>
    <td style="${td}${lbl}">Claim No.</td><td style="${td}font-family:monospace;">${gv('f-claim-no')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Policy Period</td><td style="${td}">${gv('f-policy-from')||'‚Äî'} to ${gv('f-policy-to')||'‚Äî'}</td>
    <td style="${td}${lbl}">I.D.V.</td><td style="${td}font-weight:600;">‚Çπ ${fmt2(gv('f-idv'))}</td>
  </tr>
</table>

<div style="${sec}">${sn++}. INSURED DETAILS</div>
<table style="${ts}">
  <tr><td style="${td}${lbl}width:26%;">Name</td><td style="${td}font-weight:600;" colspan="3">${gv('f-insured-name')||'‚Äî'}</td></tr>
  <tr><td style="${td}${lbl}">Address</td><td style="${td}" colspan="3">${gv('f-insured-addr')||'‚Äî'}</td></tr>
  <tr><td style="${td}${lbl}">H.P.A. With</td><td style="${td}" colspan="3">${gv('f-hpa')||'NIL'}</td></tr>
</table>

<div style="${sec}">${sn++}. VEHICLE PARTICULARS</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">Reg. No.</td><td style="${td}font-weight:700;">${gv('f-reg-no')||'‚Äî'}</td>
    <td style="${td}${lbl}width:26%;">Date of Reg.</td><td style="${td}">${gv('f-reg-date')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Make / Model / Year</td><td style="${td}" colspan="3"><b>${gv('f-make')||'‚Äî'}</b> / ${gv('f-model')||'‚Äî'} / ${gv('f-year')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Chassis No.</td><td style="${td}font-family:monospace;">${gv('f-chassis')||'‚Äî'}</td>
    <td style="${td}${lbl}">Engine No.</td><td style="${td}font-family:monospace;">${gv('f-engine')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Body / Colour / Fuel</td><td style="${td}" colspan="3">${gv('f-body-type')||'‚Äî'} / ${gv('f-colour')||'‚Äî'} / ${gv('f-fuel')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">R.L.W. / Seating</td><td style="${td}">${gv('f-rlw')||'‚Äî'}</td>
    <td style="${td}${lbl}">Pre-accident Cond.</td><td style="${td}">${gv('f-condition')||'‚Äî'}</td>
  </tr>
  ${isComm ? `<tr>
    <td style="${td}${lbl}">Permit / Route</td><td style="${td}">${gv('f-route')||'‚Äî'}</td>
    <td style="${td}${lbl}">Fitness Cert. No.</td><td style="${td}">${gv('spot-fitness-no')||gv('f-fitness')||'‚Äî'}</td>
  </tr>` : ''}
</table>

<div style="${sec}">${sn++}. DRIVER'S PARTICULARS ‚Äî ${dlStatus}</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">Driver Name</td><td style="${td}font-weight:600;" colspan="3">${driverNameFull||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">M.D.L. No.</td><td style="${td}font-family:monospace;">${gv('spot-mdl-no')||'‚Äî'}</td>
    <td style="${td}${lbl}width:26%;">Date of Issue</td><td style="${td}">${gv('spot-dl-issue')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Issuing Authority</td><td style="${td}" colspan="3">${gv('spot-dl-authority')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Licence Classes</td><td style="${td}" colspan="3">${gv('spot-dl-type')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Non-Transport Valid Upto (LMV)</td><td style="${td}">${ntLabel}</td>
    <td style="${td}${lbl}">Transport Valid Upto (HMV/TRANS)</td><td style="${td}">${tLabel}</td>
  </tr>
</table>
${dlRemarksHTML}
${commDocsHTML}
${challanHTML}

<div style="${sec}">${sn++}. ACCIDENT &amp; SURVEY DETAILS</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">Date &amp; Time of Accident</td><td style="${td}">${gv('spot-accident-datetime')||'‚Äî'}</td>
    <td style="${td}${lbl}width:26%;">Place of Accident</td><td style="${td}">${gv('spot-accident-place')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Date &amp; Time of Survey</td><td style="${td}">${gv('spot-survey-datetime')||'‚Äî'}</td>
    <td style="${td}${lbl}">Place of Survey</td><td style="${td}">${gv('spot-survey-place')||'‚Äî'}</td>
  </tr>
</table>

<div style="${sec}">${sn++}. POLICE CASE &amp; THIRD PARTY</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">Reported to Police</td><td style="${td}">${gv('spot-police-reported')==='yes'?'YES':'NO'}</td>
    <td style="${td}${lbl}width:26%;">Police Station</td><td style="${td}">${gv('spot-police-station')||'NIL'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Diary / FIR No.</td><td style="${td}">${gv('spot-diary-no')||'NIL'}</td>
    <td style="${td}${lbl}">Panchanama</td><td style="${td}">${gv('spot-panchanama')==='yes'?'YES':'NO'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Third Party</td><td style="${td}" colspan="3">${gv('spot-tp-involved')==='no'?'NIL':(gv('spot-tp-details')||'‚Äî')}</td>
  </tr>
</table>

<div style="${sec}">${sn++}. CAUSE &amp; NATURE OF ACCIDENT</div>
<div style="font-size:7.2pt;padding:3px 4px;border:0.4pt solid #bbb;background:#fafaf7;margin-bottom:4px;line-height:1.5;">${gv('spot-accident-cause')||'‚Äî'}</div>

<div style="${sec}">${sn++}. DAMAGE ASSESSMENT AT SPOT</div>
<table style="${ts}">
  <tr>
    <td style="${td}${lbl}width:26%;">Damage Severity</td><td style="${td}font-weight:700;text-transform:uppercase;">${gv('spot-damage-severity')||'‚Äî'}</td>
    <td style="${td}${lbl}width:26%;">Airbags Deployed</td><td style="${td}">${gv('spot-airbags')==='yes'?'YES':'NO'}</td>
  </tr><tr>
    <td style="${td}${lbl}">Vehicle Drivable</td><td style="${td}" colspan="3">${gv('spot-drivable')||'‚Äî'}</td>
  </tr>
</table>
<div style="font-weight:600;font-size:7pt;margin:3px 0 2px;">Component-wise damages observed:</div>
${damageHTML}

<div style="${sec}">${sn++}. COMMENTS / VEHICLE TO BE SHIFTED TO</div>
<div style="font-size:7.2pt;padding:3px 4px;border:0.4pt solid #bbb;background:#fafaf7;margin-bottom:4px;line-height:1.5;">${gv('spot-comments')||'‚Äî'}</div>

<p style="font-size:6.5pt;line-height:1.5;margin:5px 0;text-align:justify;color:#444;">We noted down maximum possible visible damages at the accident spot. Any other unseen/hidden damages related to the cause of accident noticed during dismantling may be considered accordingly. This report is issued without prejudice, subject to policy terms and conditions, based on physical inspection of the vehicle at the accident spot.</p>
` + getSigBlock() + `
<div style="font-size:6pt;color:#666;margin-top:3px;border-top:0.4pt solid #ccc;padding-top:2px;">Encl: DIGITAL PHOTOS &amp; SURVEYOR BILL</div>`;
}


function calcFeeTotal(){const p=parseFloat(gv('fee-prof'))||0,r=parseFloat(gv('fee-ri'))||0,t=parseFloat(gv('fee-travel'))||0,ph=(parseFloat(gv('fee-photos-count'))||0)*(parseFloat(gv('fee-photo-rate'))||0),po=parseFloat(gv('fee-postal'))||0,h=parseFloat(gv('fee-haltage'))||0,tot=p+r+t+ph+po+h;document.getElementById('fs-prof').textContent='‚Çπ '+fmt2(p);document.getElementById('fs-ri').textContent='‚Çπ '+fmt2(r);document.getElementById('fs-travel').textContent='‚Çπ '+fmt2(t);document.getElementById('fs-photos').textContent='‚Çπ '+fmt2(ph);document.getElementById('fs-postal').textContent='‚Çπ '+fmt2(po);document.getElementById('fs-total').textContent='‚Çπ '+fmt2(tot);}

function updateDashboard(){
  document.getElementById('ds-insured').textContent=gv('f-insured-name')||'‚Äî';
  document.getElementById('ds-vehicle').textContent=gv('f-reg-no')||'‚Äî';
  document.getElementById('ds-model').textContent=((gv('f-make')+' / '+gv('f-model')).replace(/^\s*\/\s*$/,''))||'‚Äî';
  document.getElementById('ds-policy').textContent=gv('f-policy-no')||'‚Äî';
  document.getElementById('ds-claim').textContent=gv('f-claim-no')||'‚Äî';
  document.getElementById('ds-doa').textContent=gv('f-doa')?new Date(gv('f-doa')).toLocaleDateString('en-IN'):'‚Äî';
  document.getElementById('ds-pos').textContent=gv('f-survey-place')||'‚Äî';
  document.getElementById('dash-ref').textContent=gv('f-report-no')||'‚Äî';
  document.getElementById('rp-report-no').textContent=gv('f-report-no')||'‚Äî';
}

function numberToWords(num){
  if(!num||isNaN(num))return'ZERO';
  const ones=['','ONE','TWO','THREE','FOUR','FIVE','SIX','SEVEN','EIGHT','NINE','TEN','ELEVEN','TWELVE','THIRTEEN','FOURTEEN','FIFTEEN','SIXTEEN','SEVENTEEN','EIGHTEEN','NINETEEN'];
  const tens=['','','TWENTY','THIRTY','FORTY','FIFTY','SIXTY','SEVENTY','EIGHTY','NINETY'];
  function c(n){if(n<20)return ones[n];if(n<100)return tens[Math.floor(n/10)]+(n%10?' '+ones[n%10]:'');if(n<1000)return ones[Math.floor(n/100)]+' HUNDRED'+(n%100?' '+c(n%100):'');if(n<100000)return c(Math.floor(n/1000))+' THOUSAND'+(n%1000?' '+c(n%1000):'');if(n<10000000)return c(Math.floor(n/100000))+' LAKH'+(n%100000?' '+c(n%100000):'');return c(Math.floor(n/10000000))+' CRORE'+(n%10000000?' '+c(n%10000000):'');}
  return c(Math.floor(num));
}

// ============================================================
// REPORT HTML BUILDERS
// ============================================================
function getSurveyorHeader(){
  const name=gv('sp-name')||'SURVEYOR NAME',qual=gv('sp-qual')||'B.Sc., Dip. in Auto Engg.',addr=gv('sp-addr')||'Address',lic=gv('sp-lic')||'‚Äî',exp=gv('sp-lic-exp')||'‚Äî',iiisla=gv('sp-iiisla')||'‚Äî',email=gv('sp-email')||'‚Äî',mob=gv('sp-mobile')||'‚Äî',cats=gv('sp-categories')||'MOTOR,MARINE,ENGG';
  return`<div style="border-bottom:1.2pt solid #000;padding-bottom:5px;margin-bottom:6px;"><div style="display:flex;justify-content:space-between;align-items:flex-start;"><div style="flex:1;text-align:center;"><div style="font-size:13pt;font-weight:700;letter-spacing:0.03em;line-height:1.1;">${name}</div><div style="font-size:7pt;margin-top:1px;">${qual}</div><div style="font-size:7.5pt;font-weight:700;letter-spacing:0.04em;margin-top:2px;">INSURANCE SURVEYOR, LOSS ASSESSOR &amp; VALUER</div></div></div><div style="display:flex;justify-content:space-between;margin-top:4px;font-size:6.8pt;"><div style="line-height:1.5;"><span>Lic. No.: <b>${lic}</b></span> &nbsp;|&nbsp; <span>Expiry: <b>${exp}</b></span> &nbsp;|&nbsp; <span>IIISLA: <b>${iiisla}</b></span> &nbsp;|&nbsp; <span>E-mail: ${email}</span> &nbsp;|&nbsp; <span>Cell: ${mob}</span></div><div style="text-align:right;font-weight:700;">${cats}<br/><span style="font-weight:400;">${addr}</span></div></div></div>`;
}
function getSigBlock(){
  const sig=sigDataUrl?`<img src="${sigDataUrl}" style="max-height:48px;max-width:90px;object-fit:contain;"/>`:'';
  const stamp=stampDataUrl?`<img src="${stampDataUrl}" style="max-height:55px;max-width:70px;object-fit:contain;"/>`:'';
  const name=gv('sp-name')||'SURVEYOR NAME';
  return`<div style="display:flex;justify-content:flex-end;align-items:flex-end;margin-top:14px;gap:8px;">${stamp}<div style="text-align:center;">${sig}<div style="font-weight:700;font-size:7.5pt;margin-top:2px;">${name}</div><div style="font-size:6.5pt;color:#555;">Licenced Surveyor &amp; Loss Assessor</div></div></div>`;
}

function buildSurveyReportHTML(){
  // Recalculate with depreciation applied correctly
  let metal=0,plastic=0,glass=0,labBase=0;
  assessRows.filter(r=>r.section==='parts').forEach(r=>{
    if(r.allowed===false) return;
    const dep=getDepRate(r.partType);
    const ad=r.assessed*(1-dep/100);
    if(r.partType==='metal') metal+=ad;
    else if(r.partType==='glass') glass+=ad;
    else plastic+=ad;
  });
  assessRows.filter(r=>r.section==='labour'||r.section==='paint').forEach(r=>{
    if(r.allowed!==false) labBase+=r.assessed;
  });
  const partsBase=metal+plastic+glass,pCGST=partsBase*0.09,pTotal=partsBase+pCGST*2,lGST=labBase*0.18,lTotal=labBase+lGST,grand=pTotal+lTotal;
  const salvage=parseFloat(document.getElementById('sum-salvage').value)||0,excess=parseFloat(document.getElementById('sum-excess').value)||500,net=Math.max(0,grand-salvage-excess);
  const fa=v=>'‚Çπ '+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');

  // Compact print CSS variables ‚Äî optimised for A4
  const ts=`width:100%;border-collapse:collapse;font-size:7.8pt;margin-bottom:4px;`;
  const th=`background:#0d1b2a;color:#fff;padding:2px 4px;font-size:6.8pt;letter-spacing:0.02em;`;
  const td=`padding:2px 4px;border:0.4pt solid #bbb;vertical-align:top;`;
  const tdr=`padding:2px 4px;border:0.4pt solid #bbb;text-align:right;white-space:nowrap;`;
  const sec=`padding:2px 4px;font-weight:700;background:#e8e3da;font-size:6.8pt;letter-spacing:0.04em;text-transform:uppercase;border:0.4pt solid #bbb;`;
  const sub=`padding:2px 4px;font-weight:700;background:#dff0ec;color:#1a5a50;border:0.4pt solid #bbb;`;

  const age = getVehicleAgeMonths();
  const ageLabel = age > 0 ? `${Math.floor(age/12)}yr ${age%12}mo (Reg: ${gv('f-reg-date')} ‚Üí Accident: ${gv('f-doa')?gv('f-doa').substring(0,10):'?'})` : '';
  const metalDep=depType==='nil'?0:getDepRate('metal');
  const plastDep=depType==='nil'?0:50;
  const depNote=depType==='standard'?` | Vehicle Age: ${ageLabel} | Metal: ${metalDep}% | Plastic: 50% | Glass: 0%`:'';

  // Parts table rows
  let partsSrNo=1;
  const partsHtml=assessRows.filter(r=>r.section==='parts').map(r=>{
    const dep=getDepRate(r.partType);
    const ad=r.allowed===false?0:r.assessed*(1-dep/100);
    return `<tr${r.allowed===false?' style="opacity:0.55;"':''}>
      <td style="${td}text-align:center;">${partsSrNo++}</td>
      <td style="${td}${r.allowed===false?'text-decoration:line-through;color:#a00;':''}">${r.particulars}${r.allowed===false?' <i style="font-size:6pt;">(Disallowed)</i>':''}</td>
      <td style="${td}text-align:center;">${r.partType.charAt(0).toUpperCase()+r.partType.slice(1)}</td>
      <td style="${tdr}">${r.allowed!==false?fa(r.assessed):'‚Äî'}</td>
      <td style="${tdr}">${dep}%</td>
      <td style="${tdr}">${r.partType==='metal'&&r.allowed!==false?fa(ad):'‚Äî'}</td>
      <td style="${tdr}">${r.partType==='plastic'&&r.allowed!==false?fa(ad):'‚Äî'}</td>
      <td style="${tdr}">${r.partType==='glass'&&r.allowed!==false?fa(ad):'‚Äî'}</td>
    </tr>`;
  }).join('');

  let labSrNo=1;
  const labHtml=assessRows.filter(r=>r.section==='labour'||r.section==='paint').map(r=>{
    return `<tr${r.allowed===false?' style="opacity:0.55;"':''}>
      <td style="${td}text-align:center;">${labSrNo++}</td>
      <td style="${td}${r.allowed===false?'text-decoration:line-through;color:#a00;':''}">${r.particulars}${r.allowed===false?' <i style="font-size:6pt;">(Disallowed)</i>':''}</td>
      <td style="${td}text-align:center;">${r.section==='paint'?'Paint':'Labour'}</td>
      <td style="${tdr}">${r.gst}%</td>
      <td colspan="4" style="${tdr}">${r.allowed!==false?fa(r.assessed):'‚Äî'}</td>
    </tr>`;
  }).join('');

  return `${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:8.5pt;margin-bottom:3px;text-decoration:underline;letter-spacing:0.05em;">PRIVATE AND CONFIDENTIAL ‚Äî MOTOR (FINAL) SURVEY REPORT</div>
<p style="font-size:6.5pt;font-style:italic;margin-bottom:4px;text-align:justify;color:#444;">This report is issued by us as Licenced Surveyors without prejudice, in respect of cause, nature &amp; extent of loss/damage, subject to the terms &amp; conditions of the Insurance policy.</p>

<table style="${ts}">
  <tr>
    <td style="${td}color:#444;width:18%;font-size:6.8pt;">Report No.</td><td style="${td}font-weight:700;width:32%;">${gv('f-report-no')}</td>
    <td style="${td}color:#444;width:18%;font-size:6.8pt;">Date</td><td style="${td}font-weight:700;">${gv('f-report-date')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Policy No.</td><td style="${td}font-family:monospace;">${gv('f-policy-no')}</td>
    <td style="${td}color:#444;font-size:6.8pt;">Claim No.</td><td style="${td}font-family:monospace;">${gv('f-claim-no')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Policy Period</td><td style="${td}">${gv('f-policy-from')} to ${gv('f-policy-to')}</td>
    <td style="${td}color:#444;font-size:6.8pt;">I.D.V.</td><td style="${td}font-weight:600;">‚Çπ ${fmt2(gv('f-idv'))}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Policy Type</td><td style="${td}" colspan="3">${gv('f-policy-type')} &nbsp;‚Äî&nbsp; <b>${depType==='nil'?'Nil Depreciation (0%)':'Standard Depreciation (IRDAI)'+depNote}</b></td>
  </tr>
</table>

<table style="${ts}">
  <tr><td style="${td}font-weight:700;width:18%;background:#f5f2ee;font-size:6.8pt;">1. INSURER</td><td style="${td}" colspan="3">${gv('f-insurer')} &nbsp;|&nbsp; Appointing: ${gv('f-appt-office')}</td></tr>
  <tr><td style="${td}font-weight:700;background:#f5f2ee;font-size:6.8pt;">2. INSURED</td><td style="${td}font-weight:600;width:32%;">${gv('f-insured-name')}</td><td style="${td}color:#444;font-size:6.8pt;">Mobile</td><td style="${td}">${gv('f-insured-mobile')}</td></tr>
  <tr><td style="${td}color:#444;font-size:6.8pt;">Address</td><td style="${td}" colspan="3">${gv('f-insured-addr')}</td></tr>
  <tr><td style="${td}font-weight:700;background:#f5f2ee;font-size:6.8pt;">3. H.P.A.</td><td style="${td}" colspan="3">${gv('f-hpa')||'NIL'}</td></tr>
</table>

<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;letter-spacing:0.04em;">4. VEHICLE PARTICULARS &nbsp;<span style="font-weight:400;font-style:italic;font-size:6.5pt;">RC VERIFIED</span></div>
<table style="${ts}">
  <tr>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">Reg. No.</td><td style="${td}font-weight:700;width:32%;">${gv('f-reg-no')}</td>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">Date of Reg.</td><td style="${td}">${gv('f-reg-date')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Make / Model / Year</td><td style="${td}" colspan="3"><b>${gv('f-make')}</b> / ${gv('f-model')} / ${gv('f-year')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Chassis No.</td><td style="${td}font-family:monospace;">${gv('f-chassis')}</td>
    <td style="${td}color:#444;font-size:6.8pt;">Engine No.</td><td style="${td}font-family:monospace;">${gv('f-engine')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Body / Colour / Fuel</td><td style="${td}" colspan="3">${gv('f-body-type')} / ${gv('f-colour')} / ${gv('f-fuel')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">CC / Odometer</td><td style="${td}">${gv('f-cc')} / ${gv('f-odo')} KM</td>
    <td style="${td}color:#444;font-size:6.8pt;">Pre-accident Cond.</td><td style="${td}">${gv('f-condition')}</td>
  </tr>
</table>

<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;letter-spacing:0.04em;">5. DRIVER'S PARTICULARS &nbsp;<span style="font-weight:400;font-style:italic;font-size:6.5pt;">${(()=>{const mv=gv('f-dl-mdl-verified')||'verified';return mv==='verified'?'ORIGINAL MDL VERIFIED':mv==='photocopy'?'PHOTOCOPY VERIFIED':'NOT AVAILABLE';})()}</span></div>
<table style="${ts}">
  <tr>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">Driver Name</td>
    <td style="${td}font-weight:600;" colspan="3">${gv('f-driver-name')||'‚Äî'}${gv('f-dl-parent') ? ' ' + (gv('f-dl-relation')||'S/o') + ' ' + gv('f-dl-parent') : ''}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">M.D.L. No.</td><td style="${td}font-family:monospace;width:32%;">${gv('f-mdl')||'‚Äî'}</td>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">Date of Birth</td><td style="${td}">${gv('f-dob')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Issuing Authority</td><td style="${td}">${gv('f-dl-auth')||'‚Äî'}</td>
    <td style="${td}color:#444;font-size:6.8pt;">DL Issue Date</td><td style="${td}">${gv('f-dl-issue')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Licence Classes</td><td style="${td}" colspan="3">${gv('f-dl-type')||'‚Äî'}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Non-Transport Validity (LMV)</td>
    <td style="${td}${gv('f-dl-valid')&&new Date(gv('f-dl-valid'))<new Date()?'color:#c00;font-weight:700;':''}">
      ${gv('f-dl-valid')||'‚Äî'}${gv('f-dl-valid')&&new Date(gv('f-dl-valid'))<new Date()?' ‚ö† EXPIRED':''}
    </td>
    <td style="${td}color:#444;font-size:6.8pt;">Transport Validity (HMV/TRANS)</td>
    <td style="${td}${gv('f-dl-valid-transport')&&new Date(gv('f-dl-valid-transport'))<new Date()?'color:#c00;font-weight:700;':''}">
      ${gv('f-dl-valid-transport')||'‚Äî'}${gv('f-dl-valid-transport')&&new Date(gv('f-dl-valid-transport'))<new Date()?' ‚ö† EXPIRED':''}
    </td>
  </tr>
</table>

<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;letter-spacing:0.04em;">6. ACCIDENT &amp; SURVEY DETAILS</div>
<table style="${ts}">
  <tr>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">Date &amp; Time</td><td style="${td};width:32%;">${gv('f-doa')}</td>
    <td style="${td}color:#444;font-size:6.8pt;width:18%;">Place of Accident</td><td style="${td}">${gv('f-poa')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Date of Survey</td><td style="${td}">${gv('f-survey-date')}</td>
    <td style="${td}color:#444;font-size:6.8pt;">Place of Survey</td><td style="${td}">${gv('f-survey-place')}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Third Party</td><td style="${td}" colspan="3">${gv('f-tp')||'NIL'}</td>
  </tr>
</table>

<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;letter-spacing:0.04em;">7. CAUSE &amp; NATURE OF ACCIDENT</div>
<div style="font-size:7.2pt;margin-bottom:4px;padding:2px 4px;border:0.4pt solid #bbb;background:#fafaf7;line-height:1.5;">${gv('f-cause')||'‚Äî'}</div>

<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;letter-spacing:0.04em;">8. ASSESSMENT SUMMARY</div>
<table style="${ts}">
  <thead><tr>
    <th style="${th};width:40%;text-align:left;">Head</th>
    <th style="${th};text-align:right;">Original Estimate</th>
    <th style="${th};text-align:right;">Assessed (after Dep.)</th>
    <th style="${th};text-align:right;">Incl. GST</th>
  </tr></thead>
  <tbody>
    <tr><td style="${td}">Spare Parts</td><td style="${tdr}">${fa(assessRows.filter(r=>r.section==='parts'&&r.allowed!==false).reduce((s,r)=>s+r.estimated,0))}</td><td style="${tdr}">${fa(partsBase)}</td><td style="${tdr}">${fa(pTotal)}</td></tr>
    <tr><td style="${td}">Labour &amp; Painting</td><td style="${tdr}">${fa(assessRows.filter(r=>(r.section==='labour'||r.section==='paint')&&r.allowed!==false).reduce((s,r)=>s+r.estimated,0))}</td><td style="${tdr}">${fa(labBase)}</td><td style="${tdr}">${fa(lTotal)}</td></tr>
    <tr style="background:#e8f5f3;"><td style="${td}font-weight:700;">GRAND TOTAL</td><td style="${tdr}font-weight:700;background:#e8f5f3;"></td><td style="${tdr}font-weight:700;background:#e8f5f3;"></td><td style="${tdr}font-weight:700;background:#e8f5f3;">${fa(grand)}</td></tr>
    <tr><td style="${td}">Less: Policy Excess</td><td colspan="2" style="border:0.4pt solid #bbb;"></td><td style="${tdr}">( ${fa(excess)} )</td></tr>
    <tr><td style="${td}">Less: Salvage Value</td><td colspan="2" style="border:0.4pt solid #bbb;"></td><td style="${tdr}">( ${fa(salvage)} )</td></tr>
    <tr style="background:#0d1b2a;color:#fff;"><td style="padding:3px 4px;font-weight:700;font-size:8pt;">NET ASSESSED LOSS</td><td colspan="2" style="border:none;"></td><td style="padding:3px 4px;text-align:right;font-weight:700;font-size:8pt;">${fa(net)}</td></tr>
    <tr><td colspan="4" style="${td}font-style:italic;font-size:6.5pt;color:#444;">RUPEES ${numberToWords(net)} ONLY</td></tr>
  </tbody>
</table>

<div style="font-weight:700;font-size:7pt;background:#0d1b2a;color:#fff;padding:2px 4px;margin-bottom:2px;letter-spacing:0.04em;">9. DETAILS OF ASSESSMENT</div>
<table style="${ts}">
  <thead><tr>
    <th style="${th};width:18pt;text-align:center;">Sr.</th>
    <th style="${th}">Particulars</th>
    <th style="${th};width:38pt;text-align:center;">Type</th>
    <th style="${th};text-align:right;width:46pt;">Assessed ‚Çπ</th>
    <th style="${th};text-align:center;width:28pt;">Dep%</th>
    <th style="${th};text-align:right;width:48pt;">Metal ‚Çπ</th>
    <th style="${th};text-align:right;width:48pt;">Plastic ‚Çπ</th>
    <th style="${th};text-align:right;width:44pt;">Glass ‚Çπ</th>
  </tr></thead>
  <tbody>
    <tr><td colspan="8" style="${sec}">SPARE PARTS</td></tr>
    ${partsHtml}
    <tr>
      <td colspan="5" style="${sub}text-align:right;font-size:6.8pt;">Sub-Total Spare Parts</td>
      <td style="${sub}text-align:right;">${fa(metal)}</td>
      <td style="${sub}text-align:right;">${fa(plastic)}</td>
      <td style="${sub}text-align:right;">${fa(glass)}</td>
    </tr>
    <tr><td colspan="8" style="${sec}">LABOUR &amp; PAINTING CHARGES</td></tr>
    <tr>
      <th style="${th};width:18pt;text-align:center;">Sr.</th>
      <th style="${th}">Particulars</th>
      <th style="${th};width:38pt;text-align:center;">Type</th>
      <th style="${th};text-align:center;width:28pt;">GST%</th>
      <th colspan="4" style="${th};text-align:right;">Amount ‚Çπ</th>
    </tr>
    ${labHtml}
    <tr>
      <td colspan="4" style="${sub}text-align:right;font-size:6.8pt;">Sub-Total Labour &amp; Paint (excl. GST)</td>
      <td colspan="4" style="${sub}text-align:right;">${fa(labBase)}</td>
    </tr>
  </tbody>
</table>

<table style="${ts}margin-bottom:5px;">
  <tr>
    <td style="${td}color:#444;font-size:6.8pt;width:25%;">Parts Base (after dep.)</td><td style="${tdr}width:25%;">${fa(partsBase)}</td>
    <td style="${td}color:#444;font-size:6.8pt;width:25%;">CGST @9%</td><td style="${tdr}">${fa(pCGST)}</td>
  </tr><tr>
    <td style="${td}color:#444;font-size:6.8pt;">Labour Base</td><td style="${tdr}">${fa(labBase)}</td>
    <td style="${td}color:#444;font-size:6.8pt;">SGST @9%</td><td style="${tdr}">${fa(pCGST)}</td>
  </tr><tr>
    <td style="${td}"></td><td></td>
    <td style="${td}color:#444;font-size:6.8pt;">GST on Labour @18%</td><td style="${tdr}">${fa(lGST)}</td>
  </tr>
</table>

<p style="font-size:6.5pt;line-height:1.5;margin-bottom:5px;text-align:justify;color:#333;">We have carried out survey of the above motor vehicle in connection with the captioned claim and assessed the loss. The survey was made in accordance with the Surveyors and Loss Assessors Regulations 2015 issued under the Insurance Act 1938. This is a final report without prejudice and subject to terms and conditions of the policy, including any applicable policy excess and depreciation as per IRDAI guidelines.</p>
${getSigBlock()}
<div style="font-size:6pt;color:#666;margin-top:4px;border-top:0.4pt solid #ccc;padding-top:2px;">Encl: Repair Estimate / Tax Invoice &amp; Digital Photographs</div>`;
}

function buildBillCheckHTML(){
  let metal=0,plastic=0,labBase=0;
  assessRows.filter(r=>r.section==='parts').forEach(r=>{ if(r.partType==='metal')metal+=r.assessed; else plastic+=r.assessed; });
  assessRows.filter(r=>r.section==='labour'||r.section==='paint').forEach(r=>labBase+=r.assessed);
  const mGST=metal*1.18,pGST=plastic*1.18,lGST=labBase*1.18,total=mGST+pGST+lGST,excess=parseFloat(document.getElementById('sum-excess').value)||500,net=Math.max(0,total-excess);
  const fa=v=>v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  const ts=`width:100%;border-collapse:collapse;font-size:0.79rem;`,th=`background:#0d1b2a;color:#fff;padding:6px 9px;font-size:0.7rem;text-align:left;`;
  const partsHtml=assessRows.filter(r=>r.section==='parts').map((r,i)=>`<tr><td style="padding:5px 8px;">${i+1}</td><td style="padding:5px 8px;">${r.particulars}</td><td style="padding:5px 8px;text-align:center;">${r.gst}%</td><td style="padding:5px 8px;text-align:right;">${r.partType==='metal'?fa(r.assessed):''}</td><td style="padding:5px 8px;text-align:right;">${r.partType!=='metal'?fa(r.assessed):''}</td></tr>`).join('');
  const labHtml=assessRows.filter(r=>r.section==='labour'||r.section==='paint').map((r,i)=>`<tr><td style="padding:5px 8px;">${i+1}</td><td style="padding:5px 8px;">${r.particulars}</td><td style="padding:5px 8px;text-align:center;">${r.gst}%</td><td colspan="2" style="padding:5px 8px;text-align:right;">${fa(r.assessed)}</td></tr>`).join('');
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:1.05rem;margin-bottom:12px;">BILL CHECK REPORT</div>
<table style="${ts} margin-bottom:12px;"><tr><td style="padding:4px 0;color:#666;width:33%;">Report No.</td><td style="font-weight:600;">${gv('f-report-no')}</td><td style="color:#666;">Date</td><td>${gv('f-report-date')}</td></tr><tr><td style="padding:4px 0;color:#666;">Insurer</td><td colspan="3">${gv('f-insurer')}</td></tr><tr><td style="padding:4px 0;color:#666;">Insured</td><td colspan="3">${gv('f-insured-name')}</td></tr><tr><td style="padding:4px 0;color:#666;">Policy No.</td><td>${gv('f-policy-no')}</td><td style="color:#666;">Vehicle No.</td><td style="font-weight:600;">${gv('f-reg-no')}</td></tr><tr><td style="padding:4px 0;color:#666;">Chassis</td><td>${gv('f-chassis')}</td><td style="color:#666;">Engine</td><td>${gv('f-engine')}</td></tr></table>
<table style="${ts} margin-bottom:12px;"><thead><tr><th style="${th}">Sr.</th><th style="${th}">Particulars</th><th style="${th}text-align:center;">GST%</th><th style="${th}text-align:right;">Nil Dep Metal</th><th style="${th}text-align:right;">Nil Dep Rubber</th></tr></thead><tbody><tr><td colspan="5" style="padding:5px 8px;font-weight:600;background:#ede8df;font-size:0.7rem;">SPARE PARTS</td></tr>${partsHtml}<tr style="background:#e8f5f3;"><td colspan="3" style="padding:5px 8px;font-weight:600;">TOTAL</td><td style="padding:5px 8px;text-align:right;font-weight:600;">${fa(metal)}</td><td style="padding:5px 8px;text-align:right;font-weight:600;">${fa(plastic)}</td></tr><tr><td colspan="5" style="padding:5px 8px;font-weight:600;background:#ede8df;font-size:0.7rem;">LABOUR</td></tr>${labHtml}<tr style="background:#e8f5f3;"><td colspan="3" style="padding:5px 8px;font-weight:600;">TOTAL LABOUR</td><td colspan="2" style="padding:5px 8px;text-align:right;font-weight:600;">${fa(labBase)}</td></tr></tbody></table>
<table style="${ts} margin-bottom:14px;"><tr><td style="padding:7px;border-bottom:1px solid #ddd;">I) Total Spare Parts (incl. GST)</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;font-weight:600;">‚Çπ ${fa(mGST+pGST)}</td></tr><tr><td style="padding:7px;border-bottom:1px solid #ddd;">II) Total Labour (incl. GST)</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;font-weight:600;">‚Çπ ${fa(lGST)}</td></tr><tr><td style="padding:7px;border-bottom:1px solid #ddd;">Total (I+II)</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;">‚Çπ ${fa(total)}</td></tr><tr><td style="padding:7px;border-bottom:1px solid #ddd;">Less Excess</td><td style="padding:7px;text-align:right;border-bottom:1px solid #ddd;">‚Çπ ${fa(excess)}</td></tr><tr style="background:#0d1b2a;color:#fff;"><td style="padding:9px;font-weight:700;">NET LIABILITY</td><td style="padding:9px;text-align:right;font-weight:700;">‚Çπ ${fa(net)}</td></tr></table>
<div style="font-style:italic;font-size:0.78rem;margin-bottom:14px;">INWORDS : RUPEES ${numberToWords(net)} ONLY</div>
<div style="font-size:0.76rem;"><strong>ENCL:-</strong> REPAIR BILLS / TAX INVOICE</div>
${getSigBlock()}`;
}

function buildRIReportHTML(){
  const ts=`width:100%;border-collapse:collapse;font-size:0.79rem;`,td=`padding:5px 0;`;
  const th=`background:#0d1b2a;color:#fff;padding:6px 9px;font-size:0.7rem;text-align:left;`;
  
  // Build parts verification table
  let partsTableHtml = '';
  if (riParts.length > 0) {
    const replacedParts = riParts.filter(p => p.status === 'replaced');
    const notReplacedParts = riParts.filter(p => p.status === 'not-replaced');
    const repairedParts = riParts.filter(p => p.status === 'repaired');
    
    partsTableHtml = `
<div style="font-weight:700;margin:16px 0 8px;">PARTS REPLACEMENT VERIFICATION</div>
<table style="${ts} margin-bottom:12px;border:1px solid #ddd;">
  <thead><tr style="background:#0d1b2a;color:#fff;">
    <th style="${th}width:30px;">Sr.</th>
    <th style="${th}">Particulars (From Survey Report)</th>
    <th style="${th}text-align:center;width:100px;">Status</th>
    <th style="${th}width:180px;">Remarks</th>
  </tr></thead>
  <tbody>
    ${riParts.map((p, i) => {
      const statusText = p.status === 'replaced' ? '‚úì Replaced' : p.status === 'repaired' ? '‚ö° Repaired' : '‚úó Not Replaced';
      const statusColor = p.status === 'replaced' ? '#1e7e52' : p.status === 'repaired' ? '#fbbf24' : '#c0392b';
      return `<tr style="border-bottom:1px solid #e5e0d8;">
        <td style="padding:5px 9px;color:#666;">${i+1}</td>
        <td style="padding:5px 9px;">${p.particulars}</td>
        <td style="padding:5px 9px;text-align:center;color:${statusColor};font-weight:600;font-size:0.75rem;">${statusText}</td>
        <td style="padding:5px 9px;font-size:0.75rem;font-style:italic;">${p.remarks || '‚Äî'}</td>
      </tr>`;
    }).join('')}
  </tbody>
</table>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
  <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:10px;text-align:center;">
    <div style="font-size:0.7rem;color:#15803d;margin-bottom:3px;">REPLACED</div>
    <div style="font-size:1.4rem;font-weight:700;color:#15803d;">${replacedParts.length}</div>
  </div>
  <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:10px;text-align:center;">
    <div style="font-size:0.7rem;color:#c0392b;margin-bottom:3px;">NOT REPLACED</div>
    <div style="font-size:1.4rem;font-weight:700;color:#c0392b;">${notReplacedParts.length}</div>
  </div>
  <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:6px;padding:10px;text-align:center;">
    <div style="font-size:0.7rem;color:#92400e;margin-bottom:3px;">REPAIRED ONLY</div>
    <div style="font-size:1.4rem;font-weight:700;color:#92400e;">${repairedParts.length}</div>
  </div>
</div>`;
  }
  
  const repairQuality = gv('ri-repair-quality') || 'satisfactory';
  const vehicleCond = gv('ri-vehicle-condition') || 'roadworthy';
  const salvageStatus = gv('ri-salvage-status') || 'collected';
  const observations = gv('ri-observations') || '';
  
  const qualityText = {
    satisfactory: 'Satisfactory - As per survey report',
    good: 'Good - Better than expected',
    partial: 'Partial - Some items pending',
    unsatisfactory: 'Unsatisfactory - Not as per survey'
  }[repairQuality];
  
  const condText = {
    roadworthy: 'Road Worthy - Fit for operation',
    'needs-attention': 'Needs Minor Attention',
    'not-roadworthy': 'Not Road Worthy'
  }[vehicleCond];
  
  const salvageText = {
    collected: 'Salvage parts collected and verified',
    'not-collected': 'Salvage parts not collected',
    partial: 'Partial salvage collected',
    na: 'Not Applicable'
  }[salvageStatus];
  
  return`${getSurveyorHeader()}
<div style="text-align:center;font-weight:700;font-size:1.15rem;margin-bottom:12px;letter-spacing:0.05em;">REINSPECTION REPORT</div>
<div style="display:flex;justify-content:space-between;margin-bottom:12px;"><div><strong>Ref No. : ${gv('ri-ref')||'RIN/‚Äî/2026'}</strong></div><div><strong>Date : ${gv('ri-date')||gv('f-report-date')}</strong></div></div>
<div style="font-weight:700;margin-bottom:7px;">INSURANCE POLICY PARTICULARS</div>
<table style="${ts} margin-bottom:12px;"><tr><td style="${td}color:#666;width:35%;">Insurer's Name</td><td>${gv('f-insurer').split(',')[0]||''}</td></tr><tr><td style="${td}color:#666;">Policy issuing office</td><td>${gv('f-policy-office')}</td></tr><tr><td style="${td}color:#666;">Address</td><td>${gv('f-insurer')}</td></tr><tr><td style="${td}color:#666;">Insured Name</td><td style="font-weight:600;">${gv('f-insured-name')}</td></tr><tr><td style="${td}color:#666;">Insured's Address</td><td>${gv('f-insured-addr')}</td></tr><tr><td style="${td}color:#666;">Policy Number</td><td style="font-family:monospace;">${gv('f-policy-no')}</td></tr><tr><td style="${td}color:#666;">Claim No</td><td style="font-family:monospace;">${gv('f-claim-no')}</td></tr><tr><td style="${td}color:#666;">Policy Period</td><td>${gv('f-policy-from')} To ${gv('f-policy-to')}</td></tr><tr><td style="${td}color:#666;">Vehicle Finance Details</td><td>${gv('f-hpa')}</td></tr></table>
<div style="font-weight:700;margin-bottom:7px;">DETAILS OF SURVEY</div>
<table style="${ts} margin-bottom:12px;"><tr><td style="${td}color:#666;width:35%;">Original Survey Report</td><td><strong>${gv('ri-survey-ref')||gv('f-report-no')}</strong> dated ${gv('ri-survey-date')||gv('f-report-date')}</td></tr><tr><td style="${td}color:#666;">Date of Accident</td><td>${gv('f-doa')}</td></tr><tr><td style="${td}color:#666;">Date Of Reinspection</td><td>${gv('ri-date')}</td></tr><tr><td style="${td}color:#666;">Place of Survey</td><td>${gv('f-survey-place')}</td></tr></table>
<div style="font-weight:700;margin-bottom:7px;">VEHICLE PARTICULARS</div>
<table style="${ts} margin-bottom:14px;"><tr><td style="${td}color:#666;width:35%;">Registration Number</td><td style="font-weight:600;">${gv('f-reg-no')}</td></tr><tr><td style="${td}color:#666;">Class of Vehicle</td><td>${gv('f-veh-class')}</td></tr><tr><td style="${td}color:#666;">Make of Vehicle</td><td>${gv('f-make')}</td></tr><tr><td style="${td}color:#666;">Model of Vehicle</td><td>${gv('f-model')}</td></tr><tr><td style="${td}color:#666;">Chassis Number</td><td style="font-family:monospace;">${gv('f-chassis')}</td></tr><tr><td style="${td}color:#666;">Engine Number</td><td style="font-family:monospace;">${gv('f-engine')}</td></tr><tr><td style="${td}color:#666;">Odometer</td><td>${gv('f-odo')} KM</td></tr></table>
${partsTableHtml}
<div style="font-weight:700;margin-bottom:7px;">REPAIR QUALITY & VEHICLE CONDITION</div>
<table style="${ts} margin-bottom:12px;"><tr><td style="${td}color:#666;width:35%;">Repair Quality</td><td style="font-weight:600;">${qualityText}</td></tr><tr><td style="${td}color:#666;">Vehicle Condition</td><td style="font-weight:600;">${condText}</td></tr><tr><td style="${td}color:#666;">Salvage Parts Status</td><td>${salvageText}</td></tr></table>
${observations ? `<div style="font-weight:700;margin-bottom:7px;">ADDITIONAL OBSERVATIONS</div><p style="font-size:0.8rem;line-height:1.6;margin-bottom:14px;background:#f7f3ed;padding:12px;border-radius:6px;">${observations}</p>` : ''}
<p style="font-size:0.8rem;line-height:1.75;margin-bottom:18px;text-transform:uppercase;font-weight:500;">WE HAVE RE-INSPECTED THE CAPTIONED VEHICLE &amp; HAVE VERIFIED THE REPAIRS / REPLACEMENTS AS DETAILED ABOVE. THE REPAIRS WERE ${repairQuality === 'satisfactory' || repairQuality === 'good' ? 'CARRIED OUT' : 'PARTIALLY CARRIED OUT'} AS PER OUR FINAL SURVEY REPORT BEARING REF NO ${gv('ri-survey-ref')||gv('f-report-no')} DATED ${gv('ri-survey-date')||gv('f-report-date')}. I HAVE INSPECTED THE SAID VEHICLE &amp; HAVE TAKEN NECESSARY PHOTOGRAPHS OF THE SAME ALONG WITH THE SALVAGE PARTS. THE VEHICLE RE-INSPECTED WAS FOUND TO BE ${vehicleCond === 'roadworthy' ? 'IN ROAD WORTHY CONDITION' : 'REQUIRING ATTENTION'} AT THE TIME OF MY SURVEY.</p>
${getSigBlock()}
<div style="font-size:0.72rem;color:#666;margin-top:14px;">ENCL: R.I PHOTOS, SALVAGE PARTS PHOTOS &amp; MY BILL FOR SURVEY.</div>`;
}


function refreshReportPreview(){document.getElementById('survey-report-html').innerHTML=buildSurveyReportHTML();document.getElementById('rp-report-no').textContent=gv('f-report-no')||'‚Äî';}
function refreshBillCheck(){document.getElementById('bill-check-html').innerHTML=buildBillCheckHTML();}
function refreshRIReport(){document.getElementById('ri-report-html').innerHTML=buildRIReportHTML();}

// ============================================================
// REPORT ATTACHMENTS ‚Äî Embed uploaded source docs & photos
// ============================================================

const DOC_LABELS = {
  rc: 'Registration Certificate (RC)',
  dl: 'Driving Licence (DL)',
  policy: 'Insurance Policy',
  claim: 'Claim / Intimation Form',
  estimate: 'Repair Estimate',
  permit: 'Permit',
  auth: 'Authorisation Certificate',
  fitness: 'Fitness Certificate',
  'lok-challan': 'Load / Lok Challan'
};

// Which uploaded docs get appended to each report type
const REPORT_DOC_KEYS = {
  'spot-survey':   ['photos', 'claim', 'dl'],
  'survey-report': ['rc', 'dl', 'policy', 'claim', 'estimate', 'photos'],
  'bill-check':    ['estimate', 'photos'],
  'ri-report':     ['photos'],
  'fee-bill':      []
};

function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = () => reject(new Error('Could not read file: ' + file.name));
    reader.readAsDataURL(file);
  });
}

async function buildAttachmentsHTML(docKeys) {
  const sections = [];

  for (const key of docKeys) {
    const rawFiles = uploadedDocs[key];
    if (!rawFiles) continue;
    const files = Array.isArray(rawFiles) ? rawFiles : [rawFiles];
    if (!files.length) continue;

    if (key === 'photos') {
      // Photos ‚Äî 3-column grid, images only
      const photoItems = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;
        try {
          const dataUrl = await fileToDataUrl(file);
          photoItems.push(`
            <div style="break-inside:avoid;page-break-inside:avoid;text-align:center;">
              <img src="${dataUrl}" style="width:100%;max-height:165px;object-fit:cover;border:0.5pt solid #bbb;display:block;border-radius:2px;"/>
              <div style="font-size:5.8pt;color:#555;margin-top:2px;font-family:sans-serif;">Photo ${i+1} ‚Äî ${file.name}</div>
            </div>`);
        } catch(e) { console.warn('Photo read error', e); }
      }
      if (photoItems.length === 0) continue;

      // Split into pages of 12 photos (4 rows √ó 3 cols)
      const PAGE_SIZE = 12;
      for (let p = 0; p < photoItems.length; p += PAGE_SIZE) {
        const chunk = photoItems.slice(p, p + PAGE_SIZE);
        const pageNum = Math.floor(p / PAGE_SIZE) + 1;
        const totalPages = Math.ceil(photoItems.length / PAGE_SIZE);
        const pageLabel = totalPages > 1 ? ` ‚Äî Sheet ${pageNum} of ${totalPages}` : '';
        sections.push(`
          <div style="page-break-before:always;padding:2mm;">
            <div style="background:#0d1b2a;color:#fff;padding:4px 8px;font-size:8pt;font-weight:700;letter-spacing:0.05em;margin-bottom:8px;display:flex;justify-content:space-between;">
              <span>ENCLOSURE ‚Äî DAMAGE PHOTOGRAPHS (${photoItems.length} Nos.)${pageLabel}</span>
              <span style="font-weight:400;font-size:7pt;">Vehicle: ${gv('f-reg-no')||'‚Äî'} | Claim: ${gv('f-claim-no')||'‚Äî'}</span>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:7px;">
              ${chunk.join('')}
            </div>
          </div>`);
      }

    } else {
      // Single or multi-file document (RC, DL, Policy, etc.)
      const label = DOC_LABELS[key] || key.toUpperCase();
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const pageLabel = files.length > 1 ? `${label} (Part ${i+1} of ${files.length})` : label;
        try {
          const dataUrl = await fileToDataUrl(file);
          const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');

          let embedHTML;
          if (isPdf) {
            // PDF: embed at full A4 height. Chrome prints it; Firefox/Safari may show blank.
            embedHTML = `
              <iframe src="${dataUrl}" style="width:100%;height:1090px;border:none;display:block;"
                title="${pageLabel}"></iframe>
              <div style="font-size:6pt;color:#888;font-style:italic;text-align:center;margin-top:3px;">
                ‚ìò If blank, your browser may not render embedded PDFs in print ‚Äî attach the original separately.
              </div>`;
          } else {
            // Image document
            embedHTML = `<img src="${dataUrl}" style="width:100%;max-height:1090px;object-fit:contain;border:0.5pt solid #ccc;display:block;"/>`;
          }

          sections.push(`
            <div style="page-break-before:always;padding:2mm;">
              <div style="background:#0d1b2a;color:#fff;padding:4px 8px;font-size:8pt;font-weight:700;letter-spacing:0.05em;margin-bottom:6px;display:flex;justify-content:space-between;">
                <span>ENCLOSURE ‚Äî ${pageLabel.toUpperCase()}</span>
                <span style="font-weight:400;font-size:7pt;">Vehicle: ${gv('f-reg-no')||'‚Äî'} | Claim: ${gv('f-claim-no')||'‚Äî'}</span>
              </div>
              ${embedHTML}
            </div>`);
        } catch(e) { console.warn('Doc read error for', key, e); }
      }
    }
  }

  if (sections.length === 0) return '';

  // Enclosure index at the start of attachment section
  const enclosureList = docKeys
    .filter(k => uploadedDocs[k])
    .map((k, idx) => {
      const f = Array.isArray(uploadedDocs[k]) ? uploadedDocs[k] : [uploadedDocs[k]];
      const count = k === 'photos' ? f.length : f.length;
      const label = k === 'photos' ? `Damage Photographs (${count} Nos.)` : DOC_LABELS[k] || k;
      return `<tr><td style="padding:2px 6px;">${idx+1}.</td><td style="padding:2px 6px;">${label}</td></tr>`;
    }).join('');

  const enclosureIndex = `
    <div style="page-break-before:always;padding:2mm;">
      <div style="background:#0d1b2a;color:#fff;padding:4px 8px;font-size:8pt;font-weight:700;letter-spacing:0.05em;margin-bottom:8px;">
        ENCLOSURES INDEX
      </div>
      <table style="width:50%;font-size:7.5pt;border-collapse:collapse;">
        <thead><tr style="background:#eee;"><th style="padding:3px 6px;text-align:left;">Sr.</th><th style="padding:3px 6px;text-align:left;">Document</th></tr></thead>
        <tbody>${enclosureList}</tbody>
      </table>
      <div style="margin-top:10px;font-size:6.5pt;color:#666;font-style:italic;">Enclosures follow on subsequent pages. Print all pages to include all supporting documents.</div>
    </div>`;

  return enclosureIndex + sections.join('');
}

async function printReportWithAttachments(html, title, docKeys, checkboxId) {
  const attachEnabled = checkboxId ? (document.getElementById(checkboxId)?.checked !== false) : true;
  const hasAnyDocs = attachEnabled && docKeys && docKeys.some(k => uploadedDocs[k]);
  let fullHTML = html;
  if (hasAnyDocs) {
    showToast('Building report with enclosures‚Ä¶', 'success');
    try {
      const attachHTML = await buildAttachmentsHTML(docKeys);
      fullHTML = html + attachHTML;
    } catch(e) {
      console.error('Attachment build error:', e);
      showToast('Warning: Some attachments could not be embedded.', 'error');
    }
  }
  printReport(fullHTML, title);
}

// ============================================================
// END REPORT ATTACHMENTS
// ============================================================

function printReport(html,title){
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>${title}</title><link rel='preconnect' href='https://fonts.googleapis.com'/><link href='https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap' rel='stylesheet'/><style>@page{margin:8mm 10mm;size:A4 portrait;}*{box-sizing:border-box;}body{font-family:'DM Sans',Arial,sans-serif;font-size:7.8pt;line-height:1.3;color:#000;margin:0;padding:0;}table{border-collapse:collapse;width:100%;font-size:7.8pt;}td,th{padding:2px 4px;}p{margin:0 0 4px 0;}@media print{@page{margin:8mm 10mm;}body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}tr{page-break-inside:avoid;}}</style></head><body>${html}</body></html>`);
  w.document.close();
  setTimeout(()=>{w.focus();w.print();},600);
  showToast('Report opened ‚Äî use Print ‚Üí Save as PDF');
}

function generateSurveyReportPDF(){refreshReportPreview();printReportWithAttachments(buildSurveyReportHTML(),'Final Survey Report - '+gv('f-report-no'),REPORT_DOC_KEYS['survey-report'],'attach-docs-survey');}
function generateBillCheckPDF(){refreshBillCheck();printReportWithAttachments(buildBillCheckHTML(),'Bill Check Report - '+gv('f-report-no'),REPORT_DOC_KEYS['bill-check']);}
function generateRIPDF(){refreshRIReport();printReportWithAttachments(buildRIReportHTML(),'Reinspection Report - '+gv('ri-ref'),REPORT_DOC_KEYS['ri-report']);}
function generateFeeBillPDF(){
  calcFeeTotal();
  const p=parseFloat(gv('fee-prof'))||0,r=parseFloat(gv('fee-ri'))||0,t=parseFloat(gv('fee-travel'))||0,ph=(parseFloat(gv('fee-photos-count'))||0)*(parseFloat(gv('fee-photo-rate'))||0),po=parseFloat(gv('fee-postal'))||0,tot=p+r+t+ph+po;
  const fa=v=>v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  const html=`${getSurveyorHeader()}<table style="width:100%;border-collapse:collapse;font-size:0.83rem;margin-bottom:10px;"><tr><td style="padding:4px 0;color:#666;">Report No.</td><td>${gv('f-report-no')}</td><td style="color:#666;text-align:right;">Date :</td><td style="text-align:right;font-weight:700;">${gv('f-report-date')}</td></tr><tr><td style="color:#666;">GST No.</td><td>${gv('sp-gst')}</td><td style="color:#666;text-align:right;">Surveyor Code :</td><td style="text-align:right;">${gv('sp-code')}</td></tr><tr><td colspan="4" style="padding:4px 0;">Insurer Name : <strong>${gv('f-insurer')}</strong></td></tr><tr><td colspan="4" style="padding:4px 0;"><strong>Insured :</strong> ${gv('f-insured-name')}, ${gv('f-insured-addr')}</td></tr><tr><td style="color:#666;">Policy No.</td><td>${gv('f-policy-no')}</td><td style="color:#666;text-align:right;">Claim No.</td><td style="text-align:right;">${gv('f-claim-no')}</td></tr></table><table style="width:100%;border-collapse:collapse;font-size:0.83rem;border:1px solid #000;"><thead><tr style="background:#0d1b2a;color:#fff;"><th style="padding:6px 9px;text-align:left;width:40px;">Sr.</th><th style="padding:6px 9px;text-align:left;">Particular</th><th style="padding:6px 9px;text-align:right;">Amount Rs</th></tr></thead><tbody><tr><td style="padding:6px 9px;border-bottom:1px solid #ddd;">1</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;">Professional Fees Rs.${fa(p)} + R.I Fees Rs.${fa(r)}</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;text-align:right;">${fa(p+r)}</td></tr><tr><td style="padding:6px 9px;border-bottom:1px solid #ddd;">2</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;">Travelling/Conveyance (${gv('fee-travel-note')})</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;text-align:right;">${fa(t)}</td></tr><tr><td style="padding:6px 9px;border-bottom:1px solid #ddd;">3</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;">Haltage</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;text-align:right;">0.00</td></tr><tr><td style="padding:6px 9px;border-bottom:1px solid #ddd;">4</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;">Digital Photo Charges ${gv('fee-photos-count')} No's @ Rs. ${gv('fee-photo-rate')}</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;text-align:right;">${fa(ph)}</td></tr><tr><td style="padding:6px 9px;border-bottom:1px solid #ddd;">5</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;">Postal/Courier Charges</td><td style="padding:6px 9px;border-bottom:1px solid #ddd;text-align:right;">${fa(po)}</td></tr><tr style="background:#0d1b2a;color:#fff;"><td colspan="2" style="padding:8px 9px;font-weight:700;text-align:right;">TOTAL :</td><td style="padding:8px 9px;text-align:right;font-weight:700;">${fa(tot)}</td></tr></tbody></table><div style="font-size:0.76rem;margin:7px 0 14px;font-style:italic;">RUPEES ${numberToWords(tot)} ONLY</div>${getSigBlock()}<div style="margin-top:18px;font-size:0.79rem;"><strong>Advance receipt</strong><br/>Bank Name : ${gv('bank-name')}<br/>A/C No. : ${gv('bank-ac')}<br/>IFSC CODE : ${gv('bank-ifsc')}<br/>PAN NO. : ${gv('bank-pan')}</div>`;
  printReport(html,'Surveyor Fee Bill - '+gv('f-report-no'));
}
function generateAllReports(){ preflightThenGenerate(); }

// ============================================================
// REINSPECTION PARTS VERIFICATION
// ============================================================
function loadPartsForRI() {
  if (assessRows.length === 0) {
    showToast('No parts in assessment. Complete assessment first.', 'error');
    return;
  }
  
  // Load parts from assessment into RI tracking
  riParts = assessRows
    .filter(r => r.section === 'parts' && r.assessed > 0)
    .map((r, i) => ({
      id: 'ri-part-' + i,
      particulars: r.particulars,
      assessed: r.assessed,
      status: 'replaced', // default to replaced
      remarks: ''
    }));
  
  // Auto-fill survey ref from report no
  document.getElementById('ri-survey-ref').value = gv('f-report-no');
  document.getElementById('ri-survey-date').value = gv('f-report-date');
  
  renderRIParts();
  showToast(`Loaded ${riParts.length} parts from assessment`, 'success');
}

function renderRIParts() {
  const tbody = document.getElementById('ri-parts-tbody');
  tbody.innerHTML = '';
  
  if (riParts.length === 0) {
    const tr = tbody.insertRow();
    tr.innerHTML = '<td colspan="5" style="text-align:center;padding:20px;color:var(--muted);">No parts loaded. Click "Load Parts from Assessment" button above.</td>';
    updateRISummary();
    return;
  }
  
  riParts.forEach((part, idx) => {
    const tr = tbody.insertRow();
    tr.innerHTML = `
      <td class="mono" style="color:var(--muted);">${idx + 1}</td>
      <td>${part.particulars}</td>
      <td class="text-right mono">‚Çπ ${part.assessed.toFixed(2)}</td>
      <td class="text-center">
        <select class="form-select" style="font-size:0.75rem;padding:4px 8px;" onchange="riParts[${idx}].status=this.value;updateRISummary();">
          <option value="replaced" ${part.status === 'replaced' ? 'selected' : ''}>‚úì Replaced</option>
          <option value="not-replaced" ${part.status === 'not-replaced' ? 'selected' : ''}>‚úó Not Replaced</option>
          <option value="repaired" ${part.status === 'repaired' ? 'selected' : ''}>‚ö° Repaired (Not Replaced)</option>
        </select>
      </td>
      <td>
        <input type="text" class="text-input-cell" style="font-size:0.75rem;" placeholder="Optional remarks..." value="${part.remarks}" onchange="riParts[${idx}].remarks=this.value;">
      </td>
    `;
  });
  
  updateRISummary();
}

function updateRISummary() {
  const total = riParts.length;
  const replaced = riParts.filter(p => p.status === 'replaced').length;
  const notReplaced = riParts.filter(p => p.status === 'not-replaced' || p.status === 'repaired').length;
  const rate = total > 0 ? Math.round((replaced / total) * 100) : 0;
  
  document.getElementById('ri-total-allowed').textContent = total;
  document.getElementById('ri-parts-replaced').textContent = replaced;
  document.getElementById('ri-parts-not-replaced').textContent = notReplaced;
  document.getElementById('ri-replacement-rate').textContent = rate + '%';
}

// ============================================================
// VOICE INPUT ‚Äî CONTINUOUS RECORDING + AI VERIFICATION + CORRECTION LEARNING
// ============================================================

// Session-level corrections store: [{field, raw, aiFormatted, corrected}]
const voiceCorrections = [];

function initVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    console.warn('Speech recognition not supported');
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  voiceRecognition = new SpeechRecognition();
  voiceRecognition.continuous = true;
  voiceRecognition.interimResults = true;
  voiceRecognition.lang = 'en-IN';

  voiceRecognition.onstart = () => {
    isRecording = true;
    document.getElementById('voice-record-btn').classList.add('recording');
    document.getElementById('voice-record-icon').textContent = '‚èπÔ∏è';
    document.getElementById('voice-record-text').textContent = 'Stop Recording';
    document.getElementById('voice-status').textContent = 'üî¥ Listening... speak freely, press Stop when done';
    document.getElementById('voice-status').style.color = 'var(--red)';
    document.getElementById('voice-raw-section').style.display = 'block';
    document.getElementById('voice-ai-section').style.display = 'none';
    document.getElementById('voice-apply-btn').style.display = 'none';
  };

  voiceRecognition.onresult = (event) => {
    let finalText = '';
    let interimText = '';
    for (let i = 0; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalText += event.results[i][0].transcript + ' ';
      } else {
        interimText += event.results[i][0].transcript;
      }
    }
    document.getElementById('voice-raw-text').textContent = (finalText + interimText).trim();
  };

  voiceRecognition.onerror = (event) => {
    if (event.error === 'no-speech') return;
    if (event.error !== 'aborted') showToast('Voice error: ' + event.error, 'error');
    resetVoiceRecording();
  };

  voiceRecognition.onend = () => {
    if (isRecording) {
      // Browser stopped on its own ‚Äî restart to keep going
      try { voiceRecognition.start(); } catch(e) { resetVoiceRecording(); }
    } else {
      resetVoiceRecording();
      // Recording was manually stopped ‚Äî now run AI verification
      const rawText = document.getElementById('voice-raw-text').textContent.trim();
      if (rawText) runAIVoiceVerification(rawText);
    }
  };
}

async function runAIVoiceVerification(rawTranscript) {
  const aiSection = document.getElementById('voice-ai-section');
  const aiText = document.getElementById('voice-ai-text');
  const aiSpinner = document.getElementById('voice-ai-spinner');
  const applyBtn = document.getElementById('voice-apply-btn');

  aiSection.style.display = 'block';
  aiSpinner.style.display = 'inline-flex';
  aiText.value = '';
  applyBtn.style.display = 'none';
  document.getElementById('voice-status').textContent = '‚ú® AI is formatting your text...';
  document.getElementById('voice-status').style.color = '#6366f1';

  try {
    const fieldLabel = currentVoiceFieldLabel || 'field';

    // Build few-shot examples from past corrections this session
    let correctionExamples = '';
    const relevantCorrections = voiceCorrections.slice(-5); // last 5 corrections
    if (relevantCorrections.length > 0) {
      correctionExamples = '\n\nLearn from these past corrections the surveyor made:\n';
      relevantCorrections.forEach(c => {
        correctionExamples += `Field: "${c.field}" | Raw: "${c.raw}" | AI said: "${c.aiFormatted}" | Surveyor corrected to: "${c.corrected}"\n`;
      });
      correctionExamples += '\nApply the same correction style going forward.\n';
    }

    const prompt = `You are helping an Indian motor insurance surveyor fill a survey form using voice input.

Field being filled: "${fieldLabel}"
Raw speech transcript: "${rawTranscript}"
${correctionExamples}
Your task ‚Äî clean and format the transcript for this field:
- Names: Proper capitalization (e.g. "VIKRAM PATIL")
- Vehicle registration: UPPERCASE with hyphens (e.g. "MH-15-CK-7321")
- Chassis/Engine numbers: UPPERCASE, no spaces
- Dates: DD-MM-YYYY format
- Amounts: numbers only (e.g. "45000")
- Accident/damage descriptions: clean professional Hindi-English mixed language is OK, keep full meaning intact, do NOT shorten
- Addresses: proper capitalization, keep full address
- Remove filler words (um, uh, like, basically) but keep all actual content

Return ONLY the cleaned formatted value. No explanation, no quotes.`;

    const result = await callGemini([{ text: prompt }], 600);
    const cleaned = result.trim();

    aiText.value = cleaned;
    aiText.dataset.aiOriginal = cleaned; // save for correction tracking
    aiSpinner.style.display = 'none';
    applyBtn.style.display = 'inline-flex';
    document.getElementById('voice-status').textContent = '‚úÖ Review and edit above if needed, then click Apply';
    document.getElementById('voice-status').style.color = 'var(--green)';

  } catch (err) {
    // AI failed ‚Äî fall back to raw transcript so user isn't stuck
    aiSpinner.style.display = 'none';
    aiText.value = rawTranscript;
    applyBtn.style.display = 'inline-flex';
    document.getElementById('voice-status').textContent = '‚ö†Ô∏è AI formatting failed ‚Äî raw transcript shown, edit as needed';
    document.getElementById('voice-status').style.color = 'var(--gold)';
  }
}

function toggleVoiceRecording() {
  if (!voiceRecognition) {
    showToast('Voice recording not supported in this browser. Use Chrome.', 'error');
    return;
  }
  if (isRecording) {
    isRecording = false; // set BEFORE stop so onend doesn't restart
    voiceRecognition.stop();
  } else {
    document.getElementById('voice-raw-text').textContent = '';
    document.getElementById('voice-ai-section').style.display = 'none';
    document.getElementById('voice-apply-btn').style.display = 'none';
    voiceRecognition.start();
  }
}

function resetVoiceRecording() {
  isRecording = false;
  const btn = document.getElementById('voice-record-btn');
  if (btn) {
    btn.classList.remove('recording');
    document.getElementById('voice-record-icon').textContent = 'üé§';
    document.getElementById('voice-record-text').textContent = 'Start Recording';
  }
}

function openVoiceInput(fieldId, fieldLabel) {
  currentVoiceFieldId = fieldId;
  currentVoiceFieldLabel = fieldLabel;
  document.getElementById('voice-field-name').textContent = fieldLabel;
  document.getElementById('voice-raw-text').textContent = '';
  document.getElementById('voice-raw-section').style.display = 'none';
  document.getElementById('voice-ai-section').style.display = 'none';
  document.getElementById('voice-apply-btn').style.display = 'none';
  document.getElementById('voice-status').textContent = 'Press Start ‚Äî speak freely ‚Äî press Stop when done';
  document.getElementById('voice-status').style.color = 'var(--muted)';
  // Update correction badge
  const badge = document.getElementById('voice-correction-badge');
  const count = document.getElementById('voice-correction-count');
  if (voiceCorrections.length > 0) {
    badge.style.display = 'block';
    count.textContent = voiceCorrections.length;
  } else {
    badge.style.display = 'none';
  }
  document.getElementById('voice-modal').classList.add('open');
  if (!voiceRecognition) initVoiceRecognition();
}

function applyVoiceInput() {
  if (!currentVoiceFieldId) return;
  const aiText = document.getElementById('voice-ai-text').value.trim();
  const rawText = document.getElementById('voice-raw-text').textContent.trim();
  if (!aiText && !rawText) { showToast('Nothing recorded yet', 'error'); return; }

  const finalText = aiText || rawText;

  // Record correction if surveyor edited the AI output
  const aiOriginal = document.getElementById('voice-ai-text').dataset.aiOriginal || '';
  if (aiOriginal && aiOriginal !== finalText && rawText) {
    voiceCorrections.push({
      field: currentVoiceFieldLabel,
      raw: rawText,
      aiFormatted: aiOriginal,
      corrected: finalText
    });
    // Update badge
    document.getElementById('voice-correction-count').textContent = voiceCorrections.length;
    document.getElementById('voice-correction-badge').style.display = 'block';
    showToast('Correction saved ‚Äî AI will learn from it', 'ai');
  }

  const field = document.getElementById(currentVoiceFieldId);
  if (field) {
    field.value = finalText;
    field.classList.add('ai-filled');
    // Dispatch input event so oninput handlers (like spotDamageRows) update correctly
    field.dispatchEvent(new Event('input', { bubbles: true }));
    showToast(`Applied to ${currentVoiceFieldLabel}`, 'success');
    closeVoiceModal();
  }
}

function closeVoiceModal() {
  isRecording = false;
  if (voiceRecognition) { try { voiceRecognition.stop(); } catch(e) {} }
  document.getElementById('voice-modal').classList.remove('open');
  currentVoiceFieldId = null;
  currentVoiceFieldLabel = null;
}

function addVoiceButtonToField(fieldId, fieldLabel) {
  const field = document.getElementById(fieldId);
  if (!field || field.closest('.form-group').querySelector('.voice-btn')) return;
  
  const voiceBtn = document.createElement('button');
  voiceBtn.className = 'voice-btn';
  voiceBtn.innerHTML = 'üé§';
  voiceBtn.type = 'button';
  voiceBtn.title = 'Voice input';
  voiceBtn.onclick = (e) => {
    e.preventDefault();
    openVoiceInput(fieldId, fieldLabel);
  };
  
  field.closest('.form-group').style.position = 'relative';
  field.style.paddingRight = '45px';
  field.parentElement.appendChild(voiceBtn);
}

// INIT
// ============================================================
// FIX: analyzeSavedPhotos uses callGeminiChunked
// ============================================================
function analyzeSavedPhotos() {
  if (savedPhotoFiles.length === 0) { showToast('No photos available for analysis', 'error'); return; }
  (async () => {
    showToast('Analyzing damage photos with AI...', 'ai');
    try {
      const images = await Promise.all(Array.from(savedPhotoFiles).map(async f => {
        const base64 = await fileToBase64(f);
        return { base64, dataUrl: 'data:image/jpeg;base64,' + base64, mimeType: 'image/jpeg' };
      }));
      const PHOTO_PROMPT = 'You are a senior motor vehicle damage assessor. Analyze ALL these damage photos. ' +
        'Return JSON: { "damaged_parts": [{ "part":"", "location":"", "damage_type":"", "severity":"", "recommendation":"REPAIR or REPLACE", "reason":"", "estimated_cost":0 }],' +
        '"overall_assessment": { "total_parts":0, "severity":"", "total_cost":0, "repair_days":0 }, "safety_concerns":[], "next_steps":[] }' +
        '\nReturn ONLY the JSON. No markdown, no backticks.';
      const rawText = await callGeminiChunked(images, PHOTO_PROMPT, 3000);
      const analysis = JSON.parse(rawText.replace(/```json|```/g, '').trim());
      showDamageAnalysisModal(analysis);
    } catch(err) {
      showToast('Damage analysis failed: ' + err.message, 'error');
      console.error(err);
    }
  })();
}

// ============================================================
// GROQ MODEL SELECTOR
// ============================================================
let activeGroqModel = 'meta-llama/llama-4-scout-17b-16e-instruct';
const MODEL_LABELS = {
  'meta-llama/llama-4-scout-17b-16e-instruct': '\u26A1 Scout',
  'meta-llama/llama-4-maverick-17b-128e-instruct': '\U0001F985 Maverick',
  'llama-3.2-11b-vision-preview': '\U0001F50E Vision'
};

function cycleModel() {
  document.getElementById('model-modal').classList.add('open');
  document.querySelectorAll('input[name="groq-model"]').forEach(r => { r.checked = r.value === activeGroqModel; });
}

function applyModelSelection() {
  const sel = document.querySelector('input[name="groq-model"]:checked');
  if (sel) {
    activeGroqModel = sel.value;
    document.getElementById('model-badge').textContent = MODEL_LABELS[activeGroqModel] || '\u26A1 AI';
    showToast('AI model: ' + (MODEL_LABELS[activeGroqModel] || activeGroqModel), 'ai');
  }
  document.getElementById('model-modal').classList.remove('open');
}

// Override callGemini to use activeGroqModel
const _origCallGeminiBase = callGemini;
callGemini = async function(parts, maxTokens) {
  maxTokens = maxTokens || 3000;
  const userContent = [];
  for (const part of parts) {
    if (part.inlineData) userContent.push({ type: 'image_url', image_url: { url: 'data:' + part.inlineData.mimeType + ';base64,' + part.inlineData.data } });
    else if (part.text) userContent.push({ type: 'text', text: part.text });
  }
  const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + GROQ_API_KEY },
    body: JSON.stringify({ model: activeGroqModel, max_tokens: maxTokens, temperature: 0.1, messages: [{ role: 'user', content: userContent }] })
  });
  if (!response.ok) { const err = await response.json().catch(() => ({})); throw new Error('Groq API ' + response.status + ': ' + (err.error && err.error.message ? err.error.message : response.statusText)); }
  const data = await response.json();
  return (data.choices && data.choices[0] && data.choices[0].message) ? data.choices[0].message.content || '' : '';
};

// ============================================================
// AUTO-SAVE (every 30 seconds)
// ============================================================
let autoSaveTimer = null;
let lastAutoSaveHash = '';

function getFormHash() {
  return [gv('f-reg-no'), gv('f-claim-no'), gv('f-insured-name'), assessRows.length, spotDamageRows.length].join('|');
}

function autoSave() {
  const vehicle = gv('f-reg-no');
  if (!vehicle) return;
  const hash = getFormHash();
  if (hash === lastAutoSaveHash) return;
  const dot = document.getElementById('autosave-dot');
  const lbl = document.getElementById('autosave-label');
  if (dot) dot.className = 'autosave-dot saving';
  if (lbl) { lbl.textContent = 'Saving\u2026'; lbl.className = 'autosave-label'; }
  try {
    const data = gatherCurrentReportData();
    const existingId = localStorage.getItem('current_report_id');
    const reportId = existingId || ('survey_' + vehicle.replace(/[^A-Z0-9]/gi, '') + '_' + Date.now());
    localStorage.setItem(reportId, JSON.stringify(data));
    let allReports = JSON.parse(localStorage.getItem('all_reports') || '[]');
    const idx = allReports.findIndex(r => r.id === reportId);
    const entry = { id: reportId, reportNo: data.reportNo || 'DRAFT-' + vehicle, vehicle: data.vehicle, insured: data.insured, claimNo: data.claimNo, savedAt: data.savedAt, make: data.make, model: data.model };
    if (idx >= 0) allReports[idx] = entry; else allReports.unshift(entry);
    if (allReports.length > 50) allReports = allReports.slice(0, 50);
    localStorage.setItem('all_reports', JSON.stringify(allReports));
    localStorage.setItem('current_report_id', reportId);
    lastAutoSaveHash = hash;
    setTimeout(() => { if (dot) dot.className = 'autosave-dot saved'; }, 300);
    setTimeout(() => { if (lbl) { lbl.textContent = 'Saved'; lbl.className = 'autosave-label saved'; } }, 300);
    setTimeout(() => { if (lbl) { lbl.textContent = 'Auto-save on'; lbl.className = 'autosave-label'; } if (dot) dot.className = 'autosave-dot'; }, 3500);
    updateDashboard();
  } catch(e) {
    if (dot) dot.className = 'autosave-dot';
    if (lbl) lbl.textContent = 'Save failed';
    console.error('Auto-save error:', e);
  }
}

function startAutoSave() {
  if (autoSaveTimer) clearInterval(autoSaveTimer);
  autoSaveTimer = setInterval(autoSave, 30000);
}

// ============================================================
// PRE-FLIGHT VALIDATION + SEQUENTIAL REPORT GENERATION
// ============================================================
function preflightThenGenerate() {
  const checks = [
    { label: 'Claim Number',       val: gv('f-claim-no'),      req: true  },
    { label: 'Registration No.',   val: gv('f-reg-no'),         req: true  },
    { label: 'Insurer Name',       val: gv('f-insurer'),        req: true  },
    { label: 'Insured Name',       val: gv('f-insured-name'),   req: true  },
    { label: 'Policy Number',      val: gv('f-policy-no'),      req: true  },
    { label: 'Date of Accident',   val: gv('f-doa'),            req: true  },
    { label: 'Assessment rows',    val: assessRows.length > 0 ? 'yes' : '', req: true, note: assessRows.length + ' items' },
    { label: 'Driver MDL No.',     val: gv('f-mdl'),            req: false },
    { label: 'Report No.',         val: gv('f-report-no'),      req: false },
    { label: 'Signature',          val: sigDataUrl ? 'yes' : '', req: false },
  ];
  const hasMissing = checks.some(c => c.req && !c.val);
  const hasWarnings = checks.some(c => !c.req && !c.val);
  if (!hasMissing && !hasWarnings) { doGenerateAllReports(); return; }
  let html = '';
  checks.forEach(c => {
    const ok = !!c.val;
    const icon = ok ? '\u2705' : (c.req ? '\u274C' : '\u26A0\uFE0F');
    const color = ok ? 'inherit' : (c.req ? 'var(--red)' : '#f59e0b');
    const note = c.note || (ok ? c.val.slice(0,20) : 'Missing');
    html += '<div class="preflight-row"><span class="preflight-icon">' + icon + '</span><span style="flex:1;color:' + color + ';">' + c.label + '</span><span style="font-size:0.75rem;color:var(--muted);">' + note + '</span></div>';
  });
  document.getElementById('preflight-checks').innerHTML = html;
  document.getElementById('preflight-modal').classList.add('open');
}

async function doGenerateAllReports() {
  showToast('Generating all 4 reports\u2026', 'ai');
  generateSurveyReportPDF();
  await new Promise(r => setTimeout(r, 800));
  generateBillCheckPDF();
  await new Promise(r => setTimeout(r, 800));
  generateRIPDF();
  await new Promise(r => setTimeout(r, 800));
  generateFeeBillPDF();
  const fab = document.getElementById('share-fab');
  if (fab) fab.classList.remove('hidden');
}

// Show share FAB whenever any report is printed
const _origPrintReport = printReport;
printReport = function(html, title) {
  _origPrintReport(html, title);
  const fab = document.getElementById('share-fab');
  if (fab) fab.classList.remove('hidden');
};

// ============================================================
// SHARE REPORT
// ============================================================
function openShareMenu() { document.getElementById('share-modal').classList.add('open'); }

function buildShareText() {
  const net = (document.getElementById('sum-net') || {}).textContent || '\u2014';
  return [
    '*Motor Survey Report*',
    'Report No: ' + (gv('f-report-no') || '\u2014'),
    'Vehicle: ' + (gv('f-reg-no') || '\u2014') + ' (' + gv('f-make') + ' ' + gv('f-model') + ')',
    'Insured: ' + (gv('f-insured-name') || '\u2014'),
    'Claim No: ' + (gv('f-claim-no') || '\u2014'),
    'Insurer: ' + (gv('f-insurer') || '\u2014'),
    'Net Liability: ' + net,
    'Surveyor: ' + (gv('sp-name') || '\u2014'),
  ].join('%0A');
}

function shareViaWhatsApp() {
  window.open('https://wa.me/?text=' + buildShareText(), '_blank');
  document.getElementById('share-modal').classList.remove('open');
}

function shareViaEmail() {
  const net = (document.getElementById('sum-net') || {}).textContent || '\u2014';
  const subj = encodeURIComponent('Survey Report ' + gv('f-report-no') + ' \u2014 ' + gv('f-reg-no'));
  const body = encodeURIComponent(
    'Dear Sir/Madam,\n\nPlease find below the survey report summary:\n\n' +
    'Report No: ' + (gv('f-report-no') || '\u2014') + '\n' +
    'Vehicle: ' + gv('f-reg-no') + ' | ' + gv('f-make') + ' ' + gv('f-model') + '\n' +
    'Insured: ' + gv('f-insured-name') + '\n' +
    'Claim No: ' + gv('f-claim-no') + '\n' +
    'Net Liability: ' + net + '\n\n' +
    'Regards,\n' + gv('sp-name') + '\nSurveyor & Loss Assessor\nLic. No.: ' + gv('sp-lic') + '\nMob: ' + gv('sp-mobile')
  );
  window.open('mailto:?subject=' + subj + '&body=' + body, '_self');
  document.getElementById('share-modal').classList.remove('open');
}

function copyReportSummary() {
  const net = (document.getElementById('sum-net') || {}).textContent || '\u2014';
  const txt = [
    'Motor Survey Report',
    'Report No: ' + (gv('f-report-no') || '\u2014'),
    'Vehicle: ' + gv('f-reg-no') + ' \u2014 ' + gv('f-make') + ' ' + gv('f-model'),
    'Insured: ' + gv('f-insured-name') + ' | Claim: ' + gv('f-claim-no'),
    'Net Liability: ' + net,
    'Surveyor: ' + gv('sp-name') + ' | ' + gv('sp-mobile'),
  ].join('\n');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(txt).then(() => showToast('Summary copied!', 'success')).catch(() => showToast('Copy failed', 'error'));
  } else { showToast('Clipboard not available', 'error'); }
  document.getElementById('share-modal').classList.remove('open');
}

// ============================================================
// IRDAI SURVEYOR FEE AUTO-CALCULATION
// ============================================================
function calcIRDAIFee(net) {
  if (net <= 0)       return 1500;
  if (net <= 50000)   return Math.max(1500,  Math.round(net * 0.07));
  if (net <= 200000)  return Math.max(3500,  Math.round(net * 0.05));
  if (net <= 500000)  return Math.max(10000, Math.round(net * 0.03));
  if (net <= 2000000) return Math.max(15000, Math.round(net * 0.02));
  return Math.max(40000, Math.round(net * 0.015));
}

function autoCalcIRDAIFee() {
  const netEl = document.getElementById('sum-net');
  const netLoss = netEl ? (parseFloat(netEl.textContent.replace(/[^\d.]/g, '')) || 0) : 0;
  if (netLoss <= 0) { showToast('Complete the assessment first to get net liability', 'error'); return; }
  const fee = calcIRDAIFee(netLoss);
  const el = document.getElementById('fee-prof');
  if (el) el.value = fee;
  calcFeeTotal();
  showToast('IRDAI fee: \u20B9' + fee.toLocaleString('en-IN') + ' on net \u20B9' + netLoss.toLocaleString('en-IN'), 'success');
}

// ============================================================
// PWA SERVICE WORKER + INSTALL PROMPT
// ============================================================
let pwaInstallEvent = null;

function installPWA() {
  if (pwaInstallEvent) {
    pwaInstallEvent.prompt();
    pwaInstallEvent.userChoice.then(r => {
      if (r.outcome === 'accepted') showToast('App installed! \uD83C\uDF89', 'success');
      pwaInstallEvent = null;
      document.getElementById('pwa-banner').classList.remove('show');
    });
  } else {
    showToast('Browser menu \u2192 "Add to Home Screen" or "Install App"', 'ai');
  }
}

function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return;
  const sw = [
    "const CACHE='survey-v1';",
    "self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll([self.location.href]).catch(()=>{})));self.skipWaiting();});",
    "self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));self.clients.claim();});",
    "self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(caches.match(e.request).then(cached=>{if(cached)return cached;return fetch(e.request).then(r=>{if(!r||r.status!==200)return r;caches.open(CACHE).then(c=>c.put(e.request,r.clone()));return r;}).catch(()=>cached);}));});",
  ].join('\n');
  try {
    const blob = new Blob([sw], { type: 'application/javascript' });
    navigator.serviceWorker.register(URL.createObjectURL(blob))
      .then(() => console.log('[SW] Registered'))
      .catch(e => console.warn('[SW]', e));
  } catch(e) { console.warn('[SW] Blob SW not supported:', e); }

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault(); pwaInstallEvent = e;
    if (!localStorage.getItem('pwa-dismissed'))
      setTimeout(() => document.getElementById('pwa-banner').classList.add('show'), 4000);
  });
}


// ============================================================
// GOOGLE DRIVE INTEGRATION
// ============================================================

// --- Drive State ---
let driveAccessToken = null;
let driveTokenClient = null;
let driveClientId = '';
let driveApiKey = '';
let driveRootFolderId = null;
let driveCurrentClaimFolderId = null;
const DRIVE_ROOT_FOLDER_NAME = 'Motor Survey Reports';

function saveDriveConfig() {
  const cid = document.getElementById('drive-client-id').value.trim();
  const akey = document.getElementById('drive-api-key').value.trim();
  if (cid) localStorage.setItem('drive_client_id', cid);
  if (akey) localStorage.setItem('drive_api_key', akey);
}

function loadDriveConfig() {
  const cid = localStorage.getItem('drive_client_id') || '';
  const akey = localStorage.getItem('drive_api_key') || '';
  const cidEl = document.getElementById('drive-client-id');
  const akeyEl = document.getElementById('drive-api-key');
  if (cidEl) cidEl.value = cid;
  if (akeyEl) akeyEl.value = akey;
  driveClientId = cid;
  driveApiKey = akey;
  if (cid) {
    const cfgStatus = document.getElementById('drive-config-status');
    if (cfgStatus) cfgStatus.textContent = '‚úÖ Credentials loaded';
    initDriveTokenClient();
  }
  const saved = localStorage.getItem('drive_access_token');
  const exp = parseInt(localStorage.getItem('drive_token_expiry') || '0');
  if (saved && exp > Date.now()) {
    driveAccessToken = saved;
    const email = localStorage.getItem('drive_user_email') || 'Connected';
    onDriveConnected(email);
  }
}

function initDriveWithConfig() {
  const cid = document.getElementById('drive-client-id').value.trim();
  const akey = document.getElementById('drive-api-key').value.trim();
  if (!cid) { showToast('Enter your OAuth Client ID first', 'error'); return; }
  localStorage.setItem('drive_client_id', cid);
  localStorage.setItem('drive_api_key', akey);
  driveClientId = cid;
  driveApiKey = akey;
  document.getElementById('drive-config-status').textContent = '‚úÖ Saved! Connecting...';
  initDriveTokenClient();
  setTimeout(() => requestDriveToken(), 600);
}

function initDriveTokenClient() {
  if (!window.google || !window.google.accounts) {
    setTimeout(initDriveTokenClient, 1200);
    return;
  }
  if (!driveClientId) return;
  driveTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: driveClientId,
    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
    callback: (tokenResponse) => {
      if (tokenResponse.error) { showToast('Google auth error: ' + tokenResponse.error, 'error'); return; }
      driveAccessToken = tokenResponse.access_token;
      const expiry = Date.now() + (tokenResponse.expires_in * 1000);
      localStorage.setItem('drive_access_token', driveAccessToken);
      localStorage.setItem('drive_token_expiry', String(expiry));
      fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: 'Bearer ' + driveAccessToken }
      }).then(r => r.json()).then(info => {
        localStorage.setItem('drive_user_email', info.email || '');
        onDriveConnected(info.email || 'Connected');
      }).catch(() => onDriveConnected('Connected'));
    }
  });
}

function requestDriveToken() {
  if (!driveTokenClient) { showToast('Add your Google Client ID in the Drive page first.', 'error'); showPage('drive'); return; }
  driveTokenClient.requestAccessToken({ prompt: '' });
}

function handleDriveAuthBtn() {
  if (driveAccessToken) disconnectDrive(); else requestDriveToken();
}

function onDriveConnected(email) {
  showToast('Google Drive connected! ‚úÖ', 'success');
  const authBtn = document.getElementById('drive-auth-btn');
  if (authBtn) { authBtn.textContent = '‚úÖ Connected ‚Äî Sign Out'; }
  const emailEl = document.getElementById('drive-user-email');
  if (emailEl) emailEl.textContent = email;
  const uInfo = document.getElementById('drive-user-info');
  if (uInfo) uInfo.style.display = 'block';
  const setupPanel = document.getElementById('drive-setup-panel');
  const connPanel = document.getElementById('drive-connected-panel');
  if (setupPanel) setupPanel.style.display = 'none';
  if (connPanel) connPanel.style.display = 'block';
  const bar = document.getElementById('sidebar-drive-bar');
  if (bar) {
    bar.classList.add('connected');
    document.getElementById('sidebar-drive-title').textContent = '‚úÖ Drive Connected';
    const shortEmail = email.length > 24 ? email.substring(0,22)+'‚Ä¶' : email;
    document.getElementById('sidebar-drive-sub').textContent = shortEmail;
  }
  const dsAccount = document.getElementById('ds-account');
  if (dsAccount) dsAccount.textContent = email;
  refreshDriveFileList();
}

function disconnectDrive() {
  driveAccessToken = null; driveRootFolderId = null; driveCurrentClaimFolderId = null;
  localStorage.removeItem('drive_access_token');
  localStorage.removeItem('drive_token_expiry');
  localStorage.removeItem('drive_user_email');
  const authBtn = document.getElementById('drive-auth-btn');
  if (authBtn) authBtn.textContent = 'üîó Connect Google Drive';
  const uInfo = document.getElementById('drive-user-info');
  if (uInfo) uInfo.style.display = 'none';
  const setupPanel = document.getElementById('drive-setup-panel');
  const connPanel = document.getElementById('drive-connected-panel');
  if (setupPanel) setupPanel.style.display = 'block';
  if (connPanel) connPanel.style.display = 'none';
  const bar = document.getElementById('sidebar-drive-bar');
  if (bar) {
    bar.classList.remove('connected');
    document.getElementById('sidebar-drive-title').textContent = 'Connect Google Drive';
    document.getElementById('sidebar-drive-sub').textContent = 'Tap to link your account';
  }
  showToast('Disconnected from Google Drive', 'success');
}

async function driveAPI(method, endpoint, body) {
  if (!driveAccessToken) throw new Error('Not connected to Google Drive');
  const url = 'https://www.googleapis.com/drive/v3/' + endpoint;
  const headers = { Authorization: 'Bearer ' + driveAccessToken };
  if (body && typeof body === 'object' && !(body instanceof FormData)) headers['Content-Type'] = 'application/json';
  const opts = { method, headers };
  if (body) opts.body = (typeof body === 'object' && !(body instanceof FormData)) ? JSON.stringify(body) : body;
  const res = await fetch(url, opts);
  if (res.status === 401) { driveAccessToken = null; localStorage.removeItem('drive_access_token'); throw new Error('Drive session expired. Please reconnect.'); }
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error((e.error&&e.error.message)||res.statusText); }
  return res.status === 204 ? {} : res.json();
}

async function findOrCreateFolder(name, parentId) {
  let q = `name='${name.replace(/'/g,"\\'")}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
  if (parentId) q += ` and '${parentId}' in parents`;
  const search = await driveAPI('GET', `files?q=${encodeURIComponent(q)}&fields=files(id,name)&spaces=drive`);
  if (search.files && search.files.length > 0) return search.files[0].id;
  const meta = { name, mimeType: 'application/vnd.google-apps.folder' };
  if (parentId) meta.parents = [parentId];
  const folder = await driveAPI('POST', 'files', meta);
  return folder.id;
}

async function uploadFileToDrive(file, folderId, fileName) {
  const metadata = { name: fileName || file.name, parents: [folderId] };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + driveAccessToken },
    body: form
  });
  if (res.status === 401) { driveAccessToken = null; localStorage.removeItem('drive_access_token'); throw new Error('Drive session expired.'); }
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error((e.error&&e.error.message)||res.statusText); }
  return res.json();
}

async function uploadHTMLToDrive(htmlContent, fileName, folderId) {
  const blob = new Blob([htmlContent], { type: 'text/html' });
  return uploadFileToDrive(new File([blob], fileName, { type: 'text/html' }), folderId, fileName);
}

async function uploadJSONToDrive(data, fileName, folderId) {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  return uploadFileToDrive(new File([blob], fileName, { type: 'application/json' }), folderId, fileName);
}

function getClaimFolderName() {
  const reg = (gv('f-reg-no') || 'UNKNOWN').replace(/\s+/g,'').toUpperCase();
  const claim = (gv('f-claim-no') || '').replace(/[\s\/\\:*?"<>|]/g,'');
  const insured = (gv('f-insured-name') || '').replace(/[^A-Za-z\s]/g,'').trim().split(' ')[0];
  const year = (gv('f-report-date') || new Date().toISOString().split('T')[0]).split('-')[0];
  let name = reg;
  if (claim) name += ' ‚Äî ' + claim;
  if (insured) name += ' ‚Äî ' + insured;
  name += ' ‚Äî ' + year;
  return name.substring(0, 100);
}

function buildUploadManifest() {
  const items = [];
  const reg = (gv('f-reg-no') || 'REPORT').replace(/\s+/g,'').replace(/[^A-Z0-9]/gi,'_');
  const claimNo = (gv('f-claim-no') || '').replace(/[^A-Z0-9]/gi,'_');
  const prefix = reg + (claimNo ? '_' + claimNo : '');
  items.push({ type:'report', label:'üìÑ Final Survey Report', key:'survey', fileName: prefix + '_Final_Survey_Report.html' });
  items.push({ type:'report', label:'üìç Spot Survey Report', key:'spot', fileName: prefix + '_Spot_Survey_Report.html' });
  items.push({ type:'report', label:'üßæ Bill Check Report', key:'bill', fileName: prefix + '_Bill_Check_Report.html' });
  items.push({ type:'report', label:'üîÑ Reinspection Report', key:'ri', fileName: prefix + '_Reinspection_Report.html' });
  items.push({ type:'report', label:'üí∞ Surveyor Fee Bill', key:'fee', fileName: prefix + '_Fee_Bill.html' });
  items.push({ type:'report', label:'üíæ Claim Data Backup', key:'json', fileName: prefix + '_ClaimData.json' });
  const docLabels = { rc:'RC_Book', dl:'Driving_Licence', policy:'Insurance_Policy', claim:'Claim_Form', estimate:'Repair_Estimate', permit:'Permit', auth:'Authorisation', fitness:'Fitness_Certificate', 'lok-challan':'Lok_Challan' };
  Object.entries(docLabels).forEach(([k, label]) => {
    if (uploadedDocs[k]) {
      const f = Array.isArray(uploadedDocs[k]) ? uploadedDocs[k][0] : uploadedDocs[k];
      const ext = f.name.split('.').pop();
      items.push({ type:'source', label:'üìé '+label.replace(/_/g,' '), key:k, fileName: prefix + '_' + label + '.' + ext });
    }
  });
  if (uploadedDocs['photos'] && uploadedDocs['photos'].length) {
    uploadedDocs['photos'].forEach((f, i) => {
      items.push({ type:'source', label:`üñº Photo ${i+1}`, key:'photo_'+i, fileName: prefix + `_Photo_${String(i+1).padStart(2,'0')}.${f.name.split('.').pop()}` });
    });
  }
  return items;
}

function refreshDriveFileList() {
  if (!driveAccessToken) return;
  const vehicle = gv('f-reg-no');
  const manifest = buildUploadManifest();
  const folderName = vehicle ? getClaimFolderName() : '‚Äî';
  const fnEl = document.getElementById('drive-folder-name');
  const fbEl = document.getElementById('drive-folder-badge');
  if (fnEl) fnEl.textContent = folderName;
  if (fbEl) fbEl.textContent = vehicle || 'No claim loaded';
  const listEl = document.getElementById('drive-upload-file-list');
  if (!listEl) return;
  if (!vehicle) {
    listEl.innerHTML = '<div style="font-size:0.8rem;color:var(--muted);padding:12px;text-align:center;">Enter claim details first (vehicle no., claim no.)</div>';
    return;
  }
  let html = '<ul class="drive-file-list">';
  manifest.forEach(item => {
    html += `<li><span class="dfl-icon">${item.label.split(' ')[0]}</span><span class="dfl-name" title="${item.fileName}">${item.fileName}</span><span class="dfl-status dfl-pending" id="dfl-${CSS.escape(item.key)}">Pending</span></li>`;
  });
  html += '</ul>';
  listEl.innerHTML = html;
}

async function uploadCurrentClaimToDrive() {
  if (!driveAccessToken) { showToast('Connect Google Drive first', 'error'); showPage('drive'); return; }
  if (!gv('f-reg-no')) { showToast('Enter vehicle registration number first', 'error'); return; }
  const btn = document.getElementById('drive-upload-btn');
  btn.disabled = true; btn.textContent = '‚è≥ Uploading...';
  const logEl = document.getElementById('drive-upload-log');
  logEl.innerHTML = '';
  const progressBar = document.getElementById('drive-progress-bar');
  const progressFill = document.getElementById('drive-progress-fill');
  progressBar.style.display = 'block'; progressFill.style.width = '0%';
  const manifest = buildUploadManifest();
  let done = 0; const total = manifest.length;

  function setStatus(key, status, cls) {
    const safeKey = CSS.escape ? CSS.escape(key) : key.replace(/[^\w-]/g,'_');
    const el = document.querySelector(`#dfl-${safeKey}`);
    if (el) { el.textContent = status; el.className = 'dfl-status ' + cls; }
  }
  function log(msg) { logEl.innerHTML += msg + '<br/>'; logEl.scrollTop = logEl.scrollHeight; }

  try {
    log('üìÅ Finding root folder...');
    driveRootFolderId = await findOrCreateFolder(DRIVE_ROOT_FOLDER_NAME, null);
    log('‚úÖ Root: ' + DRIVE_ROOT_FOLDER_NAME);
    const claimFolderName = getClaimFolderName();
    log('üìÅ Creating: ' + claimFolderName);
    driveCurrentClaimFolderId = await findOrCreateFolder(claimFolderName, driveRootFolderId);
    log('‚úÖ Claim folder ready');
    const sourceItems = manifest.filter(m => m.type === 'source');
    let sourceFolderId = null;
    if (sourceItems.length > 0) {
      sourceFolderId = await findOrCreateFolder('Source Documents', driveCurrentClaimFolderId);
      log('üìÅ Source Documents folder ready');
    }
    for (const item of manifest) {
      setStatus(item.key, 'Uploading‚Ä¶', 'dfl-uploading');
      log('‚¨Ü ' + item.fileName + '‚Ä¶');
      try {
        if (item.type === 'report') {
          if (item.key === 'json') {
            await uploadJSONToDrive(gatherCurrentReportData(), item.fileName, driveCurrentClaimFolderId);
          } else {
            let html = '';
            if (item.key === 'survey') html = buildFullPageHTML(buildSurveyReportHTML(), 'Final Survey Report');
            else if (item.key === 'spot') html = buildFullPageHTML(buildSpotSurveyHTML(), 'Spot Survey Report');
            else if (item.key === 'bill') html = buildFullPageHTML(buildBillCheckHTML(), 'Bill Check Report');
            else if (item.key === 'ri') html = buildFullPageHTML(buildRIReportHTML(), 'Reinspection Report');
            else if (item.key === 'fee') html = buildFullPageHTML(buildFeeBillHTMLContent(), 'Surveyor Fee Bill');
            await uploadHTMLToDrive(html, item.fileName, driveCurrentClaimFolderId);
          }
        } else {
          const targetFolder = sourceFolderId || driveCurrentClaimFolderId;
          if (item.key.startsWith('photo_')) {
            const idx = parseInt(item.key.split('_')[1]);
            await uploadFileToDrive(uploadedDocs['photos'][idx], targetFolder, item.fileName);
          } else {
            const f = uploadedDocs[item.key];
            await uploadFileToDrive(Array.isArray(f) ? f[0] : f, targetFolder, item.fileName);
          }
        }
        setStatus(item.key, '‚úÖ Done', 'dfl-done');
        done++; progressFill.style.width = Math.round((done/total)*100) + '%';
        log('‚úÖ ' + item.fileName);
      } catch(err) {
        setStatus(item.key, '‚ö† Error', 'dfl-error');
        log('‚ùå ' + item.fileName + ': ' + err.message);
        if (err.message.includes('expired')) { onDriveSessionExpired(); break; }
      }
    }
    const openBtn = document.getElementById('drive-open-btn');
    if (openBtn && driveCurrentClaimFolderId) {
      openBtn.style.display = 'inline-flex';
      openBtn.onclick = () => window.open('https://drive.google.com/drive/folders/' + driveCurrentClaimFolderId, '_blank');
    }
    log(`<span style="color:var(--teal);font-weight:700;">üéâ Complete! ${done}/${total} files uploaded.</span>`);
    showToast('‚òÅÔ∏è ' + done + ' files saved to Google Drive!', 'success');
    loadDriveStats();
    listAllClaimFolders();
  } catch(err) {
    log('<span style="color:var(--red);">‚ùå Error: ' + err.message + '</span>');
    showToast('Drive upload failed: ' + err.message, 'error');
    if (err.message.includes('expired')) onDriveSessionExpired();
  } finally {
    btn.disabled = false; btn.textContent = '‚òÅÔ∏è Upload All to Drive';
  }
}

async function quickSaveToDrive(reportType) {
  if (!driveAccessToken) {
    if (!driveClientId) { showToast('Set up Google Drive first ‚Äî click ‚òÅÔ∏è Drive in menu', 'error'); showPage('drive'); return; }
    requestDriveToken(); return;
  }
  if (!gv('f-reg-no')) { showToast('Enter vehicle registration number first', 'error'); return; }
  showToast('Saving to Drive‚Ä¶', 'ai');
  try {
    if (!driveRootFolderId) driveRootFolderId = await findOrCreateFolder(DRIVE_ROOT_FOLDER_NAME, null);
    if (!driveCurrentClaimFolderId) driveCurrentClaimFolderId = await findOrCreateFolder(getClaimFolderName(), driveRootFolderId);
    const prefix = (gv('f-reg-no')||'REPORT').replace(/\s+/g,'').replace(/[^A-Z0-9]/gi,'_');
    let html, fileName;
    if (reportType === 'survey') { html = buildFullPageHTML(buildSurveyReportHTML(), 'Final Survey Report'); fileName = prefix + '_Final_Survey_Report.html'; }
    else if (reportType === 'bill-check') { html = buildFullPageHTML(buildBillCheckHTML(), 'Bill Check'); fileName = prefix + '_Bill_Check_Report.html'; }
    else if (reportType === 'ri') { html = buildFullPageHTML(buildRIReportHTML(), 'Reinspection Report'); fileName = prefix + '_Reinspection_Report.html'; }
    await uploadHTMLToDrive(html, fileName, driveCurrentClaimFolderId);
    showToast('‚úÖ Saved to Drive: ' + fileName, 'success');
  } catch(err) {
    showToast('Drive error: ' + err.message, 'error');
    if (err.message.includes('expired')) onDriveSessionExpired();
  }
}

function onDriveSessionExpired() {
  driveAccessToken = null; localStorage.removeItem('drive_access_token');
  showToast('Drive session expired ‚Äî reconnecting‚Ä¶', 'ai');
  setTimeout(() => requestDriveToken(), 800);
}

function openDriveFolder() {
  const url = driveCurrentClaimFolderId
    ? 'https://drive.google.com/drive/folders/' + driveCurrentClaimFolderId
    : 'https://drive.google.com/drive/search?q=' + encodeURIComponent(DRIVE_ROOT_FOLDER_NAME);
  window.open(url, '_blank');
}

async function loadDriveStats() {
  if (!driveAccessToken) return;
  try {
    if (!driveRootFolderId) { try { driveRootFolderId = await findOrCreateFolder(DRIVE_ROOT_FOLDER_NAME, null); } catch(e) { return; } }
    const q = `'${driveRootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    const res = await driveAPI('GET', 'files?q=' + encodeURIComponent(q) + '&fields=files(id)&pageSize=100');
    const count = (res.files || []).length;
    const el = document.getElementById('ds-claims-count');
    if (el) el.textContent = count;
  } catch(e) { /* non-critical */ }
}

async function listAllClaimFolders() {
  if (!driveAccessToken) return;
  const container = document.getElementById('drive-folders-list');
  if (!container) return;
  container.innerHTML = '<div style="padding:14px;text-align:center;"><div class="spinner spinner-green" style="margin:0 auto;width:20px;height:20px;border-width:3px;"></div></div>';
  try {
    if (!driveRootFolderId) driveRootFolderId = await findOrCreateFolder(DRIVE_ROOT_FOLDER_NAME, null);
    const q = `'${driveRootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    const res = await driveAPI('GET', 'files?q=' + encodeURIComponent(q) + '&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc&pageSize=50');
    const folders = res.files || [];
    const countEl = document.getElementById('ds-claims-count');
    if (countEl) countEl.textContent = folders.length;
    if (folders.length === 0) {
      container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--muted);font-size:0.85rem;"><div style="font-size:2rem;margin-bottom:8px;">üìÇ</div>No claim folders yet. Upload your first report above.</div>';
      return;
    }
    let html = '';
    folders.forEach(f => {
      const mod = new Date(f.modifiedTime).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
      html += `<div class="drive-folder-card" onclick="window.open('https://drive.google.com/drive/folders/${f.id}','_blank')">
        <span class="dfc-icon">üìÅ</span>
        <div style="flex:1;min-width:0;">
          <div class="dfc-name">${f.name}</div>
          <div class="dfc-meta">Modified: ${mod}</div>
        </div>
        <span class="dfc-arrow">‚Üó</span>
      </div>`;
    });
    container.innerHTML = html;
  } catch(err) {
    container.innerHTML = `<div style="padding:14px;color:var(--red);font-size:0.82rem;">Error: ${err.message}</div>`;
  }
}

function buildFullPageHTML(bodyHTML, title) {
  return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><title>${title}</title><link href='https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap' rel='stylesheet'/><style>@page{margin:8mm 10mm;size:A4 portrait;}*{box-sizing:border-box;}body{font-family:'DM Sans',Arial,sans-serif;font-size:7.8pt;line-height:1.3;color:#000;margin:16px;padding:0;}table{border-collapse:collapse;width:100%;font-size:7.8pt;}td,th{padding:2px 4px;}p{margin:0 0 4px 0;}.no-print{display:none;}@media print{.btn-print{display:none!important;}}</style></head><body>${bodyHTML}<button onclick="window.print()" style="position:fixed;bottom:18px;right:18px;background:#1a7a6e;color:#fff;border:none;border-radius:24px;padding:10px 20px;font-size:0.85rem;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.2);font-family:sans-serif;" class="btn-print">üñ® Print / Save PDF</button></body></html>`;
}

function buildFeeBillHTMLContent() {
  calcFeeTotal();
  const p=parseFloat(gv('fee-prof'))||0, r=parseFloat(gv('fee-ri'))||0, t=parseFloat(gv('fee-travel'))||0,
    ph=(parseFloat(gv('fee-photos-count'))||0)*(parseFloat(gv('fee-photo-rate'))||0),
    po=parseFloat(gv('fee-postal'))||0, tot=p+r+t+ph+po;
  const fa=v=>v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  return getSurveyorHeader()+`<div style="text-align:center;font-weight:700;font-size:1rem;margin-bottom:10px;">SURVEYOR FEE BILL</div><table style="width:100%;font-size:0.82rem;border-collapse:collapse;margin-bottom:8px;"><tr><td style="color:#666;">Report No.</td><td>${gv('f-report-no')}</td><td style="text-align:right;color:#666;">Date:</td><td style="text-align:right;font-weight:700;">${gv('f-report-date')}</td></tr><tr><td colspan="4">Insurer: <strong>${gv('f-insurer')}</strong> | Policy: ${gv('f-policy-no')} | Claim: ${gv('f-claim-no')}</td></tr><tr><td colspan="4">Insured: <strong>${gv('f-insured-name')}</strong> ‚Äî ${gv('f-reg-no')}</td></tr></table><table style="width:100%;border-collapse:collapse;border:1px solid #000;font-size:0.82rem;"><thead><tr style="background:#0d1b2a;color:#fff;"><th style="padding:6px 8px;text-align:left;width:30px;">Sr.</th><th style="padding:6px 8px;text-align:left;">Particular</th><th style="padding:6px 8px;text-align:right;width:90px;">Amount ‚Çπ</th></tr></thead><tbody><tr><td style="padding:5px 8px;">1</td><td style="padding:5px 8px;">Professional Fees ‚Çπ${fa(p)} + RI Fees ‚Çπ${fa(r)}</td><td style="padding:5px 8px;text-align:right;">${fa(p+r)}</td></tr><tr><td style="padding:5px 8px;">2</td><td style="padding:5px 8px;">Travelling / Conveyance (${gv('fee-travel-note')})</td><td style="padding:5px 8px;text-align:right;">${fa(t)}</td></tr><tr><td style="padding:5px 8px;">3</td><td style="padding:5px 8px;">Digital Photo Charges ${gv('fee-photos-count')} Nos @ ‚Çπ${gv('fee-photo-rate')}</td><td style="padding:5px 8px;text-align:right;">${fa(ph)}</td></tr><tr><td style="padding:5px 8px;">4</td><td style="padding:5px 8px;">Postal / Courier</td><td style="padding:5px 8px;text-align:right;">${fa(po)}</td></tr><tr style="background:#0d1b2a;color:#fff;"><td colspan="2" style="padding:7px 8px;text-align:right;font-weight:700;">TOTAL</td><td style="padding:7px 8px;text-align:right;font-weight:700;">${fa(tot)}</td></tr></tbody></table><div style="margin:6px 0;font-style:italic;font-size:0.76rem;">RUPEES ${numberToWords(tot)} ONLY</div>${getSigBlock()}<div style="margin-top:14px;font-size:0.78rem;"><strong>Bank Details:</strong> ${gv('bank-name')} | A/C: ${gv('bank-ac')} | IFSC: ${gv('bank-ifsc')} | PAN: ${gv('bank-pan')}</div>`;
}

// Extend showPage to refresh drive list when navigating to drive page
const _showPageOrig = showPage;
showPage = function(id) {
  _showPageOrig(id);
  if (id === 'drive' && driveAccessToken) refreshDriveFileList();
};

// ============================================================
// END GOOGLE DRIVE INTEGRATION  
// ============================================================

window.addEventListener('load', () => {
  // Pre-fill surveyor profile defaults
  document.getElementById('sp-name').value = 'VIKRAM PATIL';
  document.getElementById('sp-qual').value = 'B.Sc., Dip. in Auto Engg.';
  document.getElementById('sp-lic').value = 'SLA-34369/2025-2028';
  document.getElementById('sp-lic-exp').value = '27-11-2028';
  document.getElementById('sp-iiisla').value = 'F/W/00200';
  document.getElementById('sp-code').value = 'SU00006883';
  document.getElementById('sp-categories').value = 'MOTOR, MARINE, ENGG';
  document.getElementById('sp-email').value = 'vikram.dhule9@gmail.com';
  document.getElementById('sp-mobile').value = '9518510366, 9423662250';
  document.getElementById('sp-addr').value = '62, Vighnaharta Colony, Near Aakshwani, Deopur, Dhule- 424005.';
  document.getElementById('f-report-no').value = '';
  document.getElementById('f-report-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('bank-name').value = 'State Bank Of India';
  document.getElementById('bank-ac').value = '30714578614';
  document.getElementById('bank-ifsc').value = 'SBIN0000366';
  document.getElementById('bank-pan').value = 'ACJPP9011H';
  
  // Add voice input buttons to key fields
  setTimeout(() => {
    // Policy & Claim fields
    addVoiceButtonToField('f-policy-no', 'Policy Number');
    addVoiceButtonToField('f-claim-no', 'Claim Number');
    addVoiceButtonToField('f-insurer', 'Insurer Name & Address');
    addVoiceButtonToField('f-policy-office', 'Policy Issuing Office');
    addVoiceButtonToField('f-appt-office', 'Appointing Office');
    
    // Insured fields
    addVoiceButtonToField('f-insured-name', 'Insured Name');
    addVoiceButtonToField('f-insured-mobile', 'Mobile Number');
    addVoiceButtonToField('f-insured-addr', 'Address');
    addVoiceButtonToField('f-hpa', 'HPA / Finance With');
    
    // Vehicle fields
    addVoiceButtonToField('f-reg-no', 'Registration Number');
    addVoiceButtonToField('f-make', 'Make');
    addVoiceButtonToField('f-model', 'Model / Variant');
    addVoiceButtonToField('f-chassis', 'Chassis Number');
    addVoiceButtonToField('f-engine', 'Engine Number');
    addVoiceButtonToField('f-cc', 'Cubic Capacity');
    addVoiceButtonToField('f-body-type', 'Body Type');
    addVoiceButtonToField('f-colour', 'Colour');
    addVoiceButtonToField('f-rlw', 'RLW / Seating Capacity');
    addVoiceButtonToField('f-fitness', 'Fitness Cert No.');
    addVoiceButtonToField('f-route', 'Route / Area');
    
    // Driver fields
    addVoiceButtonToField('f-driver-name', 'Driver Name');
    addVoiceButtonToField('f-mdl', 'MDL Number');
    addVoiceButtonToField('f-dl-valid', 'Validity');
    addVoiceButtonToField('f-dl-auth', 'Issuing Authority');
    addVoiceButtonToField('f-dl-type', 'Type of License');
    
    // Accident fields
    addVoiceButtonToField('f-poa', 'Place of Accident');
    addVoiceButtonToField('f-survey-place', 'Place of Survey');
    addVoiceButtonToField('f-cause', 'Cause & Nature of Accident');
    addVoiceButtonToField('f-tp', 'Third Party Details');
    
    // RI fields
    addVoiceButtonToField('ri-ref', 'RI Reference Number');
    
    // Spot Survey voice inputs
    addVoiceButtonToField('spot-report-no', 'Spot Report Number');
    addVoiceButtonToField('spot-accident-place', 'Place of Accident');
    addVoiceButtonToField('spot-survey-place', 'Place of Survey');
    addVoiceButtonToField('spot-accident-cause', 'Cause of Accident');
    addVoiceButtonToField('spot-driver-name', 'Driver Name');
    addVoiceButtonToField('spot-mdl-no', 'MDL Number');
    addVoiceButtonToField('spot-dl-authority', 'DL Issuing Authority');
    addVoiceButtonToField('spot-dl-type', 'Licence Type');
    addVoiceButtonToField('spot-dl-invalid-remarks', 'DL Invalid Remarks');
    addVoiceButtonToField('spot-cn-no', 'Challan Number');
    addVoiceButtonToField('spot-load-desc', 'Load Description');
    addVoiceButtonToField('spot-police-station', 'Police Station Name');
    addVoiceButtonToField('spot-diary-no', 'Station Diary Number');
    addVoiceButtonToField('spot-tp-details', 'Third Party Details');
    addVoiceButtonToField('spot-comments', 'Damage Details / Comments');
    addVoiceButtonToField('spot-comments', 'Additional Comments');
  }, 500);
  
  showPage('dashboard');
  refreshReportsList();
  renderSpotDamageRows();
  startAutoSave();
  registerServiceWorker();
  // Initialize Google Drive connection state
  loadDriveConfig();
});
</script>
</body>
</html>
